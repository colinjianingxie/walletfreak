{% extends 'auth_base.html' %}
{% load static %}

{% block content %}
<!-- Hidden CSRF token for JavaScript -->
<form style="display: none;">
    {% csrf_token %}
</form>

<!-- Dashboard Header -->
<div style="margin-bottom: 2.5rem;">
    <!-- Greeting Section -->
    <div style="display: flex; align-items: center; gap: 1.5rem;">
        <div
            style="width: 60px; height: 60px; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);">
            <span class="material-icons" style="font-size: 32px;">flight</span>
        </div>
        <div>
            <h1 style="font-size: 2rem; font-weight: 800; margin: 0; line-height: 1.2;">
                Hey, <span style="color: #7C3AED;">{% if user.first_name %}{{ user.first_name }}{% else %}Alex{% endif %}!</span>
            </h1>
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                {% if assigned_personality %}
                <a href="{% url 'personality_results' %}" style="text-decoration: none;">
                    <span
                        style="background: #E0F2FE; color: #0284C7; font-size: 0.7rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 4px; letter-spacing: 0.05em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='#BAE6FD'"
                        onmouseout="this.style.background='#E0F2FE'">
                        <span class="material-icons" style="font-size: 10px; vertical-align: middle;">psychology</span>
                        {{ assigned_personality.name }}
                    </span>
                </a>
                {% if assigned_personality.match_score %}
                <span style="color: #64748B; font-size: 0.9rem;">{{ assigned_personality.match_score }} card{{ assigned_personality.match_score|pluralize }} match</span>
                {% endif %}
                {% else %}
                <span style="color: #64748B; font-size: 0.9rem;">
                    {% if active_cards|length == 2 %}
                    Add 1 more card to discover your personality
                    {% elif active_cards|length == 1 %}
                    Add 2 more cards to discover your personality
                    {% else %}
                    Add 3 cards to discover your personality
                    {% endif %}
                </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Search Bar (Right Aligned) -->
        <div style="margin-left: auto; width: 300px;">
            <div style="position: relative;">
                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9CA3AF;"><span class="material-icons" style="font-size: 18px;">search</span></span>
                <input type="text" placeholder="Search benefits..." style="width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid #E5E7EB; border-radius: 99px; font-size: 0.9rem; background: white;">
            </div>
        </div>
    </div>
</div>

<!-- Top Grid: Annual Value + My Wallet + Add New Card -->
<div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2.5rem;">
    <!-- Annual Value Card (Purple) -->
    <div
        style="background: linear-gradient(135deg, #6366F1 0%, #7C3AED 100%); border-radius: 24px; padding: 2rem; color: white; box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 240px;">
        
        <!-- Top Row -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 1;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                <span class="material-icons" style="font-size: 24px;">trending_up</span>
            </div>
            <div style="font-size: 0.875rem; font-weight: 500; opacity: 0.9;">Annual Value</div>
        </div>

        <!-- Bottom Row -->
        <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem; opacity: 0.9;">Total Value Extracted</div>
            <div style="font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; letter-spacing: -0.02em;">
                ${{ total_used_value|floatformat:0 }}<span style="font-size: 1.75rem; font-weight: 500; opacity: 0.7;">.00</span>
            </div>
            <div style="font-size: 0.875rem; opacity: 0.8;">
                Out of ${{ total_potential_value|floatformat:0 }} available credits
            </div>
        </div>
    </div>

    <!-- My Wallet Card -->
    <div
        style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; justify-content: space-between;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 0.75rem; font-weight: 700; color: #64748B; letter-spacing: 0.05em; margin-bottom: 0.5rem; text-transform: uppercase;">MY STACK</div>
                <div style="display: flex; align-items: baseline; gap: 0.5rem;">
                    <div style="font-size: 3rem; font-weight: 800; color: #1F2937; line-height: 1;">{{ active_cards|length }}</div>
                    <div style="font-size: 0.9rem; color: #64748B;">Active Cards</div>
                </div>
            </div>
            <div style="width: 40px; height: 40px; background: #FDF4FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #D946EF;">
                <span class="material-icons" style="font-size: 20px;">wallet</span>
            </div>
        </div>
        
        <div style="margin-top: auto;">
            <button onclick="openManageWalletModal('stack')" style="width: 100%; padding: 0.75rem; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; font-weight: 600; color: #1F2937; cursor: pointer; transition: all 0.2s;">
                Manage Wallet
            </button>
        </div>
    </div>

    <!-- Add New Card Trigger -->
    <div
        style="background: white; border-radius: 24px; padding: 1.5rem; border: 2px dashed #E5E7EB; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: all 0.2s;"
        onclick="openManageWalletModal('add')"
        onmouseover="this.style.borderColor='#7C3AED'; this.style.background='#F5F3FF'"
        onmouseout="this.style.borderColor='#E5E7EB'; this.style.background='white'">
        
        <div style="width: 64px; height: 64px; background: #EEF2FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #6366F1; margin-bottom: 1rem;">
            +
        </div>
        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">Add New Card</h3>
        <p style="color: #64748B; font-size: 0.875rem; margin: 0;">Track a new bonus or fee</p>
    </div>
</div>


<!-- Action Needed Section -->
<div style="margin-bottom: 3rem;">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
        <div style="width: 32px; height: 32px; background: #FEF3C7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #D97706;">
            <span class="material-icons" style="font-size: 18px;">priority_high</span>
        </div>
        <h2 style="font-size: 1.25rem; font-weight: 800; margin: 0; color: #1F2937;">Action Needed <span style="color: #94A3B8; font-weight: 600; font-size: 1rem; margin-left: 0.25rem;">({{ action_needed_benefits|length }})</span></h2>
    </div>

    {% if not action_needed_benefits %}
    <div style="text-align: center; padding: 3rem 1rem; background: white; border-radius: 24px; border: 1px solid #F3F4F6;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">check_circle</span></div>
        <div style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem; color: #1F2937;">All caught up!</div>
        <div style="color: #64748B;">You've maximized all your benefits for the current period.</div>
    </div>
    {% else %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(520px, 1fr)); gap: 1.5rem;">
        {% for benefit in action_needed_benefits %}
        <div class="benefit-card" style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.2s;">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;">
                    <div style="width: 48px; height: 32px; background: #94A3B8; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">
                        {% if 'platinum' in benefit.card_name|lower %}PLATINUM{% elif 'gold' in benefit.card_name|lower %}GOLD{% elif 'sapphire' in benefit.card_name|lower %}SAPPHIRE{% else %}CARD{% endif %}
                    </div>
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">{{ benefit.benefit_name }}</h3>
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">
                            {{ benefit.card_name }} â€¢ 
                            {% if 'anniversary year' in benefit.frequency|lower %}
                                ANNUALLY ({{ benefit.periods.0.label }})
                            {% elif 'calendar year' in benefit.frequency|lower %}
                                {% if 'semi' in benefit.frequency|lower %}SEMI-ANNUALLY{% else %}ANNUALLY{% endif %}
                            {% elif 'every four years' in benefit.frequency|lower %}
                                EVERY FOUR YEARS ({{ benefit.periods.0.label }})
                            {% else %}
                                {{ benefit.frequency }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.25rem; font-weight: 800; color: #1F2937;">${{ benefit.amount|floatformat:0 }}</div>
                    <div style="font-size: 0.7rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">PER PERIOD</div>
                </div>
            </div>

            <!-- Tracker -->
            {% if 'Monthly' in benefit.frequency %}
            {{ benefit.periods|json_script:benefit.benefit_id }}
            <div class="monthly-pills-grid">
                {% for period in benefit.periods %}
                <div class="period-pill {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}')"{% endif %}
                     style="{% if not period.is_available %}cursor: not-allowed;{% endif %}">
                    <div class="pill-label">{{ period.label }}</div>
                    <div style="font-size: 0.65rem; font-weight: 600; color: #64748B;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 12px;">check</span>
                        {% elif period.status == 'partial' %}
                        <div style="width: 6px; height: 2px; background: #3B82F6; border-radius: 1px;"></div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% elif 'Quarterly' in benefit.frequency or 'Semi-annually' in benefit.frequency %}
            {{ benefit.periods|json_script:benefit.benefit_id }}
            <div style="display: flex; gap: 1.5rem;">
                {% for period in benefit.periods %}
                <div class="period-pill large {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}')"{% endif %}
                     style="flex: 1; {% if not period.is_available %}opacity: 0.3; cursor: not-allowed;{% else %}cursor: pointer;{% endif %}">
                    <div class="pill-label">
                        {% if period.label == 'H1' %}Jan - Jun{% elif period.label == 'H2' %}Jul - Dec{% else %}{{ period.label }}{% endif %}
                    </div>
                    <div style="font-size: 0.875rem; font-weight: 700; color: #1F2937;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 16px;">check</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Annual Progress Bar -->
            {{ benefit.periods|json_script:benefit.benefit_id }}
            <div style="background: #F8FAFC; border-radius: 12px; padding: 1rem; border: 1px solid #E2E8F0; cursor: pointer;"
                 onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ benefit.periods.0.key }}')">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #64748B;">
                    <span>{{ benefit.periods.0.label }}</span>
                    {% if benefit.used > 0 %}<span style="color: #6366F1;">${{ benefit.used|floatformat:0 }} used</span>{% endif %}
                </div>
                <div style="height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden;">
                    <div style="width: {% widthratio benefit.used benefit.amount 100 %}%; height: 100%; background: #6366F1; border-radius: 4px;"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Maxed Out Section -->
{% if maxed_out_benefits %}
<div style="margin-bottom: 3rem;">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
        <div style="width: 32px; height: 32px; background: #DCFCE7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #16A34A;">
            <span class="material-icons" style="font-size: 18px;">check_circle</span>
        </div>
        <h2 style="font-size: 1.25rem; font-weight: 800; margin: 0; color: #1F2937;">Maxed Out <span style="color: #94A3B8; font-weight: 600; font-size: 1rem; margin-left: 0.25rem;">({{ maxed_out_benefits|length }})</span></h2>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(520px, 1fr)); gap: 1.5rem;">
        {% for benefit in maxed_out_benefits %}
        <div class="benefit-card" style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.2s;">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;">
                    <div style="width: 48px; height: 32px; background: #CBD5E1; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">
                        {% if 'platinum' in benefit.card_name|lower %}PLATINUM{% elif 'gold' in benefit.card_name|lower %}GOLD{% elif 'sapphire' in benefit.card_name|lower %}SAPPHIRE{% else %}CARD{% endif %}
                    </div>
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">{{ benefit.benefit_name }}</h3>
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">
                            {{ benefit.card_name }} â€¢ 
                            {% if 'anniversary year' in benefit.frequency|lower %}
                                ANNUALLY ({{ benefit.periods.0.label }})
                            {% elif 'calendar year' in benefit.frequency|lower %}
                                {% if 'semi' in benefit.frequency|lower %}SEMI-ANNUALLY{% else %}ANNUALLY{% endif %}
                            {% elif 'every four years' in benefit.frequency|lower %}
                                EVERY FOUR YEARS ({{ benefit.periods.0.label }})
                            {% else %}
                                {{ benefit.frequency }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.25rem; font-weight: 800; color: #1F2937;">${{ benefit.amount|floatformat:0 }}</div>
                    <div style="font-size: 0.7rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">PER PERIOD</div>
                </div>
            </div>

            <!-- Tracker -->
            {% if 'Monthly' in benefit.frequency %}
            {{ benefit.periods|json_script:benefit.benefit_id }}
            <div class="monthly-pills-grid">
                {% for period in benefit.periods %}
                <div class="period-pill {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}')"{% endif %}
                     style="{% if not period.is_available %}cursor: not-allowed;{% endif %}">
                    <div class="pill-label">{{ period.label }}</div>
                    <div style="font-size: 0.65rem; font-weight: 600; color: #64748B;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 12px;">check</span>
                        {% elif period.status == 'partial' %}
                        <div style="width: 6px; height: 2px; background: #3B82F6; border-radius: 1px;"></div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% elif 'Quarterly' in benefit.frequency or 'Semi-annually' in benefit.frequency %}
            {{ benefit.periods|json_script:benefit.benefit_id }}
            <div style="display: flex; gap: 1.5rem;">
                {% for period in benefit.periods %}
                <div class="period-pill large {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}')"{% endif %}
                     style="flex: 1; {% if not period.is_available %}opacity: 0.3; cursor: not-allowed;{% else %}cursor: pointer;{% endif %}">
                    <div class="pill-label">
                        {% if period.label == 'H1' %}Jan - Jun{% elif period.label == 'H2' %}Jul - Dec{% else %}{{ period.label }}{% endif %}
                    </div>
                    <div style="font-size: 0.875rem; font-weight: 700; color: #1F2937;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 16px;">check</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Annual Progress Bar -->
            {{ benefit.periods|json_script:benefit.benefit_id }}
            <div style="background: #F8FAFC; border-radius: 12px; padding: 1rem; border: 1px solid #E2E8F0; cursor: pointer;"
                 onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ benefit.periods.0.key }}')">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #64748B;">
                    <span>{{ benefit.periods.0.label }}</span>
                    {% if benefit.used > 0 %}<span style="color: #6366F1;">${{ benefit.used|floatformat:0 }} used</span>{% endif %}
                </div>
                <div style="height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden;">
                    <div style="width: 100%; height: 100%; background: #16A34A; border-radius: 4px;"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Manage Wallet Modal (Redesigned with Sidebar) -->
<div id="manage-wallet-modal" class="modal" style="display: none; align-items: center; justify-content: center; padding: 2rem;">
    <div class="modal-content" style="width: 1000px; max-width: 95vw; height: 600px; max-height: 90vh; padding: 0; display: flex; overflow: hidden; border-radius: 24px; background: white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        
        <!-- Sidebar -->
        <div class="modal-sidebar">
            <div style="padding: 0 0.5rem; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.25rem; font-weight: 800; margin: 0; color: #1F2937;">Manage Wallet</h3>
            </div>
            
            <div class="modal-sidebar-item active" onclick="switchTab('stack')" id="tab-stack">
                <span class="material-icons" style="font-size: 20px;">wallet</span>
                <span>My Stack</span>
                <span style="background: #E2E8F0; color: #64748B; font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 99px; margin-left: auto;">{{ active_cards|length }}</span>
            </div>
            
            <div class="modal-sidebar-item" onclick="switchTab('add')" id="tab-add">
                <span class="material-icons" style="font-size: 20px;">add_circle_outline</span>
                <span>Add New Card</span>
            </div>

            <div style="margin-top: auto; padding: 1rem; background: #F1F5F9; border-radius: 12px; font-size: 0.75rem; color: #64748B; line-height: 1.4;">
                Tip: Removing a card will archive its history but keep your data safe.
            </div>
        </div>
        
        <!-- Content Area -->
        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;">
            <button class="modal-close-btn" onclick="closeManageWalletModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">Ã—</button>

            <!-- View 1: My Stack -->
            <div id="content-stack" style="flex: 1; padding: 2rem; display: flex; flex-direction: column; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0; color: #1F2937;">Active Cards</h3>
                    <button onclick="switchTab('add')" style="color: #6366F1; font-weight: 700; background: none; border: none; cursor: pointer; font-size: 0.9rem;">+ Add Another</button>
                </div>
                
                <div style="flex: 1; overflow-y: auto;">
                    {% if active_cards %}
                        {% for card in active_cards %}
                        <div style="display: flex; align-items: center; padding: 1.25rem; border: 1px solid #F3F4F6; border-radius: 16px; margin-bottom: 1rem; background: white; transition: all 0.2s;">
                            <div style="width: 60px; height: 40px; background: {% if 'chase' in card.name|lower %}#117ACA{% elif 'amex' in card.name|lower or 'american express' in card.name|lower %}#2563EB{% elif 'capital' in card.name|lower %}#0F172A{% else %}#CBD5E1{% endif %}; border-radius: 6px; margin-right: 1.25rem;"></div>
                            
                            <div>
                                <div style="font-weight: 700; color: #1F2937; font-size: 1rem;">{{ card.name }}</div>
                                <div style="font-size: 0.85rem; color: #94A3B8; font-family: monospace;">â€¢â€¢â€¢â€¢ {{ card.last4|default:"****" }}</div>
                            </div>
                            
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem;">
                                <span style="background: #DCFCE7; color: #16A34A; font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 99px;">Active</span>
                                
                                <form method="POST" action="{% url 'remove_card' card.id %}" style="margin: 0;" onsubmit="return confirm('Remove this card from your wallet?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-delete-card" style="background: none; border: none; cursor: pointer; color: #E2E8F0; padding: 0.5rem; transition: color 0.2s;" onmouseover="this.style.color='#EF4444'" onmouseout="this.style.color='#E2E8F0'" title="Remove Card">
                                        <span class="material-icons" style="font-size: 20px;">delete_outline</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 4rem 2rem; color: #94A3B8;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">wallet</span></div>
                            <p>Your wallet is empty.</p>
                            <button onclick="switchTab('add')" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #6366F1; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                                Add Your First Card
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- View 2: Find a Card -->
            <div id="content-add" style="flex: 1; display: none; overflow: hidden; height: 100%;">
                <div style="display: flex; height: 100%;">
                    <!-- Left Column: Search & List -->
                    <div style="flex: 1; padding: 2rem; border-right: 1px solid #F3F4F6; display: flex; flex-direction: column; overflow: hidden;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1F2937;">Find a Card</h3>
                        <p style="color: #64748B; font-size: 0.9rem; margin-bottom: 1.5rem;">Search by name or issuer to add it to your wallet.</p>
                        
                        <div style="position: relative; margin-bottom: 1.5rem;">
                            <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #6366F1;"><span class="material-icons" style="font-size: 20px;">search</span></span>
                            <input type="text" id="card-search-input" placeholder="Search e.g. 'Sapphire' or 'Amex'" 
                                   style="width: 100%; padding: 1rem 1rem 1rem 3rem; border: 1px solid #6366F1; border-radius: 12px; font-size: 1rem; outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);">
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; margin-bottom: 0.75rem; text-transform: uppercase;">Quick Add</div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="quick-add-btn" onclick="filterCards('Chase')">Chase</button>
                                <button class="quick-add-btn" onclick="filterCards('Amex')">Amex</button>
                                <button class="quick-add-btn" onclick="filterCards('Capital One')">Capital One</button>
                                <button class="quick-add-btn" onclick="filterCards('Citi')">Citi</button>
                            </div>
                        </div>
                        
                        <div id="card-results-list" style="overflow-y: auto; flex: 1; padding-right: 0.5rem;">
                            <!-- Results populated via JS -->
                        </div>
                    </div>
                    
                    <!-- Right Column: Card Preview -->
                    <div style="width: 380px; padding: 2rem; background: #F8FAFC; display: flex; flex-direction: column; align-items: center; overflow-y: auto;">
                        <div id="card-preview-empty" style="color: #94A3B8; text-align: center; margin-top: 8rem;">
                            <div style="width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                                <span class="material-icons" style="font-size: 32px; color: #CBD5E1;">credit_card</span>
                            </div>
                            <h4 style="color: #1F2937; margin-bottom: 0.5rem;">Select a Card</h4>
                            <p style="font-size: 0.9rem;">Choose a card from the list to<br>preview its benefits.</p>
                        </div>
                        
                        <div id="card-preview-content" style="display: none; width: 100%;">
                            <!-- Card Visual -->
                            <div id="preview-card-visual" style="width: 100%; max-width: 300px; height: 190px; background: linear-gradient(135deg, #6366F1, #8B5CF6); border-radius: 16px; margin: 0 auto 2rem; box-shadow: 0 20px 40px -10px rgba(99, 102, 241, 0.4); padding: 1.5rem; display: flex; flex-direction: column; justify-content: space-between; color: white; position: relative; overflow: hidden;">
                                <div id="preview-issuer" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.1em;">CHASE</div>
                                <div style="font-size: 1.1rem; letter-spacing: 0.15em; font-family: 'Courier New', monospace; opacity: 0.8;">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242</div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                    <div style="font-size: 0.75rem; opacity: 0.9;">YOUR NAME</div>
                                    <div style="display: flex; gap: 2px;">
                                        <div style="width: 20px; height: 20px; background: #EB001B; border-radius: 50%; opacity: 0.9;"></div>
                                        <div style="width: 20px; height: 20px; background: #F79E1B; border-radius: 50%; margin-left: -8px; opacity: 0.9;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <h3 id="preview-card-name" style="font-size: 1.5rem; font-weight: 800; color: #1F2937; margin: 0 0 0.25rem 0; text-align: center;">Sapphire Preferred</h3>
                            <p id="preview-card-issuer-text" style="color: #64748B; margin: 0 0 2rem 0; text-align: center;">Chase</p>
                            
                            <!-- Add to Wallet Button -->
                            <button id="add-card-btn" onclick="addSelectedCard()" style="width: 100%; padding: 1rem; background: #111827; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; margin-bottom: 2rem;">
                                <span class="material-icons" style="font-size: 20px;">add</span>
                                Add to Wallet
                            </button>

                            <!-- Benefits List -->
                            <div style="width: 100%;">
                                <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; margin-bottom: 1rem; text-transform: uppercase;">Benefits & Credits</div>
                                <div id="preview-credits" style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <!-- Populated via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Benefit Usage Modal (Redesigned) -->
<div id="benefit-modal" class="modal" style="display: none; align-items: center; justify-content: center; padding: 1rem;">
    <div class="modal-content" style="width: 400px; max-width: 95vw; padding: 0; border-radius: 24px; overflow: hidden; background: white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        
        <!-- Header (Dark) -->
        <div style="background: #111827; padding: 1.5rem; color: white; position: relative;">
            <button class="modal-close-btn" onclick="closeBenefitModal()" style="position: absolute; top: 1rem; right: 1rem; color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.1);">Ã—</button>
            
            <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; color: white;" id="benefit-modal-title">Dining Credit</h3>
            <div style="display: inline-block; background: rgba(255,255,255,0.15); padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.9);" id="benefit-modal-subtitle">
                Gold Card
            </div>
        </div>

        <div style="padding: 2rem;">
            <!-- Month Navigator -->
            <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 2rem; background: #F9FAFB; padding: 0.75rem; border-radius: 12px;">
                <button onclick="navigatePeriod(-1)" style="background: none; border: none; color: #64748B; cursor: pointer; padding: 0.25rem;"><span class="material-icons" style="font-size: 18px;">chevron_left</span></button>
                <div style="font-weight: 700; color: #1F2937; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="material-icons" style="font-size: 18px; color: #6366F1;">calendar_today</span>
                    <span id="benefit-period-label">Sep</span>
                </div>
                <button onclick="navigatePeriod(1)" style="background: none; border: none; color: #64748B; cursor: pointer; padding: 0.25rem;"><span class="material-icons" style="font-size: 18px;">chevron_right</span></button>
            </div>

            <!-- Circular Progress -->
            <div style="margin-bottom: 2.5rem;">
                <div class="circular-progress" id="benefit-circular-progress">
                    <div class="circular-progress-content">
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.1em; margin-bottom: 0.25rem;">USAGE</div>
                        <div style="font-size: 2.5rem; font-weight: 800; color: #1F2937; line-height: 1; margin-bottom: 0.25rem;" id="benefit-current-used-display">$10</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #64748B;">of <span id="benefit-total-value-display">$10</span></div>
                    </div>
                </div>
            </div>

            <!-- Add Usage Input -->
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; border-top: 1px solid #F3F4F6; padding-top: 2rem; position: relative;">
                <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 1rem; color: #94A3B8; font-size: 0.75rem; font-weight: 600;">Add Usage</div>
                
                <div style="flex: 1; position: relative;">
                    <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94A3B8; font-weight: 600;">$</span>
                    <input type="number" id="benefit-amount-input" min="0" step="0.01" 
                           style="width: 100%; padding: 0.875rem 1rem 0.875rem 2rem; border: 1px solid #E5E7EB; border-radius: 12px; font-size: 1rem; font-weight: 600; color: #1F2937; margin-bottom: 0;"
                           placeholder="Remaining: $0">
                </div>
                <button id="btn-log-usage" onclick="saveBenefitUsage()" style="background: #111827; color: white; border: none; padding: 0.875rem 1.5rem; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s; min-width: 80px;">
                    Log
                </button>
            </div>

            <!-- Mark as Full -->
            <button id="mark-full-btn" onclick="markAsFull()" style="width: 100%; background: white; color: #1F2937; border: 1px solid #E5E7EB; padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                <span class="material-icons" style="font-size: 20px; margin-right: 0.5rem; color: #10B981; opacity: 0;">check</span>
                Mark <span id="benefit-period-label-btn" style="margin: 0 0.25rem;">Sep</span> as Full
            </button>
        </div>
    </div>
</div>

<!-- Anniversary Date Modal -->
<div id="anniversary-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0;">Set Card Anniversary</h3>
                <p style="color: #64748B; margin: 0; font-size: 0.875rem;">When did you get this card?</p>
            </div>
            <button class="modal-close" onclick="closeAnniversaryModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94A3B8;">Ã—</button>
        </div>

        <!-- Card Info -->
        <div style="background: #F9FAFB; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
            <div style="font-size: 0.75rem; font-weight: 700; color: #64748B; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.5rem;">CARD</div>
            <div id="anniversary-card-name" style="font-weight: 700; font-size: 1.125rem; color: #1F2937;">Loading...</div>
        </div>

        <!-- Date Input -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1F2937;">Anniversary Date</label>
            <input type="date" id="anniversary-date-input" 
                   style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; font-weight: 600;">
            <p style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">This helps track which months/quarters are available for benefit tracking.</p>
        </div>

        <!-- Example -->
        <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="font-weight: 600; color: #92400E; margin-bottom: 0.25rem; font-size: 0.875rem;">ðŸ’¡ Example</div>
            <div style="color: #78350F; font-size: 0.875rem;">If you got your card in October 2025, months before October will be grayed out.</div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 0.75rem;">
            <button onclick="closeAnniversaryModal()" style="flex: 1; background: #F3F4F6; color: #64748B; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Cancel
            </button>
            <button onclick="saveAnniversaryDate()" style="flex: 1; background: #7C3AED; color: white; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Save Anniversary
            </button>
        </div>
    </div>
</div>

<style>
    .wallet-tab:hover {
        color: #1F2937;
    }
    
    .wallet-tab.active {
        color: #6366F1;
        border-bottom-color: #6366F1 !important;
    }
    
    .quick-add-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #E2E8F0;
        background: white;
        border-radius: 99px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #64748B;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .quick-add-btn:hover {
        border-color: #8B5CF6;
        color: #8B5CF6;
        background: #F5F3FF;
    }
    
    .card-result-item {
        padding: 1rem;
        border: 1px solid transparent;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.5rem;
    }
    
    .card-result-item:hover {
        background: #F8FAFC;
        border-color: #E2E8F0;
    }
    
    .card-result-item.selected {
        background: #EEF2FF;
        border-color: #6366F1;
    }
    
    .modal-close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #94A3B8;
        padding: 0;
        line-height: 1;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    /* Period Pills */
    .monthly-pills-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 0.5rem;
        width: 100%;
    }

    .period-pill {
        width: 100%;
        height: 44px;
        border-radius: 12px;
        background: #F8FAFC;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        min-width: 0; /* Allow shrinking in grid */
        padding: 0.25rem;
        position: relative;
    }
    
    .period-pill:hover {
        background: #F1F5F9;
        transform: translateY(-1px);
    }
    
    .period-pill.current {
        border-color: #3B82F6;
        background: #EFF6FF;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    
    .period-pill.full {
        background: #DCFCE7;
        color: #16A34A;
    }
    
    .period-pill.partial {
        background: #DBEAFE;
        color: #2563EB;
    }
    
    .period-pill.unavailable {
        opacity: 0.4;
        background: #F1F5F9;
        color: #94A3B8;
        cursor: not-allowed;
    }
    
    .period-pill.large {
        height: 60px;
        flex-direction: column;
        gap: 0.1rem;
        padding: 0.5rem;
        justify-content: center;
    }
    
    .pill-label {
        font-size: 0.7rem;
        font-weight: 700;
        color: inherit;
        line-height: 1;
    }
    
    .pill-status {
        height: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }
    
    .pill-status .material-icons {
        line-height: 1;
    }

    .benefit-card {
        background: white; 
        border-radius: 24px; 
        padding: 1.5rem; 
        border: 1px solid #F3F4F6; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
        transition: all 0.2s;
    }
    
    .benefit-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1) !important;
    }

    /* --- Circular Progress Bar --- */
    .circular-progress {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        background: conic-gradient(#10B981 var(--progress, 0%), #F3F4F6 0deg);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        margin: 0 auto;
        transition: background 0.3s ease;
    }
    
    .circular-progress::before {
        content: "";
        position: absolute;
        width: 156px;
        height: 156px;
        border-radius: 50%;
        background: white;
    }
    
    .circular-progress-content {
        position: relative;
        z-index: 1;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* --- Modal Sidebar --- */
    .modal-sidebar {
        width: 260px;
        background: #F8FAFC;
        border-right: 1px solid #E2E8F0;
        padding: 1.5rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex-shrink: 0;
    }
    
    .modal-sidebar-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: 12px;
        color: #64748B;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    
    .modal-sidebar-item:hover {
        background: #F1F5F9;
        color: #1F2937;
    }
    
    .modal-sidebar-item.active {
        background: white;
        color: #1F2937;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        border-color: #E2E8F0;
    }

    /* Loader */
    .loader {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 1200px) {
        .monthly-pills-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }

    @media (max-width: 768px) {
        div[style*="grid-template-columns: 1.5fr 1fr 1fr"] {
            grid-template-columns: 1fr !important;
        }
        
        div[style*="grid-template-columns: repeat(auto-fill, minmax(520px, 1fr))"] {
            grid-template-columns: 1fr !important;
        }
        
        .modal-content {
            flex-direction: column;
            height: 90vh !important;
            width: 95vw !important;
        }
        
        .modal-sidebar {
            width: 100%;
            flex-direction: row;
            overflow-x: auto;
            border-right: none;
            border-bottom: 1px solid #E2E8F0;
            padding: 1rem;
        }
        
        .modal-sidebar-item {
            white-space: nowrap;
        }

        #content-add > div {
            flex-direction: column;
        }
        
        #content-add > div > div:first-child {
            border-right: none;
            border-bottom: 1px solid #E2E8F0;
        }

        div[style*="width: 360px"] {
            width: 100% !important;
        }
        
        .monthly-pills-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }
</style>

<script>
    // --- Manage Wallet Modal Logic ---
    const availableCards = {{ available_cards_json|safe }};
    let selectedAddCard = null;

    function openManageWalletModal(view = 'stack') {
        document.getElementById('manage-wallet-modal').style.display = 'flex';
        switchTab(view);
    }

    function closeManageWalletModal() {
        document.getElementById('manage-wallet-modal').style.display = 'none';
        // Reset preview
        document.getElementById('card-preview-empty').style.display = 'block';
        document.getElementById('card-preview-content').style.display = 'none';
        selectedAddCard = null;
    }

    function switchTab(view) {
        // Update Sidebar/Tabs
        document.querySelectorAll('.modal-sidebar-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + view).classList.add('active');
        
        // Update Content
        document.getElementById('content-stack').style.display = 'none';
        document.getElementById('content-add').style.display = 'none';
        
        if (view === 'stack') {
            document.getElementById('content-stack').style.display = 'flex';
        } else {
            document.getElementById('content-add').style.display = 'block';
            renderCardResults(availableCards);
        }
    }

    function renderCardResults(cards) {
        const container = document.getElementById('card-results-list');
        container.innerHTML = '';
        
        if (cards.length === 0) {
            container.innerHTML = '<div style="padding: 1rem; color: #94A3B8; text-align: center;">No cards found</div>';
            return;
        }
        
        cards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'card-result-item';
            div.onclick = () => selectCardForPreview(card, div);
            
            div.innerHTML = `
                <div style="font-weight: 700; color: #1F2937; margin-bottom: 0.25rem;">${card.name}</div>
                <div style="font-size: 0.85rem; color: #64748B;">${card.issuer}</div>
            `;
            container.appendChild(div);
        });
    }

    function selectCardForPreview(card, element) {
        // Highlight selection
        document.querySelectorAll('.card-result-item').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        
        selectedAddCard = card;
        
        // Update Preview
        document.getElementById('card-preview-empty').style.display = 'none';
        document.getElementById('card-preview-content').style.display = 'block';
        
        // Visual
        const visual = document.getElementById('preview-card-visual');
        if (card.name.toLowerCase().includes('chase')) {
            visual.style.background = 'linear-gradient(135deg, #117ACA 0%, #005EB8 100%)';
        } else if (card.name.toLowerCase().includes('amex') || card.name.toLowerCase().includes('american express')) {
            visual.style.background = 'linear-gradient(135deg, #2563EB 0%, #1E40AF 100%)';
        } else if (card.name.toLowerCase().includes('capital')) {
            visual.style.background = 'linear-gradient(135deg, #0F172A 0%, #1E293B 100%)';
        } else {
            visual.style.background = 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)';
        }
        
        document.getElementById('preview-issuer').innerText = card.issuer.toUpperCase();
        document.getElementById('preview-card-name').innerText = card.name;
        document.getElementById('preview-card-issuer-text').innerText = card.issuer;
        
        // Render Benefits
        const earningContainer = document.getElementById('preview-earning-rates');
        earningContainer.innerHTML = '';
        if (card.earning_rates) {
            card.earning_rates.forEach(rate => {
                earningContainer.innerHTML += `
                    <div style="background: white; padding: 0.75rem; border-radius: 12px; border: 1px solid #E2E8F0;">
                        <div style="font-size: 1.25rem; font-weight: 800; color: #1F2937;">${rate.multiplier}x</div>
                        <div style="font-size: 0.75rem; color: #64748B; font-weight: 600;">${rate.category}</div>
                    </div>
                `;
            });
        }
        
        const creditsContainer = document.getElementById('preview-credits');
        creditsContainer.innerHTML = '';
        if (card.credits) {
            card.credits.forEach(credit => {
                creditsContainer.innerHTML += `
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 12px; border: 1px solid #E2E8F0;">
                        <div style="width: 32px; height: 32px; background: #DCFCE7; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #16A34A; font-weight: 700; font-size: 0.75rem;">$${credit.amount}</div>
                        <div>
                            <div style="font-weight: 700; color: #1F2937; font-size: 0.9rem;">${credit.name}</div>
                            <div style="font-size: 0.75rem; color: #64748B;">${credit.frequency}</div>
                        </div>
                    </div>
                `;
            });
        }
    }

    function filterCards(issuer) {
        let searchIssuer = issuer;
        if (issuer === 'Amex') {
            searchIssuer = 'American Express';
        }
        const filtered = availableCards.filter(c => c.issuer.includes(searchIssuer));
        renderCardResults(filtered);
    }

    document.getElementById('card-search-input')?.addEventListener('input', (e) => {
        let term = e.target.value.toLowerCase();
        
        // Alias mapping
        if (term === 'amex') {
            term = 'american express';
        }
        
        const filtered = availableCards.filter(c => 
            c.name.toLowerCase().includes(term) || c.issuer.toLowerCase().includes(term) ||
            (term === 'amex' && c.issuer.toLowerCase().includes('american express'))
        );
        renderCardResults(filtered);
    });

    function addSelectedCard() {
        if (!selectedAddCard) return;
        
        // Open anniversary modal in "add" mode
        // We pass null as cardId to indicate we are adding a new card
        // But we store the selectedAddCard.id in a separate variable or reuse currentAnniversaryCardId with a flag
        
        currentAnniversaryCardId = 'ADD_NEW_CARD'; // Special flag
        document.getElementById('anniversary-card-name').textContent = selectedAddCard.name;
        
        // Default to current month
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
        const defaultDate = `${currentYear}-${currentMonth}-01`;
        
        document.getElementById('anniversary-date-input').value = defaultDate;
        document.getElementById('anniversary-modal').style.display = 'flex';
    }
    
    // --- Anniversary Modal Logic ---
    let currentAnniversaryCardId = null;

    function openAnniversaryModal(cardId, cardName, currentDate) {
        currentAnniversaryCardId = cardId;
        document.getElementById('anniversary-card-name').textContent = cardName;
        document.getElementById('anniversary-date-input').value = currentDate || '';
        document.getElementById('anniversary-modal').style.display = 'flex';
    }

    function closeAnniversaryModal() {
        document.getElementById('anniversary-modal').style.display = 'none';
        currentAnniversaryCardId = null;
    }

    function saveAnniversaryDate() {
        if (!currentAnniversaryCardId) return;
        
        const date = document.getElementById('anniversary-date-input').value;
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        // Check if we are adding a new card
        if (currentAnniversaryCardId === 'ADD_NEW_CARD') {
            if (!selectedAddCard) return;
            
            // Submit form to add card with anniversary date
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/dashboard/add-card/${selectedAddCard.id}/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Add anniversary date
            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'anniversary_date';
            dateInput.value = date;
            form.appendChild(dateInput);
            
            document.body.appendChild(form);
            form.submit();
            
            closeAnniversaryModal();
            return;
        }
        
        // Otherwise, we are updating an existing card
        const formData = new FormData();
        formData.append('anniversary_date', date);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/dashboard/update-anniversary/${currentAnniversaryCardId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error saving date: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Error saving date');
        });
    }

    // --- Benefit Modal Logic (Existing) ---
    // --- Benefit Modal Logic (Updated) ---
    // --- Benefit Modal Logic (Updated) ---
    let currentBenefitData = {};
    let currentBenefitPeriods = [];
    let currentPeriodIndex = 0;

    function openBenefitModal(cardId, benefitId, benefitName, amount, used, frequency, periodKey) {
        // Parse periods from json_script
        const script = document.getElementById(benefitId);
        if (script) {
            currentBenefitPeriods = JSON.parse(script.textContent);
        } else {
            // Fallback
            currentBenefitPeriods = [{key: periodKey, label: 'Current', max_value: amount, status: 'unknown'}];
        }

        // Find index
        currentPeriodIndex = currentBenefitPeriods.findIndex(p => p.key === periodKey);
        if (currentPeriodIndex === -1) currentPeriodIndex = 0;

        currentBenefitData = {
            cardId,
            benefitId,
            benefitName,
            amount, // Base amount
            frequency
        };

        updateBenefitModalUI();
        document.getElementById('benefit-modal').style.display = 'flex';
    }

    function updateBenefitModalUI() {
        const period = currentBenefitPeriods[currentPeriodIndex];
        const maxVal = period.max_value || currentBenefitData.amount;
        
        // Fetch usage for this period? 
        // We don't have it readily available in the array except implicitly via status.
        // Ideally, the periods array should contain 'used' value.
        // Let's check if the periods object has 'used'. The template loop didn't seem to have it explicitly passed.
        // However, we can infer or default to 0 if not full.
        // Wait, the 'used' passed to openBenefitModal was total used for the benefit? 
        // Or was it period used? In the template: {{ benefit.used }} is passed.
        // For monthly benefits, benefit.used might be total annual used or current period used?
        // Usually benefit.used is the current period usage for monthly benefits in this app context.
        // But if we navigate to other months, we don't have their usage data client-side unless it was in the periods array.
        // Let's assume for now we only show usage for the *current* period correctly if passed, 
        // and for others we might show 0 or max if full.
        // Actually, let's look at the periods array structure in the template:
        // periods = [{'key': '...', 'label': '...', 'status': '...', 'max_value': ...}]
        // It doesn't seem to have 'used_amount'.
        // This is a limitation. We might need to fetch it or just rely on status.
        // For this UI fix, let's rely on status: full = maxVal, else 0 (or keep passed 'used' if it matches current period).
        
        let usedVal = 0;
        if (period.status === 'full') {
            usedVal = maxVal;
        } else if (period.key === currentBenefitPeriods.find(p => p.is_current)?.key) {
             // If this is the current period, maybe we can use the 'used' passed initially?
             // But we didn't store the initial 'used' in a way that maps to the period key.
             // Let's just default to 0 for non-full periods for now to avoid errors, 
             // or better, if we are on the period that was clicked, we use the passed 'used'.
             // But we don't know which one was clicked after navigation.
             // Let's just use 0 for now if not full.
             usedVal = 0; 
        }
        
        // Update Header
        document.getElementById('benefit-modal-title').textContent = currentBenefitData.benefitName;
        document.getElementById('benefit-modal-subtitle').textContent = `${period.label} Usage`;
        
        // Update Period Label in Navigator
        document.getElementById('benefit-period-label').textContent = period.label;
        
        // Update Values
        document.getElementById('benefit-current-used-display').textContent = `$${usedVal}`;
        document.getElementById('benefit-total-value-display').textContent = `$${maxVal}`;
        
        updateProgress(usedVal, maxVal);
        
        // Update Input
        document.getElementById('benefit-amount-input').value = '';
        document.getElementById('benefit-amount-input').placeholder = `Remaining: $${maxVal - usedVal}`;
        
        // Update Mark as Full Button
        const markBtn = document.getElementById('mark-full-btn');
        if (markBtn) {
            markBtn.innerHTML = `Mark <span style="margin: 0 0.25rem;">${period.label}</span> as Full`;
            if (period.status === 'full') {
                markBtn.innerHTML = `<span class="material-icons" style="font-size: 18px; margin-right: 0.5rem;">check</span> ${period.label} is Full`;
                markBtn.disabled = true;
                markBtn.style.opacity = '0.7';
            } else {
                markBtn.disabled = false;
                markBtn.style.opacity = '1';
            }
        }
    }

    function navigatePeriod(direction) {
        const newIndex = currentPeriodIndex + direction;
        if (newIndex >= 0 && newIndex < currentBenefitPeriods.length) {
            currentPeriodIndex = newIndex;
            updateBenefitModalUI();
        }
    }

    function closeBenefitModal() {
        document.getElementById('benefit-modal').style.display = 'none';
        currentBenefitData = {};
        currentBenefitPeriods = [];
    }

    function updateProgress(used, total) {
        const percentage = Math.min(100, Math.max(0, (used / total) * 100));
        document.getElementById('benefit-circular-progress').style.setProperty('--progress', percentage + '%');
        // document.getElementById('benefit-progress-text').textContent = `${Math.round(percentage)}%`; // Not used in circular design
    }

    document.getElementById('benefit-amount-input').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value) || 0;
        // Visual update only, doesn't change stored data until save
        // We need to know the base usage to add to? Or is this absolute amount?
        // Usually "Add Usage" implies adding. But the input says "Remaining".
        // Let's assume input is "Amount to Add".
        // The progress bar should reflect Current + Added?
        // For simplicity, let's just show the input value as the "new" part of the progress?
        // Or just leave progress bar as is until saved.
    });

    function markAsFull() {
        const period = currentBenefitPeriods[currentPeriodIndex];
        const maxVal = period.max_value || currentBenefitData.amount;
        
        const btn = document.getElementById('mark-full-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="loader"></span> Marking...';
        btn.disabled = true;
        
        const formData = new FormData();
        formData.append('amount', maxVal);
        formData.append('period_key', period.key);
        formData.append('is_full', 'true');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/dashboard/update-benefit/${currentBenefitData.cardId}/${currentBenefitData.benefitId}/`, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    }

    function saveBenefitUsage() {
        const amount = parseFloat(document.getElementById('benefit-amount-input').value);
        if (isNaN(amount) || amount <= 0) return;
        
        const period = currentBenefitPeriods[currentPeriodIndex];
        const btn = document.getElementById('btn-log-usage');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="loader"></span>';
        btn.disabled = true;
        
        const formData = new FormData();
        formData.append('amount', amount);
        formData.append('period_key', period.key);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/dashboard/update-benefit/${currentBenefitData.cardId}/${currentBenefitData.benefitId}/`, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    }
    
    // Close modal on outside click
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }
</script>
{% endblock %}