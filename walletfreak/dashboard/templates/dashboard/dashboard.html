{% extends 'auth_base.html' %}
{% load static %}

{% block content %}
<!-- Hidden CSRF token for JavaScript -->
<form style="display: none;">
    {% csrf_token %}
</form>

<!-- Dashboard Header -->
<div style="margin-bottom: 2.5rem;">
    <!-- Greeting Section -->
    <div style="display: flex; align-items: center; gap: 1.5rem;">
        <div
            style="width: 60px; height: 60px; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);">
            <span class="material-icons" style="font-size: 32px;">flight</span>
        </div>
        <div>
            <h1 style="font-size: 2rem; font-weight: 800; margin: 0; line-height: 1.2;">
                Hey, <span style="color: #7C3AED;">{% if user.first_name %}{{ user.first_name }}{% else %}Alex{% endif %}!</span>
            </h1>
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                {% if assigned_personality %}
                <a href="{% url 'personality_results' %}" style="text-decoration: none;">
                    <span
                        style="background: #E0F2FE; color: #0284C7; font-size: 0.7rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 4px; letter-spacing: 0.05em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='#BAE6FD'"
                        onmouseout="this.style.background='#E0F2FE'">
                        <span class="material-icons" style="font-size: 10px; vertical-align: middle;">psychology</span>
                        {{ assigned_personality.name }}
                    </span>
                </a>
                {% if assigned_personality.match_score %}
                <span style="color: #64748B; font-size: 0.9rem;">{{ assigned_personality.match_score }} card{{ assigned_personality.match_score|pluralize }} match</span>
                {% endif %}
                {% else %}
                <span style="color: #64748B; font-size: 0.9rem;">
                    {% if active_cards|length >= 3 %}
                    <a href="{% url 'personality_survey' %}" style="color: #0284C7; text-decoration: none; font-weight: 500;">Take survey</a> to discover your personality
                    {% elif active_cards|length == 2 %}
                    Add 1 more card to discover your personality
                    {% elif active_cards|length == 1 %}
                    Add 2 more cards to discover your personality
                    {% else %}
                    Add 3 cards to discover your personality
                    {% endif %}
                </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Search Bar (Right Aligned) -->
        <div style="margin-left: auto; width: 300px;">
            <div style="position: relative;">
                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9CA3AF;"><span class="material-icons" style="font-size: 18px;">search</span></span>
                <input type="text" placeholder="Search benefits..." style="width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid #E5E7EB; border-radius: 99px; font-size: 0.9rem; background: white;">
            </div>
        </div>
    </div>
</div>

<!-- Top Grid: Annual Value + My Wallet + Add New Card -->
<div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2.5rem;">
    <!-- Annual Value Card (Purple) -->
    <div
        style="background: linear-gradient(135deg, #6366F1 0%, #7C3AED 100%); border-radius: 24px; padding: 2rem; color: white; box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 240px;">
        
        <!-- Top Row -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 1;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                <span class="material-icons" style="font-size: 24px;">trending_up</span>
            </div>
            <div style="font-size: 0.875rem; font-weight: 500; opacity: 0.9;">Annual Value</div>
        </div>

        <!-- Bottom Row -->
        <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem; opacity: 0.9;">Total Value Extracted</div>
            <div style="font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; letter-spacing: -0.02em;">
                ${{ total_used_value|floatformat:0 }}<span style="font-size: 1.75rem; font-weight: 500; opacity: 0.7;">.00</span>
            </div>
            <div style="font-size: 0.875rem; opacity: 0.8;">
                Out of ${{ total_potential_value|floatformat:0 }} available credits
            </div>
        </div>
    </div>

    <!-- My Wallet Card -->
    <div
        style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; justify-content: space-between;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 0.75rem; font-weight: 700; color: #64748B; letter-spacing: 0.05em; margin-bottom: 0.5rem; text-transform: uppercase;">My Wallet</div>
                <div style="display: flex; align-items: baseline; gap: 0.5rem;">
                    <div style="font-size: 3rem; font-weight: 800; color: #1F2937; line-height: 1;">{{ active_cards|length }}</div>
                    <div style="font-size: 0.9rem; color: #64748B;">Cards</div>
                </div>
            </div>
            <div style="width: 40px; height: 40px; background: #FDF4FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #D946EF;">
                <span class="material-icons" style="font-size: 20px;">credit_card</span>
            </div>
        </div>
        
        <!-- Mini card previews -->
        <div style="display: flex; gap: 0.5rem; margin: 1rem 0;">
            <div style="width: 40px; height: 26px; background: #CBD5E1; border-radius: 4px;"></div>
            <div style="width: 40px; height: 26px; background: #3B82F6; border-radius: 4px;"></div>
            <div style="width: 40px; height: 26px; background: #F59E0B; border-radius: 4px;"></div>
        </div>

        <button onclick="openManageWalletModal('stack')" style="width: 100%; padding: 0.75rem; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; font-weight: 600; color: #1F2937; cursor: pointer; transition: all 0.2s;">
            Manage Wallet
        </button>
    </div>

    <!-- Add New Card Trigger -->
    <div
        style="background: white; border-radius: 24px; padding: 1.5rem; border: 2px dashed #E5E7EB; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: all 0.2s;"
        onclick="openManageWalletModal('add')"
        onmouseover="this.style.borderColor='#7C3AED'; this.style.background='#F5F3FF'"
        onmouseout="this.style.borderColor='#E5E7EB'; this.style.background='white'">
        
        <div style="width: 64px; height: 64px; background: #EEF2FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #6366F1; margin-bottom: 1rem;">
            +
        </div>
        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">Add New Card</h3>
        <p style="color: #64748B; font-size: 0.875rem; margin: 0;">Track a new bonus or fee</p>
    </div>
</div>


<!-- Active Benefits Section -->
<div
    style="background: white; border-radius: 24px; padding: 2rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
        <div>
            <h2 style="font-size: 1.5rem; font-weight: 800; margin: 0 0 0.5rem 0; color: #1F2937;">Active Benefits</h2>
            <p style="color: #64748B; font-size: 0.9rem; margin: 0;">Click a benefit to update your usage.</p>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <button
                style="background: #F1F5F9; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; color: #475569; cursor: pointer;">Reset: All</button>
            <button
                style="background: #F1F5F9; border: none; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #475569;">
                ▼
            </button>
        </div>
    </div>

    {% if not all_benefits %}
    <!-- Empty State -->
    <div style="text-align: center; padding: 3rem 1rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">credit_card</span></div>
        <div style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem; color: #1F2937;">No active benefits yet</div>
        <div style="color: #64748B; margin-bottom: 1.5rem;">Add cards to your wallet to start tracking benefits</div>
        <button class="btn btn-primary" onclick="openManageWalletModal('add')">Add Card</button>
    </div>
    {% else %}

    <!-- Benefits List -->
    <div style="display: flex; flex-direction: column; gap: 2rem;">
        {% for benefit in all_benefits|slice:":10" %}
        <div style="display: grid; grid-template-columns: 60px 1fr 120px; gap: 1.5rem; align-items: center; cursor: pointer;"
             onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}')">
            
            <!-- Percentage Circle -->
            {% if benefit.is_used %}
            <div style="width: 56px; height: 56px; border-radius: 50%; background: #DCFCE7; border: 2px solid #DCFCE7; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: #16A34A;">
                <span class="material-icons" style="font-size: 24px;">check</span>
            </div>
            {% else %}
            <div style="width: 56px; height: 56px; border-radius: 50%; border: 2px solid {% if benefit.used > 0 %}#6366F1{% else %}#E2E8F0{% endif %}; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: {% if benefit.used > 0 %}#6366F1{% else %}#64748B{% endif %};">
                {% if benefit.amount > 0 %}{% widthratio benefit.used benefit.amount 100 %}{% else %}0{% endif %}%
            </div>
            {% endif %}

            <!-- Benefit Info & Progress Bar -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.25rem;">
                    <div style="font-weight: 700; font-size: 1.1rem; color: #1F2937;">{{ benefit.benefit_name }}</div>
                </div>
                <div style="font-size: 0.75rem; color: #94A3B8; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.75rem;">
                    {{ benefit.card_name }} • {{ benefit.frequency }}
                </div>
                
                <!-- Progress Bar -->
                <div style="height: 8px; background: #F1F5F9; border-radius: 4px; overflow: hidden; width: 100%;">
                    {% if benefit.is_used %}
                    <div style="width: 100%; height: 100%; background: #22C55E; border-radius: 4px;"></div>
                    {% else %}
                    <div style="width: {% if benefit.amount > 0 %}{% widthratio benefit.used benefit.amount 100 %}{% else %}0{% endif %}%; height: 100%; background: #6366F1; border-radius: 4px;"></div>
                    {% endif %}
                </div>
            </div>

            <!-- Value Display -->
            <div style="text-align: right;">
                <div style="font-weight: 800; font-size: 1.25rem; color: #1F2937;">
                    ${{ benefit.used|floatformat:0 }}
                </div>
                <div style="font-size: 0.85rem; color: #94A3B8;">
                    / ${{ benefit.amount|floatformat:0 }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- View All History Button -->
    <div style="margin-top: 2.5rem;">
        <button onclick="window.location.href='{% url 'wallet' %}'" style="width: 100%; padding: 1rem; background: white; border: 1px solid #E2E8F0; border-radius: 12px; font-weight: 600; color: #64748B; cursor: pointer; transition: all 0.2s;">
            View All Benefits History
        </button>
    </div>
</div>

<!-- Manage Wallet Modal (Redesigned to match image) -->
<div id="manage-wallet-modal" class="modal" style="display: none; align-items: center; justify-content: center; padding: 2rem;">
    <div class="modal-content" style="width: 900px; max-width: 95vw; max-height: 90vh; padding: 0; display: flex; flex-direction: column; overflow: hidden; border-radius: 16px; background: white;">
        
        <!-- Tab Navigation -->
        <div style="display: flex; border-bottom: 2px solid #F3F4F6; padding: 0 2rem;">
            <button class="wallet-tab active" onclick="switchTab('stack')" id="tab-stack" style="padding: 1.25rem 2rem; border: none; background: none; font-weight: 700; font-size: 1rem; color: #64748B; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s;">
                Manage Wallet
            </button>
            <button class="wallet-tab" onclick="switchTab('add')" id="tab-add" style="padding: 1.25rem 2rem; border: none; background: none; font-weight: 700; font-size: 1rem; color: #64748B; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s;">
                Find a Card
            </button>
            <button class="modal-close-btn" onclick="closeManageWalletModal()" style="margin-left: auto; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94A3B8; padding: 1rem;">×</button>
        </div>
        
        <!-- Tab Content Area -->
        <div style="flex: 1; display: flex; overflow: hidden;">
            
            <!-- Tab 1: Manage Wallet (My Stack) -->
            <div id="content-stack" style="flex: 1; padding: 2rem; display: flex; flex-direction: column; overflow-y: auto;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <span class="material-icons" style="font-size: 20px; color: #6366F1;">credit_card</span>
                    <h3 style="font-size: 1rem; font-weight: 700; margin: 0; color: #1F2937;">My Stack</h3>
                    <span style="background: #F3F4F6; color: #64748B; font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 99px; margin-left: 0.5rem;">{{ active_cards|length }}</span>
                </div>
                
                <div style="flex: 1; overflow-y: auto;">
                    {% if active_cards %}
                        {% for card in active_cards %}
                        <div style="display: flex; align-items: center; padding: 1rem; border: 1px solid #E2E8F0; border-radius: 12px; margin-bottom: 1rem; background: white;">
                            <div style="width: 60px; height: 40px; background: {% if 'chase' in card.name|lower %}#117ACA{% elif 'amex' in card.name|lower or 'american express' in card.name|lower %}#2563EB{% elif 'capital' in card.name|lower %}#0F172A{% else %}#CBD5E1{% endif %}; border-radius: 6px; margin-right: 1rem;"></div>
                            
                            <div>
                                <div style="font-weight: 700; color: #1F2937;">{{ card.name }}</div>
                                <div style="font-size: 0.85rem; color: #64748B;">{{ card.issuer }}</div>
                            </div>
                            
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem;">
                                <form method="POST" action="{% url 'remove_card' card.id %}" style="margin: 0;" onsubmit="return confirm('Remove this card from your wallet?');">
                                    {% csrf_token %}
                                    <button type="submit" style="background: none; border: none; cursor: pointer; color: #94A3B8; padding: 0.5rem;">
                                        <span class="material-icons" style="font-size: 20px;">delete</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">credit_card</span></div>
                            <p>No cards in your wallet yet.</p>
                            <button onclick="switchTab('add')" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #6366F1; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                + Add New Card
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Tab 2: Find a Card -->
            <div id="content-add" style="flex: 1; display: none; overflow: hidden;">
                <div style="display: flex; height: 100%;">
                    <!-- Left Column: Search & List -->
                    <div style="flex: 1; padding: 2rem; border-right: 1px solid #E2E8F0; display: flex; flex-direction: column; overflow: hidden;">
                        <p style="color: #64748B; font-size: 0.9rem; margin-bottom: 1.5rem;">Search by name or issuer to add it to your wallet.</p>
                        
                        <div style="position: relative; margin-bottom: 1.5rem;">
                            <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9CA3AF;"><span class="material-icons" style="font-size: 18px;">search</span></span>
                            <input type="text" id="card-search-input" placeholder="Search e.g. 'Sapphire' or 'Amex'" 
                                   style="width: 100%; padding: 0.875rem 1rem 0.875rem 2.5rem; border: 1px solid #E2E8F0; border-radius: 12px; font-size: 0.95rem;">
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; margin-bottom: 0.75rem;">QUICK ADD</div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="quick-add-btn" onclick="filterCards('Chase')">Chase</button>
                                <button class="quick-add-btn" onclick="filterCards('Amex')">Amex</button>
                                <button class="quick-add-btn" onclick="filterCards('Capital One')">Capital One</button>
                                <button class="quick-add-btn" onclick="filterCards('Citi')">Citi</button>
                            </div>
                        </div>
                        
                        <div id="card-results-list" style="overflow-y: auto; flex: 1;">
                            <!-- Results populated via JS -->
                        </div>
                    </div>
                    
                    <!-- Right Column: Card Preview -->
                    <div style="width: 360px; padding: 2rem; background: white; display: flex; flex-direction: column; align-items: center; overflow-y: auto;">
                        <div id="card-preview-empty" style="color: #94A3B8; text-align: center; margin-top: 4rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">credit_card</span></div>
                            <p>Select a card to preview</p>
                        </div>
                        
                        <div id="card-preview-content" style="display: none; width: 100%;">
                            <!-- Card Visual -->
                            <div id="preview-card-visual" style="width: 100%; max-width: 280px; height: 176px; background: linear-gradient(135deg, #6366F1, #8B5CF6); border-radius: 16px; margin: 0 auto 1.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.15); padding: 1.25rem; display: flex; flex-direction: column; justify-content: space-between; color: white; position: relative; overflow: hidden;">
                                <div id="preview-issuer" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.1em;">CHASE</div>
                                <div style="font-size: 1rem; letter-spacing: 0.15em; font-family: 'Courier New', monospace;">•••• •••• •••• 4242</div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                    <div style="font-size: 0.75rem;">YOUR NAME</div>
                                    <div style="display: flex; gap: 2px;">
                                        <div style="width: 18px; height: 18px; background: #EB001B; border-radius: 50%; opacity: 0.9;"></div>
                                        <div style="width: 18px; height: 18px; background: #F79E1B; border-radius: 50%; margin-left: -6px; opacity: 0.9;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <h3 id="preview-card-name" style="font-size: 1.5rem; font-weight: 800; color: #1F2937; margin: 0 0 0.25rem 0; text-align: left;">Sapphire Preferred</h3>
                            <p id="preview-card-issuer-text" style="color: #64748B; margin: 0 0 1.5rem 0; text-align: left;">Chase</p>
                            
                            <!-- Earning Rates -->
                            <div style="margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span class="material-icons" style="font-size: 16px; color: #94A3B8;">trending_up</span>
                                    <span style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em;">EARNING RATES</span>
                                </div>
                                <div id="preview-earning-rates" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 200px; overflow-y: auto; padding-right: 0.5rem;">
                                    <!-- Populated via JS -->
                                </div>
                            </div>
                            
                            <!-- Credits -->
                            <div id="preview-credits-section" style="margin-bottom: 2rem; display: none;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span class="material-icons" style="font-size: 16px; color: #94A3B8;">verified_user</span>
                                    <span style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em;">CREDITS</span>
                                </div>
                                <div id="preview-credits" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 150px; overflow-y: auto; padding-right: 0.5rem;">
                                    <!-- Populated via JS -->
                                </div>
                            </div>
                            
                            <!-- Add to Wallet Button -->
                            <button id="add-card-btn" onclick="addSelectedCard()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4); display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                                <span class="material-icons" style="font-size: 20px;">add</span>
                                Add to Wallet
                            </button>
                            
                            <!-- APR Disclaimer -->
                            <div style="margin-top: 1rem; text-align: center; font-size: 0.7rem; color: #94A3B8; line-height: 1.4;">
                                Variable APR: 21.24% - 29.24% Var. Terms apply. Rates as of Oct 2024.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Benefit Usage Modal (Reused) -->
<div id="benefit-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0;" id="benefit-modal-title">Update Benefit Usage</h3>
                <p style="color: var(--text-muted); margin: 0; font-size: 0.875rem;" id="benefit-modal-subtitle">Specify how much you've used</p>
            </div>
            <button class="modal-close" onclick="closeBenefitModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">×</button>
        </div>

        <!-- Benefit Details -->
        <div style="background: #F9FAFB; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span style="color: #64748B; font-size: 0.875rem;">Total Benefit Value</span>
                <span style="font-weight: 700; font-size: 1.125rem; color: #1F2937;" id="benefit-total-value">$0</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #64748B; font-size: 0.875rem;">Currently Used</span>
                <span style="font-weight: 700; font-size: 1.125rem; color: #7C3AED;" id="benefit-current-used">$0</span>
            </div>
        </div>

        <!-- Amount Input -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1F2937;">Amount Used ($)</label>
            <input type="number" id="benefit-amount-input" min="0" step="0.01" 
                   style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; font-weight: 600;"
                   placeholder="0.00">
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
                <button onclick="setQuickAmount(25)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">25%</button>
                <button onclick="setQuickAmount(50)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">50%</button>
                <button onclick="setQuickAmount(75)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">75%</button>
                <button onclick="setQuickAmount(100)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">100%</button>
                <button onclick="clearAmount()" style="background: #FEE2E2; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #DC2626;">Clear</button>
            </div>
        </div>

        <!-- Progress Preview -->
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-size: 0.875rem; color: #64748B;">Progress</span>
                <span style="font-size: 0.875rem; font-weight: 600; color: #1F2937;" id="benefit-progress-text">0%</span>
            </div>
            <div style="height: 8px; background: #F3F4F6; border-radius: 4px; overflow: hidden;">
                <div id="benefit-progress-bar" style="width: 0%; height: 100%; background: #6366F1; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 0.75rem;">
            <button onclick="closeBenefitModal()" style="flex: 1; background: #F3F4F6; color: #64748B; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Cancel
            </button>
            <button onclick="saveBenefitUsage()" style="flex: 1; background: #7C3AED; color: white; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Save Changes
            </button>
        </div>
    </div>
</div>

<style>
    .wallet-tab:hover {
        color: #1F2937;
    }
    
    .wallet-tab.active {
        color: #6366F1;
        border-bottom-color: #6366F1 !important;
    }
    
    .quick-add-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #E2E8F0;
        background: white;
        border-radius: 99px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #64748B;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .quick-add-btn:hover {
        border-color: #8B5CF6;
        color: #8B5CF6;
        background: #F5F3FF;
    }
    
    .card-result-item {
        padding: 1rem;
        border: 1px solid transparent;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.5rem;
    }
    
    .card-result-item:hover {
        background: #F8FAFC;
        border-color: #E2E8F0;
    }
    
    .card-result-item.selected {
        background: #EEF2FF;
        border-color: #6366F1;
    }
    
    .modal-close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #94A3B8;
        padding: 0;
        line-height: 1;
    }
    
    @media (max-width: 768px) {
        div[style*="grid-template-columns: 1.5fr 1fr 1fr"] {
            grid-template-columns: 1fr !important;
        }
        
        .modal-content {
            flex-direction: column;
            height: 90vh !important;
        }
        
        div[style*="width: 240px"] {
            width: 100% !important;
            flex-direction: row;
            padding: 1rem;
            overflow-x: auto;
            border-right: none;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .sidebar-nav {
            display: flex;
            gap: 1rem;
        }
        
        #view-add {
            flex-direction: column;
        }
        
        div[style*="width: 300px"] {
            width: 100% !important;
            border-top: 1px solid #E2E8F0;
            padding: 1rem;
        }
    }
</style>

<script>
    // --- Manage Wallet Modal Logic ---
    const availableCards = {{ available_cards_json|safe }};
    let selectedAddCard = null;

    function openManageWalletModal(view = 'stack') {
        document.getElementById('manage-wallet-modal').style.display = 'flex';
        switchTab(view);
    }

    function closeManageWalletModal() {
        document.getElementById('manage-wallet-modal').style.display = 'none';
        // Reset preview
        document.getElementById('card-preview-empty').style.display = 'block';
        document.getElementById('card-preview-content').style.display = 'none';
        selectedAddCard = null;
    }

    function switchTab(view) {
        // Update Tabs
        document.querySelectorAll('.wallet-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + view).classList.add('active');
        
        // Update Content
        document.getElementById('content-stack').style.display = 'none';
        document.getElementById('content-add').style.display = 'none';
        
        if (view === 'stack') {
            document.getElementById('content-stack').style.display = 'flex';
        } else {
            document.getElementById('content-add').style.display = 'block';
            renderCardResults(availableCards);
        }
    }

    function renderCardResults(cards) {
        const container = document.getElementById('card-results-list');
        container.innerHTML = '';
        
        if (cards.length === 0) {
            container.innerHTML = '<div style="padding: 1rem; color: #94A3B8; text-align: center;">No cards found</div>';
            return;
        }
        
        cards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'card-result-item';
            div.onclick = () => selectCardForPreview(card, div);
            
            div.innerHTML = `
                <div style="font-weight: 700; color: #1F2937; margin-bottom: 0.25rem;">${card.name}</div>
                <div style="font-size: 0.85rem; color: #64748B;">${card.issuer}</div>
            `;
            container.appendChild(div);
        });
    }

    function selectCardForPreview(card, element) {
        // Highlight selection
        document.querySelectorAll('.card-result-item').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        
        selectedAddCard = card;
        
        // Update Preview
        document.getElementById('card-preview-empty').style.display = 'none';
        document.getElementById('card-preview-content').style.display = 'block';
        
        // Update card name and issuer
        document.getElementById('preview-card-name').textContent = card.name;
        document.getElementById('preview-card-issuer-text').textContent = card.issuer;
        document.getElementById('preview-issuer').textContent = card.issuer.toUpperCase();
        
        // Update card visual colors
        const cardVisual = document.getElementById('preview-card-visual');
        const name = (card.name || '').toLowerCase();
        const issuer = (card.issuer || '').toLowerCase();
        
        if (issuer.includes('american express') || issuer.includes('amex') || name.includes('amex')) {
            if (name.includes('platinum')) {
                cardVisual.style.background = 'linear-gradient(135deg, #E2E8F0 0%, #CBD5E1 100%)';
            } else if (name.includes('gold')) {
                cardVisual.style.background = 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)';
            } else {
                cardVisual.style.background = 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)';
            }
        } else if (issuer.includes('chase') || name.includes('chase')) {
            cardVisual.style.background = 'linear-gradient(135deg, #1E40AF 0%, #1E3A8A 100%)';
        } else if (issuer.includes('capital one') || name.includes('capital')) {
            cardVisual.style.background = 'linear-gradient(135deg, #1F2937 0%, #111827 100%)';
        } else if (issuer.includes('citi')) {
            cardVisual.style.background = 'linear-gradient(135deg, #2563EB 0%, #1E40AF 100%)';
        } else {
            cardVisual.style.background = 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)';
        }
        
        // Parse benefits from Firestore structure
        const benefits = card.benefits || [];
        
        // Separate earning rates (multipliers) from credits
        const earningRates = [];
        const creditBenefits = [];
        
        benefits.forEach(benefit => {
            const desc = benefit.description || '';
            const dollarValue = benefit.dollar_value;
            
            // If it has a dollar value > 0, it's a credit
            if (dollarValue && dollarValue > 0) {
                creditBenefits.push({
                    name: desc,
                    amount: dollarValue
                });
            }
            // If description contains multiplier patterns, it's an earning rate
            else if (desc.match(/\d+x/i)) {
                // Extract multiplier and category from description
                const match = desc.match(/(\d+x)\s*(?:total\s*)?(?:points?\s*)?(?:on\s*)?(.+)/i);
                if (match) {
                    earningRates.push({
                        rate: match[1],
                        category: match[2].trim()
                    });
                }
            }
        });
        
        // Update earning rates display
        const earningContainer = document.getElementById('preview-earning-rates');
        earningContainer.innerHTML = '';
        
        if (earningRates.length > 0) {
            earningRates.forEach(rate => {
                const rateDiv = document.createElement('div');
                rateDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;';
                rateDiv.innerHTML = `
                    <div style="font-size: 1rem; font-weight: 800; color: #6366F1;">${rate.rate}</div>
                    <div style="font-size: 0.875rem; color: #64748B; text-align: right;">${rate.category}</div>
                `;
                earningContainer.appendChild(rateDiv);
            });
        } else {
            // Fallback to old structure if available
            const multipliers = card.rewards_structure || [];
            if (multipliers && Array.isArray(multipliers) && multipliers.length > 0) {
                multipliers.forEach(mult => {
                    const rate = mult.rate || mult.multiplier || '1x';
                    const category = mult.category || mult.name || 'Purchases';
                    
                    const rateDiv = document.createElement('div');
                    rateDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;';
                    rateDiv.innerHTML = `
                        <div style="font-size: 1rem; font-weight: 800; color: #6366F1;">${rate}</div>
                        <div style="font-size: 0.875rem; color: #64748B; text-align: right;">${category}</div>
                    `;
                    earningContainer.appendChild(rateDiv);
                });
            } else {
                // Final fallback
                const rateDiv = document.createElement('div');
                rateDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;';
                rateDiv.innerHTML = `
                    <div style="font-size: 1rem; font-weight: 800; color: #6366F1;">1x</div>
                    <div style="font-size: 0.875rem; color: #64748B; text-align: right;">All Purchases</div>
                `;
                earningContainer.appendChild(rateDiv);
            }
        }
        
        // Update credits display
        const creditsContainer = document.getElementById('preview-credits');
        const creditsSection = document.getElementById('preview-credits-section');
        creditsContainer.innerHTML = '';
        
        if (creditBenefits.length > 0) {
            creditsSection.style.display = 'block';
            creditBenefits.forEach(credit => {
                const creditDiv = document.createElement('div');
                creditDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;';
                creditDiv.innerHTML = `
                    <div style="font-size: 0.875rem; color: #64748B; flex: 1;">${credit.name}</div>
                    <div style="font-size: 0.9rem; font-weight: 700; color: #10B981;">$${credit.amount}</div>
                `;
                creditsContainer.appendChild(creditDiv);
            });
        } else {
            // Fallback to old structure if available
            const credits = card.credits || [];
            if (credits && Array.isArray(credits) && credits.length > 0) {
                creditsSection.style.display = 'block';
                credits.forEach(credit => {
                    const name = credit.name || credit.category || 'Credit';
                    const amount = credit.amount || credit.value || '0';
                    
                    const creditDiv = document.createElement('div');
                    creditDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;';
                    creditDiv.innerHTML = `
                        <div style="font-size: 0.875rem; color: #64748B; flex: 1;">${name}</div>
                        <div style="font-size: 0.9rem; font-weight: 700; color: #10B981;">$${amount}</div>
                    `;
                    creditsContainer.appendChild(creditDiv);
                });
            } else {
                creditsSection.style.display = 'none';
            }
        }
    }

    function filterCards(issuer) {
        let searchIssuer = issuer;
        if (issuer === 'Amex') {
            searchIssuer = 'American Express';
        }
        const filtered = availableCards.filter(c => c.issuer.includes(searchIssuer));
        renderCardResults(filtered);
    }

    document.getElementById('card-search-input')?.addEventListener('input', (e) => {
        let term = e.target.value.toLowerCase();
        
        // Alias mapping
        if (term === 'amex') {
            term = 'american express';
        }
        
        const filtered = availableCards.filter(c => 
            c.name.toLowerCase().includes(term) || c.issuer.toLowerCase().includes(term) ||
            (term === 'amex' && c.issuer.toLowerCase().includes('american express'))
        );
        renderCardResults(filtered);
    });

    function addSelectedCard() {
        if (!selectedAddCard) return;
        
        // Submit form to add card
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/dashboard/add-card/${selectedAddCard.id}/`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
</script>

    // --- Benefit Modal Logic (Existing) ---
    let currentBenefitData = {
        cardId: null,
        benefitId: null,
        benefitName: '',
        totalAmount: 0,
        currentUsed: 0,
        frequency: ''
    };

    function openBenefitModal(cardId, benefitId, benefitName, totalAmount, currentUsed, frequency) {
        currentBenefitData = {
            cardId: cardId,
            benefitId: benefitId,
            benefitName: benefitName,
            totalAmount: parseFloat(totalAmount),
            currentUsed: parseFloat(currentUsed),
            frequency: frequency
        };

        document.getElementById('benefit-modal-title').textContent = benefitName;
        document.getElementById('benefit-modal-subtitle').textContent = frequency;
        document.getElementById('benefit-total-value').textContent = '$' + totalAmount;
        document.getElementById('benefit-current-used').textContent = '$' + currentUsed.toFixed(0);
        document.getElementById('benefit-amount-input').value = currentUsed;
        document.getElementById('benefit-amount-input').max = totalAmount;

        updateBenefitProgress(currentUsed);
        document.getElementById('benefit-modal').style.display = 'flex';
    }

    function closeBenefitModal() {
        document.getElementById('benefit-modal').style.display = 'none';
    }

    function updateBenefitProgress(amount) {
        const percentage = (amount / currentBenefitData.totalAmount) * 100;
        const clampedPercentage = Math.min(100, Math.max(0, percentage));
        
        document.getElementById('benefit-progress-bar').style.width = clampedPercentage + '%';
        document.getElementById('benefit-progress-text').textContent = Math.round(clampedPercentage) + '%';
        
        const progressBar = document.getElementById('benefit-progress-bar');
        if (clampedPercentage >= 100) {
            progressBar.style.background = '#22C55E';
        } else {
            progressBar.style.background = '#6366F1';
        }
    }

    function setQuickAmount(percentage) {
        const amount = (currentBenefitData.totalAmount * percentage) / 100;
        document.getElementById('benefit-amount-input').value = amount.toFixed(2);
        updateBenefitProgress(amount);
    }

    function clearAmount() {
        document.getElementById('benefit-amount-input').value = '0';
        updateBenefitProgress(0);
    }

    document.getElementById('benefit-amount-input')?.addEventListener('input', function(e) {
        const amount = parseFloat(e.target.value) || 0;
        updateBenefitProgress(amount);
    });

    function saveBenefitUsage() {
        const amount = parseFloat(document.getElementById('benefit-amount-input').value) || 0;
        const clampedAmount = Math.max(0, Math.min(amount, currentBenefitData.totalAmount));
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`/dashboard/update-benefit/${currentBenefitData.cardId}/${currentBenefitData.benefitId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: `amount=${clampedAmount}&csrfmiddlewaretoken=${csrfToken}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeBenefitModal();
                window.location.reload();
            } else {
                alert('Failed to update benefit usage.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
        });
    }

    // Close modals on outside click
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }
</script>
{% endblock %}