{% extends 'auth_base.html' %}

{% block content %}
<!-- Dashboard Header -->
<div style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem;">
        <!-- Greeting Section -->
        <div style="display: flex; align-items: center; gap: 1.5rem;">
            <div
                style="width: 64px; height: 64px; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); border: 3px solid white;">
                ‚úàÔ∏è
            </div>
            <div>
                <h1 style="font-size: 2.25rem; font-weight: 800; margin: 0; line-height: 1.1;">
                    Hey, <span style="color: #6D28D9;">{% if user.first_name %}{{ user.first_name }}{% else %}Alex{% endif %}!</span>
                </h1>
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                    <span
                        style="background: rgba(14, 165, 233, 0.1); color: #0ea5e9; font-size: 0.7rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 4px; letter-spacing: 0.05em;">
                        THE JETSETTER
                    </span>
                    <span style="color: var(--text-muted); font-size: 0.9rem;">Your benefits are working hard.</span>
                </div>
            </div>
        </div>

        <!-- Search & Notifications -->
        <div style="display: flex; align-items: center; gap: 1rem;">
            <a href="{% url 'quiz' %}" class="btn btn-sm"
                style="background: white; color: var(--primary); border: 1px solid #E5E7EB; font-weight: 600; padding: 0.5rem 1rem; border-radius: 99px; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; text-decoration: none;">
                <span>‚ú®</span> Take Quiz
            </a>
            <div style="position: relative;">
                <span
                    style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem;">üîç</span>
                <input type="search" placeholder="Search benefits..."
                    style="padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid #E5E7EB; border-radius: 99px; width: 280px; font-size: 0.9rem; background: white; transition: all 0.2s;">
            </div>
            <button
                style="width: 48px; height: 48px; border-radius: 50%; border: 1px solid #E5E7EB; background: white; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); transition: all 0.2s;">
                üîî
            </button>
        </div>
    </div>
</div>

<!-- Stats Cards Grid -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;">
    <!-- Annual Value Card (Purple) -->
    <div
        style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 24px; padding: 2rem; color: white; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3); position: relative; overflow: hidden;">
        <!-- Background decoration -->
        <div
            style="position: absolute; top: -20px; right: -20px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%;">
        </div>

        <div
            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; position: relative; z-index: 1;">
            <div
                style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                üìà
            </div>
            <div style="font-size: 0.8rem; font-weight: 600; opacity: 0.9;">Annual Value</div>
        </div>

        <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem; opacity: 0.9;">Total Value Extracted</div>
            <div style="font-size: 3.5rem; font-weight: 700; line-height: 1; margin-bottom: 0.5rem;">
                ${{ total_used_value|default:0|floatformat:0 }}<span style="font-size: 1.5rem; opacity: 0.7;">.00</span>
            </div>
            <div style="font-size: 0.85rem; opacity: 0.8;">
                Out of ${{ total_potential_value|default:0|floatformat:0 }} available credits
            </div>
        </div>

        <!-- Progress bar at bottom -->
        <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; background: rgba(0,0,0,0.1);">
            <div
                style="width: {% if total_potential_value > 0 %}{% widthratio total_used_value total_potential_value 100 %}{% else %}0{% endif %}%; height: 100%; background: rgba(255,255,255,0.5);">
            </div>
        </div>
    </div>

    <!-- Benefit Utilization Card (White) -->
    <div
        style="background: white; border-radius: 24px; padding: 2rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
            <div>
                <div style="font-size: 0.9rem; color: var(--text-muted); font-weight: 600; margin-bottom: 0.25rem;">
                    Benefit Utilization</div>
            </div>
            <div
                style="width: 40px; height: 40px; background: #F3F4F6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                ‚ö°
            </div>
        </div>

        <div style="font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; color: var(--dark);">
            {% if total_potential_value > 0 %}{% widthratio total_used_value total_potential_value 100 %}{% else %}0{% endif %}%
        </div>
        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.5rem;">
            You're using most of your perks!
        </div>

        <div style="height: 8px; background: #F3F4F6; border-radius: 4px; overflow: hidden;">
            <div
                style="width: {% if total_potential_value > 0 %}{% widthratio total_used_value total_potential_value 100 %}{% else %}0{% endif %}%; height: 100%; background: linear-gradient(90deg, #8b5cf6 0%, #d946ef 100%); border-radius: 4px;">
            </div>
        </div>
    </div>

    <!-- Add New Card (White) -->
    <div style="background: white; border-radius: 24px; padding: 2rem; border: 2px dashed #E5E7EB; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: all 0.2s; min-height: 240px;"
        onclick="openAddCardModal()">
        <div
            style="width: 64px; height: 64px; background: #eff6ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #2563eb; margin-bottom: 1rem;">
            +
        </div>
        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem; color: var(--dark);">Add New Card</div>
        <div style="font-size: 0.85rem; color: var(--text-muted);">Track a new bonus or fee</div>
    </div>
</div>

<!-- Active Benefits Section -->
<div
    style="background: white; border-radius: 24px; padding: 2rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <h2 style="font-size: 1.5rem; font-weight: 800; margin: 0; color: var(--dark);">Active Benefits</h2>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <button
                style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer;">Reset:
                All</button>
            <button
                style="background: #F3F4F6; border: none; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted);">
                ‚ñº
            </button>
        </div>
    </div>
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 2rem;">Real-time tracking of your card
        credits.</p>

    {% if not all_benefits %}
    <!-- Empty State -->
    <div style="text-align: center; padding: 3rem 1rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">üí≥</div>
        <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem;">No active benefits yet</div>
        <div style="color: var(--text-muted); margin-bottom: 1.5rem;">Add cards to your wallet to start tracking
            benefits</div>
        <button class="btn btn-primary" onclick="openAddCardModal()">Add Card</button>
    </div>
    {% else %}

    <!-- Benefits List -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        {% for benefit in all_benefits|slice:":10" %}
        <div style="display: grid; grid-template-columns: 60px 1fr 100px; gap: 1.5rem; align-items: center;">
            <!-- Percentage Circle -->
            <div
                style="width: 50px; height: 50px; border-radius: 50%; background: {% if benefit.is_used %}#dcfce7{% else %}#eff6ff{% endif %}; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: {% if benefit.is_used %}#16a34a{% else %}#2563eb{% endif %};">
                {% if benefit.is_used %}‚úì{% else %}{% if benefit.amount > 0 %}{% widthratio benefit.used benefit.amount 100 %}{% else %}0{% endif %}%{% endif %}
            </div>

            <!-- Benefit Info -->
            <div>
                <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem; color: var(--dark);">{{
                    benefit.benefit_name }}</div>
                <div
                    style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase;">
                    {{ benefit.card_name }} ‚Ä¢ {{ benefit.frequency }}
                </div>
                <div style="height: 8px; background: #F3F4F6; border-radius: 4px; overflow: hidden;">
                    <div
                        style="width: {% if benefit.amount > 0 %}{% widthratio benefit.used benefit.amount 100 %}{% else %}0{% endif %}%; height: 100%; background: {% if benefit.is_used %}#22c55e{% else %}#6366f1{% endif %}; border-radius: 4px;">
                    </div>
                </div>
            </div>

            <!-- Value Display -->
            <div style="text-align: right;">
                <div style="font-weight: 800; font-size: 1.1rem; color: var(--dark);">
                    ${{ benefit.used|floatformat:0 }}
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                    / ${{ benefit.amount|floatformat:0 }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Add Card Modal (Include here as well for the dashboard button) -->
<div id="add-card-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0;">Add New Card</h3>
            <button class="modal-close" onclick="closeAddCardModal()"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">√ó</button>
        </div>

        <!-- Search Bar -->
        <div style="margin-bottom: 1.5rem;">
            <input type="text" id="modal-search" placeholder="Search e.g. 'Sapphire' or 'Amex'"
                style="width: 100%; padding: 0.875rem 1rem; border: 1px solid #E5E7EB; border-radius: var(--radius-md); font-size: 0.95rem;">
        </div>

        <!-- Popular Issuers Filters -->
        <div style="margin-bottom: 1.5rem;">
            <div
                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; font-weight: 600;">
                POPULAR ISSUERS</div>
            <div class="filter-pills" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="filter-pill active" data-issuer="all" onclick="filterModalCards('all')">All</button>
                <button class="filter-pill" data-issuer="Chase" onclick="filterModalCards('Chase')">Chase</button>
                <button class="filter-pill" data-issuer="American Express"
                    onclick="filterModalCards('American Express')">Amex</button>
                <button class="filter-pill" data-issuer="Capital One" onclick="filterModalCards('Capital One')">Capital
                    One</button>
                <button class="filter-pill" data-issuer="Citi" onclick="filterModalCards('Citi')">Citi</button>
            </div>
        </div>

        <!-- Card Selection List -->
        <div id="modal-card-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1.5rem;">
            <!-- Cards will be populated dynamically via JS -->
            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                Loading cards...
            </div>
        </div>

        <!-- Add to Wallet Button -->
        <button id="add-to-wallet-btn" class="btn btn-primary"
            style="width: 100%; padding: 1rem; font-size: 1rem; display: none;" disabled>
            + Add to Wallet
        </button>
    </div>
</div>

<script>
    // Modal Logic
    let selectedCard = null;

    // Sample cards data since we don't have an API yet
    const sampleCards = [
        { id: 1, name: 'Sapphire Preferred', issuer: 'Chase', image: 'card-chase' },
        { id: 2, name: 'Sapphire Reserve', issuer: 'Chase', image: 'card-chase' },
        { id: 3, name: 'Platinum Card', issuer: 'American Express', image: 'card-amex-platinum' },
        { id: 4, name: 'Gold Card', issuer: 'American Express', image: 'card-gold' },
        { id: 5, name: 'Venture X', issuer: 'Capital One', image: 'card-capital-one' },
        { id: 6, name: 'Double Cash', issuer: 'Citi', image: 'card-citi' },
        { id: 7, name: 'Freedom Unlimited', issuer: 'Chase', image: 'card-chase' }
    ];

    function openAddCardModal() {
        document.getElementById('add-card-modal').style.display = 'flex';
        renderModalCards(sampleCards);
    }

    function closeAddCardModal() {
        document.getElementById('add-card-modal').style.display = 'none';
        selectedCard = null;
        document.getElementById('add-to-wallet-btn').style.display = 'none';
    }

    function renderModalCards(cards) {
        const container = document.getElementById('modal-card-list');
        container.innerHTML = '';

        if (cards.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No cards found</div>';
            return;
        }

        cards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'modal-card-item';
            div.style.cssText = `
            display: flex; align-items: center; gap: 1rem; padding: 1rem; 
            border: 1px solid #E5E7EB; border-radius: 12px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s;
        `;
            div.onclick = () => selectCard(card, div);

            div.innerHTML = `
            <div style="width: 60px; height: 40px; background: #eee; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üí≥</div>
            <div>
                <div style="font-weight: 700; color: var(--dark);">${card.name}</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">${card.issuer}</div>
            </div>
            <div style="margin-left: auto; width: 24px; height: 24px; border: 2px solid #E5E7EB; border-radius: 50%; display: flex; align-items: center; justify-content: center;" class="check-circle">
            </div>
        `;
            container.appendChild(div);
        });
    }

    function selectCard(card, element) {
        // Deselect all
        document.querySelectorAll('.modal-card-item').forEach(el => {
            el.style.borderColor = '#E5E7EB';
            el.style.background = 'white';
            el.querySelector('.check-circle').innerHTML = '';
            el.querySelector('.check-circle').style.borderColor = '#E5E7EB';
            el.querySelector('.check-circle').style.background = 'transparent';
        });

        // Select clicked
        element.style.borderColor = '#8b5cf6';
        element.style.background = '#f5f3ff';
        const check = element.querySelector('.check-circle');
        check.style.borderColor = '#8b5cf6';
        check.style.background = '#8b5cf6';
        check.innerHTML = '<span style="color: white; font-size: 0.8rem;">‚úì</span>';

        selectedCard = card;
        const btn = document.getElementById('add-to-wallet-btn');
        btn.style.display = 'block';
        btn.disabled = false;
        btn.textContent = `+ Add ${card.name} to Wallet`;
        btn.onclick = () => addToWallet(card);
    }

    function addToWallet(card) {
        // In a real app, this would be an AJAX call
        // For now, we'll simulate it by redirecting to wallet page
        // Ideally we would POST to an endpoint
        alert(`Added ${card.name} to your wallet!`);
        window.location.href = '{% url "wallet" %}';
    }

    function filterModalCards(issuer) {
        document.querySelectorAll('.filter-pill').forEach(pill => {
            pill.classList.remove('active');
            if (pill.dataset.issuer === issuer) {
                pill.classList.add('active');
            }
        });

        const search = document.getElementById('modal-search').value.toLowerCase();
        let filtered = sampleCards;

        if (issuer !== 'all') {
            filtered = filtered.filter(c => c.issuer === issuer);
        }

        if (search) {
            filtered = filtered.filter(c => c.name.toLowerCase().includes(search) || c.issuer.toLowerCase().includes(search));
        }

        renderModalCards(filtered);
    }

    document.getElementById('modal-search').addEventListener('input', (e) => {
        const activeIssuer = document.querySelector('.filter-pill.active').dataset.issuer;
        filterModalCards(activeIssuer);
    });

    // Close modal when clicking outside
    document.getElementById('add-card-modal')?.addEventListener('click', function (e) {
        if (e.target.id === 'add-card-modal') {
            closeAddCardModal();
        }
    });
</script>

<style>
    @media (max-width: 768px) {
        div[style*="grid-template-columns: 60px 1fr 100px"] {
            grid-template-columns: 1fr !important;
            gap: 0.5rem !important;
        }
    }
</style>
{% endblock %}