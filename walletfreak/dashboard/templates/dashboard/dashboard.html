{% extends 'auth_base.html' %}

{% block content %}
<!-- Hidden CSRF token for JavaScript -->
<form style="display: none;">
    {% csrf_token %}
</form>

<!-- Dashboard Header -->
<div style="margin-bottom: 2.5rem;">
    <!-- Greeting Section -->
    <div style="display: flex; align-items: center; gap: 1.5rem;">
        <div
            style="width: 60px; height: 60px; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);">
            ‚úàÔ∏è
        </div>
        <div>
            <h1 style="font-size: 2rem; font-weight: 800; margin: 0; line-height: 1.2;">
                Hey, <span style="color: #7C3AED;">{% if user.first_name %}{{ user.first_name }}{% else %}Alex{% endif %}!</span>
            </h1>
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                <span
                    style="background: rgba(14, 165, 233, 0.1); color: #0ea5e9; font-size: 0.7rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 4px; letter-spacing: 0.05em;">
                    THE JETSETTER
                </span>
                <span style="color: #64748B; font-size: 0.9rem;">Your benefits are working hard.</span>
            </div>
        </div>
    </div>
</div>

<!-- Top Grid: Annual Value + My Wallet + Add New Card -->
<div style="display: grid; grid-template-columns: 1.8fr 1fr; gap: 1.5rem; margin-bottom: 2.5rem;">
    <!-- Annual Value Card (Purple) -->
    <div
        style="background: linear-gradient(135deg, #7C3AED 0%, #6366F1 100%); border-radius: 20px; padding: 2rem; color: white; box-shadow: 0 8px 20px rgba(124, 58, 237, 0.25); position: relative; overflow: hidden; grid-row: span 2;">
        <!-- Background decoration -->
        <div
            style="position: absolute; top: -30px; right: -30px; width: 180px; height: 180px; background: rgba(255,255,255,0.08); border-radius: 50%;">
        </div>
        <div
            style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.05); border-radius: 50%;">
        </div>

        <div
            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 3rem; position: relative; z-index: 1;">
            <div
                style="width: 42px; height: 42px; background: rgba(255,255,255,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                üìà
            </div>
            <div style="font-size: 0.75rem; font-weight: 600; opacity: 0.85; letter-spacing: 0.05em;">Annual Value</div>
        </div>

        <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.85;">Total Value Extracted</div>
            <div style="font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.75rem;">
                ${{ total_used_value|default:590|floatformat:0 }}<span style="font-size: 1.75rem; font-weight: 400; opacity: 0.6;">.00</span>
            </div>
            <div style="font-size: 0.875rem; opacity: 0.75;">
                Out of ${{ total_potential_value|default:1120|floatformat:0 }} available credits
            </div>
        </div>
    </div>

    <!-- Right Column: My Wallet + Add New Card -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <!-- My Wallet Card -->
        <div
            style="background: white; border-radius: 20px; padding: 1.75rem; border: 1px solid #E5E7EB; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem;">
                <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0; color: #1F2937;">My Wallet</h3>
                <span style="font-size: 1.25rem;">üí≥</span>
            </div>
            <div style="display: flex; align-items: baseline; gap: 0.625rem; margin-bottom: 1rem;">
                <div style="font-size: 2.5rem; font-weight: 800; color: #1F2937; line-height: 1;">3</div>
                <div style="font-size: 0.875rem; color: #64748B;">Active Cards</div>
            </div>
            <!-- Mini card icons -->
            <div style="display: flex; gap: 0.375rem; margin-bottom: 1.25rem;">
                <div style="width: 32px; height: 20px; background: linear-gradient(135deg, #94a3b8, #cbd5e1); border-radius: 3px;"></div>
                <div style="width: 32px; height: 20px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 3px;"></div>
                <div style="width: 32px; height: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 3px;"></div>
            </div>
            <button onclick="openWalletModal()" style="text-decoration: none; color: #7C3AED; font-weight: 600; font-size: 0.875rem; display: block; text-align: center; padding: 0.75rem; background: #F5F3FF; border-radius: 10px; transition: all 0.2s; width: 100%; border: none; cursor: pointer;">
                Manage Wallet
            </button>
        </div>

        <!-- Add New Card - Compact Version -->
        <div
            style="background: white; border-radius: 20px; padding: 1.75rem; border: 1px solid #E5E7EB; box-shadow: 0 2px 8px rgba(0,0,0,0.04); text-align: center;">
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #7C3AED, #A78BFA); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; margin: 0 auto 1rem;">
                +
            </div>
            <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.375rem 0; color: #1F2937;">Add New Card</h3>
            <p style="color: #64748B; font-size: 0.875rem; margin: 0 0 1.25rem 0;">
                Track a new bonus or fee
            </p>
            <button onclick="openAddCardModal()" style="background: #7C3AED; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; font-size: 0.875rem; cursor: pointer; width: 100%; transition: all 0.2s;">
                Add Card
            </button>
        </div>
    </div>
</div>

<!-- Active Benefits Section -->
<div
    style="background: white; border-radius: 20px; padding: 2rem; border: 1px solid #E5E7EB; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
        <div>
            <h2 style="font-size: 1.5rem; font-weight: 800; margin: 0 0 0.375rem 0; color: #1F2937;">Active Benefits</h2>
            <p style="color: #64748B; font-size: 0.875rem; margin: 0;">Real-time tracking of your card credits.</p>
        </div>
        <div style="display: flex; align-items: center; gap: 0.625rem;">
            <button
                style="background: #F3F4F6; border: none; padding: 0.5rem 0.875rem; border-radius: 8px; font-size: 0.8125rem; font-weight: 600; color: #64748B; cursor: pointer; transition: all 0.2s;">Reset: All</button>
            <button
                style="background: #F3F4F6; border: none; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748B; font-size: 0.875rem;">
                ‚ñº
            </button>
        </div>
    </div>

    {% if not all_benefits %}
    <!-- Empty State -->
    <div style="text-align: center; padding: 3rem 1rem; margin-top: 1.5rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">üí≥</div>
        <div style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem; color: #1F2937;">No active benefits yet</div>
        <div style="color: #64748B; margin-bottom: 1.5rem;">Add cards to your wallet to start tracking benefits</div>
        <button class="btn btn-primary" onclick="openAddCardModal()">Add Card</button>
    </div>
    {% else %}

    <!-- Benefits List -->
    <div style="display: flex; flex-direction: column; gap: 1.25rem; margin-top: 1.5rem;">
        {% for benefit in all_benefits|slice:":10" %}
        <div style="display: grid; grid-template-columns: 50px 1fr 90px; gap: 1.25rem; align-items: center; cursor: pointer; padding: 0.5rem; border-radius: 12px; transition: all 0.2s;"
             onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}')"
             onmouseover="this.style.background='#F9FAFB'"
             onmouseout="this.style.background='transparent'">
            <!-- Percentage Circle -->
            {% if benefit.is_used %}
            <div style="width: 48px; height: 48px; border-radius: 50%; background: #DCFCE7; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; color: #16A34A;">
                ‚úì
            </div>
            {% else %}
            <div style="width: 48px; height: 48px; border-radius: 50%; background: #EFF6FF; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; color: #2563EB;">
                {% if benefit.amount > 0 %}{% widthratio benefit.used benefit.amount 100 %}{% else %}0{% endif %}%
            </div>
            {% endif %}

            <!-- Benefit Info -->
            <div>
                <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem; color: #1F2937;">
                    {{ benefit.benefit_name }}
                </div>
                <div
                    style="font-size: 0.75rem; color: #64748B; margin-bottom: 0.625rem; font-weight: 600; letter-spacing: 0.025em; text-transform: uppercase;">
                    {{ benefit.card_name }} ‚Ä¢ {{ benefit.frequency }}
                </div>
                <div style="height: 6px; background: #F3F4F6; border-radius: 3px; overflow: hidden;">
                    {% if benefit.is_used %}
                    <div style="width: {% if benefit.amount > 0 %}{% widthratio benefit.used benefit.amount 100 %}{% else %}0{% endif %}%; height: 100%; background: #22C55E; border-radius: 3px;"></div>
                    {% else %}
                    <div style="width: {% if benefit.amount > 0 %}{% widthratio benefit.used benefit.amount 100 %}{% else %}0{% endif %}%; height: 100%; background: #6366F1; border-radius: 3px;"></div>
                    {% endif %}
                </div>
            </div>

            <!-- Value Display -->
            <div style="text-align: right;">
                <div style="font-weight: 800; font-size: 1.125rem; color: #1F2937;">
                    ${{ benefit.used|floatformat:0 }}
                </div>
                <div style="font-size: 0.8125rem; color: #9CA3AF;">
                    / ${{ benefit.amount|floatformat:0 }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Wallet Modal -->
<div id="wallet-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0;">My Wallet</h3>
                <p style="color: var(--text-muted); margin: 0; font-size: 0.875rem;">Manage your active credit cards</p>
            </div>
            <button class="modal-close" onclick="closeWalletModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">√ó</button>
        </div>

        {% if not active_cards %}
        <!-- Empty State -->
        <div style="background: #F9FAFB; border-radius: 16px; padding: 3rem 2rem; text-align: center; border: 2px dashed #E5E7EB;">
            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">üí≥</div>
            <h4 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">No cards in your wallet</h4>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Add your first credit card to start tracking benefits</p>
            <button class="btn btn-primary" style="padding: 0.875rem 1.75rem;" onclick="closeWalletModal(); openAddCardModal();">
                Browse Cards ‚Üí
            </button>
        </div>
        {% else %}
        <!-- Card Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
            {% for card in active_cards %}
            <div>
                <!-- 3D Credit Card -->
                <div class="credit-card {% if 'american express' in card.name.lower or 'amex' in card.name.lower %}{% if 'platinum' in card.name.lower %}card-amex-platinum{% else %}card-gold{% endif %}{% elif 'chase' in card.name.lower %}card-chase{% elif 'capital one' in card.name.lower %}card-capital-one{% elif 'citi' in card.name.lower %}card-citi{% else %}card-chase{% endif %}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.1em;">
                            {% if 'american express' in card.name.lower or 'amex' in card.name.lower %}AMERICAN EXPRESS
                            {% elif 'chase' in card.name.lower %}CHASE
                            {% elif 'capital one' in card.name.lower %}CAPITAL ONE
                            {% elif 'citi' in card.name.lower %}CITI
                            {% else %}CREDIT CARD{% endif %}
                        </div>
                    </div>
                    <div class="credit-card-chip"></div>
                    <div class="credit-card-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ card.id|slice:"-4:" }}</div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div class="credit-card-name">{% if user.first_name %}{{ user.first_name|upper }} {{ user.last_name|upper }}{% else %}CARDHOLDER NAME{% endif %}</div>
                    </div>
                </div>

                <!-- Card Details Below -->
                <div style="margin-top: 1rem; text-align: center;">
                    <div style="font-weight: 700; font-size: 0.95rem; color: var(--dark); margin-bottom: 0.25rem;">
                        {{ card.name }}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                        --- {{ card.id|slice:"-4:" }}
                    </div>
                    <!-- Remove Card Button -->
                    <form method="POST" action="{% url 'remove_card' card.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to remove this card from your wallet?');">
                        {% csrf_token %}
                        <button type="submit" style="background: #FEE2E2; color: #DC2626; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            Remove Card
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}

            <!-- Add Another Card Button -->
            <div style="border: 2px dashed #E5E7EB; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; min-height: 220px; background: white;" onclick="closeWalletModal(); openAddCardModal();">
                <div style="width: 60px; height: 60px; background: #F5F3FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 0.75rem; color: #7C3AED;">
                    ‚ûï
                </div>
                <div style="font-weight: 700; font-size: 1rem; color: var(--dark);">Add Another Card</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Card Modal -->
<div id="add-card-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0;">Add New Card</h3>
            <button class="modal-close" onclick="closeAddCardModal()"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">√ó</button>
        </div>

        <!-- Search Bar -->
        <div style="margin-bottom: 1.5rem;">
            <input type="text" id="modal-search" placeholder="Search e.g. 'Sapphire' or 'Amex'"
                style="width: 100%; padding: 0.875rem 1rem; border: 1px solid #E5E7EB; border-radius: var(--radius-md); font-size: 0.95rem;">
        </div>

        <!-- Popular Issuers Filters -->
        <div style="margin-bottom: 1.5rem;">
            <div
                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; font-weight: 600;">
                POPULAR ISSUERS</div>
            <div class="filter-pills" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="filter-pill active" data-issuer="all" onclick="filterModalCards('all')">All</button>
                <button class="filter-pill" data-issuer="Chase" onclick="filterModalCards('Chase')">Chase</button>
                <button class="filter-pill" data-issuer="American Express"
                    onclick="filterModalCards('American Express')">Amex</button>
                <button class="filter-pill" data-issuer="Capital One" onclick="filterModalCards('Capital One')">Capital
                    One</button>
                <button class="filter-pill" data-issuer="Citi" onclick="filterModalCards('Citi')">Citi</button>
            </div>
        </div>

        <!-- Card Selection List -->
        <div id="modal-card-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1.5rem;">
            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                Loading cards...
            </div>
        </div>

        <!-- Add to Wallet Button -->
        <button id="add-to-wallet-btn" class="btn btn-primary"
            style="width: 100%; padding: 1rem; font-size: 1rem; display: none;" disabled>
<!-- Benefit Usage Modal -->
<div id="benefit-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0;" id="benefit-modal-title">Update Benefit Usage</h3>
                <p style="color: var(--text-muted); margin: 0; font-size: 0.875rem;" id="benefit-modal-subtitle">Specify how much you've used</p>
            </div>
            <button class="modal-close" onclick="closeBenefitModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">√ó</button>
        </div>

        <!-- Benefit Details -->
        <div style="background: #F9FAFB; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span style="color: #64748B; font-size: 0.875rem;">Total Benefit Value</span>
                <span style="font-weight: 700; font-size: 1.125rem; color: #1F2937;" id="benefit-total-value">$0</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #64748B; font-size: 0.875rem;">Currently Used</span>
                <span style="font-weight: 700; font-size: 1.125rem; color: #7C3AED;" id="benefit-current-used">$0</span>
            </div>
        </div>

        <!-- Amount Input -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1F2937;">Amount Used ($)</label>
            <input type="number" id="benefit-amount-input" min="0" step="0.01" 
                   style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; font-weight: 600;"
                   placeholder="0.00">
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
                <button onclick="setQuickAmount(25)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">25%</button>
                <button onclick="setQuickAmount(50)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">50%</button>
                <button onclick="setQuickAmount(75)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">75%</button>
                <button onclick="setQuickAmount(100)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">100%</button>
                <button onclick="clearAmount()" style="background: #FEE2E2; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #DC2626;">Clear</button>
            </div>
        </div>

        <!-- Progress Preview -->
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-size: 0.875rem; color: #64748B;">Progress</span>
                <span style="font-size: 0.875rem; font-weight: 600; color: #1F2937;" id="benefit-progress-text">0%</span>
            </div>
            <div style="height: 8px; background: #F3F4F6; border-radius: 4px; overflow: hidden;">
                <div id="benefit-progress-bar" style="width: 0%; height: 100%; background: #6366F1; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 0.75rem;">
            <button onclick="closeBenefitModal()" style="flex: 1; background: #F3F4F6; color: #64748B; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Cancel
            </button>
            <button onclick="saveBenefitUsage()" style="flex: 1; background: #7C3AED; color: white; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Save Changes
            </button>
        </div>
    </div>
</div>

            + Add to Wallet
        </button>
    </div>
</div>

<script>
    // Wallet Modal Logic
    function openWalletModal() {
        document.getElementById('wallet-modal').style.display = 'flex';
    }

    function closeWalletModal() {
        document.getElementById('wallet-modal').style.display = 'none';
    }

    // Close wallet modal when clicking outside
    document.getElementById('wallet-modal')?.addEventListener('click', function(e) {
        if (e.target.id === 'wallet-modal') {
            closeWalletModal();
        }
    });

    // Add Card Modal Logic
    let selectedCard = null;

    // Get real cards from backend
    const availableCards = {{ available_cards_json|safe }};

    function openAddCardModal() {
        document.getElementById('add-card-modal').style.display = 'flex';
        renderModalCards(availableCards);
    }

    function closeAddCardModal() {
        document.getElementById('add-card-modal').style.display = 'none';
        selectedCard = null;
        document.getElementById('add-to-wallet-btn').style.display = 'none';
    }

    function renderModalCards(cards) {
        const container = document.getElementById('modal-card-list');
        container.innerHTML = '';

        if (cards.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No cards found</div>';
            return;
        }

        cards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'modal-card-item';
            div.style.cssText = `
            display: flex; align-items: center; gap: 1rem; padding: 1rem; 
            border: 1px solid #E5E7EB; border-radius: 12px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s;
        `;
            div.onclick = () => selectCard(card, div);

            div.innerHTML = `
            <div style="width: 60px; height: 40px; background: #eee; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üí≥</div>
            <div>
                <div style="font-weight: 700; color: var(--dark);">${card.name}</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">${card.issuer}</div>
            </div>
            <div style="margin-left: auto; width: 24px; height: 24px; border: 2px solid #E5E7EB; border-radius: 50%; display: flex; align-items: center; justify-content: center;" class="check-circle">
            </div>
        `;
            container.appendChild(div);
        });
    }

    function selectCard(card, element) {
        document.querySelectorAll('.modal-card-item').forEach(el => {
            el.style.borderColor = '#E5E7EB';
            el.style.background = 'white';
            el.querySelector('.check-circle').innerHTML = '';
            el.querySelector('.check-circle').style.borderColor = '#E5E7EB';
            el.querySelector('.check-circle').style.background = 'transparent';
        });

        element.style.borderColor = '#8b5cf6';
        element.style.background = '#f5f3ff';
        const check = element.querySelector('.check-circle');
        check.style.borderColor = '#8b5cf6';
        check.style.background = '#8b5cf6';
        check.innerHTML = '<span style="color: white; font-size: 0.8rem;">‚úì</span>';

        selectedCard = card;
        const btn = document.getElementById('add-to-wallet-btn');
        btn.style.display = 'block';

    // Benefit Usage Modal Logic
    let currentBenefitData = {
        cardId: null,
        benefitId: null,
        benefitName: '',
        totalAmount: 0,
        currentUsed: 0,
        frequency: ''
    };

    function openBenefitModal(cardId, benefitId, benefitName, totalAmount, currentUsed, frequency) {
        currentBenefitData = {
            cardId: cardId,
            benefitId: benefitId,
            benefitName: benefitName,
            totalAmount: parseFloat(totalAmount),
            currentUsed: parseFloat(currentUsed),
            frequency: frequency
        };

        // Update modal content
        document.getElementById('benefit-modal-title').textContent = benefitName;
        document.getElementById('benefit-modal-subtitle').textContent = frequency;
        document.getElementById('benefit-total-value').textContent = '$' + totalAmount;
        document.getElementById('benefit-current-used').textContent = '$' + currentUsed.toFixed(0);
        document.getElementById('benefit-amount-input').value = currentUsed;
        document.getElementById('benefit-amount-input').max = totalAmount;

        // Update progress
        updateBenefitProgress(currentUsed);

        // Show modal
        document.getElementById('benefit-modal').style.display = 'flex';
    }

    function closeBenefitModal() {
        document.getElementById('benefit-modal').style.display = 'none';
        currentBenefitData = {
            cardId: null,
            benefitId: null,
            benefitName: '',
            totalAmount: 0,
            currentUsed: 0,
            frequency: ''
        };
    }

    function updateBenefitProgress(amount) {
        const percentage = (amount / currentBenefitData.totalAmount) * 100;
        const clampedPercentage = Math.min(100, Math.max(0, percentage));
        
        document.getElementById('benefit-progress-bar').style.width = clampedPercentage + '%';
        document.getElementById('benefit-progress-text').textContent = Math.round(clampedPercentage) + '%';
        
        // Change color based on completion
        const progressBar = document.getElementById('benefit-progress-bar');
        if (clampedPercentage >= 100) {
            progressBar.style.background = '#22C55E';
        } else {
            progressBar.style.background = '#6366F1';
        }
    }

    function setQuickAmount(percentage) {
        const amount = (currentBenefitData.totalAmount * percentage) / 100;
        document.getElementById('benefit-amount-input').value = amount.toFixed(2);
        updateBenefitProgress(amount);
    }

    function clearAmount() {
        document.getElementById('benefit-amount-input').value = '0';
        updateBenefitProgress(0);
    }

    // Update progress as user types
    document.getElementById('benefit-amount-input')?.addEventListener('input', function(e) {
        const amount = parseFloat(e.target.value) || 0;
        updateBenefitProgress(amount);
    });

    function saveBenefitUsage() {
        const amount = parseFloat(document.getElementById('benefit-amount-input').value) || 0;
        
        // Clamp to valid range
        const clampedAmount = Math.max(0, Math.min(amount, currentBenefitData.totalAmount));
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Send AJAX request
        fetch(`/dashboard/update-benefit/${currentBenefitData.cardId}/${currentBenefitData.benefitId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: `amount=${clampedAmount}&csrfmiddlewaretoken=${csrfToken}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                closeBenefitModal();
                
                // Reload page to show updated values
                window.location.reload();
            } else {
                alert('Failed to update benefit usage. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    // Close benefit modal when clicking outside
    document.getElementById('benefit-modal')?.addEventListener('click', function(e) {
        if (e.target.id === 'benefit-modal') {
            closeBenefitModal();
        }
    });
        btn.disabled = false;
        btn.textContent = `+ Add ${card.name} to Wallet`;
        btn.onclick = () => addToWallet(card);
    }

    function addToWallet(card) {
        // Create a form and submit it to add the card
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/dashboard/add-card/${card.id}/`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        // Add status field (default to 'active')
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = 'active';
        form.appendChild(statusInput);
        
        document.body.appendChild(form);
        form.submit();
    }

    function filterModalCards(issuer) {
        document.querySelectorAll('.filter-pill').forEach(pill => {
            pill.classList.remove('active');
            if (pill.dataset.issuer === issuer) {
                pill.classList.add('active');
            }
        });

        const search = document.getElementById('modal-search').value.toLowerCase();
        let filtered = availableCards;

        if (issuer !== 'all') {
            filtered = filtered.filter(c => c.issuer === issuer);
        }

        if (search) {
            filtered = filtered.filter(c => c.name.toLowerCase().includes(search) || c.issuer.toLowerCase().includes(search));
        }

        renderModalCards(filtered);
    }

    document.getElementById('modal-search')?.addEventListener('input', (e) => {
        const activeIssuer = document.querySelector('.filter-pill.active').dataset.issuer;
        filterModalCards(activeIssuer);
    });

    document.getElementById('add-card-modal')?.addEventListener('click', function (e) {
        if (e.target.id === 'add-card-modal') {
            closeAddCardModal();
        }
    });
</script>

<style>
    @media (max-width: 768px) {
        div[style*="grid-template-columns: 60px 1fr 100px"] {
            grid-template-columns: 1fr !important;
            gap: 0.5rem !important;
        }
        div[style*="grid-template-columns: 2fr 1fr"] {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}