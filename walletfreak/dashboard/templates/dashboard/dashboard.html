{% extends 'auth_base.html' %}
{% load static %}
{% load card_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/mobile_modal.css' %}">
<style>
/* Loader */
#global-loader {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(4px);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}
.spinner {
    width: 50px; height: 50px;
    border: 5px solid #E2E8F0;
    border-top-color: #6366F1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { 100% { transform: rotate(360deg); } }

/* Toast */
#toast-container {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.toast {
    background: #10B981;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    display: flex; align-items: center; gap: 0.75rem;
    animation: slideIn 0.3s ease-out;
    min-width: 300px;
    font-weight: 500;
}
.toast.error { background: #EF4444; }
@keyframes slideIn {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}

{% block content %}
<!-- Hidden CSRF token for JavaScript -->
<form style="display: none;">
    {% csrf_token %}
</form>

<!-- Dashboard Header -->
<div style="margin-bottom: 2.5rem;">
    <!-- Greeting Section -->
    <div style="display: flex; align-items: center; gap: 1.5rem;">
        <div
            style="width: 60px; height: 60px; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); overflow: hidden;">
            {% if user_profile.photo_url %}
            <img src="{{ user_profile.photo_url }}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
            <span class="material-icons" style="font-size: 32px;">flight</span>
            {% endif %}
        </div>
        <div>
            <h1 style="font-size: 2rem; font-weight: 800; margin: 0; line-height: 1.2;">
                Hey, <span style="color: #7C3AED;">{% if user.first_name %}{{ user.first_name }}{% else %}Alex{% endif %}!</span>
            </h1>
            <div id="personality-badge-section" style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                {% if assigned_personality %}
                <a href="{% url 'personality_detail' assigned_personality.id %}" style="text-decoration: none;">
                    <span
                        style="background: #E0F2FE; color: #0284C7; font-size: 0.7rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 4px; letter-spacing: 0.05em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='#BAE6FD'"
                        onmouseout="this.style.background='#E0F2FE'">
                        <span class="material-icons" style="font-size: 10px; vertical-align: middle;">psychology</span>
                        {{ assigned_personality.name }}
                    </span>
                </a>
                {% if assigned_personality.match_score %}
                <span style="color: #64748B; font-size: 0.9rem;">{{ assigned_personality.match_score }} card{{ assigned_personality.match_score|pluralize }} match</span>
                {% endif %}
                {% else %}
                <span style="color: #94A3B8; font-size: 0.875rem; font-style: italic;">
                    <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 4px;">info</span>
                    Add at least 2 cards to discover your freak
                </span>
                {% endif %}
            </div>
        </div>
        <!-- Search Bar Removed -->
    </div>
</div>

<!-- Top Grid: Annual Value + My Wallet + Add New Card -->
<div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2.5rem;">
    <!-- Annual Value Card (Purple) -->
    <div id="annual-value-card"
        style="background: linear-gradient(135deg, #6366F1 0%, #7C3AED 100%); border-radius: 24px; padding: 2rem; color: white; box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 240px;">
        
        <!-- Top Row -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 1;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                <span class="material-icons" style="font-size: 24px;">trending_up</span>
            </div>
            <div style="font-size: 0.875rem; font-weight: 500; opacity: 0.9;">Annual Value</div>
        </div>

        <!-- Bottom Row -->
        <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem; opacity: 0.9;">Total Value Extracted</div>
            <div style="font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; letter-spacing: -0.02em;">
                ${{ total_used_value|floatformat:0 }}<span style="font-size: 1.75rem; font-weight: 500; opacity: 0.7;">.00</span>
            </div>
            <div style="font-size: 0.875rem; opacity: 0.8;">
                Out of ${{ total_potential_value|floatformat:0 }} available credits
            </div>
        </div>
    </div>

    <!-- My Wallet Card -->
    <div
        style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; justify-content: space-between;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 0.75rem; font-weight: 700; color: #64748B; letter-spacing: 0.05em; margin-bottom: 0.5rem; text-transform: uppercase;">MY STACK</div>
                <div style="display: flex; align-items: baseline; gap: 0.5rem;">
                    <div style="font-size: 3rem; font-weight: 800; color: #1F2937; line-height: 1;">{{ active_cards|length }}</div>
                    <div style="font-size: 0.9rem; color: #64748B;">Active Cards</div>
                </div>
            </div>
            <div style="width: 40px; height: 40px; background: #FDF4FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #D946EF;">
                <span class="material-icons" style="font-size: 20px;">wallet</span>
            </div>
        </div>
        
        <div style="margin-top: auto;">
            <button onclick="openManageWalletModal('stack')" style="width: 100%; padding: 0.75rem; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; font-weight: 600; color: #1F2937; cursor: pointer; transition: all 0.2s;">
                Manage Wallet
            </button>
        </div>
    </div>

    <!-- Add New Card Trigger -->
    <div
        style="background: white; border-radius: 24px; padding: 1.5rem; border: 2px dashed #E5E7EB; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: all 0.2s;"
        onclick="openManageWalletModal('add')"
        onmouseover="this.style.borderColor='#7C3AED'; this.style.background='#F5F3FF'"
        onmouseout="this.style.borderColor='#E5E7EB'; this.style.background='white'">
        
        <div style="width: 64px; height: 64px; background: #EEF2FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #6366F1; margin-bottom: 1rem;">
            +
        </div>
        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">Add New Card</h3>
        <p style="color: #64748B; font-size: 0.875rem; margin: 0;">Track a new bonus or fee</p>
    </div>
</div>

<!-- Filter Pills Section -->
<div id="card-filters-container" style="margin-bottom: 2rem; overflow-x: auto; padding-bottom: 0.5rem;">
    <div style="display: flex; gap: 0.75rem;" id="card-filters">
        <button class="filter-pill active" onclick="filterBenefits('all')">
            <span class="material-icons" style="font-size: 16px;">filter_list</span>
            All Cards
        </button>
        {% for card in active_cards %}
        <button class="filter-pill" onclick="filterBenefits('{{ card.card_id }}')">
            <span class="dot" style="background: {% if 'platinum' in card.name|lower %}#E5E7EB{% elif 'gold' in card.name|lower %}#FCD34D{% elif 'sapphire' in card.name|lower %}#3B82F6{% else %}#9CA3AF{% endif %};"></span>
            {{ card.name }}
        </button>
        {% endfor %}
    </div>
</div>

<!-- Action Needed Section -->
<div id="action-needed-section" style="margin-bottom: 3rem;">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
        <div style="width: 32px; height: 32px; background: #FEF3C7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #D97706;">
            <span class="material-icons" style="font-size: 18px;">priority_high</span>
        </div>
        <h2 style="font-size: 1.25rem; font-weight: 800; margin: 0; color: #1F2937;">Action Needed <span style="color: #94A3B8; font-weight: 600; font-size: 1rem; margin-left: 0.25rem;">({{ action_needed_benefits|length }})</span></h2>
    </div>

    {% if not action_needed_benefits %}
    <div style="text-align: center; padding: 3rem 1rem; background: white; border-radius: 24px; border: 1px solid #F3F4F6;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">check_circle</span></div>
        <div style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem; color: #1F2937;">All caught up!</div>
        <div style="color: #64748B;">You've maximized all your benefits for the current period.</div>
    </div>
    {% else %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(520px, 1fr)); gap: 1.5rem;">
        {% for benefit in action_needed_benefits %}
        <div class="benefit-card" data-card-id="{{ benefit.card_id }}" style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.2s;">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;">
                    <img src="{% get_card_image_url benefit.card_id %}" style="width: 48px; height: auto; object-fit: contain; border-radius: 4px;" alt="{{ benefit.card_name }}">
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">{{ benefit.benefit_name }}</h3>
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">
                            {{ benefit.card_name }} • 
                            {% if 'anniversary year' in benefit.frequency|lower %}
                                ANNUALLY ({{ benefit.periods.0.label }})
                            {% elif 'calendar year' in benefit.frequency|lower %}
                                {% if 'semi' in benefit.frequency|lower %}SEMI-ANNUALLY{% else %}ANNUALLY{% endif %}
                            {% elif 'every four years' in benefit.frequency|lower %}
                                EVERY FOUR YEARS ({{ benefit.periods.0.label }})
                            {% else %}
                                {{ benefit.frequency }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.25rem; font-weight: 800; color: #1F2937;">${{ benefit.amount|floatformat:0 }}</div>
                    <div style="font-size: 0.7rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">PER PERIOD</div>
                    {% if benefit.days_until_expiration is not None %}
                    <div style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.05em; 
                        {% if benefit.days_until_expiration < 7 %}background: #FEE2E2; color: #DC2626;{% elif benefit.days_until_expiration < 30 %}background: #FEF3C7; color: #D97706;{% else %}background: #F3F4F6; color: #6B7280;{% endif %}">
                        {% if benefit.days_until_expiration == 0 %}EXPIRES TODAY{% elif benefit.days_until_expiration == 1 %}EXPIRES TOMORROW{% else %}{{ benefit.days_until_expiration }} DAYS LEFT{% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tracker -->
            {% if 'Monthly' in benefit.frequency %}
            {{ benefit.periods|json_script:benefit.script_id }}
            <div class="monthly-pills-grid">
                {% for period in benefit.periods %}
                <div class="period-pill {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.user_card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}', '{{ benefit.script_id }}')"{% endif %}
                     style="{% if not period.is_available %}cursor: not-allowed;{% endif %}">
                    <div class="pill-label">{{ period.label }}</div>
                    <div style="font-size: 0.65rem; font-weight: 600; color: #64748B;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 12px;">check</span>
                        {% elif period.status == 'partial' %}
                        <div style="width: 6px; height: 2px; background: #3B82F6; border-radius: 1px;"></div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% elif 'Quarterly' in benefit.frequency or 'Semi-annually' in benefit.frequency %}
            {{ benefit.periods|json_script:benefit.script_id }}
            <div style="display: flex; gap: 1.5rem;">
                {% for period in benefit.periods %}
                <div class="period-pill large {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.user_card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}', '{{ benefit.script_id }}')"{% endif %}
                     style="flex: 1; {% if not period.is_available %}opacity: 0.3; cursor: not-allowed;{% else %}cursor: pointer;{% endif %}">
                    <div class="pill-label">
                        {% if period.label == 'H1' %}Jan - Jun{% elif period.label == 'H2' %}Jul - Dec{% else %}{{ period.label }}{% endif %}
                    </div>
                    <div style="font-size: 0.875rem; font-weight: 700; color: #1F2937;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 16px;">check</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Annual Progress Bar -->
            {{ benefit.periods|json_script:benefit.script_id }}
            <div style="background: #F8FAFC; border-radius: 12px; padding: 1rem; border: 1px solid #E2E8F0; cursor: pointer;"
                 onclick="openBenefitModal('{{ benefit.user_card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ benefit.periods.0.key }}', '{{ benefit.script_id }}')">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #64748B;">
                    <span>{{ benefit.periods.0.label }}</span>
                    {% if benefit.used > 0 %}<span style="color: #6366F1;">${{ benefit.used|floatformat:0 }} used</span>{% endif %}
                </div>
                <div style="height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden;">
                    <div style="width: {% widthratio benefit.used benefit.amount 100 %}%; height: 100%; background: #6366F1; border-radius: 4px;"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Maxed Out Section -->
{% if maxed_out_benefits %}
<div id="maxed-out-section" style="margin-bottom: 3rem;">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
        <div style="width: 32px; height: 32px; background: #DCFCE7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #16A34A;">
            <span class="material-icons" style="font-size: 18px;">check_circle</span>
        </div>
        <h2 style="font-size: 1.25rem; font-weight: 800; margin: 0; color: #1F2937;">Maxed Out <span style="color: #94A3B8; font-weight: 600; font-size: 1rem; margin-left: 0.25rem;">({{ maxed_out_benefits|length }})</span></h2>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(520px, 1fr)); gap: 1.5rem;">
        {% for benefit in maxed_out_benefits %}
        <div class="benefit-card" data-card-id="{{ benefit.card_id }}" style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.2s;">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;">
                    <img src="{% get_card_image_url benefit.card_id %}" style="width: 48px; height: auto; object-fit: contain; border-radius: 4px;" alt="{{ benefit.card_name }}">
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">{{ benefit.benefit_name }}</h3>
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">
                            {{ benefit.card_name }} • 
                            {% if 'anniversary year' in benefit.frequency|lower %}
                                ANNUALLY ({{ benefit.periods.0.label }})
                            {% elif 'calendar year' in benefit.frequency|lower %}
                                {% if 'semi' in benefit.frequency|lower %}SEMI-ANNUALLY{% else %}ANNUALLY{% endif %}
                            {% elif 'every four years' in benefit.frequency|lower %}
                                EVERY FOUR YEARS ({{ benefit.periods.0.label }})
                            {% else %}
                                {{ benefit.frequency }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.25rem; font-weight: 800; color: #1F2937;">${{ benefit.amount|floatformat:0 }}</div>
                    <div style="font-size: 0.7rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">PER PERIOD</div>
                </div>
            </div>

            <!-- Tracker -->
            {% if 'Monthly' in benefit.frequency %}
            {{ benefit.periods|json_script:benefit.script_id }}
            <div class="monthly-pills-grid">
                {% for period in benefit.periods %}
                <div class="period-pill {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.user_card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}', '{{ benefit.script_id }}')"{% endif %}
                     style="{% if not period.is_available %}cursor: not-allowed;{% endif %}">
                    <div class="pill-label">{{ period.label }}</div>
                    <div style="font-size: 0.65rem; font-weight: 600; color: #64748B;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 12px;">check</span>
                        {% elif period.status == 'partial' %}
                        <div style="width: 6px; height: 2px; background: #3B82F6; border-radius: 1px;"></div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% elif 'Quarterly' in benefit.frequency or 'Semi-annually' in benefit.frequency %}
            {{ benefit.periods|json_script:benefit.script_id }}
            <div style="display: flex; gap: 1.5rem;">
                {% for period in benefit.periods %}
                <div class="period-pill large {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.user_card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}', '{{ benefit.script_id }}')"{% endif %}
                     style="flex: 1; {% if not period.is_available %}opacity: 0.3; cursor: not-allowed;{% else %}cursor: pointer;{% endif %}">
                    <div class="pill-label">
                        {% if period.label == 'H1' %}Jan - Jun{% elif period.label == 'H2' %}Jul - Dec{% else %}{{ period.label }}{% endif %}
                    </div>
                    <div style="font-size: 0.875rem; font-weight: 700; color: #1F2937;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 16px;">check</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Annual Progress Bar -->
            {{ benefit.periods|json_script:benefit.script_id }}
            <div style="background: #F8FAFC; border-radius: 12px; padding: 1rem; border: 1px solid #E2E8F0; cursor: pointer;"
                 onclick="openBenefitModal('{{ benefit.user_card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ benefit.periods.0.key }}', '{{ benefit.script_id }}')">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #64748B;">
                    <span>{{ benefit.periods.0.label }}</span>
                    {% if benefit.used > 0 %}<span style="color: #6366F1;">${{ benefit.used|floatformat:0 }} used</span>{% endif %}
                </div>
                <div style="height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden;">
                    <div style="width: 100%; height: 100%; background: #16A34A; border-radius: 4px;"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Manage Wallet Modal (Redesigned with Sidebar) -->
<div id="manage-wallet-modal" class="modal" style="display: none; align-items: center; justify-content: center; padding: 2rem;">
    <div class="modal-content" style="width: 1000px; max-width: 95vw; height: 600px; max-height: 90vh; padding: 0; display: flex; overflow: hidden; border-radius: 24px; background: white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        
        <!-- Sidebar -->
        <div class="modal-sidebar">
            <div style="padding: 0 0.5rem; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.25rem; font-weight: 800; margin: 0; color: #1F2937;">Manage Wallet</h3>
            </div>
            
            <div class="modal-sidebar-item active" onclick="switchTab('stack')" id="tab-stack">
                <span class="material-icons" style="font-size: 20px;">wallet</span>
                <span>My Stack</span>
                <span style="background: #E2E8F0; color: #64748B; font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 99px; margin-left: auto;">{{ active_cards|length }}</span>
            </div>
            
            <div class="modal-sidebar-item" onclick="switchTab('add')" id="tab-add">
                <span class="material-icons" style="font-size: 20px;">add_circle_outline</span>
                <span>Add New Card</span>
            </div>

        </div>
        
        <!-- Content Area -->
        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;">
            <button class="modal-close-btn" onclick="closeManageWalletModal()" style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">×</button>

            <!-- Mobile Screen 1: My Stack -->
            <div id="mobile-my-stack-screen" style="display: none; flex: 1; flex-direction: column; overflow-y: auto; height: 100vh; background: white;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: white; position: relative;">
                    <h1 style="font-size: 1.5rem; font-weight: 700; color: #1F2937; margin: 0;">Manage Wallet</h1>
                    <button class="modal-close-btn" onclick="closeManageWalletModal()" style="background: none; border: none; color: #64748B; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; position: absolute; top: 1rem; right: 1rem;">×</button>
                </div>
                
                <!-- Tab Navigation -->
                <div style="padding: 1.5rem; background: white;">
                    <div style="display: flex; gap: 1rem;">
                        <button id="mobile-my-stack-tab" style="flex: 1; background: #6366F1; border: 1px solid #6366F1; border-radius: 12px; padding: 1rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; color: white; font-weight: 600;">
                            <span class="material-icons" style="font-size: 24px;">account_balance_wallet</span>
                            <div>
                                <div style="font-size: 0.875rem; font-weight: 500;">My Stack</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">{{ active_cards|length }}</div>
                            </div>
                        </button>
                        
                        <button onclick="showMobileAddNewScreen()" style="flex: 1; background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: #6366F1; font-weight: 600; cursor: pointer;">
                            <span class="material-icons">add</span>
                            Add New
                        </button>
                    </div>
                </div>
                
                <!-- Active Cards Content -->
                <div style="padding: 1.5rem; background: white; flex: 1; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #1F2937; margin: 0;">Active Cards</h2>

                    </div>
                    
                    <!-- Active Cards List -->
                    {% if active_cards %}
                        {% for card in active_cards %}
                        <div class="card-item-container" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: white; border: 1px solid #E5E7EB; border-radius: 12px; margin-bottom: 0.75rem;">
<img src="{% get_card_image_url card.card_id %}" style="width: 60px; height: auto; object-fit: contain; border-radius: 4px;" alt="{{ card.name }}">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: #1F2937; font-size: 1rem; margin-bottom: 0.25rem;">{{ card.name }}</div>
                                <div style="color: #64748B; font-size: 0.875rem;">•••• {{ card.last4|default:"****" }}</div>
                            </div>
                            <form method="POST" action="{% url 'remove_card' card.id %}" style="margin: 0;" onsubmit="return openRemoveCardModal(event, this, '{{ card.name|escapejs }}');">
                                {% csrf_token %}
                                <button type="submit" style="background: none; border: none; color: #CBD5E1; cursor: pointer; padding: 0.5rem;">
                                    <span class="material-icons" style="font-size: 1.5rem;">delete_outline</span>
                                </button>
                            </form>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 4rem 2rem; color: #94A3B8;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">wallet</span></div>
                            <p>Your wallet is empty.</p>
                            <button onclick="showMobileAddNewScreen()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #6366F1; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                                Add Your First Card
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Mobile Screen 2: Add New -->
            <div id="mobile-add-new-screen" style="display: none; flex: 1; flex-direction: column; overflow-y: auto; height: 100vh; background: white;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: white; position: relative;">
                    <h1 style="font-size: 1.5rem; font-weight: 700; color: #1F2937; margin: 0;">Manage Wallet</h1>
                    <button class="modal-close-btn" onclick="closeManageWalletModal()" style="background: none; border: none; color: #64748B; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; position: absolute; top: 1rem; right: 1rem;">×</button>
                </div>
                
                <!-- Tab Navigation -->
                <div style="padding: 1.5rem; background: white;">
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="showMobileMyStackScreen()" class="mobile-tab-button">
                            <span class="material-icons" style="font-size: 24px;">account_balance_wallet</span>
                            <div>
                                <div style="font-size: 0.875rem; font-weight: 500;">My Stack</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">{{ active_cards|length }}</div>
                            </div>
                        </button>
                        
                        <button class="mobile-tab-button active">
                            <span class="material-icons">add</span>
                            Add New
                        </button>
                    </div>
                </div>
                
                <!-- Find a Card Content -->
                <div style="padding: 1.5rem; background: white; flex: 1; overflow-y: auto;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: #1F2937;">Find a Card</h2>
                    <p style="color: #64748B; margin-bottom: 1.5rem; font-size: 0.95rem;">Search by name or issuer.</p>
                    
                    <!-- Search -->
                    <div style="position: relative; margin-bottom: 1.5rem;">
                        <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94A3B8;"><span class="material-icons" style="font-size: 20px;">search</span></span>
                        <input type="text" id="mobile-card-search" placeholder="Search e.g. 'Sapphire' or 'Amex'" style="width: 100%; padding: 0.875rem 1rem 0.875rem 3rem; border: 1px solid #E5E7EB; border-radius: 12px; font-size: 1rem; outline: none; background: white;" oninput="handleMobileSearch(this.value)">
                    </div>
                    
                    <!-- Quick Add Filters -->
                    <div style="margin-bottom: 1.5rem; background: #FFFFFF; padding-top: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #F3F4F6;">
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; margin-bottom: 0.75rem; letter-spacing: 0.1em;">QUICK ADD</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="toggleMobileFilter('Chase')" id="filter-Chase" class="mobile-quick-add-btn">Chase</button>
                            <button onclick="toggleMobileFilter('American Express')" id="filter-American Express" class="mobile-quick-add-btn">Amex</button>
                            <button onclick="toggleMobileFilter('Capital One')" id="filter-Capital One" class="mobile-quick-add-btn">Capital One</button>
                            <button onclick="toggleMobileFilter('Citi')" id="filter-Citi" class="mobile-quick-add-btn">Citi</button>
                        </div>
                    </div>
                    
                    <!-- Card List -->
                    <div id="mobile-card-results-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Mobile Screen 3: Card Detail -->
            <div id="mobile-card-detail-screen" style="display: none; flex: 1; flex-direction: column; overflow-y: auto; height: 100vh; background: white;">
                <!-- Content populated by JS -->
            </div>

            <!-- Desktop View 1: My Stack -->
            <div id="content-stack" style="flex: 1; padding: 2rem; display: flex; flex-direction: column; overflow-y: auto;">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0; color: #1F2937;">Active Cards</h3>

                </div>
                
                <div style="flex: 1; overflow-y: auto;">
                    {% if active_cards %}
                        {% for card in active_cards %}
                        <div class="card-item-container" style="display: flex; align-items: center; padding: 1.25rem; border: 1px solid #F3F4F6; border-radius: 16px; margin-bottom: 1rem; background: white; transition: all 0.2s;">
                            <img src="{% get_card_image_url card.card_id %}" style="width: 60px; height: auto; object-fit: contain; border-radius: 4px; margin-right: 1.25rem;" alt="{{ card.name }}">
                            
                            <div>
                                <div style="font-weight: 700; color: #1F2937; font-size: 1rem;">{{ card.name }}</div>
                                <div style="font-size: 0.85rem; color: #94A3B8; font-family: monospace;">•••• {{ card.last4|default:"****" }}</div>
                            </div>
                            
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem;">
                                <span style="background: #DCFCE7; color: #16A34A; font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 99px;">Active</span>
                                
                                <form method="POST" action="{% url 'remove_card' card.id %}" style="margin: 0;" onsubmit="return openRemoveCardModal(event, this, '{{ card.name|escapejs }}');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-delete-card" style="background: none; border: none; cursor: pointer; color: #E2E8F0; padding: 0.5rem; transition: color 0.2s;" onmouseover="this.style.color='#EF4444'" onmouseout="this.style.color='#E2E8F0'" title="Remove Card">
                                        <span class="material-icons" style="font-size: 20px;">delete_outline</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 4rem 2rem; color: #94A3B8;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">wallet</span></div>
                            <p>Your wallet is empty.</p>
                            <button onclick="switchTab('add')" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #6366F1; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">
                                Add Your First Card
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- View 2: Find a Card -->
            <div id="content-add" style="flex: 1; display: none; overflow: hidden; height: 100%;">
                <div style="display: flex; height: 100%;">
                    <!-- Left Column: Search & List -->
                    <div style="flex: 1; padding: 2rem; border-right: 1px solid #F3F4F6; display: flex; flex-direction: column; overflow: hidden;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1F2937;">Find a Card</h3>
                        <p style="color: #64748B; font-size: 0.9rem; margin-bottom: 1.5rem;">Search by name or issuer to add it to your wallet.</p>
                        
                        <div style="position: relative; margin-bottom: 1.5rem;">
                            <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #6366F1;"><span class="material-icons" style="font-size: 20px;">search</span></span>
                            <input type="text" id="card-search-input" placeholder="Search e.g. 'Sapphire' or 'Amex'" 
                                   style="width: 100%; padding: 1rem 1rem 1rem 3rem; border: 1px solid #6366F1; border-radius: 12px; font-size: 1rem; outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);">
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; margin-bottom: 0.75rem; text-transform: uppercase;">Quick Add</div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="quick-add-btn" onclick="filterCards('Chase')">Chase</button>
                                <button class="quick-add-btn" onclick="filterCards('Amex')">Amex</button>
                                <button class="quick-add-btn" onclick="filterCards('Capital One')">Capital One</button>
                                <button class="quick-add-btn" onclick="filterCards('Citi')">Citi</button>
                            </div>
                        </div>
                        
                        <div id="card-results-list" style="overflow-y: auto; flex: 1; padding-right: 0.5rem;">
                            <!-- Results populated via JS -->
                        </div>
                    </div>
                    
                    <!-- Right Column: Card Preview -->
                    <div style="width: 380px; padding: 2rem; background: #F8FAFC; display: flex; flex-direction: column; align-items: center; overflow-y: auto;">
                        <div id="card-preview-empty" style="color: #94A3B8; text-align: center; margin-top: 8rem;">
                            <div style="width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                                <span class="material-icons" style="font-size: 32px; color: #CBD5E1;">credit_card</span>
                            </div>
                        </div>
                        
                        <div id="card-preview-content" style="display: none; width: 100%; padding: 0 1rem;">
                            <!-- Card Visual -->
                            <div id="preview-card-visual" style="width: 100%; height: 180px; background: linear-gradient(135deg, #6366F1, #8B5CF6); border-radius: 16px; margin: 0 0 1.5rem 0; box-shadow: 0 8px 24px rgba(99, 102, 241, 0.25); padding: 1.25rem; display: flex; flex-direction: column; justify-content: space-between; color: white; position: relative; overflow: hidden;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div id="preview-issuer" style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em; opacity: 0.9;">AMERICAN EXPRESS</div>
                                    <span class="material-icons" style="font-size: 24px; opacity: 0.7;">contactless</span>
                                </div>
                                <div style="width: 40px; height: 28px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 4px; opacity: 0.9;"></div>
                                <div>
                                    <div style="font-size: 1rem; letter-spacing: 0.15em; font-family: 'Courier New', monospace; opacity: 0.85; margin-bottom: 0.75rem;">•••• •••• •••• 4242</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="font-size: 0.7rem; opacity: 0.85; letter-spacing: 0.05em;">YOUR NAME</div>
                                        <div style="display: flex; gap: 2px;">
                                            <div style="width: 18px; height: 18px; background: #EB001B; border-radius: 50%; opacity: 0.9;"></div>
                                            <div style="width: 18px; height: 18px; background: #F79E1B; border-radius: 50%; margin-left: -6px; opacity: 0.9;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Add to Wallet Button -->
                            <button id="add-card-btn" onclick="addSelectedCard()" style="width: 100%; padding: 1rem; background: #6366F1; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; margin-bottom: 2rem;">
                                <span class="material-icons" style="font-size: 20px;">add</span>
                                Add to Wallet
                            </button>

                            <!-- Earning Rates -->
                            <div style="width: 100%; margin-bottom: 2rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span class="material-icons" style="font-size: 14px; color: #9CA3AF;">trending_up</span>
                                    <div style="font-size: 0.7rem; font-weight: 700; color: #9CA3AF; letter-spacing: 0.1em; text-transform: uppercase;">EARNING RATES</div>
                                </div>
                                <div id="preview-earning-rates" style="display: flex; flex-direction: column;">
                                    <!-- Populated via JS -->
                                </div>
                            </div>

                            <!-- Credits -->
                            <div style="width: 100%;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span class="material-icons" style="font-size: 14px; color: #9CA3AF;">bolt</span>
                                    <div style="font-size: 0.7rem; font-weight: 700; color: #9CA3AF; letter-spacing: 0.1em; text-transform: uppercase;">CREDITS</div>
                                </div>
                                <div id="preview-credits" style="display: flex; flex-direction: column;">
                                    <!-- Populated via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Benefit Usage Modal (Redesigned) -->
<div id="benefit-modal" class="modal" style="display: none; align-items: center; justify-content: center; padding: 1rem;">
    <div class="modal-content" style="width: 400px; max-width: 95vw; padding: 0; border-radius: 24px; overflow: hidden; background: white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        
        <!-- Header (Dark) -->
        <div style="background: #111827; padding: 1.5rem; color: white; position: relative;">
            <button class="modal-close-btn" onclick="closeBenefitModal()" style="position: absolute; top: 1rem; right: 1rem; color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.1);">×</button>
            
            <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; color: white;" id="benefit-modal-title">Dining Credit</h3>
            <div style="display: inline-block; background: rgba(255,255,255,0.15); padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.9);" id="benefit-modal-subtitle">
                Gold Card
            </div>
        </div>

        <div style="padding: 2rem;">
            <!-- Month Navigator -->
            <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 2rem; background: #F9FAFB; padding: 0.75rem; border-radius: 12px;">
                <button onclick="navigatePeriod(-1)" style="background: none; border: none; color: #64748B; cursor: pointer; padding: 0.25rem;"><span class="material-icons" style="font-size: 18px;">chevron_left</span></button>
                <div style="font-weight: 700; color: #1F2937; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="material-icons" style="font-size: 18px; color: #6366F1;">calendar_today</span>
                    <span id="benefit-period-label">Sep</span>
                </div>
                <button onclick="navigatePeriod(1)" style="background: none; border: none; color: #64748B; cursor: pointer; padding: 0.25rem;"><span class="material-icons" style="font-size: 18px;">chevron_right</span></button>
            </div>

            <!-- Circular Progress -->
            <div style="margin-bottom: 2.5rem;">
                <div class="circular-progress" id="benefit-circular-progress">
                    <div class="circular-progress-content">
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.1em; margin-bottom: 0.25rem;">USAGE</div>
                        <div style="font-size: 2.5rem; font-weight: 800; color: #1F2937; line-height: 1; margin-bottom: 0.25rem;" id="benefit-current-used-display">$10</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #64748B;">of <span id="benefit-total-value-display">$10</span></div>
                    </div>
                </div>
            </div>

            <!-- Add Usage Input -->
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; border-top: 1px solid #F3F4F6; padding-top: 2rem; position: relative;">
                <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 1rem; color: #94A3B8; font-size: 0.75rem; font-weight: 600;">Add Usage</div>
                
                <div style="flex: 1; position: relative;">
                    <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94A3B8; font-weight: 600;">$</span>
                    <input type="number" id="benefit-amount-input" min="0" step="0.01" 
                           style="width: 100%; padding: 0.875rem 1rem 0.875rem 2rem; border: 1px solid #E5E7EB; border-radius: 12px; font-size: 1rem; font-weight: 600; color: #1F2937; margin-bottom: 0;"
                           placeholder="Remaining: $0">
                </div>
                <button id="btn-log-usage" onclick="saveBenefitUsage()" style="background: #111827; color: white; border: none; padding: 0.875rem 1.5rem; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s; min-width: 80px;">
                    Log
                </button>
            </div>

            <!-- Mark as Full -->
            <button id="mark-full-btn" onclick="markAsFull()" style="width: 100%; background: white; color: #1F2937; border: 1px solid #E5E7EB; padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                <span class="material-icons" style="font-size: 20px; margin-right: 0.5rem; color: #10B981; opacity: 0;">check</span>
                Mark <span id="benefit-period-label-btn" style="margin: 0 0.25rem;">Sep</span> as Full
            </button>
        </div>
    </div>
</div>

<!-- Anniversary Date Modal -->
<!-- Anniversary Date Modal -->
<div id="anniversary-modal" class="modal" style="display: none; align-items: center; justify-content: center;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0;">Set Card Anniversary</h3>
                <p style="color: #64748B; margin: 0; font-size: 0.875rem;">When did you get this card?</p>
            </div>
            <button class="modal-close" onclick="closeAnniversaryModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94A3B8;">×</button>
        </div>

        <!-- Card Info -->
        <div style="background: #F9FAFB; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
            <div style="font-size: 0.75rem; font-weight: 700; color: #64748B; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.5rem;">CARD</div>
            <div id="anniversary-card-name" style="font-weight: 700; font-size: 1.125rem; color: #1F2937;">Loading...</div>
        </div>

        <!-- Date Input -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1F2937;">Anniversary Date</label>
            <input type="date" id="anniversary-date-input" 
                   style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; font-weight: 600;">
            <p style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">This helps track which months/quarters are available for benefit tracking.</p>
        </div>

        <!-- Example -->
        <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="font-weight: 600; color: #92400E; margin-bottom: 0.25rem; font-size: 0.875rem;">💡 Example</div>
            <div style="color: #78350F; font-size: 0.875rem;">If you got your card in October 2025, months before October will be grayed out.</div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 0.75rem;">
            <button onclick="closeAnniversaryModal()" style="flex: 1; background: #F3F4F6; color: #64748B; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Cancel
            </button>
            <button onclick="saveAnniversaryDate()" style="flex: 1; background: #7C3AED; color: white; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Save Anniversary
            </button>
        </div>
    </div>
</div>



<script>
    // --- Manage Wallet Modal Logic ---
    const currentUserUid = "{{ request.session.uid }}";
    // allCardsData contains ALL cards (database), used for client-side filtering
    const allCardsData = {{ all_cards_json|safe }};
    // Initialize availableCards with allCardsData for legacy compatibility, will be filtered by JS
    let availableCards = allCardsData;

</script>
<!-- Remove Card Modal -->
<div id="remove-card-modal" class="modal" style="display: none; align-items: center; justify-content: center; z-index: 10001; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);">
    <div class="modal-content" style="width: 90% !important; max-width: 400px !important; height: auto !important; background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; margin: auto;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0; color: #EF4444;">Remove Card?</h3>
            <button class="modal-close" onclick="closeRemoveCardModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94A3B8;">×</button>
        </div>
        <p style="color: #475569; margin-bottom: 1.5rem; font-size: 1rem; line-height: 1.5;">Are you sure you want to remove <strong id="remove-card-name" style="color: #1F2937;">this card</strong> from your wallet?</p>
        <div style="display: flex; gap: 0.75rem;">
            <button onclick="closeRemoveCardModal()" style="flex: 1; background: #F3F4F6; color: #64748B; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#E5E7EB'" onmouseout="this.style.background='#F3F4F6'">Cancel</button>
            <button onclick="confirmRemoveCard()" style="flex: 1; background: #EF4444; color: white; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#DC2626'" onmouseout="this.style.background='#EF4444'">Remove</button>
        </div>
    </div>
</div>

<!-- Loader & Toast -->
<div id="global-loader">
    <div class="spinner"></div>
    <div style="margin-top: 1rem; font-weight: 600; color: #475569;">Processing...</div>
</div>
<div id="toast-container"></div>
{% endblock %}