{% extends 'auth_base.html' %}
{% load static %}

{% block breadcrumb_section %}Overview{% endblock %}
{% load card_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=1.5">
<link rel="stylesheet" href="{% static 'css/mobile_modal.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/dashboard_modules/utils.js' %}"></script>
<script src="{% static 'js/dashboard_modules/state.js' %}"></script>
<script src="{% static 'js/dashboard_modules/ui_stats.js' %}"></script>
<script src="{% static 'js/dashboard_modules/ui_chase.js' %}"></script>
<script src="{% static 'js/dashboard_modules/ui_personality.js' %}"></script>
<script src="{% static 'js/dashboard_modules/ui_core.js' %}?v=1.6"></script>
<script src="{% static 'js/dashboard_modules/actions.js' %}"></script>
<script src="{% static 'js/dashboard_modules/mobile_ui.js' %}"></script>
<script src="{% static 'js/dashboard_modules/wallet_stack.js' %}"></script>
<script src="{% static 'js/dashboard_modules/wallet_add.js' %}"></script>
<script src="{% static 'js/dashboard_modules/wallet_preview.js' %}"></script>
<script src="{% static 'js/dashboard_modules/wallet_modal.js' %}"></script>
<script src="{% static 'js/dashboard_modules/benefits_filters.js' %}"></script>
<script src="{% static 'js/dashboard_modules/benefits_modal.js' %}"></script>
<script src="{% static 'js/dashboard_modules/benefits_actions.js' %}"></script>
<script src="{% static 'js/dashboard_modules/benefits.js' %}?v=1.6"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pulltorefreshjs/0.1.25/index.umd.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const ptr = PullToRefresh.init({
            mainElement: '.content-scrollable',
            onRefresh: function() {
                window.location.reload();
            },
            distThreshold: 70, // Distance required to trigger refresh
            distMax: 90,       // Max distance
            distReload: 60,    // Distance to hold while loading
            iconArrow: '<span class="material-icons" style="transform: rotate(180deg);">arrow_upward</span>',
            iconRefreshing: '<span class="material-icons loop-animation">refresh</span>',
            instructionsPullToRefresh: 'Pull down to refresh',
            instructionsReleaseToRefresh: 'Release to refresh',
            instructionsRefreshing: 'Refreshing...'
        });
    });
</script>
<style>
    /* Simple rotation animation for the refresh icon */
    @keyframes spin { 100% { -webkit-transform: rotate(360deg); transform:rotate(360deg); } }
    .loop-animation { animation:spin 1s linear infinite; }
    
    /* Ensure the pull-to-refresh element is above other content */
    .ptr--ptr { z-index: 100; }
</style>
{% endblock %}

{% block content %}
<!-- Hidden CSRF token for JavaScript -->
<form style="display: none;">
    {% csrf_token %}
</form>

{% include "dashboard/partials/_header.html" %}
{% include "dashboard/partials/_top_grid.html" %}
{% include "dashboard/partials/_filters.html" %}
{% include "dashboard/partials/_section_action.html" %}
{% include "dashboard/partials/_section_maxed.html" %}
{% include "dashboard/partials/_section_ignored.html" %}

<!-- Modals -->
{% include "dashboard/modals/_manage_wallet.html" %}
{% include "dashboard/modals/_benefit_usage.html" %}
{% include "dashboard/modals/_anniversary.html" %}
{% include "dashboard/modals/_edit_anniversary.html" %}
{% include "dashboard/modals/_remove_card.html" %}
{% include "dashboard/modals/_chase_524_info.html" %}

{% include "dashboard/partials/_ui_elements.html" %}

<script>
    // --- Manage Wallet Modal Logic ---
    const currentUserUid = "{{ request.session.uid }}";
    // allCardsData contains ALL cards (database), used for client-side filtering
    const allCardsData = {{ all_cards_json|safe }};
    // Initialize availableCards with allCardsData for legacy compatibility, will be filtered by JS
    let availableCards = allCardsData;
</script>
{% endblock %}