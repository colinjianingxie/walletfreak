{% extends 'base.html' %}

{% block content %}
<div class="container" style="padding: 3rem 0;">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1>Subscription Tracker</h1>
            <p>Track your recurring credits and maximize your annual fees.</p>
        </div>
        <a href="{% url 'card_list' %}" class="btn btn-outline">‚öôÔ∏è Manage Wallet</a>
    </div>

    <!-- Notifications Toggle -->
    <div class="card mb-4"
        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 200px;">
            <div
                style="width: 48px; height: 48px; background: #e0e7ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.5rem;">
                üîî
            </div>
            <div>
                <h3 style="margin: 0; font-size: 1.1rem;">Email Notifications</h3>
                <p style="margin: 0; font-size: 0.9rem;">Get alerts for expiring benefits</p>
            </div>
        </div>
        <label class="switch">
            <input type="checkbox" checked>
            <span class="slider round"></span>
        </label>
    </div>

    <!-- Stats Row -->
    <div class="card mb-4">
        <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: var(--text-muted);">Utilization</span>
                    <span style="font-weight: 700;">${{ total_used_value }} / ${{ total_potential_value }}</span>
                </div>
                <div style="height: 12px; background: #f1f5f9; border-radius: 6px; overflow: hidden;">
                    <div
                        style="width: {% if total_potential_value > 0 %}{% widthratio total_used_value total_potential_value 100 %}{% else %}0{% endif %}%; height: 100%; background: var(--primary); transition: width 0.5s ease;">
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <div
                    style="background: #eff6ff; padding: 1rem; border-radius: 8px; text-align: center; min-width: 100px;">
                    <div style="font-size: 0.8rem; font-weight: 700; color: var(--primary); text-transform: uppercase;">
                        Cards</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--dark);">{{ active_cards|length }}
                    </div>
                </div>
                <div
                    style="background: #eff6ff; padding: 1rem; border-radius: 8px; text-align: center; min-width: 100px;">
                    <div style="font-size: 0.8rem; font-weight: 700; color: var(--primary); text-transform: uppercase;">
                        Credits</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--dark);">{{ all_benefits|length }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not active_cards %}
    <!-- Empty State -->
    <div class="card text-center" style="padding: 4rem 2rem; border-style: dashed; border-width: 2px;">
        <p style="font-size: 1.2rem; margin-bottom: 2rem;">You haven't added any cards to your wallet yet.</p>
        <a href="{% url 'card_list' %}" class="btn btn-primary">Add your cards now</a>
    </div>
    {% else %}

    <!-- All Benefits Section -->
    {% if all_benefits %}
    <div class="card mb-4" style="background: linear-gradient(45deg, #2c3e50, #3498db); border: none;">
        <h3 style="color: white; margin-bottom: 1rem;">üí≥ Credit Card Benefits</h3>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            {% for benefit in all_benefits %}
            <div data-benefit-id="{{ benefit.benefit_id }}"
                style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; backdrop-filter: blur(5px); display: flex; flex-direction: column; justify-content: space-between; {% if benefit.is_used %}opacity: 0.7;{% endif %}">
                <div>
                    <p style="font-weight: bold; color: #fff; margin-bottom: 0.25rem;">{{ benefit.benefit_name }}</p>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem;">{{ benefit.card_name }}</p>
                </div>
                <div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span class="badge" style="background: rgba(255,255,255,0.2); color: white;">
                            {% if benefit.frequency != 'Annual' %}{{ benefit.frequency }}{% endif %}
                            {% if benefit.reset_date %}
                            (Resets: {{ benefit.reset_date|date:"M d" }})
                            {% endif %}
                        </span>
                        <span
                            style="color: {% if benefit.is_used %}#95a5a6{% else %}#4cd137{% endif %}; font-weight: 600;">
                            {% if benefit.is_used %}‚úì Used{% else %} ${{ benefit.remaining }} Left{% endif %}
                        </span>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                        <input type="number"
                               id="amount-{{ benefit.card_id }}-{{ benefit.benefit_id }}"
                               min="0"
                               max="{{ benefit.amount }}"
                               step="0.01"
                               value="{{ benefit.used }}"
                               placeholder="Amount used"
                               style="flex: 1; padding: 0.5rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.9); color: #2c3e50; font-size: 0.9rem;">
                        <button type="button"
                                onclick="updateBenefitAmount('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', this)"
                                class="btn btn-sm"
                                style="background: rgba(255,255,255,0.9); color: #2c3e50; font-weight: 600; border: none; padding: 0.5rem 1rem;">
                            Update
                        </button>
                    </div>
                    <form action="{% url 'toggle_benefit_usage' benefit.card_id benefit.benefit_id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm"
                            style="width: 100%; background: {% if benefit.is_used %}rgba(255,255,255,0.5){% else %}rgba(255,255,255,0.9){% endif %}; color: #2c3e50; font-weight: 600; border: none;">
                            {% if benefit.is_used %}‚Ü∫ Reset{% else %}‚úì Mark Full{% endif %}
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Active Cards List -->
    <div class="grid">
        {% for card in active_cards %}
        <div class="card">
            <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                <div
                    style="width: 60px; height: 40px; background: #f1f5f9; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                    {% if card.image_url %}
                    <img src="{{ card.image_url }}" alt="{{ card.name }}" style="max-width: 100%; max-height: 100%;">
                    {% else %}
                    üí≥
                    {% endif %}
                </div>
                <div>
                    <h3 style="font-size: 1.1rem; margin: 0;">{{ card.name }}</h3>
                    <span class="badge badge-success">Active</span>
                </div>
            </div>

            <!-- Anniversary Date Input -->
            <div style="margin-bottom: 1rem; padding: 0.5rem; background: #f8fafc; border-radius: 4px;">
                <form action="{% url 'update_anniversary' card.id %}" method="POST"
                    style="display: flex; align-items: center; gap: 0.5rem;">
                    {% csrf_token %}
                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--text-muted);">Anniversary:</label>
                    <input type="date" name="anniversary_date" value="{{ card.anniversary_date|default:'' }}"
                        style="padding: 0.25rem; font-size: 0.8rem; border: 1px solid #cbd5e1; border-radius: 4px;">
                    <button type="submit" class="btn btn-outline btn-sm"
                        style="padding: 0.25rem 0.5rem; font-size: 0.7rem;">Save</button>
                </form>
            </div>

            <div
                style="border-top: 1px solid #f1f5f9; padding-top: 1rem; margin-top: 1rem; display: flex; gap: 0.5rem;">
                <a href="{% url 'card_detail' card.card_id %}" class="btn btn-outline btn-sm" style="flex: 1;">View
                    Benefits</a>

                <!-- Remove Card Button -->
                <button type="button" class="btn btn-outline btn-sm remove-card-btn" data-card-id="{{ card.id }}"
                    data-card-name="{{ card.name }}"
                    style="color: var(--danger); border-color: var(--danger);">Remove</button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Remove Card Confirmation Modal -->
<div id="removeCardModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 400px; margin: 2rem; padding: 2rem;">
        <h3 style="margin-bottom: 1rem;">Remove Card from Wallet?</h3>
        <p id="removeCardMessage" style="margin-bottom: 1.5rem; color: var(--text-muted);"></p>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button type="button" id="cancelRemove" class="btn btn-outline">Cancel</button>
            <form id="removeCardForm" method="POST" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary"
                    style="background: var(--danger); border-color: var(--danger);">Remove</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Update benefit amount with custom value
    async function updateBenefitAmount(cardId, benefitId, button) {
        const inputId = `amount-${cardId}-${benefitId}`;
        const input = document.getElementById(inputId);
        const amount = parseFloat(input.value) || 0;
        
        // Disable button during request
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '...';
        
        try {
            const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
            const url = `/dashboard/update-benefit/${cardId}/${benefitId}/`;
            
            const formData = new FormData();
            formData.append('amount', amount);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update the benefit card
                const benefitCard = button.closest('[data-benefit-id]');
                const statusSpan = benefitCard.querySelector('span[style*="font-weight: 600"]');
                
                if (data.is_used) {
                    if (benefitCard) benefitCard.style.opacity = '0.7';
                    if (statusSpan) {
                        statusSpan.style.color = '#95a5a6';
                        statusSpan.textContent = '‚úì Used';
                    }
                } else {
                    if (benefitCard) benefitCard.style.opacity = '1';
                    if (statusSpan) {
                        statusSpan.style.color = '#4cd137';
                        statusSpan.textContent = ` $${data.remaining.toFixed(2)} Left`;
                    }
                }
                
                // Update utilization stats
                const utilizationText = document.querySelector('span[style*="font-weight: 700"]');
                if (utilizationText) {
                    utilizationText.textContent = `$${data.total_used_value.toFixed(2)} / $${data.total_potential_value.toFixed(2)}`;
                }
                
                const progressBar = document.querySelector('div[style*="background: var(--primary)"]');
                if (progressBar) {
                    progressBar.style.width = `${data.utilization_percentage}%`;
                }
                
                // Update the input value to reflect what was actually saved
                input.value = data.used.toFixed(2);
            }
        } catch (error) {
            console.error('Error updating benefit:', error);
            alert('Failed to update benefit amount');
        } finally {
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    // AJAX Benefit Toggle
    document.querySelectorAll('form[action*="toggle-benefit"]').forEach(form => {
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const button = this.querySelector('button[type="submit"]');
            // Use the data-benefit-id attribute to find the card
            const benefitCard = this.closest('[data-benefit-id]');

            // Find the status span - navigate up to the parent div, then find the status container
            const parentDiv = this.parentElement;
            const statusContainer = parentDiv ? parentDiv.querySelector('div[style*="display: flex"]') : null;
            const statusSpan = statusContainer ? statusContainer.querySelector('span[style*="font-weight: 600"]') : null;

            const originalButtonText = button.textContent.trim();

            // Disable button during request
            button.disabled = true;
            button.textContent = '...';

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': this.querySelector('[name="csrfmiddlewaretoken"]').value,
                    },
                    body: new FormData(this)
                });

                const data = await response.json();

                if (data.success) {
                    // Update benefit card styling
                    if (data.is_used) {
                        if (benefitCard) benefitCard.style.opacity = '0.7';
                        button.textContent = '‚Ü∫ Uncheck';
                        button.style.background = 'rgba(255,255,255,0.5)';
                        if (statusSpan) {
                            statusSpan.style.color = '#95a5a6';
                            statusSpan.textContent = '‚úì Used';
                        }
                    } else {
                        if (benefitCard) benefitCard.style.opacity = '1';
                        button.textContent = '‚úì Mark as Used';
                        button.style.background = 'rgba(255,255,255,0.9)';
                        if (statusSpan) {
                            statusSpan.style.color = '#4cd137';
                            statusSpan.textContent = ` $${data.remaining} Left`;
                        }
                    }

                    // Update utilization stats
                    const utilizationText = document.querySelector('span[style*="font-weight: 700"]');
                    if (utilizationText && utilizationText.textContent.includes('/')) {
                        utilizationText.textContent = `$${data.total_used_value} / $${data.total_potential_value}`;
                    }

                    // Update progress bar
                    const progressBar = document.querySelector('[style*="height: 12px"]').querySelector('div');
                    if (progressBar) {
                        progressBar.style.width = `${data.utilization_percentage}%`;
                    }
                } else {
                    console.error('Toggle failed:', data);
                    button.textContent = originalButtonText;
                }
            } catch (error) {
                console.error('Error toggling benefit:', error);
                button.textContent = originalButtonText;
            } finally {
                button.disabled = false;
            }
        });
    });

    // Remove card modal functionality
    const modal = document.getElementById('removeCardModal');
    const removeForm = document.getElementById('removeCardForm');
    const removeMessage = document.getElementById('removeCardMessage');
    const cancelBtn = document.getElementById('cancelRemove');

    document.querySelectorAll('.remove-card-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const cardId = this.dataset.cardId;
            const cardName = this.dataset.cardName;

            removeMessage.textContent = `Are you sure you want to remove "${cardName}" from your wallet?`;
            removeForm.action = `/dashboard/remove-card/${cardId}/`;
            modal.style.display = 'flex';
        });
    });

    cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
</script>

<style>
    /* Toggle Switch */
    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 28px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
    }

    input:checked+.slider {
        background-color: var(--primary);
    }

    input:focus+.slider {
        box-shadow: 0 0 1px var(--primary);
    }

    input:checked+.slider:before {
        -webkit-transform: translateX(22px);
        -ms-transform: translateX(22px);
        transform: translateX(22px);
    }

    /* Rounded sliders */
    .slider.round {
        border-radius: 34px;
    }

    .slider.round:before {
        border-radius: 50%;
    }
</style>
{% endblock %}