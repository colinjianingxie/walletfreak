{% extends 'auth_base.html' %}
{% load static %}

{% block content %}
<!-- Hidden CSRF token for JavaScript -->
<form style="display: none;">
    {% csrf_token %}
</form>

<!-- Dashboard Header -->
<div style="margin-bottom: 2.5rem;">
    <!-- Greeting Section -->
    <div style="display: flex; align-items: center; gap: 1.5rem;">
        <div
            style="width: 60px; height: 60px; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);">
            <span class="material-icons" style="font-size: 32px;">flight</span>
        </div>
        <div>
            <h1 style="font-size: 2rem; font-weight: 800; margin: 0; line-height: 1.2;">
                Hey, <span style="color: #7C3AED;">{% if user.first_name %}{{ user.first_name }}{% else %}Alex{% endif %}!</span>
            </h1>
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                {% if assigned_personality %}
                <a href="{% url 'personality_results' %}" style="text-decoration: none;">
                    <span
                        style="background: #E0F2FE; color: #0284C7; font-size: 0.7rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 4px; letter-spacing: 0.05em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='#BAE6FD'"
                        onmouseout="this.style.background='#E0F2FE'">
                        <span class="material-icons" style="font-size: 10px; vertical-align: middle;">psychology</span>
                        {{ assigned_personality.name }}
                    </span>
                </a>
                {% if assigned_personality.match_score %}
                <span style="color: #64748B; font-size: 0.9rem;">{{ assigned_personality.match_score }} card{{ assigned_personality.match_score|pluralize }} match</span>
                {% endif %}
                {% else %}
                <span style="color: #64748B; font-size: 0.9rem;">
                    {% if active_cards|length == 2 %}
                    Add 1 more card to discover your personality
                    {% elif active_cards|length == 1 %}
                    Add 2 more cards to discover your personality
                    {% else %}
                    Add 3 cards to discover your personality
                    {% endif %}
                </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Search Bar (Right Aligned) -->
        <div style="margin-left: auto; width: 300px;">
            <div style="position: relative;">
                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9CA3AF;"><span class="material-icons" style="font-size: 18px;">search</span></span>
                <input type="text" placeholder="Search benefits..." style="width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid #E5E7EB; border-radius: 99px; font-size: 0.9rem; background: white;">
            </div>
        </div>
    </div>
</div>

<!-- Top Grid: Annual Value + My Wallet + Add New Card -->
<div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2.5rem;">
    <!-- Annual Value Card (Purple) -->
    <div
        style="background: linear-gradient(135deg, #6366F1 0%, #7C3AED 100%); border-radius: 24px; padding: 2rem; color: white; box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 240px;">
        
        <!-- Top Row -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 1;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                <span class="material-icons" style="font-size: 24px;">trending_up</span>
            </div>
            <div style="font-size: 0.875rem; font-weight: 500; opacity: 0.9;">Annual Value</div>
        </div>

        <!-- Bottom Row -->
        <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem; opacity: 0.9;">Total Value Extracted</div>
            <div style="font-size: 3.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; letter-spacing: -0.02em;">
                ${{ total_used_value|floatformat:0 }}<span style="font-size: 1.75rem; font-weight: 500; opacity: 0.7;">.00</span>
            </div>
            <div style="font-size: 0.875rem; opacity: 0.8;">
                Out of ${{ total_potential_value|floatformat:0 }} available credits
            </div>
        </div>
    </div>

    <!-- My Wallet Card -->
    <div
        style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; justify-content: space-between;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 0.75rem; font-weight: 700; color: #64748B; letter-spacing: 0.05em; margin-bottom: 0.5rem; text-transform: uppercase;">My Wallet</div>
                <div style="display: flex; align-items: baseline; gap: 0.5rem;">
                    <div style="font-size: 3rem; font-weight: 800; color: #1F2937; line-height: 1;">{{ active_cards|length }}</div>
                    <div style="font-size: 0.9rem; color: #64748B;">Cards</div>
                </div>
            </div>
            <div style="width: 40px; height: 40px; background: #FDF4FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #D946EF;">
                <span class="material-icons" style="font-size: 20px;">credit_card</span>
            </div>
        </div>
        
        <!-- Mini card previews -->
        <div style="display: flex; gap: 0.5rem; margin: 1rem 0;">
            <div style="width: 40px; height: 26px; background: #CBD5E1; border-radius: 4px;"></div>
            <div style="width: 40px; height: 26px; background: #3B82F6; border-radius: 4px;"></div>
            <div style="width: 40px; height: 26px; background: #F59E0B; border-radius: 4px;"></div>
        </div>

        <button onclick="openManageWalletModal('stack')" style="width: 100%; padding: 0.75rem; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; font-weight: 600; color: #1F2937; cursor: pointer; transition: all 0.2s;">
            Manage Wallet
        </button>
    </div>

    <!-- Add New Card Trigger -->
    <div
        style="background: white; border-radius: 24px; padding: 1.5rem; border: 2px dashed #E5E7EB; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: all 0.2s;"
        onclick="openManageWalletModal('add')"
        onmouseover="this.style.borderColor='#7C3AED'; this.style.background='#F5F3FF'"
        onmouseout="this.style.borderColor='#E5E7EB'; this.style.background='white'">
        
        <div style="width: 64px; height: 64px; background: #EEF2FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #6366F1; margin-bottom: 1rem;">
            +
        </div>
        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">Add New Card</h3>
        <p style="color: #64748B; font-size: 0.875rem; margin: 0;">Track a new bonus or fee</p>
    </div>
</div>


<!-- Action Needed Section -->
<div style="margin-bottom: 3rem;">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
        <div style="width: 32px; height: 32px; background: #FEF3C7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #D97706;">
            <span class="material-icons" style="font-size: 18px;">priority_high</span>
        </div>
        <h2 style="font-size: 1.25rem; font-weight: 800; margin: 0; color: #1F2937;">Action Needed <span style="color: #94A3B8; font-weight: 600; font-size: 1rem; margin-left: 0.25rem;">({{ action_needed_benefits|length }})</span></h2>
    </div>

    {% if not action_needed_benefits %}
    <div style="text-align: center; padding: 3rem 1rem; background: white; border-radius: 24px; border: 1px solid #F3F4F6;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">check_circle</span></div>
        <div style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem; color: #1F2937;">All caught up!</div>
        <div style="color: #64748B;">You've maximized all your benefits for the current period.</div>
    </div>
    {% else %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(520px, 1fr)); gap: 1.5rem;">
        {% for benefit in action_needed_benefits %}
        <div class="benefit-card" style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.2s;">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;">
                    <div style="width: 48px; height: 32px; background: #94A3B8; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">
                        {% if 'platinum' in benefit.card_name|lower %}PLATINUM{% elif 'gold' in benefit.card_name|lower %}GOLD{% elif 'sapphire' in benefit.card_name|lower %}SAPPHIRE{% else %}CARD{% endif %}
                    </div>
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">{{ benefit.benefit_name }}</h3>
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">
                            {{ benefit.card_name }} â€¢ {{ benefit.frequency }}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.25rem; font-weight: 800; color: #1F2937;">${{ benefit.amount|floatformat:0 }}</div>
                    <div style="font-size: 0.7rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">PER PERIOD</div>
                </div>
            </div>

            <!-- Tracker -->
            {% if 'Monthly' in benefit.frequency %}
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {% for period in benefit.periods %}
                <div class="period-pill {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ period.max_value|default:benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}', '{{ period.label }}', '{{ period.status }}')"{% endif %}
                     style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; {% if not period.is_available %}opacity: 0.3; cursor: not-allowed;{% else %}cursor: pointer;{% endif %}">
                    <div class="pill-label">{{ period.label }}</div>
                    <div style="font-size: 0.65rem; font-weight: 600; color: #64748B;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 12px;">check</span>
                        {% elif period.status == 'partial' %}
                        <div style="width: 6px; height: 2px; background: #3B82F6; border-radius: 1px;"></div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% elif 'Quarterly' in benefit.frequency or 'Semi-annually' in benefit.frequency %}
            <div style="display: flex; gap: 1rem;">
                {% for period in benefit.periods %}
                <div class="period-pill large {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ period.max_value|default:benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}', '{{ period.label }}', '{{ period.status }}')"{% endif %}
                     style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; {% if not period.is_available %}opacity: 0.3; cursor: not-allowed;{% else %}cursor: pointer;{% endif %}">
                    <div class="pill-label">{{ period.label }}</div>
                    <div style="font-size: 0.875rem; font-weight: 700; color: #1F2937;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 16px;">check</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Annual Progress Bar -->
            <div style="background: #F8FAFC; border-radius: 12px; padding: 1rem; border: 1px solid #E2E8F0; cursor: pointer;"
                 onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ benefit.periods.0.key }}', '{{ benefit.periods.0.label }}', '{{ benefit.periods.0.status }}')">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #64748B;">
                    <span>{{ benefit.periods.0.label }}</span>
                    {% if benefit.used > 0 %}<span style="color: #6366F1;">${{ benefit.used|floatformat:0 }} used</span>{% endif %}
                </div>
                <div style="height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden;">
                    <div style="width: {% widthratio benefit.used benefit.amount 100 %}%; height: 100%; background: #6366F1; border-radius: 4px;"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Maxed Out Section -->
{% if maxed_out_benefits %}
<div style="margin-bottom: 3rem;">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
        <div style="width: 32px; height: 32px; background: #DCFCE7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #16A34A;">
            <span class="material-icons" style="font-size: 18px;">check_circle</span>
        </div>
        <h2 style="font-size: 1.25rem; font-weight: 800; margin: 0; color: #1F2937;">Maxed Out <span style="color: #94A3B8; font-weight: 600; font-size: 1rem; margin-left: 0.25rem;">({{ maxed_out_benefits|length }})</span></h2>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(520px, 1fr)); gap: 1.5rem;">
        {% for benefit in maxed_out_benefits %}
        <div class="benefit-card" style="background: white; border-radius: 24px; padding: 1.5rem; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.2s;">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;">
                    <div style="width: 48px; height: 32px; background: #CBD5E1; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">
                        {% if 'platinum' in benefit.card_name|lower %}PLATINUM{% elif 'gold' in benefit.card_name|lower %}GOLD{% elif 'sapphire' in benefit.card_name|lower %}SAPPHIRE{% else %}CARD{% endif %}
                    </div>
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin: 0 0 0.25rem 0; color: #1F2937;">{{ benefit.benefit_name }}</h3>
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">
                            {{ benefit.card_name }} â€¢ {{ benefit.frequency }}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.25rem; font-weight: 800; color: #1F2937;">${{ benefit.amount|floatformat:0 }}</div>
                    <div style="font-size: 0.7rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; text-transform: uppercase;">PER PERIOD</div>
                </div>
            </div>

            <!-- Tracker -->
            {% if 'Monthly' in benefit.frequency %}
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {% for period in benefit.periods %}
                <div class="period-pill {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ period.max_value|default:benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}', '{{ period.label }}', '{{ period.status }}')"{% endif %}
                     style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; {% if not period.is_available %}opacity: 0.3; cursor: not-allowed;{% else %}cursor: pointer;{% endif %}">
                    <div class="pill-label">{{ period.label }}</div>
                    <div style="font-size: 0.65rem; font-weight: 600; color: #64748B;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 12px;">check</span>
                        {% elif period.status == 'partial' %}
                        <div style="width: 6px; height: 2px; background: #3B82F6; border-radius: 1px;"></div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% elif 'Quarterly' in benefit.frequency or 'Semi-annually' in benefit.frequency %}
            <div style="display: flex; gap: 1rem;">
                {% for period in benefit.periods %}
                <div class="period-pill large {% if period.status == 'full' %}full{% elif period.status == 'partial' %}partial{% endif %} {% if period.is_current %}current{% endif %} {% if not period.is_available %}unavailable{% endif %}"
                     {% if period.is_available %}onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ period.max_value|default:benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ period.key }}', '{{ period.label }}', '{{ period.status }}')"{% endif %}
                     style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; {% if not period.is_available %}opacity: 0.3; cursor: not-allowed;{% else %}cursor: pointer;{% endif %}">
                    <div class="pill-label">{{ period.label }}</div>
                    <div style="font-size: 0.875rem; font-weight: 700; color: #1F2937;">${{ period.max_value|floatformat:0 }}</div>
                    <div class="pill-status">
                        {% if period.status == 'full' %}
                        <span class="material-icons" style="font-size: 16px;">check</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Annual Progress Bar -->
            <div style="background: #F8FAFC; border-radius: 12px; padding: 1rem; border: 1px solid #E2E8F0; cursor: pointer;"
                 onclick="openBenefitModal('{{ benefit.card_id }}', '{{ benefit.benefit_id }}', '{{ benefit.benefit_name|escapejs }}', {{ benefit.amount }}, {{ benefit.used }}, '{{ benefit.frequency|escapejs }}', '{{ benefit.periods.0.key }}', '{{ benefit.periods.0.label }}', '{{ benefit.periods.0.status }}')">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #64748B;">
                    <span>{{ benefit.periods.0.label }}</span>
                    {% if benefit.used > 0 %}<span style="color: #6366F1;">${{ benefit.used|floatformat:0 }} used</span>{% endif %}
                </div>
                <div style="height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden;">
                    <div style="width: 100%; height: 100%; background: #16A34A; border-radius: 4px;"></div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Manage Wallet Modal (Redesigned to match image) -->
<div id="manage-wallet-modal" class="modal" style="display: none; align-items: center; justify-content: center; padding: 2rem;">
    <div class="modal-content" style="width: 900px; max-width: 95vw; max-height: 90vh; padding: 0; display: flex; flex-direction: column; overflow: hidden; border-radius: 16px; background: white;">
        
        <!-- Tab Navigation -->
        <div style="display: flex; border-bottom: 2px solid #F3F4F6; padding: 0 2rem;">
            <button class="wallet-tab active" onclick="switchTab('stack')" id="tab-stack" style="padding: 1.25rem 2rem; border: none; background: none; font-weight: 700; font-size: 1rem; color: #64748B; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s;">
                Manage Wallet
            </button>
            <button class="wallet-tab" onclick="switchTab('add')" id="tab-add" style="padding: 1.25rem 2rem; border: none; background: none; font-weight: 700; font-size: 1rem; color: #64748B; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s;">
                Find a Card
            </button>
            <button class="modal-close-btn" onclick="closeManageWalletModal()" style="margin-left: auto; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94A3B8; padding: 1rem;">Ã—</button>
        </div>
        
        <!-- Tab Content Area -->
        <div style="flex: 1; display: flex; overflow: hidden;">
            
            <!-- Tab 1: Manage Wallet (My Stack) -->
            <div id="content-stack" style="flex: 1; padding: 2rem; display: flex; flex-direction: column; overflow-y: auto;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <span class="material-icons" style="font-size: 20px; color: #6366F1;">credit_card</span>
                    <h3 style="font-size: 1rem; font-weight: 700; margin: 0; color: #1F2937;">My Stack</h3>
                    <span style="background: #F3F4F6; color: #64748B; font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 99px; margin-left: 0.5rem;">{{ active_cards|length }}</span>
                </div>
                
                <div style="flex: 1; overflow-y: auto;">
                    {% if active_cards %}
                        {% for card in active_cards %}
                        <div onclick="openCardModal('{{ card.id }}')" style="display: flex; align-items: center; padding: 1rem; border: 1px solid #E2E8F0; border-radius: 12px; margin-bottom: 1rem; background: white; cursor: pointer; transition: all 0.2s; position: relative;" onmouseover="this.style.borderColor='#6366F1'; this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1)';" onmouseout="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none';">
                            <div style="width: 60px; height: 40px; background: {% if 'chase' in card.name|lower %}#117ACA{% elif 'amex' in card.name|lower or 'american express' in card.name|lower %}#2563EB{% elif 'capital' in card.name|lower %}#0F172A{% else %}#CBD5E1{% endif %}; border-radius: 6px; margin-right: 1rem;"></div>
                            
                            <div>
                                <div style="font-weight: 700; color: #1F2937;">{{ card.name }}</div>
                                <div style="font-size: 0.85rem; color: #64748B;">{{ card.issuer }}</div>
                            </div>
                            
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;" onclick="event.stopPropagation();">
                                <button onclick="openAnniversaryModal('{{ card.id }}', '{{ card.name|escapejs }}', '{{ card.anniversary_date|default:'' }}')" 
                                        style="background: none; border: none; cursor: pointer; color: #94A3B8; padding: 0.5rem; transition: color 0.2s;" 
                                        onmouseover="this.style.color='#6366F1'" 
                                        onmouseout="this.style.color='#94A3B8'"
                                        title="Edit Anniversary Date">
                                    <span class="material-icons" style="font-size: 20px;">event</span>
                                </button>
                                
                                <form method="POST" action="{% url 'remove_card' card.id %}" style="margin: 0;" onsubmit="return confirm('Remove this card from your wallet?');">
                                    {% csrf_token %}
                                    <button type="submit" style="background: none; border: none; cursor: pointer; color: #94A3B8; padding: 0.5rem; transition: color 0.2s;" onmouseover="this.style.color='#EF4444'" onmouseout="this.style.color='#94A3B8'" title="Remove Card">
                                        <span class="material-icons" style="font-size: 20px;">delete</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 3rem; color: #94A3B8;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">credit_card</span></div>
                            <p>No cards in your wallet yet.</p>
                            <button onclick="switchTab('add')" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #6366F1; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                + Add New Card
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Tab 2: Find a Card -->
            <div id="content-add" style="flex: 1; display: none; overflow: hidden;">
                <div style="display: flex; height: 100%;">
                    <!-- Left Column: Search & List -->
                    <div style="flex: 1; padding: 2rem; border-right: 1px solid #E2E8F0; display: flex; flex-direction: column; overflow: hidden;">
                        <p style="color: #64748B; font-size: 0.9rem; margin-bottom: 1.5rem;">Search by name or issuer to add it to your wallet.</p>
                        
                        <div style="position: relative; margin-bottom: 1.5rem;">
                            <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9CA3AF;"><span class="material-icons" style="font-size: 18px;">search</span></span>
                            <input type="text" id="card-search-input" placeholder="Search e.g. 'Sapphire' or 'Amex'" 
                                   style="width: 100%; padding: 0.875rem 1rem 0.875rem 2.5rem; border: 1px solid #E2E8F0; border-radius: 12px; font-size: 0.95rem;">
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em; margin-bottom: 0.75rem;">QUICK ADD</div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="quick-add-btn" onclick="filterCards('Chase')">Chase</button>
                                <button class="quick-add-btn" onclick="filterCards('Amex')">Amex</button>
                                <button class="quick-add-btn" onclick="filterCards('Capital One')">Capital One</button>
                                <button class="quick-add-btn" onclick="filterCards('Citi')">Citi</button>
                            </div>
                        </div>
                        
                        <div id="card-results-list" style="overflow-y: auto; flex: 1;">
                            <!-- Results populated via JS -->
                        </div>
                    </div>
                    
                    <!-- Right Column: Card Preview -->
                    <div style="width: 360px; padding: 2rem; background: white; display: flex; flex-direction: column; align-items: center; overflow-y: auto;">
                        <div id="card-preview-empty" style="color: #94A3B8; text-align: center; margin-top: 4rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"><span class="material-icons" style="font-size: 48px;">credit_card</span></div>
                            <p>Select a card to preview</p>
                        </div>
                        
                        <div id="card-preview-content" style="display: none; width: 100%;">
                            <!-- Card Visual -->
                            <div id="preview-card-visual" style="width: 100%; max-width: 280px; height: 176px; background: linear-gradient(135deg, #6366F1, #8B5CF6); border-radius: 16px; margin: 0 auto 1.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.15); padding: 1.25rem; display: flex; flex-direction: column; justify-content: space-between; color: white; position: relative; overflow: hidden;">
                                <div id="preview-issuer" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.1em;">CHASE</div>
                                <div style="font-size: 1rem; letter-spacing: 0.15em; font-family: 'Courier New', monospace;">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242</div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                    <div style="font-size: 0.75rem;">YOUR NAME</div>
                                    <div style="display: flex; gap: 2px;">
                                        <div style="width: 18px; height: 18px; background: #EB001B; border-radius: 50%; opacity: 0.9;"></div>
                                        <div style="width: 18px; height: 18px; background: #F79E1B; border-radius: 50%; margin-left: -6px; opacity: 0.9;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <h3 id="preview-card-name" style="font-size: 1.5rem; font-weight: 800; color: #1F2937; margin: 0 0 0.25rem 0; text-align: left;">Sapphire Preferred</h3>
                            <p id="preview-card-issuer-text" style="color: #64748B; margin: 0 0 1.5rem 0; text-align: left;">Chase</p>
                            
                            <!-- All Benefits -->
                            <!-- Earning Rates -->
                            <div style="margin-bottom: 1.5rem;" id="preview-earning-rates-container">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span class="material-icons" style="font-size: 16px; color: #94A3B8;">trending_up</span>
                                    <span style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em;">EARNING RATES</span>
                                </div>
                                <div id="preview-earning-rates" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                    <!-- Populated via JS -->
                                </div>
                            </div>

                            <!-- Credits -->
                            <div style="margin-bottom: 1.5rem;" id="preview-credits-container">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span class="material-icons" style="font-size: 16px; color: #94A3B8;">bolt</span>
                                    <span style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.05em;">CREDITS</span>
                                </div>
                                <div id="preview-credits" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <!-- Populated via JS -->
                                </div>
                            </div>
                            
                            <!-- Add to Wallet Button -->
                            <button id="add-card-btn" onclick="addSelectedCard()" style="width: 100%; padding: 1rem; background: #5850EC; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(88, 80, 236, 0.4); display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.background='#4F46E5'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#5850EC'; this.style.transform=''">
                                <span class="material-icons" style="font-size: 20px;">add</span>
                                Add to Wallet
                            </button>
                            
                            <!-- APR Disclaimer -->
                            <div style="margin-top: 1rem; text-align: center; font-size: 0.7rem; color: #94A3B8; line-height: 1.4;">
                                Variable APR: 21.24% - 29.24% Var. Terms apply. Rates as of Oct 2024.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Benefit Usage Modal (Reused) -->
<div id="benefit-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0;" id="benefit-modal-title">Update Benefit Usage</h3>
                <p style="color: #64748B; margin: 0; font-size: 0.875rem;" id="benefit-modal-subtitle">Specify how much you've used</p>
            </div>
            <button class="modal-close" onclick="closeBenefitModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94A3B8;">Ã—</button>
        </div>

        <!-- Benefit Details -->
        <div style="background: #F9FAFB; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span style="color: #64748B; font-size: 0.875rem;">Total Benefit Value</span>
                <span style="font-weight: 700; font-size: 1.125rem; color: #1F2937;" id="benefit-total-value">$0</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #64748B; font-size: 0.875rem;">Currently Used</span>
                <span style="font-weight: 700; font-size: 1.125rem; color: #7C3AED;" id="benefit-current-used">$0</span>
            </div>
        </div>

        <!-- Amount Input -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1F2937;">Amount Used ($)</label>
            <input type="number" id="benefit-amount-input" min="0" step="0.01" 
                   style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; font-weight: 600;"
                   placeholder="0.00">
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
                <button onclick="setQuickAmount(25)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">25%</button>
                <button onclick="setQuickAmount(50)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">50%</button>
                <button onclick="setQuickAmount(75)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">75%</button>
                <button onclick="setQuickAmount(100)" style="background: #F3F4F6; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #64748B;">100%</button>
                <button onclick="clearAmount()" style="background: #FEE2E2; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; color: #DC2626;">Clear</button>
            </div>
        </div>

        <!-- Progress Preview -->
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-size: 0.875rem; color: #64748B;">Progress</span>
                <span style="font-size: 0.875rem; font-weight: 600; color: #1F2937;" id="benefit-progress-text">0%</span>
            </div>
            <div style="height: 8px; background: #F3F4F6; border-radius: 4px; overflow: hidden;">
                <div id="benefit-progress-bar" style="width: 0%; height: 100%; background: #6366F1; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 0.75rem; flex-direction: column;">
            <button id="mark-full-btn" onclick="markAsFull()" style="width: 100%; background: white; color: #1F2937; border: 1px solid #E5E7EB; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                <span class="material-icons" style="font-size: 18px; margin-right: 0.5rem; color: #10B981;">check_circle</span>
                Mark as Full
            </button>
            <div style="display: flex; gap: 0.75rem;">
                <button onclick="closeBenefitModal()" style="flex: 1; background: #F3F4F6; color: #64748B; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="saveBenefitUsage()" style="flex: 1; background: #7C3AED; color: white; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                    Save Log
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Anniversary Date Modal -->
<div id="anniversary-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0;">Set Card Anniversary</h3>
                <p style="color: #64748B; margin: 0; font-size: 0.875rem;">When did you get this card?</p>
            </div>
            <button class="modal-close" onclick="closeAnniversaryModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94A3B8;">Ã—</button>
        </div>

        <!-- Card Info -->
        <div style="background: #F9FAFB; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
            <div style="font-size: 0.75rem; font-weight: 700; color: #64748B; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.5rem;">CARD</div>
            <div id="anniversary-card-name" style="font-weight: 700; font-size: 1.125rem; color: #1F2937;">Loading...</div>
        </div>

        <!-- Date Input -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1F2937;">Anniversary Date</label>
            <input type="date" id="anniversary-date-input" 
                   style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; font-weight: 600;">
            <p style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">This helps track which months/quarters are available for benefit tracking.</p>
        </div>

        <!-- Example -->
        <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="font-weight: 600; color: #92400E; margin-bottom: 0.25rem; font-size: 0.875rem;">ðŸ’¡ Example</div>
            <div style="color: #78350F; font-size: 0.875rem;">If you got your card in October 2025, months before October will be grayed out.</div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 0.75rem;">
            <button onclick="closeAnniversaryModal()" style="flex: 1; background: #F3F4F6; color: #64748B; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Cancel
            </button>
            <button onclick="saveAnniversaryDate()" style="flex: 1; background: #7C3AED; color: white; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Save Anniversary
            </button>
        </div>
    </div>
</div>

<style>
    .wallet-tab:hover {
        color: #1F2937;
    }
    
    .wallet-tab.active {
        color: #6366F1;
        border-bottom-color: #6366F1 !important;
    }
    
    .quick-add-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #E2E8F0;
        background: white;
        border-radius: 99px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #64748B;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .quick-add-btn:hover {
        border-color: #8B5CF6;
        color: #8B5CF6;
        background: #F5F3FF;
    }
    
    .card-result-item {
        padding: 1rem;
        border: 1px solid transparent;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.5rem;
    }
    
    .card-result-item:hover {
        background: #F8FAFC;
        border-color: #E2E8F0;
    }
    
    .card-result-item.selected {
        background: #EEF2FF;
        border-color: #6366F1;
    }
    
    .modal-close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #94A3B8;
        padding: 0;
        line-height: 1;
    }
    
    /* Period Pills */
    .period-pill {
        min-width: 48px;
        height: 48px;
        border-radius: 12px;
        background: #F8FAFC;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    
    .period-pill:hover {
        background: #F1F5F9;
    }
    
    .period-pill.current {
        border-color: #3B82F6;
        background: #EFF6FF;
    }
    
    .period-pill.full {
        background: #DCFCE7;
        color: #16A34A;
    }
    
    .period-pill.partial {
        background: #DBEAFE;
        color: #2563EB;
    }
    
    .period-pill.large {
        height: 56px;
        flex-direction: row;
        gap: 0.5rem;
    }
    
    .pill-label {
        font-size: 0.75rem;
        font-weight: 700;
        color: inherit;
    }
    
    .pill-status {
        height: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .benefit-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    }
    
    @media (max-width: 768px) {
        div[style*="grid-template-columns: 1.5fr 1fr 1fr"] {
            grid-template-columns: 1fr !important;
        }
        
        div[style*="grid-template-columns: repeat(auto-fill, minmax(400px, 1fr))"] {
            grid-template-columns: 1fr !important;
        }
        
        .modal-content {
            flex-direction: column;
            height: 90vh !important;
        }
        
        div[style*="width: 240px"] {
            width: 100% !important;
            flex-direction: row;
            padding: 1rem;
            overflow-x: auto;
            border-right: none;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .sidebar-nav {
            display: flex;
            gap: 1rem;
        }
        
        #view-add {
            flex-direction: column;
        }
        
        div[style*="width: 300px"] {
            width: 100% !important;
            border-top: 1px solid #E2E8F0;
            padding: 1rem;
        }
    }
</style>

<script>
    // --- Manage Wallet Modal Logic ---
    const availableCards = {{ available_cards_json|safe }};
    let selectedAddCard = null;

    function openManageWalletModal(view = 'stack') {
        document.getElementById('manage-wallet-modal').style.display = 'flex';
        switchTab(view);
    }

    function closeManageWalletModal() {
        document.getElementById('manage-wallet-modal').style.display = 'none';
        // Reset preview
        document.getElementById('card-preview-empty').style.display = 'block';
        document.getElementById('card-preview-content').style.display = 'none';
        selectedAddCard = null;
    }

    function switchTab(view) {
        // Update Tabs
        document.querySelectorAll('.wallet-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + view).classList.add('active');
        
        // Update Content
        document.getElementById('content-stack').style.display = 'none';
        document.getElementById('content-add').style.display = 'none';
        
        if (view === 'stack') {
            document.getElementById('content-stack').style.display = 'flex';
        } else {
            document.getElementById('content-add').style.display = 'block';
            renderCardResults(availableCards);
        }
    }

    function renderCardResults(cards) {
        const container = document.getElementById('card-results-list');
        container.innerHTML = '';
        
        if (cards.length === 0) {
            container.innerHTML = '<div style="padding: 1rem; color: #94A3B8; text-align: center;">No cards found</div>';
            return;
        }
        
        cards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'card-result-item';
            div.onclick = () => selectCardForPreview(card, div);
            
            div.innerHTML = `
                <div style="font-weight: 700; color: #1F2937; margin-bottom: 0.25rem;">${card.name}</div>
                <div style="font-size: 0.85rem; color: #64748B;">${card.issuer}</div>
            `;
            container.appendChild(div);
        });
    }

    function selectCardForPreview(card, element) {
        // Highlight selection
        document.querySelectorAll('.card-result-item').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        
        selectedAddCard = card;
        
        // Update Preview
        document.getElementById('card-preview-empty').style.display = 'none';
        document.getElementById('card-preview-content').style.display = 'block';
        
        // Update card name and issuer
        document.getElementById('preview-card-name').textContent = card.name;
        document.getElementById('preview-card-issuer-text').textContent = card.issuer;
        document.getElementById('preview-issuer').textContent = card.issuer.toUpperCase();
        
        // Update card visual colors
        const cardVisual = document.getElementById('preview-card-visual');
        const name = (card.name || '').toLowerCase();
        const issuer = (card.issuer || '').toLowerCase();
        
        if (issuer.includes('american express') || issuer.includes('amex') || name.includes('amex')) {
            if (name.includes('platinum')) {
                cardVisual.style.background = 'linear-gradient(135deg, #E2E8F0 0%, #CBD5E1 100%)';
            } else if (name.includes('gold')) {
                cardVisual.style.background = 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)';
            } else {
                cardVisual.style.background = 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)';
            }
        } else if (issuer.includes('chase') || name.includes('chase')) {
            cardVisual.style.background = 'linear-gradient(135deg, #1E40AF 0%, #1E3A8A 100%)';
        } else if (issuer.includes('capital one') || name.includes('capital')) {
            cardVisual.style.background = 'linear-gradient(135deg, #1F2937 0%, #111827 100%)';
        } else if (issuer.includes('citi')) {
            cardVisual.style.background = 'linear-gradient(135deg, #2563EB 0%, #1E40AF 100%)';
        } else {
            cardVisual.style.background = 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)';
        }
        
        // Parse benefits from Firestore structure
        // Parse benefits from Firestore structure
        const benefits = card.benefits || [];
        const earningRatesContainer = document.getElementById('preview-earning-rates');
        const creditsContainer = document.getElementById('preview-credits');
        const earningRatesWrapper = document.getElementById('preview-earning-rates-container');
        const creditsWrapper = document.getElementById('preview-credits-container');
        
        earningRatesContainer.innerHTML = '';
        creditsContainer.innerHTML = '';
        
        // Separate benefits
        const earningRates = [];
        const credits = [];
        
        benefits.forEach((benefit) => {
            const desc = benefit.description || '';
            const shortDesc = benefit.short_description || desc;
            const benefitType = benefit.benefit_type || '';
            const numericValue = benefit.numeric_value;
            
            let formattedValue = '';
            let isEarningRate = false;
            let isCredit = false;

            // Categorization Logic
            if (benefitType === 'Multiplier' && numericValue) {
                formattedValue = `${numericValue}x`;
                isEarningRate = true;
            } else if (benefitType === 'Cashback' && numericValue) {
                formattedValue = `${numericValue}%`;
                isEarningRate = true;
            } else if (benefitType === 'Credit' && numericValue) {
                formattedValue = `$${numericValue}`;
                isCredit = true;
            } else if (benefitType === 'Bonus' && numericValue) {
                // Heuristic: Small value or % in desc -> Earning Rate (e.g. 10% bonus)
                // Large value -> Credit (e.g. 10,000 miles)
                if (numericValue <= 100 || desc.includes('%')) {
                     formattedValue = `${numericValue}%`; // Assume percent for small bonuses
                     isEarningRate = true;
                } else {
                     // Format large numbers (e.g. 10000 -> 10k)
                     if (numericValue >= 1000) {
                         formattedValue = (numericValue / 1000).toFixed(0) + 'k';
                         // Append unit if possible? 
                         // For now just 10k. User can see "Miles" in description if it's there.
                         // Actually, let's try to append "Pts" or "Miles" if in shortDesc?
                         if (shortDesc.toLowerCase().includes('miles')) formattedValue += ' Miles';
                         else if (shortDesc.toLowerCase().includes('points')) formattedValue += ' Pts';
                     } else {
                         formattedValue = numericValue.toLocaleString();
                     }
                     isCredit = true;
                }
            }

            const benefitData = {
                description: desc,
                shortDescription: shortDesc,
                formattedValue: formattedValue,
                benefitType: benefitType
            };
            
            if (isEarningRate) {
                earningRates.push(benefitData);
            } else if (isCredit) {
                credits.push(benefitData);
            }
        });
        
        // Render Earning Rates
        if (earningRates.length > 0) {
            earningRatesWrapper.style.display = 'block';
            let html = '';
            earningRates.forEach(item => {
                // Only show if we have a formatted value (user requirement)
                if (item.formattedValue) {
                    html += `
                        <div style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; gap: 0.25rem;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: #2563EB;">${item.formattedValue}</div>
                            <div style="font-size: 0.8rem; color: #64748B; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.shortDescription}</div>
                        </div>
                    `;
                }
            });
            earningRatesContainer.innerHTML = html;
        } else {
            earningRatesWrapper.style.display = 'none';
        }

        // Render Credits
        if (credits.length > 0) {
            creditsWrapper.style.display = 'block';
            let html = '';
            credits.forEach(item => {
                html += `
                    <div style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.9rem; color: #334155; font-weight: 500;">${item.shortDescription}</div>
                        <div style="font-size: 0.9rem; font-weight: 700; color: #16A34A;">${item.formattedValue}</div>
                    </div>
                `;
            });
            creditsContainer.innerHTML = html;
        } else {
            creditsWrapper.style.display = 'none';
        }
    }

    function filterCards(issuer) {
        let searchIssuer = issuer;
        if (issuer === 'Amex') {
            searchIssuer = 'American Express';
        }
        const filtered = availableCards.filter(c => c.issuer.includes(searchIssuer));
        renderCardResults(filtered);
    }

    document.getElementById('card-search-input')?.addEventListener('input', (e) => {
        let term = e.target.value.toLowerCase();
        
        // Alias mapping
        if (term === 'amex') {
            term = 'american express';
        }
        
        const filtered = availableCards.filter(c => 
            c.name.toLowerCase().includes(term) || c.issuer.toLowerCase().includes(term) ||
            (term === 'amex' && c.issuer.toLowerCase().includes('american express'))
        );
        renderCardResults(filtered);
    });

    function addSelectedCard() {
        if (!selectedAddCard) return;
        
        // Open anniversary modal in "add" mode
        // We pass null as cardId to indicate we are adding a new card
        // But we store the selectedAddCard.id in a separate variable or reuse currentAnniversaryCardId with a flag
        
        currentAnniversaryCardId = 'ADD_NEW_CARD'; // Special flag
        document.getElementById('anniversary-card-name').textContent = selectedAddCard.name;
        
        // Default to current month
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
        const defaultDate = `${currentYear}-${currentMonth}-01`;
        
        document.getElementById('anniversary-date-input').value = defaultDate;
        document.getElementById('anniversary-modal').style.display = 'flex';
    }
    
    // --- Anniversary Modal Logic ---
    let currentAnniversaryCardId = null;

    function openAnniversaryModal(cardId, cardName, currentDate) {
        currentAnniversaryCardId = cardId;
        document.getElementById('anniversary-card-name').textContent = cardName;
        document.getElementById('anniversary-date-input').value = currentDate || '';
        document.getElementById('anniversary-modal').style.display = 'flex';
    }

    function closeAnniversaryModal() {
        document.getElementById('anniversary-modal').style.display = 'none';
        currentAnniversaryCardId = null;
    }

    function saveAnniversaryDate() {
        if (!currentAnniversaryCardId) return;
        
        const date = document.getElementById('anniversary-date-input').value;
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        // Check if we are adding a new card
        if (currentAnniversaryCardId === 'ADD_NEW_CARD') {
            if (!selectedAddCard) return;
            
            // Submit form to add card with anniversary date
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/dashboard/add-card/${selectedAddCard.id}/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Add anniversary date
            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'anniversary_date';
            dateInput.value = date;
            form.appendChild(dateInput);
            
            document.body.appendChild(form);
            form.submit();
            
            closeAnniversaryModal();
            return;
        }
        
        // Otherwise, we are updating an existing card
        const formData = new FormData();
        formData.append('anniversary_date', date);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/dashboard/update-anniversary/${currentAnniversaryCardId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error saving date: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Error saving date');
        });
    }

    // --- Benefit Modal Logic (Existing) ---
    // --- Benefit Modal Logic (Updated) ---
    let currentBenefitData = {};

    function openBenefitModal(cardId, benefitId, benefitName, amount, used, frequency, periodKey, periodLabel, periodStatus) {
        currentBenefitData = {
            cardId,
            benefitId,
            amount,
            periodKey,
            periodStatus
        };
        
        document.getElementById('benefit-modal').style.display = 'flex';
        document.getElementById('benefit-modal-title').textContent = benefitName;
        document.getElementById('benefit-modal-subtitle').textContent = `${periodLabel || ''} Usage`;
        
        document.getElementById('benefit-total-value').textContent = `$${amount}`;
        
        // If we have period data, use that, otherwise fallback
        // Note: 'used' passed here is the period usage if periodKey is present
        document.getElementById('benefit-current-used').textContent = `$${used}`;
        document.getElementById('benefit-amount-input').value = used > 0 ? used : '';
        
        updateProgress(used, amount);
        
        // Update "Mark as Full" button text
        const markBtn = document.getElementById('mark-full-btn');
        if (markBtn) {
            markBtn.textContent = `Mark ${periodLabel} as Full`;
            if (periodStatus === 'full') {
                markBtn.innerHTML = `<span class="material-icons" style="font-size: 18px; margin-right: 0.5rem;">check</span> ${periodLabel} is Full`;
                markBtn.disabled = true;
                markBtn.style.opacity = '0.7';
            } else {
                markBtn.disabled = false;
                markBtn.style.opacity = '1';
            }
        }
    }

    function closeBenefitModal() {
        document.getElementById('benefit-modal').style.display = 'none';
        currentBenefitData = {};
    }

    function updateProgress(used, total) {
        const percentage = Math.min(100, Math.max(0, (used / total) * 100));
        document.getElementById('benefit-progress-bar').style.width = `${percentage}%`;
        document.getElementById('benefit-progress-text').textContent = `${Math.round(percentage)}%`;
    }

    document.getElementById('benefit-amount-input').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value) || 0;
        updateProgress(val, currentBenefitData.amount);
    });

    function setQuickAmount(percent) {
        const amount = (currentBenefitData.amount * percent) / 100;
        document.getElementById('benefit-amount-input').value = amount.toFixed(2);
        updateProgress(amount, currentBenefitData.amount);
    }

    function clearAmount() {
        document.getElementById('benefit-amount-input').value = '';
        updateProgress(0, currentBenefitData.amount);
    }
    
    function markAsFull() {
        if (!currentBenefitData.benefitId) return;
        
        const formData = new FormData();
        formData.append('amount', currentBenefitData.amount);
        formData.append('period_key', currentBenefitData.periodKey);
        formData.append('is_full', 'true');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/dashboard/update-benefit/${currentBenefitData.cardId}/${currentBenefitData.benefitId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating benefit: ' + (data.error || 'Unknown error'));
            }
        });
    }

    function saveBenefitUsage() {
        if (!currentBenefitData.benefitId) return;
        
        const amount = parseFloat(document.getElementById('benefit-amount-input').value) || 0;
        
        const formData = new FormData();
        formData.append('amount', amount);
        formData.append('period_key', currentBenefitData.periodKey);
        formData.append('is_full', amount >= currentBenefitData.amount);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/dashboard/update-benefit/${currentBenefitData.cardId}/${currentBenefitData.benefitId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating benefit: ' + (data.error || 'Unknown error'));
            }
        });
    }
    
    // Close modal on outside click
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }
</script>
{% endblock %}