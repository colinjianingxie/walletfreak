{% extends 'base.html' %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
        <h1>Manage Cards</h1>
    </div>
    
    {% if messages %}
        {% for message in messages %}
        <div style="padding: 1rem; margin-bottom: 1rem; background: {% if message.tags == 'success' %}#10b981{% elif message.tags == 'error' %}#ef4444{% else %}#3b82f6{% endif %}; border-radius: 0.5rem;">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}
    

    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
        {% if is_prompt_admin %}
        <button type="button" id="btn-bulk-prompt" class="btn btn-primary" disabled
                style="padding: 0.75rem 1.5rem; font-weight: 600; opacity: 0.5; cursor: not-allowed;">
            Generate Bulk Prompt
        </button>
        {% else %}
        <div></div>
        {% endif %}
    </div>

    {% if is_prompt_admin %}
    <div style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.1);">
        <label style="display: block; margin-bottom: 0.5rem; color: rgba(255,255,255,0.8); font-weight: 600;">Generate Prompt for New Card(s)</label>
        <div style="display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1rem;">
            <input type="text" id="new-slug-input" placeholder="Enter slug-id(s) comma-separated (e.g., chase-sapphire-reserve, amex-gold-card)"
                   style="flex: 1; padding: 0.75rem 1rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: white; font-size: 0.9rem;">
            <button type="button" id="btn-new-prompt" class="btn btn-primary" style="padding: 0.75rem 1.5rem; font-weight: 600;">
                Generate
            </button>
        </div>
        
        <label style="display: block; margin-bottom: 0.5rem; color: rgba(255,255,255,0.6); font-weight: 600; font-size: 0.875rem;">Paste AI Result (JSON)</label>
        <p style="margin: 0 0 0.5rem 0; color: rgba(255,255,255,0.4); font-size: 0.75rem;">For multiple cards, paste as JSON array: [{...}, {...}, {...}]</p>
        <textarea id="new-card-result" placeholder="Paste the JSON response from the AI here...&#10;&#10;For single card: paste the JSON object&#10;For multiple cards: paste a JSON array like [{&quot;slug-id&quot;: &quot;card1&quot;, ...}, {&quot;slug-id&quot;: &quot;card2&quot;, ...}]"
                  style="width: 100%; height: 200px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: #e5e7eb; padding: 1rem; font-family: monospace; font-size: 0.875rem; margin-bottom: 0.75rem; resize: vertical;"></textarea>
        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
            <button type="button" id="btn-save-json" class="btn btn-primary" style="padding: 0.75rem 1.5rem; font-weight: 600; background: #10b981;">
                Save JSON
            </button>
        </div>
    </div>
    {% endif %}


    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
        <thead>
            <tr style="text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);">
                {% if is_prompt_admin %}
                <th style="padding: 1rem; width: 40px; text-align: center;">
                    <input type="checkbox" id="select-all" style="cursor: pointer;">
                </th>
                {% endif %}
                <th style="padding: 1rem;">Name</th>
                <th style="padding: 1rem;">Issuer</th>
                <th style="padding: 1rem;">Fee</th>
                <th style="padding: 1rem;">Benefits</th>
                <th style="padding: 1rem;">Rates</th>
                <th style="padding: 1rem;">Questions</th>
                <th style="padding: 1rem;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for card in cards %}
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                {% if is_prompt_admin %}
                <td style="padding: 1rem; text-align: center;">
                    <input type="checkbox" class="card-checkbox" value="{{ card.id }}" style="cursor: pointer;">
                </td>
                {% endif %}
                <td style="padding: 1rem;">{{ card.name }}</td>
                <td style="padding: 1rem;">{{ card.issuer }}</td>
                <td style="padding: 1rem;">${{ card.annual_fee }}</td>
                <td style="padding: 1rem;">{{ card.benefits|length }}</td>
                <td style="padding: 1rem;">{{ card.earning_rates|length }}</td>
                <td style="padding: 1rem;">{{ card.card_questions|length }}</td>
                <td style="padding: 1rem;">
                    {% if is_prompt_admin %}
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-primary btn-update-prompt" 
                                data-card-id="{{ card.id }}"
                                style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                            Update
                        </button>
                        <button type="button" class="btn btn-min-prompt" 
                                data-card-id="{{ card.id }}"
                                style="font-size: 0.8rem; padding: 0.5rem 0.75rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem;">
                            Min
                        </button>
                    </div>
                    {% else %}
                    <span style="opacity: 0.5; font-size: 0.8rem;">Read Only</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Modal -->
    <div id="ai-prompt-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: #1f2937; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; color: white; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; color: white;">AI Update Prompt</h3>
                <button onclick="document.getElementById('ai-prompt-modal').style.display='none'" 
                        style="background: transparent; border: none; color: rgba(255,255,255,0.6); cursor: pointer; font-size: 1.5rem;">&times;</button>
            </div>
            
            <div style="flex: 1; overflow-y: auto; margin-bottom: 1rem;">
                <textarea id="prompt-output" readonly 
                          style="width: 100%; height: 350px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; color: #e5e7eb; padding: 1rem; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap; margin-bottom: 1rem;"></textarea>
                          
                <label style="display: block; margin-bottom: 0.5rem; color: rgba(255,255,255,0.6); font-weight: 600; font-size: 0.875rem;">Seed Command</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="seed-command-output" readonly 
                           style="flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; color: #10b981; padding: 0.75rem; font-family: monospace; font-size: 0.875rem;">
                    <button onclick="copySeedCommand()" class="btn btn-outline" id="btn-copy-seed" style="color: white; border-color: rgba(255,255,255,0.2);">
                        Copy
                    </button>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button onclick="copyToClipboard()" class="btn btn-primary" id="btn-copy">
                    Copy to Clipboard
                </button>
                <button onclick="document.getElementById('ai-prompt-modal').style.display='none'" class="btn btn-outline" style="color: white; border-color: white;">
                    Close
                </button>
            </div>
        </div>
    </div>

    {% if is_prompt_admin %}
    <script>
        document.querySelectorAll('.btn-update-prompt').forEach(button => {
            button.addEventListener('click', function() {
                const btn = this;
                const cardId = btn.getAttribute('data-card-id');
                const originalText = btn.innerText;
                
                btn.innerText = 'Generating...';
                btn.disabled = true;

                // Construct URL correctly - needs to match pattern cards/<card_id>/generate-prompt/
                // We'll trust that cardId is the slug we need
                const url = `/custom-admin/cards/${cardId}/generate-prompt/`; // Hardcoded base path to ensure correctness relative to root

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || response.statusText) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            document.getElementById('prompt-output').value = data.prompt;
                            document.getElementById('seed-command-output').value = data.seed_command || '';
                            document.getElementById('ai-prompt-modal').style.display = 'flex';
                        }
                    })
                    .catch(err => {
                        console.error('Fetch error:', err);
                        // Try to extract a meaningful error message from HTML if that's what was returned
                        let msg = err.message;
                        if (msg && msg.trim().startsWith('<!DOCTYPE')) {
                            msg = 'Server returned HTML error (likely 404 or 500). Check console.';
                        }
                        alert('Request failed: ' + msg);
                    })
                    .finally(() => {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    });
            });
        });

        // Min Prompt Button Handler
        document.querySelectorAll('.btn-min-prompt').forEach(button => {
            button.addEventListener('click', function() {
                const btn = this;
                const cardId = btn.getAttribute('data-card-id');
                const originalText = btn.innerText;
                
                btn.innerText = '...';
                btn.disabled = true;

                const url = `/custom-admin/cards/${cardId}/generate-prompt/?min=1`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || response.statusText) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            document.getElementById('prompt-output').value = data.prompt;
                            document.getElementById('seed-command-output').value = data.seed_command || '';
                            document.getElementById('ai-prompt-modal').style.display = 'flex';
                        }
                    })
                    .catch(err => {
                        console.error('Fetch error:', err);
                        alert('Request failed: ' + err.message);
                    })
                    .finally(() => {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    });
            });
        });

        // Bulk Selection Logic
        const selectAll = document.getElementById('select-all');
        const bulkBtn = document.getElementById('btn-bulk-prompt');
        const checkboxes = document.querySelectorAll('.card-checkbox');

        function updateBulkButton() {
            const checkedCount = document.querySelectorAll('.card-checkbox:checked').length;
            if (checkedCount > 0) {
                bulkBtn.disabled = false;
                bulkBtn.style.opacity = '1';
                bulkBtn.style.cursor = 'pointer';
                bulkBtn.innerText = `Generate Bulk Prompt (${checkedCount})`;
            } else {
                bulkBtn.disabled = true;
                bulkBtn.style.opacity = '0.5';
                bulkBtn.style.cursor = 'not-allowed';
                bulkBtn.innerText = 'Generate Bulk Prompt';
            }
        }

        if (selectAll) {
            selectAll.addEventListener('change', function() {
                checkboxes.forEach(cb => cb.checked = this.checked);
                updateBulkButton();
            });
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                if (!this.checked) {
                    if (selectAll) selectAll.checked = false;
                } else {
                    const allChecked = document.querySelectorAll('.card-checkbox:checked').length === checkboxes.length;
                    if (selectAll) selectAll.checked = allChecked;
                }
                updateBulkButton();
            });
        });

        // Bulk Generation Logic
        if (bulkBtn) {
            bulkBtn.addEventListener('click', function() {
                const checkedBoxes = document.querySelectorAll('.card-checkbox:checked');
                const ids = Array.from(checkedBoxes).map(cb => cb.value);
                
                if (ids.length === 0) return;

                const btn = this;
                const originalText = btn.innerText;
                btn.innerText = 'Generating...';
                btn.disabled = true;

                fetch('/custom-admin/cards/generate-bulk-prompt/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ card_ids: ids })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText) });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        document.getElementById('prompt-output').value = data.prompt;
                        document.getElementById('seed-command-output').value = data.seed_command || '';
                        document.getElementById('ai-prompt-modal').style.display = 'flex';
                    }
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    alert('Request failed: ' + err.message);
                })
                .finally(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
            });
        }

        function copyToClipboard() {
            const copyText = document.getElementById("prompt-output");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            
            document.execCommand("copy");
            
            const btn = document.getElementById('btn-copy');
            const originalText = btn.innerText;
            btn.innerText = 'Copied!';
            setTimeout(() => {
                btn.innerText = originalText;
            }, 2000);
        }

        function copySeedCommand() {
            const copyText = document.getElementById("seed-command-output");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            
            document.execCommand("copy");
            
            const btn = document.getElementById('btn-copy-seed');
            const originalText = btn.innerText;
            btn.innerText = 'Copied!';
            setTimeout(() => {
                btn.innerText = originalText;
            }, 2000);
        }

        // New Card Slug-ID Generation Logic
        const newSlugInput = document.getElementById('new-slug-input');
        const newPromptBtn = document.getElementById('btn-new-prompt');
        
        if (newPromptBtn) {
            newPromptBtn.addEventListener('click', function() {
                const slugId = newSlugInput.value.trim();
                
                if (!slugId) {
                    alert('Please enter a slug-id');
                    return;
                }

                const btn = this;
                const originalText = btn.innerText;
                btn.innerText = 'Generating...';
                btn.disabled = true;

                fetch('/custom-admin/cards/generate-new-prompt/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ slug_id: slugId })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText) });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        document.getElementById('prompt-output').value = data.prompt;
                        document.getElementById('seed-command-output').value = data.seed_command || '';
                        document.getElementById('ai-prompt-modal').style.display = 'flex';
                    }
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    alert('Request failed: ' + err.message);
                })
                .finally(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
            });

            // Allow Enter key to trigger generation
            newSlugInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    newPromptBtn.click();
                }
            });
        }

        // Save JSON Logic
        const saveJsonBtn = document.getElementById('btn-save-json');
        const newCardResult = document.getElementById('new-card-result');
        
        if (saveJsonBtn) {
            saveJsonBtn.addEventListener('click', function() {
                const slugIdInput = newSlugInput.value.trim();
                const jsonData = newCardResult.value.trim();
                
                if (!slugIdInput) {
                    alert('Please enter a slug-id first');
                    return;
                }
                if (!jsonData) {
                    alert('Please paste the JSON result first');
                    return;
                }
                
                // Parse slug-ids
                const slugIds = slugIdInput.split(',').map(s => s.trim()).filter(s => s);
                const numSlugs = slugIds.length;

                // Quick client-side JSON validation
                let parsedJson;
                try {
                    parsedJson = JSON.parse(jsonData);
                } catch (e) {
                    alert('Invalid JSON: ' + e.message);
                    return;
                }
                
                // Validate structure matches expected count
                if (numSlugs > 1) {
                    if (!Array.isArray(parsedJson)) {
                        alert(`For ${numSlugs} slug-ids, you need to provide a JSON array with ${numSlugs} objects.\n\nWrap your JSONs in square brackets: [{...}, {...}]`);
                        return;
                    }
                    if (parsedJson.length !== numSlugs) {
                        alert(`Mismatch: You provided ${numSlugs} slug-ids but the JSON array has ${parsedJson.length} objects.\n\nExpected exactly ${numSlugs} JSON objects.`);
                        return;
                    }
                } else if (numSlugs === 1 && Array.isArray(parsedJson) && parsedJson.length !== 1) {
                    alert(`For a single slug-id, expected 1 JSON object but found an array with ${parsedJson.length} items.`);
                    return;
                }

                const btn = this;
                const originalText = btn.innerText;
                btn.innerText = 'Saving...';
                btn.disabled = true;

                fetch('/custom-admin/cards/save-card-json/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ slug_id: slugIdInput, json_data: jsonData })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText) });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        alert('Success: ' + data.message);
                        newCardResult.value = '';
                    }
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    alert('Request failed: ' + err.message);
                })
                .finally(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
            });
        }
    </script>
    {% endif %}
</div>
{% endblock %}