{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalletFreak - Credit Card Recommendations</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=1.5">
    <link rel="stylesheet" href="{% static 'css/layout.css' %}?v=1.1">
    {% if not user.is_authenticated %}
    <link rel="stylesheet" href="{% static 'css/landing_fix.css' %}?v=1.0">
    {% endif %}
    <!-- Tailwind removed -->
    <link rel="stylesheet" href="{% static 'css/notifications.css' %}?v=1.0">
    {% block extra_css %}{% endblock %}
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <script id="firebase-config" type="application/json">
        {{ firebase_config_json|safe }}
    </script>
    <script>
        // Define handleLogout globally first
        window.handleLogout = function(e) {
            if (e) e.preventDefault();
            // Set flag to prevent base.html from auto-syncing logic re-logging us in
            sessionStorage.setItem('logging_out', 'true');
            if (window.firebase && firebase.auth) {
                firebase.auth().signOut().then(() => {
                    window.location.href = "/logout/";
                }).catch((error) => {
                    console.error("Firebase logout error:", error);
                    window.location.href = "/logout/"; // Fallback logout
                });
            } else {
                window.location.href = "/logout/"; // Fallback if firebase not loaded
            }
        };

        function toggleSidebar() {
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('mobile-overlay');
          if (sidebar && sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            if(overlay) overlay.classList.remove('visible');
          } else if (sidebar) {
            sidebar.classList.add('open');
            if(overlay) overlay.classList.add('visible');
          }
        }

        try {
            const firebaseConfigElement = document.getElementById('firebase-config');
            if (firebaseConfigElement) {
                const firebaseConfig = JSON.parse(firebaseConfigElement.textContent);
                
                // Initialize Firebase only if not already initialized
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                } else {
                    firebase.app(); // if already initialized, use that one
                }
                
                window.auth = firebase.auth();
                window.db = firebase.firestore();

                // Auth State Observer & Sync
                auth.onAuthStateChanged(async (user) => {
                    const isDjangoAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}" === "true";

                    if (user) {
                        // User is signed in to Firebase
                        if (!isDjangoAuthenticated) {
                            if (user.emailVerified || user.providerData[0].providerId === 'phone') {
                                try {
                                    const idToken = await user.getIdToken();
                                    fetch('/accounts/api/login/', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({ idToken: idToken })
                                    }).then(res => {
                                        if (res.ok) window.location.reload();
                                    });
                                } catch (e) {
                                    console.error("Token sync error:", e);
                                }
                            }
                        }
                    } else {
                        // User is NOT signed in to Firebase
                        if (sessionStorage.getItem('logging_out') === 'true') {
                            sessionStorage.removeItem('logging_out');
                            return;
                        }

                        if (isDjangoAuthenticated) {
                            console.log('Session mismatch detected. Logging out...');
                            fetch('/accounts/api/logout/').then(() => {
                                window.location.reload();
                            });
                        }
                    }
                });
            }
        } catch (e) {
            console.error("Firebase init error:", e);
        }
    </script>
</head>

<body>

    {% if user.is_authenticated %}
    <!-- Logged In Layout -->
    <div class="app-layout">
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" onclick="toggleSidebar()" class="mobile-overlay"></div>

        <!-- Sidebar -->
        {% include 'includes/sidebar.html' %}

        <!-- Main Content Area -->
        <main class="app-main">
            <!-- Top Application Header -->
            <header class="top-header">
                <div class="header-left">
                    <button class="mobile-toggle-btn icon-btn" onclick="toggleSidebar()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu" aria-hidden="true"><path d="M4 5h16"></path><path d="M4 12h16"></path><path d="M4 19h16"></path></svg>
                    </button>
                    <div class="hidden md:flex items-center text-sm text-slate-500">
                        <span class="hover:text-slate-800 cursor-pointer">{% block breadcrumb_section %}App{% endblock %}</span>
                        <span class="mx-2">/</span>
                        <span class="font-semibold text-slate-800 capitalize">{% block page_title %}Wallet{% endblock %}</span>
                    </div>
                </div>
                
                <div class="header-right relative">
                    <button id="notification-bell-btn" class="icon-btn relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell" aria-hidden="true"><path d="M10.268 21a2 2 0 0 0 3.464 0"></path><path d="M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326"></path></svg>
                        <span id="notification-badge" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full ring-2 ring-white" style="display: none;"></span>
                    </button>

                    <!-- User Notification Popup -->
                    <div id="notification-popup" class="notification-popup">
                        <div class="notification-header">
                            <h3 class="notification-title">Notifications</h3>
                            <button class="mark-all-btn" onclick="markAllRead()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-check" aria-hidden="true"><path d="M18 6 7 17l-5-5"></path><path d="m22 10-7.5 7.5L13 16"></path></svg>
                                Mark all read
                            </button>
                        </div>
                        <div id="notification-list" class="notification-list custom-scrollbar">
                            <!-- JS injected items -->
                        </div>
                        <div class="notification-footer">
                            <a href="{% url 'notifications_history' %}" class="view-all-btn">View All History</a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-scrollable">
                <div class="content-container" style="{% block main_style %}{% endblock %}">
    {% else %}
    <!-- Logged Out Layout -->
        {% include 'includes/navbar.html' %}
    {% endif %}

    <!-- Common Content Placement -->
    {% block full_width_content %}
        {% block content %}{% endblock %}
    {% endblock %}

    {% if user.is_authenticated %}
                </div>
            </div>
        </main>
    </div>
    {% endif %}

    <!-- Login Required Modal -->
    <div id="login-required-modal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <div style="margin-bottom: 1.5rem;">
                <span class="material-icons" style="font-size: 3rem; color: var(--primary);">account_circle</span>
            </div>
            <h3 style="margin-bottom: 1rem; font-family: 'Outfit', sans-serif;">Please Log In</h3>
            <p style="margin-bottom: 2rem; color: #666; line-height: 1.5;">You need to be logged in to perform this action. Join the community to vote, save posts, and more!</p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button onclick="closeLoginModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #ddd; background: white; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    Cancel
                </button>
                <a href="{% url 'login' %}?next={{ request.path }}" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border-radius: 8px; font-weight: 600; text-decoration: none; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    Log In
                </a>
            </div>
        </div>
    </div>

    <script>
        function showLoginModal() {
            const modal = document.getElementById('login-required-modal');
            if(modal) modal.style.display = 'flex';
        }

        function closeLoginModal() {
            const modal = document.getElementById('login-required-modal');
            if(modal) modal.style.display = 'none';
        }
        
        // Close on outside click
        const loginModal = document.getElementById('login-required-modal');
        if (loginModal) {
            loginModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeLoginModal();
                }
            });
        }
    </script>
    <script src="{% static 'js/notifications.js' %}?v=1.0"></script>
    {% block extra_js %}{% endblock %}
</body>

</html>