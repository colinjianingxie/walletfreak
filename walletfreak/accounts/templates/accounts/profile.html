{% extends 'auth_base.html' %}
{% load static %}

{% block extra_css %}
<!-- Profile Styles -->
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="profile-title-container">
    <h1 class="profile-title">My Profile</h1>
</div>

<!-- Profile Card -->
<div class="profile-card">
    <div class="profile-header-content">
        <!-- Avatar -->
        <div class="avatar-container" onclick="openAvatarModal()">
            <div class="avatar-display">
                {% if user_profile.photo_url %}
                    <img src="{{ user_profile.photo_url }}" alt="Profile" class="avatar-img" id="profile-avatar-display">
                {% else %}
                    <div class="avatar-placeholder" id="profile-avatar-placeholder">
                        {{ user.first_name|first|default:user.username|first|upper|default:"✈️" }}
                    </div>
                {% endif %}
            </div>
            <!-- Edit Overlay -->
            <div class="avatar-edit-badge">
                <span class="material-icons" style="font-size: 18px;">edit</span>
            </div>
        </div>

        <!-- User Info -->
        <div class="user-info-container">
            <h2 class="user-name-title">
                <span id="profile-name-display">{{ user.first_name|default:"User" }} {{ user.last_name|default:"" }}</span>
                <button class="btn btn-icon btn-ghost" onclick="openChangeNameModal()" style="padding: 0.25rem; color: var(--text-muted);">
                    <span class="material-icons" style="font-size: 1.25rem;">edit</span>
                </button>
            </h2>
            <div class="user-username-display">
                <span id="profile-username-display">@{{ user_profile.username|default:"username" }}</span>
                <button class="btn btn-icon btn-ghost" onclick="openChangeUsernameModal()" style="padding: 0.25rem; color: var(--text-muted);">
                    <span class="material-icons" style="font-size: 1rem;">edit</span>
                </button>
            </div>
            
            {% if user_is_premium %}
            <div class="badge badge-purple personality-badge" style="background: #F59E0B; color: white;">
                <span class="material-icons" style="font-size: 16px;">auto_awesome</span>
                WALLET FREAK PREMIUM
            </div>
            {% endif %}

            <div class="badge badge-purple personality-badge">
                <span class="material-icons" style="font-size: 16px;">psychology</span>
                {{ matched_personality.name|default:"Wallet Freak"|upper }}
            </div>

            <div class="user-meta-list">
                <div class="user-meta-item">
                    <span class="material-icons" style="font-size: 1.25rem; color: var(--text-muted);">email</span>
                    <span>{{ user.email }}</span>
                </div>

                <div class="user-meta-item">
                    <span class="material-icons" style="font-size: 1.25rem; color: var(--text-muted);">calendar_today</span>
                    <span>Joined {{ user.date_joined|date:"M Y" }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Account Security Section -->
<div class="section-card">
    <h2 class="section-title">
        <span class="material-icons" style="font-size: 1.5rem; color: var(--primary);">lock</span>
        Account Security
    </h2>

    <!-- Email Address -->
    <div class="settings-item">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Email Address</div>
                <div style="font-size: 1.1rem; color: var(--dark);" id="user-email-display">{{ user.email }}</div>
            </div>
<!-- Email Change Removed -->
        </div>
    </div>

    <!-- Password -->
    <div class="settings-item">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Password</div>
                <div style="font-size: 1.1rem; color: var(--dark); letter-spacing: 2px;">••••••••</div>
            </div>
            <button class="btn btn-outline" style="padding: 0.5rem 1.25rem; font-size: 0.9rem;" onclick="sendPasswordReset()" id="btn-password-reset">
                Update
            </button>
        </div>
    </div>

    <!-- Separator -->
    <div style="margin-top: 2rem; margin-bottom: 2rem; border-top: 1px solid #E5E7EB;"></div>

    <!-- Notifications Section -->
    <div class="notifications-section">
        <h2 class="section-title">
            <span class="material-icons" style="font-size: 1.5rem; color: var(--primary);">notifications</span>
            Notifications
        </h2>

        <!-- Blog Updates Toggle -->
        <div class="settings-item">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div class="settings-item-info">
                    <div style="font-weight: 600; font-size: 1rem; color: var(--dark); margin-bottom: 0.5rem;">Blog Updates</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Get notified when new articles are published.</div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <label class="toggle-switch">
                        <input type="checkbox" class="notification-toggle" data-type="blog_updates"
                            {% if notification_preferences.blog_updates.enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Benefit Expiration Toggle -->
        <div class="settings-item settings-section-content">
            <div class="settings-flex-container" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div class="settings-item-info">
                    <div style="font-weight: 600; font-size: 1rem; color: var(--dark); margin-bottom: 0.5rem;">Benefit Expiration</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Alert me before a credit expires.</div>
                </div>
                
                <div class="settings-controls-wrapper">
                    <div class="settings-controls-group">
                        <div class="settings-control-row">
                            <span style="font-size: 0.85rem; color: var(--text-muted); white-space: nowrap;">Start notifying:</span>
                            <select class="form-select pref-select pref-select-disabled" id="exp-start-days"
                               {% if not notification_preferences.benefit_expiration.enabled %}disabled{% endif %}>
                               <option value="1" {% if notification_preferences.benefit_expiration.start_days_before == 1 %}selected{% endif %}>1 day before</option>
                               <option value="3" {% if notification_preferences.benefit_expiration.start_days_before == 3 %}selected{% endif %}>3 days before</option>
                               <option value="5" {% if notification_preferences.benefit_expiration.start_days_before == 5 %}selected{% endif %}>5 days before</option>
                               <option value="7" {% if notification_preferences.benefit_expiration.start_days_before|default:7 == 7 %}selected{% endif %}>1 week before</option>
                               <option value="14" {% if notification_preferences.benefit_expiration.start_days_before == 14 %}selected{% endif %}>2 weeks before</option>
                               <option value="30" {% if notification_preferences.benefit_expiration.start_days_before == 30 %}selected{% endif %}>1 month before</option>
                           </select>
                       </div>

                       <div class="settings-control-row">
                           <span style="font-size: 0.85rem; color: var(--text-muted); white-space: nowrap;">Repeat every:</span>
                           
                           {% if user.email == 'colinjianingxie@gmail.com' %}
                               <select class="form-select pref-select pref-select-disabled" id="exp-repeat-freq"
                                  {% if not notification_preferences.benefit_expiration.enabled %}disabled{% endif %}>
                                  <option value="0.000694" {% if notification_preferences.benefit_expiration.repeat_frequency == 0.000694 %}selected{% endif %}>1 Minute (Test)</option>
                                  <option value="1" {% if notification_preferences.benefit_expiration.repeat_frequency|default:1 == 1 %}selected{% endif %}>Day</option>
                                  <option value="2" {% if notification_preferences.benefit_expiration.repeat_frequency == 2 %}selected{% endif %}>2 Days</option>
                                  <option value="3" {% if notification_preferences.benefit_expiration.repeat_frequency == 3 %}selected{% endif %}>3 Days</option>
                                  <option value="5" {% if notification_preferences.benefit_expiration.repeat_frequency == 5 %}selected{% endif %}>5 Days</option>
                                  <option value="7" {% if notification_preferences.benefit_expiration.repeat_frequency == 7 %}selected{% endif %}>Week</option>
                               </select>
                           {% else %}
                               <span style="font-size: 0.9rem; font-weight: 500; color: var(--dark); padding: 0.375rem 0.75rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 6px;">Daily</span>
                               <input type="hidden" id="exp-repeat-freq" value="1">
                           {% endif %}
                       </div>
                    </div>

                    <label class="toggle-switch" style="margin-left: 0.5rem;">
                        <input type="checkbox" class="notification-toggle" data-type="benefit_expiration"
                            {% if notification_preferences.benefit_expiration.enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Annual Fee Reminders Toggle -->
        <div class="settings-item settings-section-content">
            <div class="settings-flex-container" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div class="settings-item-info">
                    <div style="font-weight: 600; font-size: 1rem; color: var(--dark); margin-bottom: 0.5rem;">Annual Fee Reminders</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Alert me before renewal.</div>
                </div>

                <div class="settings-controls-wrapper">
                    <div class="settings-controls-group">
                        <div class="settings-control-row">
                            <span style="font-size: 0.85rem; color: var(--text-muted); white-space: nowrap;">Start notifying:</span>
                            <select class="form-select pref-select" data-type="annual_fee" data-key="start_days_before"
                                 {% if not notification_preferences.annual_fee.enabled %}disabled{% endif %}>
                                <option value="7" {% if notification_preferences.annual_fee.start_days_before == 7 %}selected{% endif %}>1 week before</option>
                                <option value="14" {% if notification_preferences.annual_fee.start_days_before == 14 %}selected{% endif %}>2 weeks before</option>
                                <option value="30" {% if notification_preferences.annual_fee.start_days_before|default:30 == 30 %}selected{% endif %}>30 days before</option>
                                <option value="45" {% if notification_preferences.annual_fee.start_days_before == 45 %}selected{% endif %}>45 days before</option>
                                <option value="60" {% if notification_preferences.annual_fee.start_days_before == 60 %}selected{% endif %}>60 days before</option>
                            </select>
                        </div>
                    </div>

                    <label class="toggle-switch" style="margin-left: 0.5rem;">
                        <input type="checkbox" class="notification-toggle" data-type="annual_fee"
                            {% if notification_preferences.annual_fee.enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Global Save Button -->
        <div style="padding-top: 1.5rem; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; margin-top: 1rem;">
            <button id="btn-save-notifications" class="btn btn-primary" onclick="saveAllPreferences()" disabled style="opacity: 0.5; cursor: not-allowed;">
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Includes for Modals -->

{% include "accounts/partials/modal_change_name.html" %}
{% include "accounts/partials/modal_change_username.html" %}
{% include "accounts/partials/modal_avatar.html" %}
{% include "accounts/partials/modal_settings_saved.html" %}

<!-- Toast Container -->
<div id="toast-container" style="position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; display: flex; flex-direction: column; gap: 1rem; pointer-events: none;"></div>

{% endblock %}

{% block extra_js %}
<!-- Configuration for JS -->
<script>
    window.PROFILE_CONFIG = {
        csrf_token: '{{ csrf_token }}',
        urls: {
            sync_profile: '{% url "sync_profile" %}',
            update_notifications: '{% url "update_notifications" %}'
        }
    };
</script>
<script src="{% static 'js/profile.js' %}"></script>
{% endblock %}