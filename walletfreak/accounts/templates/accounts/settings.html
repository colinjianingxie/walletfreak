{% extends 'auth_base.html' %}

{% block content %}
<!-- Settings Header -->
<div style="margin-bottom: 2.5rem;">
    <h1 style="font-size: 2rem; font-weight: 700; margin: 0 0 0.5rem 0;">Settings</h1>
    <p style="color: var(--text-muted); margin: 0;">Manage your account preferences.</p>
</div>

<!-- Account Security Section -->
<div class="settings-card"
    style="background: white; border-radius: var(--radius-lg); padding: 2rem; border: 1px solid #E5E7EB; box-shadow: var(--elevation-1); margin-bottom: 2rem;">
    <h2
        style="font-size: 1.25rem; font-weight: 700; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
        <span class="material-icons" style="font-size: 1.5rem; color: var(--primary);">lock</span>
        Account Security
    </h2>

    <!-- Email Address -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md); margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Email
                    Address</div>
                <div style="font-size: 1.1rem; color: var(--dark);" id="user-email-display">{{ user.email }}</div>
            </div>
            <button class="btn btn-outline" style="padding: 0.5rem 1.25rem; font-size: 0.9rem;" onclick="openChangeEmailModal()">
                Change
            </button>
        </div>
    </div>

    <!-- Username -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md); margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Username</div>
                <div style="font-size: 1.1rem; color: var(--dark);" id="user-username-display">{{ user_profile.username|default:user_profile.first_name|default:"Not set" }}</div>
            </div>
            <button class="btn btn-outline" style="padding: 0.5rem 1.25rem; font-size: 0.9rem;" onclick="openChangeUsernameModal()">
                Change
            </button>
        </div>
    </div>

    <!-- Password -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                    Password</div>
                <div style="font-size: 1.1rem; color: var(--dark); letter-spacing: 2px;">••••••••</div>
            </div>
            <button class="btn btn-outline" style="padding: 0.5rem 1.25rem; font-size: 0.9rem;" onclick="sendPasswordReset()" id="btn-password-reset">
                Update
            </button>
        </div>
    </div>
</div>

<!-- Notifications Section -->
<div class="settings-card"
    style="background: white; border-radius: var(--radius-lg); padding: 2rem; border: 1px solid #E5E7EB; box-shadow: var(--elevation-1);">
    <h2
        style="font-size: 1.25rem; font-weight: 700; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
        <span class="material-icons" style="font-size: 1.5rem; color: var(--primary);">notifications</span>
        Notifications
    </h2>

    <!-- Blog Updates Toggle -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md); margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <div style="font-weight: 600; font-size: 1rem; color: var(--dark); margin-bottom: 0.5rem;">Blog Updates</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Get notified when new articles are published.</div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 1rem;">
                <label class="toggle-switch">
                    <input type="checkbox" class="notification-toggle" data-type="blog_updates"
                        {% if notification_preferences.blog_updates.enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Benefit Expiration Toggle -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md); margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <div style="font-weight: 600; font-size: 1rem; color: var(--dark); margin-bottom: 0.5rem;">Benefit
                    Expiration</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Alert me before a credit expires.</div>
            </div>
            
            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 0.85rem; color: var(--text-muted);">Start notifying:</span>
                    <!-- Start Days Selector -->
                     <select class="form-select pref-select" data-type="benefit_expiration" data-key="start_days_before"
                        style="padding: 0.4rem 2rem 0.4rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.9rem; background-color: white;"
                        {% if not notification_preferences.benefit_expiration.enabled %}disabled{% endif %}>
                        <option value="1" {% if notification_preferences.benefit_expiration.start_days_before == 1 %}selected{% endif %}>1 day before</option>
                        <option value="3" {% if notification_preferences.benefit_expiration.start_days_before == 3 %}selected{% endif %}>3 days before</option>
                        <option value="5" {% if notification_preferences.benefit_expiration.start_days_before == 5 %}selected{% endif %}>5 days before</option>
                        <option value="7" {% if notification_preferences.benefit_expiration.start_days_before == 7 %}selected{% endif %}>1 week before</option>
                        <option value="14" {% if notification_preferences.benefit_expiration.start_days_before == 14 %}selected{% endif %}>2 weeks before</option>
                        <option value="30" {% if notification_preferences.benefit_expiration.start_days_before == 30 %}selected{% endif %}>1 month before</option>
                    </select>
                </div>

                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 0.85rem; color: var(--text-muted);">Repeat every:</span>
                    <!-- Frequency Selector -->
                     <select class="form-select pref-select" data-type="benefit_expiration" data-key="repeat_frequency"
                        style="padding: 0.4rem 2rem 0.4rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.9rem; background-color: white;"
                        {% if not notification_preferences.benefit_expiration.enabled %}disabled{% endif %}>
                        <option value="1" {% if notification_preferences.benefit_expiration.repeat_frequency == 1 %}selected{% endif %}>Day</option>
                        <option value="2" {% if notification_preferences.benefit_expiration.repeat_frequency == 2 %}selected{% endif %}>2 Days</option>
                        <option value="3" {% if notification_preferences.benefit_expiration.repeat_frequency == 3 %}selected{% endif %}>3 Days</option>
                        <option value="5" {% if notification_preferences.benefit_expiration.repeat_frequency == 5 %}selected{% endif %}>5 Days</option>
                        <option value="7" {% if notification_preferences.benefit_expiration.repeat_frequency == 7 %}selected{% endif %}>Week</option>
                    </select>

                    <label class="toggle-switch">
                        <input type="checkbox" class="notification-toggle" data-type="benefit_expiration"
                            {% if notification_preferences.benefit_expiration.enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Annual Fee Reminders Toggle -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md);">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <div style="font-weight: 600; font-size: 1rem; color: var(--dark); margin-bottom: 0.5rem;">Annual Fee
                    Reminders</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Alert me before renewal.</div>
            </div>

            <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="font-size: 0.85rem; color: var(--text-muted);">Start notifying:</span>
                <!-- Start Days Selector -->
                <select class="form-select pref-select" data-type="annual_fee" data-key="start_days_before"
                    style="padding: 0.4rem 2rem 0.4rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.9rem; background-color: white;"
                     {% if not notification_preferences.annual_fee.enabled %}disabled{% endif %}>
                    <option value="7" {% if notification_preferences.annual_fee.start_days_before == 7 %}selected{% endif %}>1 week before</option>
                    <option value="14" {% if notification_preferences.annual_fee.start_days_before == 14 %}selected{% endif %}>2 weeks before</option>
                    <option value="30" {% if notification_preferences.annual_fee.start_days_before == 30 %}selected{% endif %}>30 days before</option>
                    <option value="45" {% if notification_preferences.annual_fee.start_days_before == 45 %}selected{% endif %}>45 days before</option>
                    <option value="60" {% if notification_preferences.annual_fee.start_days_before == 60 %}selected{% endif %}>60 days before</option>
                </select>

                <label class="toggle-switch">
                    <input type="checkbox" class="notification-toggle" data-type="annual_fee"
                        {% if notification_preferences.annual_fee.enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>
</div>

<!-- Change Email Modal -->
<div id="email-modal" class="modal-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: var(--radius-lg); width: 100%; max-width: 400px; box-shadow: var(--elevation-3);">
        <h3 style="margin-top: 0; font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Change Email Address</h3>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">Please enter your new email address. You may need to verify it.</p>
        
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; font-size: 0.9rem; margin-bottom: 0.5rem;">New Email</label>
            <input type="email" id="new-email-input" class="form-control" placeholder="Enter new email" style="width: 100%;">
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 1rem;">
            <button class="btn btn-ghost" onclick="closeChangeEmailModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitChangeEmail()" id="btn-save-email">Save Changes</button>
        </div>
    </div>
    </div>
</div>

<!-- Change Username Modal -->
<div id="username-modal" class="modal-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: var(--radius-lg); width: 100%; max-width: 400px; box-shadow: var(--elevation-3);">
        <h3 style="margin-top: 0; font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Change Username</h3>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">Enter your new display name.</p>
        
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; font-size: 0.9rem; margin-bottom: 0.5rem;">New Username</label>
            <input type="text" id="new-username-input" class="form-control" placeholder="Enter new username" style="width: 100%;">
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 1rem;">
            <button class="btn btn-ghost" onclick="closeChangeUsernameModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitChangeUsername()" id="btn-save-username">Save Changes</button>
        </div>
    </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" style="position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; display: flex; flex-direction: column; gap: 1rem; pointer-events: none;"></div>

<style>
    @media (max-width: 768px) {
        div[style*="display: flex"][style*="justify-content: space-between"]>div:first-child {
            margin-bottom: 0.75rem;
        }
        .frequency-select {
            max-width: 140px;
        }
        #toast-container {
            bottom: 1rem;
            right: 1rem;
            left: 1rem;
        }
    }
    
    /* Toast Styles */
    .toast {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--elevation-3);
        padding: 1rem 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: auto;
        min-width: 300px;
        transform-origin: bottom right;
        border-left: 4px solid var(--primary);
    }
    .toast.error {
        border-left-color: #EF4444;
    }
    .toast.success {
        border-left-color: #10B981;
    }
    .toast-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        background: rgba(16, 185, 129, 0.1);
        color: #10B981;
    }
    .toast.error .toast-icon {
        background: rgba(239, 68, 68, 0.1);
        color: #EF4444;
    }
    .toast-content {
        color: var(--dark);
        font-size: 0.95rem;
        font-weight: 500;
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(20px) scale(0.9); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes fadeOut {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.9); }
    }
    
    /* Loader Spinner */
    .loader {
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top: 2px solid white;
        width: 16px;
        height: 16px;
        -webkit-animation: spin 1s linear infinite; /* Safari */
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
    // --- Toast Notification ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icon = type === 'success' ? 'check' : 'error_outline';
        
        toast.innerHTML = `
            <div class="toast-icon">
                <span class="material-icons" style="font-size: 16px;">${icon}</span>
            </div>
            <div class="toast-content">${message}</div>
        `;
        
        container.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s forwards';
            setTimeout(() => {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 300);
        }, 3000);
    }

    // --- Notification Preferences ---
    const notificationToggles = document.querySelectorAll('.notification-toggle');
    const prefSelects = document.querySelectorAll('.pref-select');
    
    // Store initial state
    const preferences = {
        blog_updates: {
             enabled: {{ notification_preferences.blog_updates.enabled|yesno:"true,false"|default:"false" }}
        },
        benefit_expiration: {
            enabled: {{ notification_preferences.benefit_expiration.enabled|yesno:"true,false"|default:"false" }},
            start_days_before: {{ notification_preferences.benefit_expiration.start_days_before|default:7 }},
            repeat_frequency: {{ notification_preferences.benefit_expiration.repeat_frequency|default:1 }}
        },
        annual_fee: {
            enabled: {{ notification_preferences.annual_fee.enabled|yesno:"true,false"|default:"false" }},
            start_days_before: {{ notification_preferences.annual_fee.start_days_before|default:30 }},
            repeat_frequency: {{ notification_preferences.annual_fee.repeat_frequency|default:7 }}
        }
    };

    function savePreferences() {
        console.log('Saving preferences:', preferences);
        fetch('{% url "update_notifications" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ preferences: preferences })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Optional: Show saved toast
            } else {
                alert('Failed to save preferences: ' + data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    notificationToggles.forEach(toggle => {
        toggle.addEventListener('change', (e) => {
            const type = e.target.dataset.type;
            const enabled = e.target.checked;
            
            // Update state
            if (!preferences[type]) preferences[type] = {};
            preferences[type].enabled = enabled;
            
            // Toggle select disabled state for this type
            const selects = document.querySelectorAll(`.pref-select[data-type="${type}"]`);
            selects.forEach(s => s.disabled = !enabled);
            
            savePreferences();
        });
    });

    prefSelects.forEach(select => {
        select.addEventListener('change', (e) => {
            const type = e.target.dataset.type;
            const key = e.target.dataset.key; // start_days_before or repeat_frequency
            const value = parseInt(e.target.value);
            
            // Update state
            if (!preferences[type]) preferences[type] = {};
            preferences[type][key] = value;
            
            savePreferences();
        });
    });

    // --- Account Security ---

    // Password Reset
    function sendPasswordReset() {
        const user = firebase.auth().currentUser;
        if (user && user.email) {
            const btn = document.getElementById('btn-password-reset');
            const originalText = btn.innerText;
            btn.innerText = 'Sending...';
            btn.disabled = true;

            firebase.auth().sendPasswordResetEmail(user.email)
                .then(() => {
                    alert('Password reset email sent to ' + user.email);
                })
                .catch((error) => {
                    console.error('Error sending password reset email:', error);
                    alert('Error: ' + error.message);
                })
                .finally(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }
    }

    // Change Email
    const emailModal = document.getElementById('email-modal');
    
    function openChangeEmailModal() {
        emailModal.style.display = 'flex';
        document.getElementById('new-email-input').value = '';
        document.getElementById('new-email-input').focus();
    }
    
    function closeChangeEmailModal() {
        emailModal.style.display = 'none';
    }
    
    // Close modal on outside click
    emailModal.addEventListener('click', (e) => {
        if (e.target === emailModal) closeChangeEmailModal();
    });

    async function submitChangeEmail() {
        const newEmail = document.getElementById('new-email-input').value;
        if (!newEmail || !newEmail.includes('@')) {
            alert('Please enter a valid email address.');
            return;
        }

        const btn = document.getElementById('btn-save-email');
        const originalText = btn.innerText;
        btn.innerText = 'Saving...';
        btn.disabled = true;

        try {
            const user = firebase.auth().currentUser;
            
            // 1. Update in Firebase Auth
            await user.updateEmail(newEmail);
            
            // 2. Sync with Backend
            const response = await fetch('{% url "sync_profile" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ email: newEmail })
            });

            if (!response.ok) throw new Error('Failed to sync profile');
            
            // Success
            alert('Email updated successfully!');
            document.getElementById('user-email-display').innerText = newEmail;
            closeChangeEmailModal();

        } catch (error) {
            console.error('Error updating email:', error);
            if (error.code === 'auth/requires-recent-login') {
                alert('For security, please log out and log in again before changing your email.');
            } else {
                alert('Error updating email: ' + error.message);
            }
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // Change Username
    const usernameModal = document.getElementById('username-modal');
    
    function openChangeUsernameModal() {
        usernameModal.style.display = 'flex';
        const currentUsername = document.getElementById('user-username-display').innerText;
        if (currentUsername !== 'Not set') {
            document.getElementById('new-username-input').value = currentUsername;
        } else {
            document.getElementById('new-username-input').value = '';
        }
        document.getElementById('new-username-input').focus();
    }
    
    function closeChangeUsernameModal() {
        usernameModal.style.display = 'none';
    }
    
    // Close modal on outside click
    usernameModal.addEventListener('click', (e) => {
        if (e.target === usernameModal) closeChangeUsernameModal();
    });

    async function submitChangeUsername() {
        const newUsername = document.getElementById('new-username-input').value.trim();
        if (!newUsername || newUsername.length < 3) {
            showToast('Please enter a username with at least 3 characters.', 'error');
            return;
        }

        const btn = document.getElementById('btn-save-username');
        const originalText = btn.innerText;
        
        // Set loading state
        btn.innerHTML = '<span class="loader"></span> Saving...';
        btn.disabled = true;

        try {
            // Sync with Backend
            const response = await fetch('{% url "sync_profile" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ username: newUsername })
            });
            
            const data = await response.json();

            if (data.status === 'success') {
                showToast('Username updated successfully!');
                document.getElementById('user-username-display').innerText = newUsername;
                closeChangeUsernameModal();
            } else {
                throw new Error(data.message || 'Failed to update username');
            }

        } catch (error) {
            console.error('Error updating username:', error);
            // Display specific error message from server if available
            const msg = error.message.replace('Error: ', '');
            showToast(msg, 'error');
        } finally {
            // Reset button state
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>
{% endblock %}