{% extends 'auth_base.html' %}

{% block content %}
<!-- Settings Header -->
<div style="margin-bottom: 2.5rem;">
    <h1 style="font-size: 2rem; font-weight: 700; margin: 0 0 0.5rem 0;">Settings</h1>
    <p style="color: var(--text-muted); margin: 0;">Manage your account preferences.</p>
</div>

<!-- Account Security Section -->
<div class="settings-card"
    style="background: white; border-radius: var(--radius-lg); padding: 2rem; border: 1px solid #E5E7EB; box-shadow: var(--elevation-1); margin-bottom: 2rem;">
    <h2
        style="font-size: 1.25rem; font-weight: 700; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
        <span class="material-icons" style="font-size: 1.5rem; color: var(--primary);">lock</span>
        Account Security
    </h2>

    <!-- Email Address -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md); margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Email
                    Address</div>
                <div style="font-size: 1.1rem; color: var(--dark);" id="user-email-display">{{ user.email }}</div>
            </div>
            <button class="btn btn-outline" style="padding: 0.5rem 1.25rem; font-size: 0.9rem;" onclick="openChangeEmailModal()">
                Change
            </button>
        </div>
    </div>

    <!-- Password -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                    Password</div>
                <div style="font-size: 1.1rem; color: var(--dark); letter-spacing: 2px;">••••••••</div>
            </div>
            <button class="btn btn-outline" style="padding: 0.5rem 1.25rem; font-size: 0.9rem;" onclick="sendPasswordReset()" id="btn-password-reset">
                Update
            </button>
        </div>
    </div>
</div>

<!-- Notifications Section -->
<div class="settings-card"
    style="background: white; border-radius: var(--radius-lg); padding: 2rem; border: 1px solid #E5E7EB; box-shadow: var(--elevation-1);">
    <h2
        style="font-size: 1.25rem; font-weight: 700; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
        <span class="material-icons" style="font-size: 1.5rem; color: var(--primary);">notifications</span>
        Notifications
    </h2>

    <!-- Benefit Expiration Toggle -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md); margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <div style="font-weight: 600; font-size: 1rem; color: var(--dark); margin-bottom: 0.5rem;">Benefit
                    Expiration</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Alert me before a credit expires.</div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Frequency Selector -->
                 <select class="form-select frequency-select" data-type="benefit_expiration" 
                    style="padding: 0.4rem 2rem 0.4rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.9rem; background-color: white;"
                    {% if not notification_preferences.benefit_expiration.enabled %}disabled{% endif %}>
                    <option value="1" {% if notification_preferences.benefit_expiration.frequency == 1 %}selected{% endif %}>1 day before</option>
                    <option value="3" {% if notification_preferences.benefit_expiration.frequency == 3 %}selected{% endif %}>3 days before</option>
                    <option value="5" {% if notification_preferences.benefit_expiration.frequency == 5 %}selected{% endif %}>5 days before</option>
                    <option value="7" {% if notification_preferences.benefit_expiration.frequency == 7 %}selected{% endif %}>1 week before</option>
                    <option value="14" {% if notification_preferences.benefit_expiration.frequency == 14 %}selected{% endif %}>2 weeks before</option>
                </select>

                <label class="toggle-switch">
                    <input type="checkbox" class="notification-toggle" data-type="benefit_expiration"
                        {% if notification_preferences.benefit_expiration.enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Annual Fee Reminders Toggle -->
    <div style="padding: 1.25rem; background: var(--bg-body); border-radius: var(--radius-md);">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <div style="font-weight: 600; font-size: 1rem; color: var(--dark); margin-bottom: 0.5rem;">Annual Fee
                    Reminders</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Alert me before renewal.</div>
            </div>

            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Frequency Selector -->
                <select class="form-select frequency-select" data-type="annual_fee"
                    style="padding: 0.4rem 2rem 0.4rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.9rem; background-color: white;"
                     {% if not notification_preferences.annual_fee.enabled %}disabled{% endif %}>
                    <option value="7" {% if notification_preferences.annual_fee.frequency == 7 %}selected{% endif %}>1 week before</option>
                    <option value="14" {% if notification_preferences.annual_fee.frequency == 14 %}selected{% endif %}>2 weeks before</option>
                    <option value="30" {% if notification_preferences.annual_fee.frequency == 30 %}selected{% endif %}>30 days before</option>
                    <option value="45" {% if notification_preferences.annual_fee.frequency == 45 %}selected{% endif %}>45 days before</option>
                    <option value="60" {% if notification_preferences.annual_fee.frequency == 60 %}selected{% endif %}>60 days before</option>
                </select>

                <label class="toggle-switch">
                    <input type="checkbox" class="notification-toggle" data-type="annual_fee"
                        {% if notification_preferences.annual_fee.enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>
</div>

<!-- Change Email Modal -->
<div id="email-modal" class="modal-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: var(--radius-lg); width: 100%; max-width: 400px; box-shadow: var(--elevation-3);">
        <h3 style="margin-top: 0; font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Change Email Address</h3>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">Please enter your new email address. You may need to verify it.</p>
        
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 500; font-size: 0.9rem; margin-bottom: 0.5rem;">New Email</label>
            <input type="email" id="new-email-input" class="form-control" placeholder="Enter new email" style="width: 100%;">
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 1rem;">
            <button class="btn btn-ghost" onclick="closeChangeEmailModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitChangeEmail()" id="btn-save-email">Save Changes</button>
        </div>
    </div>
</div>

<style>
    @media (max-width: 768px) {
        div[style*="display: flex"][style*="justify-content: space-between"]>div:first-child {
            margin-bottom: 0.75rem;
        }
        .frequency-select {
            max-width: 140px;
        }
    }
</style>

<script>
    // --- Notification Preferences ---
    const notificationToggles = document.querySelectorAll('.notification-toggle');
    const frequencySelects = document.querySelectorAll('.frequency-select');
    
    // Store initial state
    const preferences = {
        benefit_expiration: {
            enabled: {{ notification_preferences.benefit_expiration.enabled|yesno:"true,false" }},
            frequency: {{ notification_preferences.benefit_expiration.frequency }}
        },
        annual_fee: {
            enabled: {{ notification_preferences.annual_fee.enabled|yesno:"true,false" }},
            frequency: {{ notification_preferences.annual_fee.frequency }}
        }
    };

    function savePreferences() {
        fetch('{% url "update_notifications" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ preferences: preferences })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Optional: Show saved toast
            } else {
                alert('Failed to save preferences: ' + data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    notificationToggles.forEach(toggle => {
        toggle.addEventListener('change', (e) => {
            const type = e.target.dataset.type;
            const enabled = e.target.checked;
            
            // Update state
            preferences[type].enabled = enabled;
            
            // Toggle select disabled state
            const select = document.querySelector(`.frequency-select[data-type="${type}"]`);
            if (select) {
                select.disabled = !enabled;
            }
            
            savePreferences();
        });
    });

    frequencySelects.forEach(select => {
        select.addEventListener('change', (e) => {
            const type = e.target.dataset.type;
            const frequency = parseInt(e.target.value);
            
            // Update state
            preferences[type].frequency = frequency;
            
            savePreferences();
        });
    });

    // --- Account Security ---

    // Password Reset
    function sendPasswordReset() {
        const user = firebase.auth().currentUser;
        if (user && user.email) {
            const btn = document.getElementById('btn-password-reset');
            const originalText = btn.innerText;
            btn.innerText = 'Sending...';
            btn.disabled = true;

            firebase.auth().sendPasswordResetEmail(user.email)
                .then(() => {
                    alert('Password reset email sent to ' + user.email);
                })
                .catch((error) => {
                    console.error('Error sending password reset email:', error);
                    alert('Error: ' + error.message);
                })
                .finally(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }
    }

    // Change Email
    const emailModal = document.getElementById('email-modal');
    
    function openChangeEmailModal() {
        emailModal.style.display = 'flex';
        document.getElementById('new-email-input').value = '';
        document.getElementById('new-email-input').focus();
    }
    
    function closeChangeEmailModal() {
        emailModal.style.display = 'none';
    }
    
    // Close modal on outside click
    emailModal.addEventListener('click', (e) => {
        if (e.target === emailModal) closeChangeEmailModal();
    });

    async function submitChangeEmail() {
        const newEmail = document.getElementById('new-email-input').value;
        if (!newEmail || !newEmail.includes('@')) {
            alert('Please enter a valid email address.');
            return;
        }

        const btn = document.getElementById('btn-save-email');
        const originalText = btn.innerText;
        btn.innerText = 'Saving...';
        btn.disabled = true;

        try {
            const user = firebase.auth().currentUser;
            
            // 1. Update in Firebase Auth
            await user.updateEmail(newEmail);
            
            // 2. Sync with Backend
            const response = await fetch('{% url "sync_profile" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ email: newEmail })
            });

            if (!response.ok) throw new Error('Failed to sync profile');
            
            // Success
            alert('Email updated successfully!');
            document.getElementById('user-email-display').innerText = newEmail;
            closeChangeEmailModal();

        } catch (error) {
            console.error('Error updating email:', error);
            if (error.code === 'auth/requires-recent-login') {
                alert('For security, please log out and log in again before changing your email.');
            } else {
                alert('Error updating email: ' + error.message);
            }
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
</script>
{% endblock %}