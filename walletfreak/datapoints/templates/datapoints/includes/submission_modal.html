<div id="submit-modal" class="dp-modal-overlay">
    <div class="dp-modal-container">
        <div class="dp-modal-header">
            <div>
                <h2 class="dp-modal-title">Submit Data Point</h2>
            </div>
            <button onclick="closeModal('submit-modal')" class="dp-modal-close">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 1.25rem; height: 1.25rem;">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
        </div>
        <div class="dp-modal-body">
            <form id="dp-submit-form" onsubmit="submitDatapoint(event)">
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div>
                        <label style="display: block; font-size: 0.625rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem;">1. Choose Card</label>
                        <select name="card_slug" required class="dp-select" style="width: 100%;" id="card_select">
                            <option value="">Select a Card...</option>
                            {% for card in submission_cards %}
                            <option value="{{ card.slug }}" data-name="{{ card.name }}">{{ card.name }}</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="card_name" id="card_name_input">
                    </div>
                
                    <div>
                        <label style="display: block; font-size: 0.625rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem;">2. Benefit</label>
                        <select name="benefit_name" required class="dp-select" style="width: 100%;" id="benefit_select" disabled>
                            <option value="">Select a Card First...</option>
                        </select>
                         <input type="hidden" name="benefit_id" id="benefit_id_input">
                    </div>

                    <div>
                        <label style="display: block; font-size: 0.625rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem;">3. Status</label>
                        <div style="display: flex; gap: 1rem;">
                            <label class="dp-radio-label">
                                <input type="radio" name="status" value="Success" checked onchange="toggleDateFields()">
                                <span class="dp-status-badge dp-status-success">Success</span>
                            </label>
                            <label class="dp-radio-label">
                                <input type="radio" name="status" value="Failed" onchange="toggleDateFields()">
                                <span class="dp-status-badge dp-status-failed">Failed</span>
                            </label>
                        </div>
                    </div>

                    <div id="date-fields-container">
                         <div style="display: flex; gap: 1rem;">
                            <div style="flex: 1;">
                                <label style="display: block; font-size: 0.625rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Transaction Date</label>
                                <input type="date" name="transaction_date" class="dp-select" style="width: 100%;">
                            </div>
                            <div style="flex: 1;" id="cleared-date-wrapper">
                                <label style="display: block; font-size: 0.625rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Cleared Date</label>
                                <input type="date" name="cleared_date" class="dp-select" style="width: 100%;">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; font-size: 0.625rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem;">4. Details</label>
                        <textarea name="content" required placeholder="Describe your experience..." class="dp-search-input" style="padding-left: 1rem; min-height: 100px; resize: vertical;"></textarea>
                    </div>
                    
                    <input type="hidden" name="edit_datapoint_id" id="edit_datapoint_id">
                    <button type="submit" class="dp-submit-btn" id="modal-submit-btn">Submit Data Point</button>
                </div>
                <button type="button" onclick="closeModal('submit-modal')" style="width: 100%; margin-top: 0.75rem; background: none; border: none; font-weight: 700; color: #94a3b8; cursor: pointer; padding: 0.5rem;">
                    Cancel
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Store benefits data safely in a script tag -->
{{ submission_cards|json_script:"submission-cards-data" }}

<script>
(function() {
    var cardSelect, benefitSelect, cardNameInput, clearedDateWrapper, modalTitle, modalSubmitBtn, editIdInput, benefitIdInput, form, transactionDateInput, clearedDateInput;

    function initElements() {
        cardSelect = document.getElementById('card_select');
        benefitSelect = document.getElementById('benefit_select');
        cardNameInput = document.getElementById('card_name_input');
        clearedDateWrapper = document.getElementById('cleared-date-wrapper');
        modalTitle = document.querySelector('.dp-modal-title');
        modalSubmitBtn = document.getElementById('modal-submit-btn');
        editIdInput = document.getElementById('edit_datapoint_id');
        benefitIdInput = document.getElementById('benefit_id_input');
        form = document.getElementById('dp-submit-form');
        
        if (form) {
            transactionDateInput = form.querySelector('input[name="transaction_date"]');
            clearedDateInput = form.querySelector('input[name="cleared_date"]');
        }
    }
    
    initElements();
    
    // Make these globally available for inline event handlers (onchange="toggleDateFields()")
    window.toggleDateFields = function() {
        if (!clearedDateWrapper) { 
            clearedDateWrapper = document.getElementById('cleared-date-wrapper');
            if(!clearedDateWrapper) return;
        }
        var statusInput = document.querySelector('input[name="status"]:checked');
        if (statusInput) {
            var status = statusInput.value;
            if (status === 'Failed') {
                clearedDateWrapper.style.display = 'none';
            } else {
                clearedDateWrapper.style.display = 'block';
            }
        }
    };
    
    function setMaxDate() {
        if (transactionDateInput && clearedDateInput) {
            var today = new Date().toISOString().split('T')[0];
            transactionDateInput.setAttribute('max', today);
            clearedDateInput.setAttribute('max', today);
        }
    }
    
    function validateDates() {
        if (!transactionDateInput || !clearedDateInput) return;
        var tVal = transactionDateInput.value;
        var cVal = clearedDateInput.value;
        
        if (tVal) {
             clearedDateInput.setAttribute('min', tVal);
        }
        
        if (tVal && cVal) {
            if (cVal < tVal) {
                clearedDateInput.value = '';
            }
        }
    }
    
    if (transactionDateInput) transactionDateInput.addEventListener('change', validateDates);
    if (clearedDateInput) clearedDateInput.addEventListener('change', validateDates);

    setMaxDate();
    window.toggleDateFields(); // Call it once
    
    var cardBenefitsMap = {
        {% for card in submission_cards %}
        "{{ card.slug }}": [
            {% for benefit in card.benefits %}
            {
                "name": "{{ benefit.short_description|default:benefit.description|escapejs }}",
                "details": "{{ benefit.additional_details|default:''|escapejs }}",
                "value": "{{ benefit.numeric_value|default:0 }}",
                "type": "{{ benefit.numeric_type|default:''|escapejs }}",
                "benefit_type": "{{ benefit.benefit_type|default:''|escapejs }}",
                "id": "{{ benefit.id|escapejs }}"
            },
            {% endfor %}
        ],
        {% endfor %}
    };

    if (cardSelect) {
        cardSelect.addEventListener('change', function() {
            var selectedOption = this.options[this.selectedIndex];
            var slug = this.value;
            
            if (cardNameInput) cardNameInput.value = selectedOption.getAttribute('data-name');
            
            if (benefitSelect) {
                benefitSelect.innerHTML = '<option value="">Select a Benefit...</option>';
                benefitSelect.disabled = false;
            }
            if (benefitIdInput) benefitIdInput.value = '';
            
            if (slug && cardBenefitsMap[slug] && benefitSelect) {
                var credits = cardBenefitsMap[slug].filter(function(b) { return b.benefit_type === 'Credit'; });
                
                credits.forEach(function(bnf) {
                    var opt = document.createElement('option');
                    opt.value = bnf.name;
                    opt.setAttribute('data-id', bnf.id || '');
                    
                    var label = bnf.name;
                    if (bnf.details && bnf.details !== 'None' && bnf.details.trim() !== '') {
                        label += ' (' + bnf.details + ')';
                    }
                    
                    var val = parseFloat(bnf.value);
                    if (val > 0) {
                        if (bnf.type === 'Cash') {
                            label += ' - $' + val; 
                        } else if (bnf.type) {
                            label += ' - ' + val + ' ' + bnf.type;
                        }
                    }
                    
                    if (label.length > 100) label = label.substring(0, 100) + '...';
                    
                    opt.textContent = label;
                    benefitSelect.appendChild(opt);
                });
                
                var otherOpt = document.createElement('option');
                otherOpt.value = "Other";
                otherOpt.textContent = "Other";
                benefitSelect.appendChild(otherOpt);
                
            } else if (benefitSelect) {
                benefitSelect.disabled = true;
                benefitSelect.innerHTML = '<option value="">Select a Card First...</option>';
            }
        });
    }

    if (benefitSelect) {
        benefitSelect.addEventListener('change', function() {
            var selectedOption = this.options[this.selectedIndex];
            var bId = selectedOption.getAttribute('data-id');
            if (benefitIdInput) benefitIdInput.value = bId || '';
        });
    }

    window.submitDatapoint = function(e) {
        e.preventDefault();
        // Lazy init
        if (!form) initElements();
        
        if (!form || !editIdInput) return; 

        var formData = new FormData(form);
        var editId = editIdInput.value;
        
        var url = '{% url "submit_datapoint" %}';
        if (editId) {
            url = '/datapoints/edit/' + editId + '/';
        }

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error submitting: ' + JSON.stringify(data.errors || data.error));
            }
        });
    };
    
    window.openSubmissionModal = function() {
        initElements();
        if (!form) return;

        form.reset();
        if (editIdInput) editIdInput.value = '';
        if (modalTitle) modalTitle.innerText = "Submit Data Point";
        if (modalSubmitBtn) modalSubmitBtn.innerText = "Submit Data Point";
        
        if (cardSelect) cardSelect.disabled = false;
        if (benefitSelect) {
            benefitSelect.disabled = true; 
            benefitSelect.innerHTML = '<option value="">Select a Card First...</option>';
        }
        if (cardNameInput) cardNameInput.value = '';
        if (benefitIdInput) benefitIdInput.value = '';
        window.toggleDateFields();
        setMaxDate();
        
        var modal = document.getElementById('submit-modal');
        if (modal) modal.classList.add('active');
    };

    window.openEditModal = function(datapointId) {
        initElements();
        if (!form) return;

        form.reset();
        if (editIdInput) editIdInput.value = datapointId;
        if (modalTitle) modalTitle.innerText = "Edit Data Point";
        if (modalSubmitBtn) modalSubmitBtn.innerText = "Save Changes";
        
        if (cardSelect) cardSelect.disabled = true;
        if (benefitSelect) benefitSelect.disabled = true;
        
        var modal = document.getElementById('submit-modal');
        if (modal) modal.classList.add('active');
        
        fetch('/datapoints/get/' + datapointId + '/')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    var dp = data.datapoint;
                    
                    var contentArea = form.querySelector('textarea[name="content"]');
                    if (contentArea) contentArea.value = dp.content;
                    
                    if (dp.transaction_date && transactionDateInput) transactionDateInput.value = dp.transaction_date;
                    if (dp.cleared_date && clearedDateInput) clearedDateInput.value = dp.cleared_date;
                    
                    var statusRadios = form.querySelectorAll('input[name="status"]');
                    statusRadios.forEach(function(r) {
                        if (r.value === dp.status) r.checked = true;
                    });
                    window.toggleDateFields();
                    
                    if (cardSelect) {
                        cardSelect.disabled = false;
                        if (dp.card_slug) {
                            cardSelect.value = dp.card_slug;
                            cardSelect.dispatchEvent(new Event('change'));
                            
                            if (dp.benefit_name && benefitSelect) {
                                benefitSelect.value = dp.benefit_name;
                            }
                        }
                        cardSelect.disabled = true;
                    }
                    if (benefitSelect) benefitSelect.disabled = true;

                } else {
                    alert("Error loading data point");
                    var modal = document.getElementById('submit-modal');
                    if (modal) modal.classList.remove('active');
                }
            });
    };
    
    var origClose = window.closeModal;
    window.closeModal = function(id) {
        if (id === 'submit-modal') {
             setTimeout(function() {
                 if (editIdInput) editIdInput.value = '';
                 if (modalTitle) modalTitle.innerText = "Submit Data Point";
                 if (modalSubmitBtn) modalSubmitBtn.innerText = "Submit Data Point";
                 if (cardSelect) cardSelect.disabled = false;
                 if (benefitSelect) benefitSelect.disabled = true;
                 if (form) form.reset();
                 window.toggleDateFields();
             }, 300);
        }
        var el = document.getElementById(id);
        if (el) el.classList.remove('active');
        if (document.body) document.body.style.overflow = '';
    };

})();
</script>
