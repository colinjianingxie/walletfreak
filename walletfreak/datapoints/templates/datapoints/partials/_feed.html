{% load humanize %}

<!-- Loading Indicator Overlay -->
<div class="dp-loading-overlay htmx-indicator">
    <div class="dp-loading-spinner"></div>
</div>

{% for dp in datapoints %}
<div class="dp-card">
    <!-- User Section -->
    <div class="dp-user-section">
        <button class="dp-user-btn" onclick="openWalletModal('{{ dp.user_display_name }}', '{{ dp.user.username }}')">
            <div>
                <div class="dp-user-name" style="font-weight: 600; font-size: 0.875rem;">
                    @{{ dp.user_display_name|default:"anonymous" }}
                </div>
                <div class="dp-view-wallet" style="margin-top: 0.25rem;">View Wallet</div>
            </div>
        </button>
        
        <div class="dp-card-info">
            <div class="dp-card-chip">
                {% if dp.card_image_url %}
                    <img src="{{ dp.card_image_url }}" alt="{{ dp.card_name }}" style="width: 48px; height: auto; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                {% else %}
                    <div class="dp-chip-color" style="background: linear-gradient(135deg, #cbd5e1, #94a3b8);"></div>
                {% endif %}
                <span class="dp-card-name">{{ dp.card_name }}</span>
            </div>
            <div class="dp-benefit-tag">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 0.625rem; height: 0.625rem; flex-shrink: 0;" fill="currentColor">
                    <path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"></path>
                </svg>
                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ dp.benefit_name }}</span>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="dp-content-section">
            <!-- Status and Dates -->
            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                <div class="dp-meta-row">
                    {% if dp.status == 'Success' %}
                    <div class="dp-status-badge dp-status-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 0.625rem; height: 0.625rem;">
                            <path d="M20 6 9 17l-5-5"></path>
                        </svg>
                        Success
                    </div>
                    {% else %}
                    <div class="dp-status-badge dp-status-failed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 0.625rem; height: 0.625rem;">
                            <path d="M18 6 6 18"></path>
                            <path d="m6 6 12 12"></path>
                        </svg>
                        Failed
                    </div>
                    {% endif %}
                    
                    <div class="dp-time">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 0.75rem; height: 0.75rem;">
                            <path d="M12 6v6l4 2"></path>
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                        {{ dp.date_posted|naturaltime }}
                        {% if dp.is_edited %}
                        <span style="font-style: italic; margin-left: 0.25rem;">(edited)</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Date Details -->
                {% if dp.transaction_date or dp.cleared_date %}
                <div style="font-size: 0.875rem; color: #334155; font-weight: 500;">
                    {% if dp.transaction_date %}
                        Purchased on {{ dp.transaction_date|date:"M j, Y" }}
                    {% endif %}
                    
                    {% if dp.status == 'Success' and dp.cleared_date %}
                        {% if dp.transaction_date %}, {% endif %}
                        Cleared on {{ dp.cleared_date|date:"M j, Y" }}
                    {% endif %}
                </div>
                {% endif %}
            </div>

        <p class="dp-body-text">{{ dp.content }}</p>

        <div class="dp-actions-footer">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <button class="dp-like-btn {% if dp.is_liked %}liked{% endif %}" onclick="voteDatapoint(this, '{{ dp.id }}')" style="display: flex; align-items: center; gap: 0.25rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 0.875rem; height: 0.875rem;">
                        <path d="M7 10v12"></path>
                        <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path>
                    </svg>
                    <span style="font-size: 0.75rem; font-weight: 700;">Works</span>
                    <span class="vote-count" style="font-size: 0.75rem;">{{ dp.upvote_count }}</span>
                </button>
                <span class="last-verified-label" style="font-size: 0.65rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1px;">
                    {% if dp.last_verified %}
                    Last verified {{ dp.last_verified|naturaltime }}
                    {% endif %}
                </span>
            </div>

            {% if request.user.username == dp.user_id %}
            <button onclick="openEditModal('{{ dp.id }}')" style="background: none; border: none; cursor: pointer; color: #64748b; font-size: 0.75rem; font-weight: 600; padding: 0; display: flex; align-items: center; gap: 0.25rem;">
                Edit
            </button>
            {% endif %}

            <!-- Outdated Button -->
            <button class="dp-outdated-btn {% if dp.is_outdated %}outdated{% endif %}" onclick="markOutdated(this, '{{ dp.id }}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 0.875rem; height: 0.875rem;">
                    <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path>
                </svg>
                <span>Outdated</span>
                <span class="outdated-count">{{ dp.outdated_count }}</span>
            </button>
        </div>
    </div>
</div>
{% empty %}
<div style="text-align: center; color: #64748b; padding: 4rem;">
    <p>No data points found. Be the first to submit one!</p>
</div>
{% endfor %}

<!-- OOB Update for Filter Chips -->
{% if is_htmx %}
<div id="dp-filter-chips-section" hx-swap-oob="true">
    {% include 'datapoints/partials/_filter_chips.html' %}
</div>
{% endif %}
