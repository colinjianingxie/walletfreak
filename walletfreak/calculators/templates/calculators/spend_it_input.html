{% extends 'base.html' %}
{% load static %}

{% block extra_css %}

<link rel="stylesheet" href="{% static 'css/card_modal.css' %}">
<style>
    /* Custom CSS for Spend It Calculator - Replacing Tailwind */
    
    :root {
        --si-primary: #4F46E5; /* Indigo 600 */
        --si-primary-hover: #4338CA; /* Indigo 700 */
        --si-bg: #FFFFFF;
        --si-text-main: #0F172A; /* Slate 900 */
        --si-text-muted: #64748B; /* Slate 500 */
        --si-text-light: #94A3B8; /* Slate 400 */
        --si-border: #F1F5F9; /* Slate 100 */
        --si-input-bg: #F8FAFC; /* Slate 50 */
    }

    .spend-it-main {
        flex: 1;
        position: relative;
        z-index: 10;
        width: 100%;
        min-height: 100vh;
        background-color: transparent;
        font-family: 'Outfit', sans-serif;
    }

    .spend-it-wrapper {
        max-width: 80rem; /* 7xl */
        margin: 0 auto;
        padding: 2rem 1.5rem 8rem 1.5rem; /* pt-8 pb-32 px-6 */
    }

    @media (min-width: 768px) {
        .spend-it-wrapper {
            padding: 3rem 2.5rem 8rem 2.5rem; /* md:pt-12 md:px-10 */
        }
    }

    /* Back Link */
    .back-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--si-text-light);
        font-weight: 700;
        font-size: 0.875rem;
        margin-bottom: 2rem;
        transition: color 0.15s;
        text-decoration: none;
    }
    .back-link:hover {
        color: var(--si-text-main);
    }

    .content-spacer {
        display: flex;
        flex-direction: column;
        gap: 2.5rem; /* space-y-10 */
    }

    /* Main Card */
    .spend-it-card {
        max-width: 56rem; /* 4xl */
        margin: 0 auto;
        background-color: white;
        border-radius: 2.5rem;
        padding: 2rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* approximated shadow-2xl */
        border: 1px solid var(--si-border);
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
        align-items: center;
        width: 100%;
    }

    @media (min-width: 768px) {
        .spend-it-card {
            padding: 3rem;
        }
    }

    .form-content {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 2.5rem; /* space-y-10 */
    }

    .header-section {
        text-align: center;
    }
    
    .title {
        font-size: 1.875rem; /* 3xl */
        font-weight: 900;
        color: var(--si-text-main);
        margin-bottom: 0.5rem;
        line-height: 1.25;
    }

    .subtitle {
        color: var(--si-text-muted);
        font-weight: 500;
    }

    .inputs-section {
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
    }

    /* Amount Input */
    .amount-input-wrapper {
        position: relative;
        max-width: 32rem; /* lg */
        margin: 0 auto;
        width: 100%;
    }

    .input-icon {
        position: absolute;
        left: 1.5rem;
        top: 44%;
        transform: translateY(-50%);
        width: 2rem;
        height: 2rem;
        color: var(--si-primary);
        pointer-events: none;
    }

    .amount-input {
        width: 100%;
        padding: 1.5rem 2rem 1.5rem 4rem; /* py-6 pl-16 pr-8 */
        background-color: var(--si-input-bg);
        border: 2px solid transparent;
        border-radius: 1.5rem;
        font-size: 2.25rem; /* 4xl */
        font-weight: 900;
        outline: none;
        transition: all 0.2s;
        text-align: center;
        color: var(--si-text-main);
    }
    
    .amount-input::placeholder {
        color: #CBD5E1; /* slate-300 */
    }

    .amount-input:focus {
        border-color: var(--si-primary);
        background-color: white;
    }

    /* Steps */
    .step-wrapper {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .step-label {
        font-size: 0.625rem; /* 10px */
        font-weight: 900;
        color: var(--si-text-light);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        display: block;
        text-align: center;
    }

    /* Grid */
    .category-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    @media (min-width: 640px) { .category-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 768px) { .category-grid { grid-template-columns: repeat(4, 1fr); } }
    @media (min-width: 1024px) { .category-grid { grid-template-columns: repeat(6, 1fr); } }

    .cat-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
        border-radius: 1rem;
        font-weight: 700;
        font-size: 0.75rem; /* xs */
        transition: all 0.2s;
        border: 2px solid var(--si-input-bg);
        background-color: white;
        color: var(--si-text-muted);
        cursor: pointer;
    }

    /* Small Screen Adjustment (< 300px) */
    @media (max-width: 300px) {
        .cat-btn {
            padding: 0.5rem;
            font-size: 0.625rem; /* 10px */
        }
    }

    .cat-btn:hover {
        border-color: #C7D2FE; /* indigo-200 */
    }

    .cat-icon-bg {
        width: 2rem;
        height: 2rem;
        border-radius: 9999px;
        background-color: rgba(0,0,0,0.05); /* current/10 approx */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.25rem;
        transition: background-color 0.2s;
        color: inherit;
    }

    .cat-label {
        text-align: center;
        line-height: 1.25;
    }

    /* Selected States */
    .si-selected-cat {
        border-color: #4F46E5 !important;
        background-color: #4F46E5 !important;
        color: white !important;
        box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1), 0 4px 6px -2px rgba(79, 70, 229, 0.05) !important;
    }
    .si-selected-cat .cat-icon-bg {
        background-color: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
    }

    /* Step 2 Buttons */
    .sub-category-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
    }

    .sub-cat-btn {
        padding: 0.625rem 1.5rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 700;
        transition: all 0.2s;
        border: 2px solid var(--si-input-bg);
        background-color: var(--si-input-bg);
        color: var(--si-text-light);
        cursor: pointer;
    }

    .sub-cat-btn:hover {
        border-color: #C7D2FE;
        color: var(--si-primary);
    }
    
    .si-selected-brand {
        background-color: #0F172A !important;
        border-color: #0F172A !important;
        color: white !important;
    }

    /* Submit Button */
    .submit-btn {
        width: 100%;
        padding: 1.25rem;
        background-color: var(--si-primary);
        color: white;
        border-radius: 1rem;
        font-weight: 900;
        font-size: 1.25rem; /* xl */
        box-shadow: 0 20px 25px -5px rgba(129, 140, 248, 0.5); /* shadow-indigo-200 approx */
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        border: none;
        cursor: pointer;
    }

    .submit-btn:hover {
        background-color: var(--si-primary-hover);
    }
    .submit-btn:active {
        transform: scale(0.95);
    }

    .btn-text {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .spinner-icon {
        animation: spin 1s linear infinite;
        height: 1.5rem;
        width: 1.5rem;
        color: white;
    }
    
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Animations */
    .animate-in {
        animation-duration: 0.5s;
        animation-fill-mode: both;
    }
    .slide-in-from-bottom-4 {
        animation-name: slideInBottom;
    }
    .slide-in-from-top-2 {
        animation-name: slideInTop;
        animation-duration: 0.3s;
    }

    @keyframes slideInBottom {
        from { transform: translateY(1rem); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideInTop {
        from { transform: translateY(-0.5rem); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .hidden {
        display: none !important;
    }
    
    /* Utilities needed for JS toggles */
    .text-indigo-600 { color: #4F46E5; }
    .bg-slate-50 { background-color: #F8FAFC; }
    .border-slate-50 { border-color: #F8FAFC; }
    .text-slate-400 { color: #94A3B8; }
</style>
{% endblock %}

{% block main_style %}{% endblock %}

{% block full_width_content %}

<main class="spend-it-main">
    <div class="spend-it-wrapper animate-in slide-in-from-bottom-4 duration-500">
        
        <a href="{% url 'calculators_index' %}" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left w-4 h-4" aria-hidden="true"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg> 
            Back to Lab
        </a>

        <div class="content-spacer">
            <!-- Main Card Container -->
            <form id="spend-it-form"
                  hx-post="{% url 'spend_it_calculate' %}"
                  hx-target="#results-container"
                  hx-swap="innerHTML"
                  hx-indicator="#submit-text, #submit-loader"
                  class="spend-it-card">
                
                {% csrf_token %}

                <div class="form-content">
                    <div class="header-section">
                        <h2 class="title">The Swipe Analyzer</h2>
                        <p class="subtitle">Crunching the data for your specific purchase.</p>
                    </div>

                    <div class="inputs-section">
                        <!-- Amount Input -->
                        <div class="amount-input-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign input-icon" aria-hidden="true"><line x1="12" x2="12" y1="2" y2="22"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                            <input 
                                name="amount"
                                class="amount-input" 
                                type="number" 
                                value="500"
                                placeholder="0"
                                required>
                        </div>

                        <!-- Step 1: Core Category -->
                        <div class="step-wrapper">
                            <label class="step-label">Step 1: Core Category</label>
                            
                            <!-- Hidden Input for Step 1 -->
                            <input type="hidden" name="category" id="selected-category" value="">

                            <div class="category-grid">
                                {% for cat in categories %}
                                <button type="button" 
                                        onclick="selectCategory(this, '{{ cat.CategoryName }}')" 
                                        class="cat-btn"
                                        data-details="{{ cat.json_details }}">
                                    
                                    <div class="cat-icon-bg">
                                        {% include "calculators/includes/_category_icon.html" with icon_key=cat.IconKey %}
                                    </div>
                                    <span class="cat-label">{{ cat.CategoryName }}</span>
                                </button>
                                {% endfor %}

                                <!-- Always include "Other" as a fallback -->
                                <button type="button" 
                                        onclick="selectCategory(this, 'Everything Else')" 
                                        class="cat-btn"
                                        data-details='[]'>
                                    <div class="cat-icon-bg">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                                    </div>
                                    Other
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Specific Brand / Type (Hidden initially) -->
                        <div id="step-2-container" class="step-wrapper animate-in slide-in-from-top-2 duration-300 hidden">
                            <label class="step-label">Step 2: Specific Brand / Type</label>
                            
                            <!-- Hidden Input for Step 2 -->
                            <input type="hidden" name="sub_category" id="selected-sub-category" value="">

                            <div class="sub-category-grid" id="step-2-buttons">
                                <!-- Populated via JS -->
                            </div>
                        </div>

                    </div>

                    <!-- Submit Button -->
                    <!-- Submit Button -->
                    {% if user.is_authenticated %}
                    <button type="submit" class="submit-btn" id="calculate-btn">
                        <span id="submit-loader" class="htmx-indicator hidden">
                            <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </span>
                        <span id="submit-text" class="btn-text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles w-6 h-6" aria-hidden="true"><path d="M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"></path><path d="M20 2v4"></path><path d="M22 4h-4"></path><circle cx="4" cy="20" r="2"></circle></svg> 
                            Calculate
                        </span>
                    </button>
                    {% else %}
                    <button type="button" class="submit-btn" style="background-color: #E2E8F0; color: #94A3B8; cursor: pointer;" onclick="window.location.href='{% url 'login' %}?next={{ request.path }}'">
                         <span class="btn-text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock w-6 h-6" aria-hidden="true"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            Login to use
                        </span>
                    </button>
                    {% endif %}
                </div>
            </form>
            
             <!-- RESULTS CONTAINER -->
            <div id="results-container"></div>

        </div>
    </div>


</main>

{% include "cards/includes/card_modal.html" %}

<script>
    function selectCategory(btn, categoryName) {
        // 1. Reset all category buttons
        document.querySelectorAll('.cat-btn').forEach(b => {
             b.classList.remove('si-selected-cat');
        });

        // 2. Highlight selected
        btn.classList.add('si-selected-cat');

        // 3. Update Hidden Input
        document.getElementById('selected-category').value = categoryName;

        // 4. Handle Step 2 Population
        const step2Container = document.getElementById('step-2-container');
        const step2Buttons = document.getElementById('step-2-buttons');
        step2Buttons.innerHTML = ''; // Clear previous

        let detailsString = btn.getAttribute('data-details');
        let details = [];
        try {
            details = JSON.parse(detailsString);
        } catch(e) {
            console.warn("Could not parse details", e);
        }


        if (details && details.length > 0) {
            // Populate buttons
            details.forEach((subCat, index) => {
                const subBtn = document.createElement('button');
                subBtn.type = 'button';
                subBtn.className = 'sub-cat-btn';
                subBtn.textContent = subCat;
                subBtn.onclick = () => selectSubCategory(subBtn, subCat);
                step2Buttons.appendChild(subBtn);
                
                // Select first one by default? Or let user choose?
                // Visuals: "Restaurants" is black (selected), others gray.
                if (index === 0) {
                     selectSubCategory(subBtn, subCat);
                }
            });
            step2Container.classList.remove('hidden');
        } else {
            step2Container.classList.add('hidden');
            document.getElementById('selected-sub-category').value = '';
        }
    }

    function selectSubCategory(btn, subCategoryName) {
        // Reset sub buttons
        document.querySelectorAll('.sub-cat-btn').forEach(b => {
             b.classList.remove('si-selected-brand');
        });

        // Highlight selected
        btn.classList.add('si-selected-brand');

        // Update Hidden Input (using the same 'category' input or a new one? Request usually expects 'category')
        // The backend expects 'category'. If we have a specific brand, that should likely be the category sent to the backend 
        // if the backend can handle it, OR we send both.
        // Looking at `spend_it_calculate`, it does `category = request.POST.get('category')`. 
        // If the user selects "Delta", we probably want to send "Delta". 
        // So I will update the MAIN category input with the sub-selection.
        
        document.getElementById('selected-category').value = subCategoryName;
    }
    
    // Auto-scroll to results
    document.body.addEventListener('htmx:afterSwap', (event) => {
         if(event.detail.target.id === 'results-container') {
             event.detail.target.scrollIntoView({ behavior: 'smooth', block: 'start' });
         }
    });
</script>
{% endblock %}
