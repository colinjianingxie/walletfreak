{% extends 'base.html' %}
{% load static %}

{% block extra_css %}

<link rel="stylesheet" href="{% static 'css/card_modal.css' %}">
<style>
    /* Custom CSS for Spend It Calculator - Replacing Tailwind */
    
    :root {
        --si-primary: #4F46E5; /* Indigo 600 */
        --si-primary-hover: #4338CA; /* Indigo 700 */
        --si-bg: #FFFFFF;
        --si-text-main: #0F172A; /* Slate 900 */
        --si-text-muted: #64748B; /* Slate 500 */
        --si-text-light: #94A3B8; /* Slate 400 */
        --si-border: #F1F5F9; /* Slate 100 */
        --si-input-bg: #F8FAFC; /* Slate 50 */
    }

    .spend-it-main {
        flex: 1;
        position: relative;
        z-index: 10;
        width: 100%;
        min-height: 100vh;
        background-color: transparent;
        font-family: 'Outfit', sans-serif;
    }

    .spend-it-wrapper {
        max-width: 80rem; /* 7xl */
        margin: 0 auto;
        padding: 2rem 1.5rem 8rem 1.5rem; /* pt-8 pb-32 px-6 */
    }

    @media (min-width: 768px) {
        .spend-it-wrapper {
            padding: 3rem 2.5rem 8rem 2.5rem; /* md:pt-12 md:px-10 */
        }
    }

    /* Back Link */
    .back-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--si-text-light);
        font-weight: 700;
        font-size: 0.875rem;
        margin-bottom: 2rem;
        transition: color 0.15s;
        text-decoration: none;
    }
    .back-link:hover {
        color: var(--si-text-main);
    }

    .content-spacer {
        display: flex;
        flex-direction: column;
        gap: 2.5rem; /* space-y-10 */
    }

    /* Main Card */
    .spend-it-card {
        max-width: 56rem; /* 4xl */
        margin: 0 auto;
        background-color: white;
        border-radius: 2.5rem;
        padding: 2rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* approximated shadow-2xl */
        border: 1px solid var(--si-border);
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
        align-items: center;
        width: 100%;
    }

    @media (min-width: 768px) {
        .spend-it-card {
            padding: 3rem;
        }
    }

    .form-content {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 2.5rem; /* space-y-10 */
    }

    .header-section {
        text-align: center;
    }
    
    .title {
        font-size: 1.875rem; /* 3xl */
        font-weight: 900;
        color: var(--si-text-main);
        margin-bottom: 0.5rem;
        line-height: 1.25;
    }

    .subtitle {
        color: var(--si-text-muted);
        font-weight: 500;
    }

    .inputs-section {
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
    }

    /* Amount Input */
    .amount-input-wrapper {
        position: relative;
        max-width: 32rem; /* lg */
        margin: 0 auto;
        width: 100%;
    }

    .input-icon {
        position: absolute;
        left: 1.5rem;
        top: 44%;
        transform: translateY(-50%);
        width: 2rem;
        height: 2rem;
        color: var(--si-primary);
        pointer-events: none;
    }

    .amount-input {
        width: 100%;
        padding: 1.5rem 2rem 1.5rem 4rem; /* py-6 pl-16 pr-8 */
        background-color: var(--si-input-bg);
        border: 2px solid transparent;
        border-radius: 1.5rem;
        font-size: 2.25rem; /* 4xl */
        font-weight: 900;
        outline: none;
        transition: all 0.2s;
        text-align: center;
        color: var(--si-text-main);
    }
    
    .amount-input::placeholder {
        color: #CBD5E1; /* slate-300 */
    }

    .amount-input:focus {
        border-color: var(--si-primary);
        background-color: white;
    }

    /* Steps */
    .step-wrapper {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .step-label {
        font-size: 0.625rem; /* 10px */
        font-weight: 900;
        color: var(--si-text-light);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        display: block;
        text-align: center;
    }

    /* Grid */
    .category-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    @media (min-width: 640px) { .category-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 768px) { .category-grid { grid-template-columns: repeat(4, 1fr); } }
    @media (min-width: 1024px) { .category-grid { grid-template-columns: repeat(6, 1fr); } }

    .cat-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
        border-radius: 1rem;
        font-weight: 700;
        font-size: 0.75rem; /* xs */
        transition: all 0.2s;
        border: 2px solid var(--si-input-bg);
        background-color: white;
        color: var(--si-text-muted);
        cursor: pointer;
    }

    /* Small Screen Adjustment (< 300px) */
    @media (max-width: 300px) {
        .cat-btn {
            padding: 0.5rem;
            font-size: 0.625rem; /* 10px */
        }
    }

    .cat-btn:hover {
        border-color: #C7D2FE; /* indigo-200 */
    }

    .cat-icon-bg {
        width: 2rem;
        height: 2rem;
        border-radius: 9999px;
        background-color: rgba(0,0,0,0.05); /* current/10 approx */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.25rem;
        transition: background-color 0.2s;
        color: inherit;
    }

    .cat-label {
        text-align: center;
        line-height: 1.25;
    }

    /* Selected States */
    .si-selected-cat {
        border-color: #4F46E5 !important;
        background-color: #4F46E5 !important;
        color: white !important;
        box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1), 0 4px 6px -2px rgba(79, 70, 229, 0.05) !important;
    }
    .si-selected-cat .cat-icon-bg {
        background-color: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
    }

    /* Step 2 Buttons */
    .sub-category-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
    }

    .sub-cat-btn {
        padding: 0.625rem 1.5rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 700;
        transition: all 0.2s;
        border: 2px solid var(--si-input-bg);
        background-color: var(--si-input-bg);
        color: var(--si-text-light);
        cursor: pointer;
    }

    .sub-cat-btn:hover {
        border-color: #C7D2FE;
        color: var(--si-primary);
    }
    
    .si-selected-brand {
        background-color: #0F172A !important;
        border-color: #0F172A !important;
        color: white !important;
    }

    /* Submit Button */
    .submit-btn {
        width: 100%;
        padding: 1.25rem;
        background-color: var(--si-primary);
        color: white;
        border-radius: 1rem;
        font-weight: 900;
        font-size: 1.25rem; /* xl */
        box-shadow: 0 20px 25px -5px rgba(129, 140, 248, 0.5); /* shadow-indigo-200 approx */
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        border: none;
        cursor: pointer;
    }

    .submit-btn:hover {
        background-color: var(--si-primary-hover);
    }
    .submit-btn:active {
        transform: scale(0.95);
    }

    .btn-text {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .spinner-icon {
        animation: spin 1s linear infinite;
        height: 1.5rem;
        width: 1.5rem;
        color: white;
    }
    
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Animations */
    .animate-in {
        animation-duration: 0.5s;
        animation-fill-mode: both;
    }
    .slide-in-from-bottom-4 {
        animation-name: slideInBottom;
    }
    .slide-in-from-top-2 {
        animation-name: slideInTop;
        animation-duration: 0.3s;
    }

    @keyframes slideInBottom {
        from { transform: translateY(1rem); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideInTop {
        from { transform: translateY(-0.5rem); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .hidden {
        display: none !important;
    }
    
    /* Utilities needed for JS toggles */
    .text-indigo-600 { color: #4F46E5; }
    .bg-slate-50 { background-color: #F8FAFC; }
    .border-slate-50 { border-color: #F8FAFC; }
    .text-slate-400 { color: #94A3B8; }
</style>
{% endblock %}

{% block main_style %}{% endblock %}

{% block full_width_content %}

<main class="spend-it-main">
    <div class="spend-it-wrapper animate-in slide-in-from-bottom-4 duration-500">
        
        <a href="{% url 'calculators_index' %}" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left w-4 h-4" aria-hidden="true"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg> 
            Back to Lab
        </a>

        <div class="content-spacer">
            <!-- Main Card Container -->
            <form id="spend-it-form"
                  hx-post="{% url 'spend_it_calculate' %}"
                  hx-target="#results-container"
                  hx-swap="innerHTML"
                  hx-indicator="#submit-text, #submit-loader"
                  class="spend-it-card">
                
                {% csrf_token %}

                <div class="form-content">
                    <div class="header-section">
                        <h2 class="title">The Swipe Analyzer</h2>
                        <p class="subtitle">Crunching the data for your specific purchase.</p>
                    </div>

                    <div class="inputs-section">
                        <!-- Amount Input -->
                        <div class="amount-input-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign input-icon" aria-hidden="true"><line x1="12" x2="12" y1="2" y2="22"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                            <input 
                                name="amount"
                                class="amount-input" 
                                type="number" 
                                value="500"
                                placeholder="0"
                                required>
                        </div>

                        <!-- Step 1: Core Category -->
                        <div class="step-wrapper">
                            <label class="step-label">Step 1: Core Category</label>
                            
                            <!-- Hidden Input for Step 1 -->
                            <input type="hidden" name="category" id="selected-category" value="">

                            <div class="category-grid">
                                {% for cat in categories %}
                                <button type="button" 
                                        onclick="selectCategory(this, '{{ cat.CategoryName }}')" 
                                        class="cat-btn"
                                        data-details="{{ cat.json_details }}">
                                    
                                    <div class="cat-icon-bg">
                                        <!-- Render Icon based on key -->
                                        {% if cat.IconKey == 'plane' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>
                                        {% elif cat.IconKey == 'building-2' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M10 12h4"/><path d="M10 8h4"/><path d="M14 21v-3a2 2 0 0 0-4 0v3"/><path d="M6 10H4a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2"/><path d="M6 21V5a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v16"/></svg>
                                        {% elif cat.IconKey == 'globe' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
                                        {% elif cat.IconKey == 'armchair' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M19 9V6a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v3"/><path d="M3 16a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-5a2 2 0 0 0-4 0v2H7v-2a2 2 0 0 0-4 0Z"/><path d="M5 18v2"/><path d="M19 18v2"/></svg>
                                        {% elif cat.IconKey == 'utensils' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
                                        {% elif cat.IconKey == 'truck' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>
                                        {% elif cat.IconKey == 'store' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M15 21v-5a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v5"/><path d="M17.774 10.31a1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.451 0 1.12 1.12 0 0 0-1.548 0 2.5 2.5 0 0 1-3.452 0 1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.77-3.248l2.889-4.184A2 2 0 0 1 7 2h10a2 2 0 0 1 1.653.873l2.895 4.192a2.5 2.5 0 0 1-3.774 3.244"/><path d="M4 10.95V19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.05"/></svg>
                                        {% elif cat.IconKey == 'fuel' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 0 4 0v-6.998a2 2 0 0 0-.59-1.42L18 5"/><path d="M14 21V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v16"/><path d="M2 21h13"/><path d="M3 9h11"/></svg>
                                        {% elif cat.IconKey == 'train' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M12 21v-8"/><path d="M16 8h-8"/><path d="M4 10a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"/></svg>
                                        {% elif cat.IconKey == 'car' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>
                                        {% elif cat.IconKey == 'shopping-bag' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                                        {% elif cat.IconKey == 'hammer' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V7.86c0-.55-.45-1-1-1H14.5c-.85 0-1.65-.33-2.25-.93L11 4.71"/><path d="M11 4.71c.78-.78 2.05-.78 2.83 0l5.88 5.88c.78.78.78 2.05 0 2.83"/></svg>
                                        {% elif cat.IconKey == 'zap' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                        {% elif cat.IconKey == 'smartphone' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
                                        {% elif cat.IconKey == 'tv' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><rect width="20" height="15" x="2" y="7" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></svg>
                                        {% elif cat.IconKey == 'ticket' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>
                                        {% elif cat.IconKey == 'heart-pulse' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M19 14c1.49-1.28 3.6-1.28 5.1 0 1.26 1.08 1.26 2.83 0 3.91l-1.41 1.41c-1.26 1.08-3.31 1.08-4.57 0l-1.41-1.41c-1.26-1.08-1.26-2.83 0-3.91l1.41-1.41c.3-.26.65-.43 1.02-.51"/><path d="M2.9 8.1c1.26-1.08 3.31-1.08 4.57 0l1.41 1.41c1.26 1.08 1.26 2.83 0 3.91l-1.41 1.41c-1.26 1.08-3.31 1.08-4.57 0L1.5 13.4c-1.26-1.08-1.26-2.83 0-3.91L2.9 8.1z"/><path d="m11 13-3-3"/><path d="m16 8-3 3"/><path d="m13.5 10.5 4 4"/></svg>
                                        {% elif cat.IconKey == 'spa' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><circle cx="12" cy="12" r="3"/><path d="M12 16.5A4.5 4.5 0 1 1 7.5 12 4.5 4.5 0 1 1 12 7.5a4.5 4.5 0 1 1 4.5 4.5 4.5 4.5 0 1 1-4.5 4.5"/><path d="M12 7.5V9"/><path d="M7.5 12H9"/><path d="M16.5 12H15"/><path d="M12 16.5V15"/><path d="m8 8 1.88 1.88"/><path d="M14.12 9.88 16 8"/><path d="m8 16 1.88-1.88"/><path d="M14.12 14.12 16 16"/></svg>
                                        {% elif cat.IconKey == 'briefcase' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                                        {% elif cat.IconKey == 'graduation-cap' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.08a1 1 0 0 0 0 1.832l8.57 3.908a2 2 0 0 0 1.66 0z"/><path d="M22 10v6"/><path d="M6 12.5V16a6 3 0 0 0 12 0v-3.5"/></svg>
                                        {% elif cat.IconKey == 'paw' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><circle cx="12" cy="5" r="3"/><circle cx="7" cy="9" r="3"/><circle cx="17" cy="9" r="3"/><path d="M13.2 16.5c-1-1.4-1.4-2.5-3.2-2.5S7.7 15.1 6.8 16.5c-.5.8-.3 1.8.4 2.4l1.6 1.3c.7.6 1.7.9 2.7.9s2-.3 2.7-.9l1.6-1.3c.7-.6.9-1.6.4-2.4Z"/></svg>
                                        {% elif cat.IconKey == 'calendar' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                                        {% elif cat.IconKey == 'heart-handshake' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M19 14c1.49-1.28 3.6-1.28 5.1 0 1.26 1.08 1.26 2.83 0 3.91l-1.41 1.41c-1.26 1.08-3.31 1.08-4.57 0l-1.41-1.41c-1.26-1.08-1.26-2.83 0-3.91l1.41-1.41c.3-.26.65-.43 1.02-.51"/><path d="M2.9 8.1c1.26-1.08 3.31-1.08 4.57 0l1.41 1.41c1.26 1.08 1.26 2.83 0 3.91l-1.41 1.41c-1.26 1.08-3.31 1.08-4.57 0L1.5 13.4c-1.26-1.08-1.26-2.83 0-3.91L2.9 8.1z"/><path d="m11 13-3-3"/><path d="m16 8-3 3"/><path d="m13.5 10.5 4 4"/></svg>
                                        {% elif cat.IconKey == 'anchor' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><circle cx="12" cy="5" r="3"/><line x1="12" x2="12" y1="22" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/> </svg>
                                        {% elif cat.IconKey == 'coins' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/><path d="m8.5 8.5 2 2"/></svg>
                                        {% elif cat.IconKey == 'shield' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>
                                        {% elif cat.IconKey == 'passport' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><circle cx="10" cy="12" r="2"/><path d="M6 16a2 2 0 0 1 4-2h0a2 2 0 0 1 4 2"/></svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>
                                        {% endif %}
                                    </div>
                                    <span class="cat-label">{{ cat.CategoryName }}</span>
                                </button>
                                {% endfor %}

                                <!-- Always include "Other" as a fallback -->
                                <button type="button" 
                                        onclick="selectCategory(this, 'Everything Else')" 
                                        class="cat-btn"
                                        data-details='[]'>
                                    <div class="cat-icon-bg">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide w-4 h-4"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                                    </div>
                                    Other
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Specific Brand / Type (Hidden initially) -->
                        <div id="step-2-container" class="step-wrapper animate-in slide-in-from-top-2 duration-300 hidden">
                            <label class="step-label">Step 2: Specific Brand / Type</label>
                            
                            <!-- Hidden Input for Step 2 -->
                            <input type="hidden" name="sub_category" id="selected-sub-category" value="">

                            <div class="sub-category-grid" id="step-2-buttons">
                                <!-- Populated via JS -->
                            </div>
                        </div>

                    </div>

                    <!-- Submit Button -->
                    <!-- Submit Button -->
                    {% if user.is_authenticated %}
                    <button type="submit" class="submit-btn" id="calculate-btn">
                        <span id="submit-loader" class="htmx-indicator hidden">
                            <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </span>
                        <span id="submit-text" class="btn-text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles w-6 h-6" aria-hidden="true"><path d="M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"></path><path d="M20 2v4"></path><path d="M22 4h-4"></path><circle cx="4" cy="20" r="2"></circle></svg> 
                            Calculate
                        </span>
                    </button>
                    {% else %}
                    <button type="button" class="submit-btn" style="background-color: #E2E8F0; color: #94A3B8; cursor: pointer;" onclick="window.location.href='{% url 'login' %}?next={{ request.path }}'">
                         <span class="btn-text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock w-6 h-6" aria-hidden="true"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            Login to use
                        </span>
                    </button>
                    {% endif %}
                </div>
            </form>
            
             <!-- RESULTS CONTAINER -->
            <div id="results-container"></div>

        </div>
    </div>


</main>

{% include "cards/includes/card_modal.html" %}

<script>
    function selectCategory(btn, categoryName) {
        // 1. Reset all category buttons
        document.querySelectorAll('.cat-btn').forEach(b => {
             b.classList.remove('si-selected-cat');
        });

        // 2. Highlight selected
        btn.classList.add('si-selected-cat');

        // 3. Update Hidden Input
        document.getElementById('selected-category').value = categoryName;

        // 4. Handle Step 2 Population
        const step2Container = document.getElementById('step-2-container');
        const step2Buttons = document.getElementById('step-2-buttons');
        step2Buttons.innerHTML = ''; // Clear previous

        let detailsString = btn.getAttribute('data-details');
        let details = [];
        try {
            details = JSON.parse(detailsString);
        } catch(e) {
            console.warn("Could not parse details", e);
        }


        if (details && details.length > 0) {
            // Populate buttons
            details.forEach((subCat, index) => {
                const subBtn = document.createElement('button');
                subBtn.type = 'button';
                subBtn.className = 'sub-cat-btn';
                subBtn.textContent = subCat;
                subBtn.onclick = () => selectSubCategory(subBtn, subCat);
                step2Buttons.appendChild(subBtn);
                
                // Select first one by default? Or let user choose?
                // Visuals: "Restaurants" is black (selected), others gray.
                if (index === 0) {
                     selectSubCategory(subBtn, subCat);
                }
            });
            step2Container.classList.remove('hidden');
        } else {
            step2Container.classList.add('hidden');
            document.getElementById('selected-sub-category').value = '';
        }
    }

    function selectSubCategory(btn, subCategoryName) {
        // Reset sub buttons
        document.querySelectorAll('.sub-cat-btn').forEach(b => {
             b.classList.remove('si-selected-brand');
        });

        // Highlight selected
        btn.classList.add('si-selected-brand');

        // Update Hidden Input (using the same 'category' input or a new one? Request usually expects 'category')
        // The backend expects 'category'. If we have a specific brand, that should likely be the category sent to the backend 
        // if the backend can handle it, OR we send both.
        // Looking at `spend_it_calculate`, it does `category = request.POST.get('category')`. 
        // If the user selects "Delta", we probably want to send "Delta". 
        // So I will update the MAIN category input with the sub-selection.
        
        document.getElementById('selected-category').value = subCategoryName;
    }
    
    // Auto-scroll to results
    document.body.addEventListener('htmx:afterSwap', (event) => {
         if(event.detail.target.id === 'results-container') {
             event.detail.target.scrollIntoView({ behavior: 'smooth', block: 'start' });
         }
    });
</script>
{% endblock %}
