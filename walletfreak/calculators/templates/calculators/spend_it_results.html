{% load humanize %}

<style>
    /* Custom CSS for Results (Injecting here so it loads with HTMX) */
    
    .results-grid {
        display: grid;
        grid-template-columns: 1fr;
        min-height: 600px;
        overflow: hidden;
        border-radius: 1.5rem;
        background-color: #F8FAFC; /* slate-50 */
        border: 1px solid #F1F5F9; /* slate-100 */
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    @media (min-width: 1024px) {
        .results-grid {
            grid-template-columns: 7fr 5fr;
        }
    }

    /* Left Column */
    .wallet-section {
        padding: 1.5rem; /* p-6 */
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        position: relative;
    }
    
    @media (min-width: 768px) {
        .wallet-section { padding: 2rem; }
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #94A3B8; /* slate-400 */
        font-weight: 700;
        font-size: 0.75rem; /* xs */
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }

    .section-badge {
        color: #4F46E5; /* indigo-600 */
        font-weight: 700;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }

    /* Cards List */
    .cards-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        position: relative;
        z-index: 10;
    }

    .separator {
        position: relative;
        padding: 1rem 0;
        text-align: center;
    }
    .separator-line {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        border-top: 1px solid #E2E8F0; /* slate-200 */
    }
    .separator-text {
        position: relative;
        background-color: #F8FAFC; /* slate-50 */
        padding: 0 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        color: #94A3B8; /* slate-400 */
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    /* Result Card */
    .result-card {
        background-color: white;
        border-radius: 1.5rem; /* rounded-[2.5rem] in tailwind -> 2.5rem, adjusted to 1.5 for consistency */
        border: 1px solid transparent;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        z-index: 20;
        cursor: pointer;
    }
    
    .result-card.winner {
        border-color: #4F46E5; /* indigo-600 */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        /* Ring simulation */
        box-shadow: 0 0 0 1px #4F46E5, 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
    }
    
    .result-card.standard {
        border-color: #F1F5F9; /* slate-100 */
        opacity: 0.7;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .result-card.standard:hover {
        opacity: 1;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .card-main-content {
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        border-bottom: 1px solid #F8FAFC; /* slate-50 */
    }
    
    @media (min-width: 640px) {
        .card-main-content {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 0;
            padding: 2rem;
        }
    }

    .card-left {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .card-visual-wrapper {
        width: 5rem; /* 20 */
        flex-shrink: 0;
        transition: transform 0.2s;
    }
    .result-card:hover .card-visual-wrapper {
        transform: rotate(3deg);
    }

    .card-image-box {
        aspect-ratio: 1.586/1;
        width: 100%;
        border-radius: 1rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, #FCD34D, #F59E0B, #B45309);
        padding: 2px;
    }
    .card-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: relative;
        z-index: 10;
        background-color: rgba(255,255,255,0.1);
        backdrop-filter: blur(1px);
    }
    .card-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255,255,255,0.5);
        position: relative;
        z-index: 10;
        background-color: #F1F5F9; /* slate-100 for standard */
    }
    .result-card.winner .card-placeholder { background-color: transparent; }
    .result-card.standard .card-image-box { background: none; box-shadow: none; padding: 0; }
    .result-card.standard .card-visual-wrapper { width: 5rem; }
    .result-card.standard .card-placeholder i { color: #CBD5E1; }

    .card-details h4 {
        font-size: 1rem;
        font-weight: 900;
        color: #0F172A; /* slate-900 */
        line-height: 1.25;
        margin: 0;
    }
    @media (min-width: 768px) { .card-details h4 { font-size: 1.125rem; } }

    .earning-badge {
        display: inline-block;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        font-weight: 900;
        padding: 0.125rem 0.5rem;
        border-radius: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    .result-card.winner .earning-badge {
        background-color: #E0E7FF; /* indigo-100 */
        color: #4338CA; /* indigo-700 */
    }
    .result-card.standard .earning-badge {
        background-color: #F1F5F9; /* slate-100 */
        color: #64748B; /* slate-500 */
    }

    .card-metrics {
        display: flex;
        gap: 2.5rem;
        align-items: center;
        justify-content: space-between; /* Mobile: space-between */
        width: 100%;
    }
    @media (min-width: 640px) {
        .card-metrics {
            width: auto;
            justify-content: flex-end;
        }
    }

    .metric-group {
        text-align: right;
        display: flex;
        flex-direction: column; /* Mobile: default */
    }
    
    .metric-group.points {
        display: none;
    }
    @media (min-width: 640px) { .metric-group.points { display: block; } }

    .metric-val {
        font-weight: 900;
        line-height: 1;
    }
    .metric-group.points .metric-val { font-size: 1.25rem; color: #0F172A; } /* winner text defaults */
    .result-card.standard .metric-group.points .metric-val { color: #94A3B8; }

    .metric-label {
        font-size: 0.625rem; /* 10px approx */
        font-weight: 900;
        color: #94A3B8;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-top: 0.25rem;
    }

    .metric-money {
        font-size: 1.5rem;
        color: #4F46E5;
    }
    .result-card.standard .metric-money { color: #64748B; }

    .cpp-text {
        font-size: 0.625rem;
        color: #94A3B8;
        font-weight: 500;
        margin-top: 0.125rem;
    }

    /* Synergy Section */
    .synergy-section {
        background-color: rgba(248, 250, 252, 0.5); /* slate-50/50 */
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    @media (min-width: 768px) { .synergy-section { padding: 2rem; } }

    .synergy-header {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
        margin-bottom: 1rem;
    }
    @media (min-width: 640px) {
        .synergy-header {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }
    }

    .synergy-title {
        font-size: 0.625rem;
        font-weight: 900;
        color: #94A3B8;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .synergy-modal-btn {
        margin-left: 0.25rem;
        color: #94A3B8;
        transition: color 0.2s;
        cursor: pointer;
        padding: 0;
        background: none;
        border: none;
    }
    .synergy-modal-btn:hover { color: #4F46E5; }

    .synergy-subtitle {
        font-size: 0.625rem; 
        font-weight: 700;
        color: #94A3B8;
        text-transform: uppercase;
    }

    .synergy-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    @media (min-width: 768px) { .synergy-grid { grid-template-columns: 1fr 1fr; } }

    .synergy-card {
        padding: 1rem;
        border-radius: 1rem;
        border: 1px solid #E2E8F0;
        background-color: white;
        transition: background-color 0.2s;
    }
    /* Dynamic Tailwind utility mapping for synergy BG/Color */
    .bg-indigo-50 { background-color: #EEF2FF !important; }
    .border-indigo-100 { border-color: #E0E7FF !important; }
    .text-indigo-700 { color: #4338CA !important; }
    .text-indigo-900 { color: #312E81 !important; }
    
    .bg-green-50 { background-color: #F0FDF4 !important; }
    .border-green-100 { border-color: #DCFCE7 !important; }
    .text-green-700 { color: #15803D !important; }
    .text-green-900 { color: #14532D !important; }
    
    .bg-slate-50 { background-color: #F8FAFC !important; }
    .border-slate-100 { border-color: #F1F5F9 !important; }
    .text-slate-500 { color: #64748B !important; }

    .synergy-label {
        font-size: 0.625rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: -0.01em;
        margin-bottom: 0.25rem;
        display: block;
    }
    .synergy-desc {
        font-size: 0.75rem; /* ~11px */
        line-height: 1.5;
        font-weight: 500;
        margin: 0;
    }

    /* Right Column (Opportunities) */
    .opp-section {
        background-color: #0F172A; /* slate-900 */
        padding: 1.5rem;
        color: white;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }
    @media (min-width: 768px) { .opp-section { padding: 2rem; } }

    .bg-fx {
        position: absolute;
        border-radius: 9999px;
        filter: blur(64px);
        pointer-events: none;
    }
    .fx-indigo { top: 0; right: 0; width: 16rem; height: 16rem; background-color: rgba(79, 70, 229, 0.2); margin: -4rem; }
    .fx-emerald { bottom: 0; left: 0; width: 16rem; height: 16rem; background-color: rgba(5, 150, 105, 0.1); margin: -4rem; }

    .opp-header {
        position: relative;
        z-index: 10;
        margin-bottom: 2rem;
    }
    
    .opp-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #818CF8; /* indigo-400 */
        font-weight: 700;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        margin-bottom: 1.5rem;
    }

    .net-gain-box {
        background-color: rgba(30, 41, 59, 0.5); /* slate-800/50 */
        border-radius: 1rem;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
        margin-bottom: 2rem;
    }
    
    .gain-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .gain-icon span { font-size: 1.5rem; font-weight: 900; }
    
    /* Gain Colors */
    .gain-pos { background-color: rgba(34, 197, 94, 0.1); color: #22C55E; box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.1); }
    .gain-neu { background-color: rgba(249, 115, 22, 0.1); color: #F97316; box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.1); }
    .gain-neg { background-color: rgba(239, 68, 68, 0.1); color: #EF4444; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.1); }
    
    .text-pos { color: #22C55E; }
    .text-neu { color: #F97316; }
    .text-neg { color: #EF4444; }

    .gain-title { color: #94A3B8; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.125rem; }
    .gain-value { font-weight: 900; font-size: 1.25rem; letter-spacing: -0.025em; }
    .gain-suffix { color: #94A3B8; font-weight: 400; font-size: 0.875rem; }

    .opp-title {
        font-size: 1.25rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: white;
    }
    .opp-desc { color: #94A3B8; font-size: 0.875rem; line-height: 1.5; }

    .opp-list {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        flex-grow: 1;
    }
    
    .sep-dark-line { 
        position: absolute; inset: 0; display: flex; align-items: center; top: 0; bottom: 0;
    }
    .sep-dark-line div { width: 100%; border-top: 1px solid #334155; }
    .sep-dark-text {
        position: relative; background-color: #0F172A; padding: 0 0.5rem;
    }

    .opp-card {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        cursor: pointer;
        padding: 1rem;
        margin: 0 -1rem;
        border-radius: 1rem;
        transition: all 0.2s; /* Changed from background-color to all */
    }
    @media (min-width: 640px) { .opp-card { flex-direction: row; } }
    .opp-card:hover { background-color: rgba(255, 255, 255, 0.05); }

    .opp-visual {
        width: 4rem;
        flex-shrink: 0;
        margin-top: 0.25rem;
        transition: transform 0.2s;
    }
    .opp-card:hover .opp-visual { transform: rotate(3deg); }
    .opp-img { width: 100%; object-fit: contain; opacity: 0.8; }
    .opp-card:hover .opp-img { opacity: 1; }
    
    .opp-details { flex: 1; width: 100%; }
    .opp-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .opp-name { font-weight: 700; color: white; transition: color 0.15s; line-height: 1.25; }
    .opp-card:hover .opp-name { color: #818CF8; }
    
    .opp-val-box { text-align: right; flex-shrink: 0; margin-left: 0.5rem; }
    .opp-val { font-size: 0.875rem; font-weight: 900; color: #4ADE80; /* green-400 */ }
    .opp-val-lbl { font-size: 0.625rem; color: #64748B; text-transform: uppercase; letter-spacing: -0.05em; }
    
    .opp-earn { font-size: 0.625rem; color: #64748B; margin: 0.125rem 0 0.5rem; }
    
    .analyze-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.625rem;
        font-weight: 900;
        color: #818CF8;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        background: none;
        border: none;
        cursor: pointer;
        transition: color 0.2s;
        padding: 0;
    }
    .analyze-btn:hover { color: #4F46E5; }
    .opp-card:hover .analyze-btn { color: #4F46E5; } /* Added */
    .analyze-btn svg { transition: transform 0.2s; }
    .opp-card:hover .analyze-btn svg { transform: translateX(4px); }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 16rem;
        text-align: center;
        border: 2px dashed #E2E8F0;
        border-radius: 1rem;
    }
    .empty-icon {
        width: 3rem; height: 3rem; background-color: #F1F5F9; color: #94A3B8;
        border-radius: 9999px; display: flex; align-items: center; justify-content: center;
        margin-bottom: 0.75rem;
    }
    .empty-title { color: #475569; font-weight: 700; }
    .empty-desc { color: #94A3B8; font-size: 0.875rem; margin-top: 0.25rem; }

    /* Synergy Info Modal */
    #synergyInfoModal {
        position: fixed; inset: 0; z-index: 100;
        display: none;
        align-items: center; justify-content: center;
        padding: 1rem;
        background-color: rgba(15, 23, 42, 0.5);
        backdrop-filter: blur(4px);
    }
    #synergyInfoModal:not(.hidden) { display: flex; }
    
    .info-modal-content {
        background-color: white;
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 28rem;
        width: 100%;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
    }
    
    .info-close {
        position: absolute; top: 0; right: 0; padding: 1rem;
        color: #94A3B8; background: none; border: none; cursor: pointer;
    }
    .info-close:hover { color: #475569; }

    .info-title {
        font-size: 1.125rem; font-weight: 900; color: #0F172A;
        margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;
    }
    
    .info-box {
        padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem;
        border: 1px solid transparent;
    }
    /* Reusing synergy bg/color mappings for info modal as they match */
    
    .info-box-title { font-size: 0.75rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; }
    .info-box-text { font-size: 0.875rem; line-height: 1.5; color: rgba(15, 23, 42, 0.8); }
</style>

<div class="results-grid">
    
    <!-- LEFT COLUMN: Your Best Moves (Wallet) -->
    <div class="wallet-section">
        <!-- Header -->
        <div class="section-header">
            <div class="section-title">
                <i data-lucide="wallet" class="w-4 h-4"></i>
                Your Best Moves

            </div>
            <div class="section-badge">
                Category: {{ parent_category|default:category }}
            </div>
        </div>



        <!-- Wallet Cards List -->
        {% if results.wallet %}
            <div class="cards-list">
                {% for item in results.wallet %}
                {% ifchanged item.is_specific_match %}
                    {% if not item.is_specific_match and not forloop.first %}
                    <div class="separator">
                        <div class="separator-line"></div>
                        <span class="separator-text">Other Options</span>
                    </div>
                    {% endif %}
                {% endifchanged %}
                {% if item.is_winner %}
                <!-- WINNER CARD STYLE -->
                <div class="result-card winner group" onclick="openCardModal('{{ item.slug }}')">
                    <div class="card-main-content">
                        <div class="card-left">
                            <!-- Card Visual -->
                            <div class="card-visual-wrapper">
                                 <div class="card-image-box">
                                    {% if item.card.image_url %}
                                        <img src="{{ item.card.image_url }}" alt="{{ item.card_name }}" class="card-image">
                                    {% else %}
                                        <div class="card-placeholder">
                                            <i data-lucide="credit-card" class="w-6 h-6"></i>
                                        </div>
                                    {% endif %}
                                    <!-- Shine effect -->
                                    <div class="absolute top-0 -right-full w-[200%] h-full bg-gradient-to-l from-transparent via-white/40 to-transparent skew-x-12 opacity-0 group-hover:animate-shimmer z-20"></div>
                                 </div>
                            </div>
                            
                            <!-- Info -->
                            <div class="card-details">
                                 <h4>{{ item.card_name }}</h4>
                                 <div>
                                    <span class="earning-badge">
                                        {{ item.earning_rate }} {{ item.currency_display }}
                                    </span>
                                 </div>
                            </div>
                        </div>

                        <!-- Metrics -->
                        <div class="card-metrics">
                             {% if 'cash' not in item.currency %}
                             <div class="metric-group points">
                                <div class="metric-val">{{ item.est_points|intcomma }}</div>
                                <div class="metric-label">Points</div>
                             </div>
                             {% endif %}
                             <div class="metric-group">
                                <div class="metric-val metric-money">${{ item.est_value|floatformat:2 }}</div>
                                <div class="metric-label">Est. Value</div>
                                {% if 'cash' not in item.currency %}
                                <div class="cpp-text">({{ item.cpp }} cpp)</div>
                                {% endif %}
                             </div>
                        </div>
                    </div>
                    
                    {% if item.synergy %}
                    <!-- Category Synergies -->
                    <div class="synergy-section">
                        <div class="synergy-header">
                            <h5 class="synergy-title">
                                <i data-lucide="shopping-bag" class="w-3 h-3"></i>
                                Category Synergies
                                <button onclick="event.stopPropagation(); document.getElementById('synergyInfoModal').classList.remove('hidden')" class="synergy-modal-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3.5 h-3.5"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                                </button>
                            </h5>
                            <div class="synergy-subtitle">Other {{ parent_category }} moves</div>
                        </div>
                        <div class="synergy-grid">
                            <div class="synergy-card {{ item.synergy.bg_class }}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                    <span class="synergy-label {{ item.synergy.color_class }}">
                                        {{ item.synergy.name }} • {{ item.synergy.label }}
                                    </span>
                                </div>
                                <p class="synergy-desc {{ item.synergy.text_class }}">
                                    {{ item.synergy.description }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <!-- STANDARD CARD STYLE -->
                <div class="result-card standard group" onclick="openCardModal('{{ item.slug }}')">
                    <div class="card-main-content">
                        <div class="card-left">
                            <!-- Card Visual -->
                            <div class="card-visual-wrapper">
                                 {% if item.card.image_url %}
                                    <img src="{{ item.card.image_url }}" alt="{{ item.card_name }}" style="width: 100%; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                                {% else %}
                                    <div class="w-full h-12 bg-slate-100 rounded-lg flex items-center justify-center">
                                        <i data-lucide="credit-card" class="w-6 h-6 text-slate-300"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Info -->
                            <div class="card-details">
                                 <h4>{{ item.card_name }}</h4>
                                 <div>
                                    <span class="earning-badge">
                                        {{ item.earning_rate }} {{ item.currency_display }}
                                    </span>
                                 </div>
                            </div>
                        </div>

                        <!-- Metrics -->
                        <div class="card-metrics">
                             {% if 'cash' not in item.currency %}
                             <div class="metric-group points">
                                <div class="metric-val">{{ item.est_points|intcomma }}</div>
                                <div class="metric-label">Points</div>
                             </div>
                             {% endif %}
                             <div class="metric-group">
                                <div class="metric-val metric-money">${{ item.est_value|floatformat:2 }}</div>
                                <div class="metric-label">Est. Value</div>
                                {% if 'cash' not in item.currency %}
                                <div class="cpp-text">({{ item.cpp }} cpp)</div>
                                {% endif %}
                             </div>
                        </div>
                    </div>
                    
                    {% if item.synergy %}
                    <!-- Category Synergies -->
                    <div class="synergy-section">
                        <div class="synergy-header">
                            <h5 class="synergy-title">
                                <i data-lucide="shopping-bag" class="w-3 h-3"></i>
                                Category Synergies
                                <button onclick="event.stopPropagation(); document.getElementById('synergyInfoModal').classList.remove('hidden')" class="synergy-modal-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3.5 h-3.5"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                                </button>
                            </h5>
                            <div class="synergy-subtitle">Other {{ parent_category }} moves</div>
                        </div>
                        <div class="synergy-grid">
                            <div class="synergy-card {{ item.synergy.bg_class }}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                    <span class="synergy-label {{ item.synergy.color_class }}">
                                        {{ item.synergy.name }} • {{ item.synergy.label }}
                                    </span>
                                </div>
                                <p class="synergy-desc {{ item.synergy.text_class }}">
                                    {{ item.synergy.description }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty Wallet State -->
            <div class="empty-state">
                 <div class="empty-icon">
                    <i data-lucide="credit-card" class="w-6 h-6"></i>
                 </div>
                 <h4 class="empty-title">No cards found in wallet</h4>
                 <p class="empty-desc">Add cards to your wallet to see recommendations.</p>
            </div>
        {% endif %}
    </div>

    <!-- RIGHT COLUMN: Opportunities (Dark Mode) -->
    <div class="opp-section">
        <!-- Background Glow Effects -->
        <div class="bg-fx fx-indigo"></div>
        <div class="bg-fx fx-emerald"></div>

        <!-- Header -->
        <div class="opp-header">
            <div class="opp-badge">
                 <i data-lucide="target" class="w-4 h-4"></i>
                 New Opportunities
            </div>

            <!-- Net Gain Header (Moved Here) -->
            {% with gain=results.net_gain %}
            <div style="position: relative; z-index: 10; marginBottom: 2rem;">
                <div class="net-gain-box">
                    <div class="gain-icon {% if gain > 0 %}gain-pos{% elif gain == 0 %}gain-neu{% else %}gain-neg{% endif %}">
                        <span>$</span>
                    </div>
                    <div>
                        <div class="gain-title">Net gain vs. your top current card:</div>
                        <div class="gain-value {% if gain > 0 %}text-pos{% elif gain == 0 %}text-neu{% else %}text-neg{% endif %}">
                            {% if gain > 0 %}+{% endif %}${{ gain|floatformat:2 }} <span class="gain-suffix">this swipe</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}

            <h4 class="opp-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy w-5 h-5 text-yellow-400 fill-current" aria-hidden="true"><path d="M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978"></path><path d="M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978"></path><path d="M18 9h1.5a1 1 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"></path><path d="M6 9H4.5a1 1 0 0 1 0-5H6"></path></svg> 
                Missing Value?
            </h4>
            <p class="opp-desc">
                For <span style="color: #E2E8F0; font-weight: 500;">{{ category }}</span> spend, these cards are built to dominate:
            </p>
        </div>

        <!-- Opportunities List -->
        <div class="opp-list">
            {% for item in results.opportunities %}
            {% ifchanged item.is_specific_match %}
                {% if not item.is_specific_match and not forloop.first %}
                <div class="separator">
                    <div class="sep-dark-line"><div></div></div>
                    <span class="separator-text sep-dark-text">Other Options</span>
                </div>
                {% endif %}
            {% endifchanged %}
            
            <div class="opp-card group" onclick="openCardModal('{{ item.slug }}')">
                <!-- Card Visual -->
                <div class="opp-visual">
                     {% if item.card.image_url %}
                        <img src="{{ item.card.image_url }}" alt="{{ item.card_name }}" class="opp-img">
                    {% else %}
                        <div style="width: 100%; aspect-ratio: 1.58/1; background-color: #1E293B; border-radius: 0.5rem; border: 1px solid #334155;"></div>
                    {% endif %}
                </div>
                
                <div class="opp-details">
                    <div class="opp-top">
                         <h5 class="opp-name">{{ item.card_name }}</h5>
                         <div class="opp-val-box">
                             <span class="opp-val">${{ item.est_value|floatformat:2 }}</span>
                             <div class="opp-val-lbl">Value</div>
                             {% if 'cash' not in item.currency %}
                             <div style="font-size: 9px; color: #64748B; font-weight: 500; margin-top: 2px;">({{ item.cpp }} cpp)</div>
                             {% endif %}
                         </div>
                    </div>
                    <p class="opp-earn">
                        {{ item.earning_rate }} on {{ parent_category|default:item.category_matched }}
                    </p>
                    <button onclick="openCardModal('{{ item.slug }}'); event.stopPropagation();" class="analyze-btn">
                        Analyze Synergy 
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
            {% endfor %}
            
            {% if not results.opportunities %}
               <div style="color: #64748B; font-size: 0.875rem; font-style: italic;">You already have the best cards for this!</div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    if (window.lucide) {
        window.lucide.createIcons();
    }
</script>

<!-- Info Modal -->
<div id="synergyInfoModal" class="hidden" onclick="if(event.target === this) this.classList.add('hidden')">
    <div class="info-modal-content">
        <button onclick="document.getElementById('synergyInfoModal').classList.add('hidden')" class="info-close">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x w-5 h-5"><line x1="18" x2="6" y1="6" y2="18"></line><line x1="6" x2="18" y1="6" y2="18"></line></svg>
        </button>
        
        <h3 class="info-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-indigo-500"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/></svg>
            Synergy Labels
        </h3>
        
        <div class="space-y-4">
            <div class="info-box bg-indigo-50 border-indigo-100">
                <div class="info-box-title text-indigo-700">Equal Performer</div>
                <p class="info-box-text text-indigo-900">
                    This card matches the <strong>highest earning rate</strong> currently in your wallet for this sibling category. It's safe to use without missing out on points.
                </p>
            </div>
            
            <div class="info-box bg-green-50 border-green-100">
                <div class="info-box-title text-green-700">Potential Candidate</div>
                <p class="info-box-text text-green-900">
                    A strong earner (4x+ points or nearly top-tier cash back) for this category. While it might not be your absolute highest, it yields excellent value.
                </p>
            </div>

            <div class="info-box bg-slate-50 border-slate-100">
                <div class="info-box-title text-slate-500">Solid Choice</div>
                <p class="info-box-text text-slate-500">
                    A decent option that earns rewards, though you may have better cards for this specific purchase in your wallet.
                </p>
            </div>
        </div>
        
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #F1F5F9; text-align: center;">
            <button onclick="document.getElementById('synergyInfoModal').classList.add('hidden')" style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; text-transform: uppercase; letter-spacing: 0.1em; background: none; border: none; cursor: pointer;">
                Close
            </button>
        </div>
    </div>
</div>


<!-- Card Details Modal Include REMOVED (now in input template) -->

<script>
    window.allCardsData = window.allCardsData || {};
    window.walletCardIds = new Set();
    {% for item in results.wallet %}
        try {
            window.allCardsData['{{ item.slug }}'] = {{ item.card_json|safe }};
            window.walletCardIds.add('{{ item.slug }}'); // Add to wallet set
        } catch(e) { console.error('Error loading card data for {{ item.slug }}'); }
    {% endfor %}
    {% for item in results.opportunities %}
        try {
            window.allCardsData['{{ item.slug }}'] = {{ item.card_json|safe }};
        } catch(e) { console.error('Error loading card data for {{ item.slug }}'); }
    {% endfor %}
</script>
