{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/blog_detail.css' %}">
<style>
    /* Toast Notification */
    .toast-container {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
    }
    
    .toast {
        background: white;
        color: #1a1a1a;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 500;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        pointer-events: auto;
        min-width: 300px;
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .toast-icon {
        font-size: 20px;
    }
    
    .toast.success .toast-icon { color: #10B981; }
    .toast.error .toast-icon { color: #EF4444; }
    .toast.info .toast-icon { color: #3B82F6; }
</style>
{% endblock %}

{% block main_style %}background: #F8F9FA; min-height: 100vh; padding: 0;{% endblock %}

{% block full_width_content %}
{% csrf_token %}
<div class="blog-detail-container">
    <!-- Header Navigation -->
    <div class="detail-header">
        <div class="container">
            <div class="header-nav">
                <a href="{% url 'blog_list' %}" class="back-btn">
                    <span class="material-icons">chevron_left</span>
                    <span>Back to Ledger</span>
                </a>
                
                <div class="header-actions">
                    <button class="action-btn bookmark-btn save-btn" data-slug="{{ blog.slug }}" data-id="{{ blog.id }}">
                        <span class="material-icons">bookmark_border</span>
                    </button>
                    <button class="action-btn share-btn">
                        <span class="material-icons">share</span>
                    </button>
                    {% if is_editor %}
                    <a href="{% url 'blog_edit' blog.slug %}" class="action-btn edit-btn">
                        <span class="material-icons">edit</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Post Content -->
    <div class="container">
        <article class="post-detail">
            <!-- Mobile Category Badge (Moved out of featured image usually, but here it was just above) -->
            <!-- We'll keep it simple and style it via CSS -->
            
            <div class="post-header-mobile-only">
                 <h1 class="post-title">{{ blog.title }}</h1>
            </div>

            <!-- Featured Image -->
            {% if blog.featured_image %}
            <div class="featured-image">
                <img src="{{ blog.featured_image }}" alt="{{ blog.title }}">
            </div>
            {% endif %}

            <!-- Post Header (Desktop & Mobile shared components but styled differently) -->
            <div class="post-header">
                <h1 class="post-title desktop-only">{{ blog.title }}</h1>
                
                <!-- Author & Stats Card -->
                <div class="author-stats-card">
                    <div class="author-section-left">
                        <div class="author-avatar-wrapper">
                            <div class="author-avatar">
                                {% if blog.author_profile.photo_url %}
                                <img src="{{ blog.author_profile.photo_url }}" alt="{{ blog.author_username }}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
                                {% else %}
                                <span class="material-icons">person</span>
                                {% endif %}
                             </div>
                             {% if blog.author_username == "WALLETFREAK" or blog.author.is_superuser %}
                             <!-- Gradient ring could go here if needed -->
                             {% endif %}
                        </div>
                        <div class="author-details">
                            <span class="author-real-name">{{ blog.author_real_name|default:"Alex Smith"|title }}</span>
                            <span class="author-username-small">@{{ blog.author_username|default:"WALLETFREAK"|upper }}</span>
                        </div>
                    </div>

                    <div class="stats-divider"></div>

                    <div class="stats-grid-right">
                        <!-- Row 1 -->
                        <div class="stat-item">
                            <span class="material-icons">calendar_today</span>
                            <span>{{ blog.published_at|timesince }} ago</span>
                        </div>
                        <div class="stat-item">
                            <span class="material-icons">local_fire_department</span>
                            <span>{{ upvote_count|default:0 }} Upvotes</span>
                        </div>
                        <div class="stat-item">
                            <span class="material-icons">visibility</span>
                            <span>{{ blog.view_count|default:"0" }} Views</span>
                        </div>
                        <div class="stat-item">
                            <span class="material-icons">chat_bubble_outline</span>
                            <span>{{ total_comments|default:"0" }} Discuss</span>
                        </div>
                        
                        <!-- Row 2 (Break to next line effectively, or grid auto-placement) -->
                        <div class="stat-item break-row-on-desktop">
                             <span class="material-icons">schedule</span>
                             <span>5 min read</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TL;DR Section -->
            {% if blog.excerpt %}
            <div class="tldr-section">
                <div class="tldr-header">
                    <span class="material-icons">bolt</span>
                    <span class="tldr-label">TOO LONG; DIDN'T READ</span>
                </div>
                <div class="tldr-content">
                    {{ blog.excerpt }}
                </div>
            </div>
            {% endif %}

            <!-- Post Content -->
            <div class="post-content">
                {{ blog.html_content }}
            </div>

            <!-- Post Actions Footer -->
            <div class="post-actions-footer">
                <div class="action-group">
                    {% if is_authenticated %}
                    <button class="action-btn upvote-btn {% if user_vote == 'upvote' %}active{% endif %}" data-vote-type="upvote">
                        <span class="material-icons">local_fire_department</span>
                        <span class="action-count" style="{% if user_vote != 'upvote' %}color: #ccc;{% endif %}">{{ upvote_count|default:0 }}</span>
                    </button>
                    {% else %}
                    <button class="action-btn upvote-btn" onclick="showLoginModal()">
                        <span class="material-icons">local_fire_department</span>
                        <span class="action-count" style="color: #ccc;">{{ upvote_count|default:0 }}</span>
                    </button>
                    {% endif %}
                    <button class="action-btn comment-btn">
                        <span class="material-icons">chat_bubble_outline</span>
                        <span class="action-count">{{ total_comments|default:0 }}</span>
                    </button>
                    <button class="action-btn share-btn">
                        <span class="material-icons">share</span>
                        <span class="action-text">Share</span>
                    </button>
                </div>
                <button class="action-btn save-btn" data-slug="{{ blog.slug }}" data-id="{{ blog.id }}">
                    <span class="material-icons">bookmark_border</span>
                    <span class="action-text">Save</span>
                </button>
            </div>
        </article>
        </article>

        <!-- Comments Section -->
        <div class="comments-section-wrapper">
            <div class="comments-header-row">
                <h3>Top Comments</h3>
                <div class="sort-dropdown">
                    <span>Best</span>
                    <span class="material-icons">expand_more</span>
                </div>
            </div>
            
            {% if is_authenticated %}
            <div class="main-comment-input">
                <div class="user-avatar-small">
                    <!-- User avatar logic or placeholder -->
                    U
                </div>
                <form class="comment-form main-form" onsubmit="submitComment(event, null)">
                    <textarea placeholder="What are your thoughts?" rows="3"></textarea>
                    <div class="form-actions">
                        <button type="submit" class="btn-submit">Comment</button>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="login-to-comment">
                <p>Please <a href="{% url 'login' %}?next={{ request.path }}">log in</a> to leave a comment.</p>
            </div>
            {% endif %}
            
            <div class="comments-list" id="comments-list">
                {% for comment in comments %}
                    {% include "blog/includes/comment_item.html" with comment=comment %}
                {% empty %}
                    <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
                {% endfor %}
            </div>
        </div>
        {% if related_posts %}
        <div class="related-section">
            <h3>Related Posts</h3>
            <div class="related-posts-list">
                {% for post in related_posts %}
                <div class="related-post-item">
                    <a href="{% url 'blog_detail' post.slug %}" class="related-post-link">
                        <h4>{{ post.title }}</h4>
                        <p>{{ post.excerpt|default:"Read more about this topic..." }}</p>
                        <span class="related-post-author">
                            by @{{ post.author_username }}
                        </span>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Bookmark functionality (unchanged logic mostly, just adding toast)
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            
            {% if not is_authenticated %}
            showLoginModal();
            return;
            {% endif %}
            
            const slug = this.getAttribute('data-slug');
            const isCurrentlySaved = this.classList.contains('active');
            
            // Toggle local state
            this.classList.toggle('active');
            const icon = this.querySelector('.material-icons');
            const text = this.querySelector('.action-text');
            
            if (this.classList.contains('active')) {
                if(icon) icon.textContent = 'bookmark';
                if(text) text.textContent = 'Saved';
                showToast('Article saved to your library', 'success');
            } else {
                if(icon) icon.textContent = 'bookmark_border';
                if(text) text.textContent = 'Save';
                showToast('Article removed from library', 'info');
            }
            
            // Logic for URL
            const url = isCurrentlySaved ? `/blog/${slug}/unsave/` : `/blog/${slug}/save/`;
            
            // CSRF
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    // Revert if failed
                    this.classList.toggle('active');
                    if (this.classList.contains('active')) {
                        if(icon) icon.textContent = 'bookmark';
                        if(text) text.textContent = 'Saved';
                    } else {
                        if(icon) icon.textContent = 'bookmark_border';
                        if(text) text.textContent = 'Save';
                    }
                    console.error('Save failed:', data.error);
                    showToast(data.error || 'Failed to save', 'error');
                }
            })
            .catch(err => {
                console.error('Error:', err);
                this.classList.toggle('active');
                showToast('Connection error', 'error');
            });
        });
    });

    // Share functionality
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (navigator.share) {
                navigator.share({
                    title: document.title,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showToast('Link copied to clipboard', 'success');
            }
        });
    });

    // Voting Logic (Client-side tracking for simple likes)
    const blogId = '{{ blog.id }}';
    const upvoteBtn = document.querySelector('.upvote-btn');
    const upvoteCount = upvoteBtn ? upvoteBtn.querySelector('.action-count') : null;
    
    // Check local storage for vote
    const storageKey = `vote_blog_${blogId}`;
    let hasVoted = localStorage.getItem(storageKey) === 'true';
    
    // Sync with server state if available
    {% if is_authenticated and user_vote == 'upvote' %}
    hasVoted = true;
    localStorage.setItem(storageKey, 'true');
    {% endif %}
    
    if (upvoteBtn && hasVoted) {
        upvoteBtn.classList.add('active');
        upvoteBtn.dataset.userVoted = 'true';
        if (upvoteCount) upvoteCount.style.color = ''; // Keep active color
    }

    if (blogId && upvoteBtn) {
        // Simple Real-time Listener (Count only)
        db.collection('blogs').doc(blogId).onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                // Just update count
                const count = data.upvote_count || 0;
                
                if (upvoteCount) {
                    upvoteCount.textContent = count;
                }
            }
        });
        
        upvoteBtn.addEventListener('click', function() {
            {% if is_authenticated %}
            
            const slug = '{{ blog.slug }}';
            // Determine action based on local state (hasVoted)
            const action = hasVoted ? 'remove' : 'add';
            
            // Optimistic UI
            hasVoted = !hasVoted;
            localStorage.setItem(storageKey, hasVoted);
            
            if (hasVoted) {
                this.classList.add('active');
                if (upvoteCount) upvoteCount.style.color = '';
            } else {
                this.classList.remove('active');
                if (upvoteCount) upvoteCount.style.color = '#ccc';
            }
            
            fetch(`/blog/${slug}/vote/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `vote_type=upvote&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    showToast(data.error || 'Failed to vote', 'error');
                    // Revert UI on error
                    hasVoted = !hasVoted;
                    localStorage.setItem(storageKey, hasVoted);
                    this.classList.toggle('active');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while voting', 'error');
                hasVoted = !hasVoted;
                localStorage.setItem(storageKey, hasVoted);
                this.classList.toggle('active');
            });
            {% else %}
            showToast('Please log in to vote', 'info');
            {% endif %}
        });
    }

    // Real-time Saved Status Listener
    const currentUid = '{{ request.session.uid|default:"" }}';
    if (currentUid && blogId) {
        db.collection('users').doc(currentUid).collection('saved_posts').doc(blogId)
            .onSnapshot((doc) => {
                const saveBtn = document.querySelector('.save-btn');
                if (saveBtn) {
                    const icon = saveBtn.querySelector('.material-icons');
                    const text = saveBtn.querySelector('.action-text');
                    
                    if (doc.exists) {
                        saveBtn.classList.add('active');
                        if (icon) icon.textContent = 'bookmark';
                        if (text) text.textContent = 'Saved';
                    } else {
                        saveBtn.classList.remove('active');
                        if (icon) icon.textContent = 'bookmark_border';
                        if (text) text.textContent = 'Save';
                    }
                }
            });
    }
});

// Toast System
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return; // Guard clause
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'info';
    if (type === 'success') icon = 'check_circle';
    if (type === 'error') icon = 'error';
    
    toast.innerHTML = `
        <span class="material-icons toast-icon">${icon}</span>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    // Trigger animation
    requestAnimationFrame(() => {
        toast.classList.add('show');
    });
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}


// Comment System Functions
function toggleReply(commentId) {
    const form = document.getElementById(`reply-form-${commentId}`);
    if (form) {
        // Toggle display
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'block';
            const textArea = form.querySelector('textarea');
            if(textArea) textArea.focus();
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            form.style.display = 'none';
        }
    }
}

function submitComment(event, parentId) {
    event.preventDefault();
    const form = event.target;
    const textarea = form.querySelector('textarea');
    const content = textarea.value.trim();
    
    if (!content) {
        showToast('Please enter a comment', 'error');
        return;
    }
    
    // Disable button
    const submitBtn = form.querySelector('.btn-submit');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Posting...';
    
    const formData = new FormData();
    formData.append('content', content);
    if (parentId) {
        formData.append('parent_id', parentId);
    }
    
    fetch(`/blog/{{ blog.slug }}/comment/add/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Comment posted successfully!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to post comment', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
}

function voteComment(commentId, voteType) {
    fetch(`/blog/{{ blog.slug }}/comment/${commentId}/vote/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `vote_type=${voteType}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload(); 
        } else {
             showToast(data.error || 'Failed to vote', 'error');
        }
    })
    .catch(e => showToast('Network error', 'error'));
}
</script>

<!-- Subscribe Confirmation Modal -->
<div id="subscribeModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
    <div class="modal-content" style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">Join The Ledger?</h3>
        <p style="color: #666; margin-bottom: 2rem; line-height: 1.5;">Subscribe to blog updates and newsletters using your registered email.</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button onclick="closeSubscribeModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 500; color: #666;">Cancel</button>
            <button onclick="confirmSubscribe()" style="padding: 0.75rem 1.5rem; border: none; background: #6366F1; color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">Confirm</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal (Reusing modal styles) -->
<div id="deleteModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
    <div class="modal-content" style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <h3 style="margin-top: 0; margin-bottom: 1rem; color: #1a1a1a;">Delete Comment?</h3>
        <p style="color: #666; margin-bottom: 2rem; line-height: 1.5;">This will remove the text of your comment.</p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button onclick="closeDeleteModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 500; color: #666;">Cancel</button>
            <button id="confirmDeleteBtn" style="padding: 0.75rem 1.5rem; border: none; background: #EF4444; color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">Delete</button>
        </div>
    </div>
</div>

<script>
// ... existing subscribe modal logic ...
function showSubscribeModal() {
    document.getElementById('subscribeModal').style.display = 'flex';
}

function closeSubscribeModal() {
    document.getElementById('subscribeModal').style.display = 'none';
}

function confirmSubscribe() {
   // ... existing subscribe logic ... (keeping for reference, but mainly focusing on delete logic below)
}

// Delete Modal Logic
let commentToDeleteId = null;

function deleteComment(commentId) {
    commentToDeleteId = commentId;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    commentToDeleteId = null;
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (!commentToDeleteId) return;
    
    const btn = this;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Deleting...';
    
    fetch(`/blog/{{ blog.slug }}/comment/${commentToDeleteId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        closeDeleteModal();
        if (data.success) {
            showToast('Comment deleted', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast('Error deleted comment: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to connect', 'error');
        closeDeleteModal();
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = originalText;
    });
});

// Close modals when clicking outside
window.addEventListener('click', function(e) {
    if (e.target.id === 'subscribeModal') {
        closeSubscribeModal();
    }
    if (e.target.id === 'deleteModal') {
        closeDeleteModal();
    }
});
</script>
{% endblock %}