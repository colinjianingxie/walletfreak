{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/blog_detail.css' %}">
{% endblock %}

{% block main_style %}background: #F8F9FA; min-height: 100vh; padding: 0;{% endblock %}

{% block full_width_content %}
{% csrf_token %}
<div class="blog-detail-container">
    <!-- Header Navigation -->
    <div class="detail-header">
        <div class="container">
            <div class="header-nav">
                <a href="{% url 'blog_list' %}" class="back-btn">
                    <span class="material-icons">arrow_back</span>
                    <span>Back to Feed</span>
                </a>
                
                <div class="header-actions">
                    <button class="action-btn bookmark-btn">
                        <span class="material-icons">bookmark_border</span>
                    </button>
                    <button class="action-btn share-btn">
                        <span class="material-icons">share</span>
                    </button>
                    {% if is_editor %}
                    <a href="{% url 'blog_edit' blog.slug %}" class="action-btn edit-btn">
                        <span class="material-icons">edit</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Post Content -->
    <div class="container">
        <article class="post-detail">
            <!-- Post Category -->
            <div class="post-category-badge">
                {% if 'review' in blog.tags|lower %}REVIEWS
                {% elif 'guide' in blog.tags|lower %}GUIDES
                {% elif 'tips' in blog.tags|lower %}TIPS
                {% elif 'news' in blog.tags|lower %}NEWS
                {% else %}REVIEWS{% endif %}
            </div>

            <!-- Featured Image -->
            {% if blog.featured_image %}
            <div class="featured-image">
                <img src="{{ blog.featured_image }}" alt="{{ blog.title }}">
            </div>
            {% endif %}

            <!-- Post Header -->
            <div class="post-header">
                <h1 class="post-title">{{ blog.title }}</h1>
                
                <div class="post-meta">
                    <div class="author-info">
                        <div class="author-avatar">
                            <span class="material-icons">person</span>
                        </div>
                        <div class="author-details">
                            <span class="author-name">{{ blog.author_real_name|default:"Unknown"|title }}</span>
                            <span class="author-handle">@{{ blog.author_username|default:"Unknown" }}</span>
                        </div>
                    </div>
                    
                    <div class="post-stats">
                        <div class="stat-item">
                            <span class="material-icons">schedule</span>
                            <span>{{ blog.published_at|timesince }} ago</span>
                        </div>
                        <div class="stat-item">
                            <span class="material-icons">local_fire_department</span>
                            <span>{{ upvote_count|default:0 }} upvote{{ upvote_count|pluralize }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="material-icons">visibility</span>
                            <span>{{ blog.view_count|default:0 }} views</span>
                        </div>
                        <div class="stat-item">
                            <span class="material-icons">chat_bubble_outline</span>
                            <span>{{ total_comments|default:0 }} comments</span>
                        </div>
                        <div class="stat-item">
                            <span class="material-icons">access_time</span>
                            <span>5 min read</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TL;DR Section -->
            {% if blog.excerpt %}
            <div class="tldr-section">
                <div class="tldr-header">
                    <span class="material-icons">bolt</span>
                    <span class="tldr-label">TOO LONG; DIDN'T READ</span>
                </div>
                <div class="tldr-content">
                    {{ blog.excerpt }}
                </div>
            </div>
            {% endif %}

            <!-- Post Content -->
            <div class="post-content">
                {{ blog.html_content }}
            </div>

            <!-- Post Actions Footer -->
            <div class="post-actions-footer">
                <div class="action-group">
                    {% if is_authenticated %}
                    <button class="action-btn upvote-btn {% if user_vote == 'upvote' %}active{% endif %}" data-vote-type="upvote">
                        <span class="material-icons">local_fire_department</span>
                        <span class="action-count" style="{% if user_vote != 'upvote' %}color: #ccc;{% endif %}">{{ upvote_count|default:0 }}</span>
                    </button>
                    {% else %}
                    <button class="action-btn upvote-btn" onclick="showLoginModal()">
                        <span class="material-icons">local_fire_department</span>
                        <span class="action-count" style="color: #ccc;">{{ upvote_count|default:0 }}</span>
                    </button>
                    {% endif %}
                    <button class="action-btn comment-btn">
                        <span class="material-icons">chat_bubble_outline</span>
                        <span class="action-count">{{ total_comments|default:0 }}</span>
                    </button>
                    <button class="action-btn share-btn">
                        <span class="material-icons">share</span>
                        <span class="action-text">Share</span>
                    </button>
                </div>
                <button class="action-btn save-btn" data-slug="{{ blog.slug }}" data-id="{{ blog.id }}">
                    <span class="material-icons">bookmark_border</span>
                    <span class="action-text">Save</span>
                </button>
            </div>
        </article>
        </article>

        <!-- Comments Section -->
        <div class="comments-section-wrapper">
            <div class="comments-header-row">
                <h3>Top Comments</h3>
                <div class="sort-dropdown">
                    <span>Best</span>
                    <span class="material-icons">expand_more</span>
                </div>
            </div>
            
            {% if is_authenticated %}
            <div class="main-comment-input">
                <div class="user-avatar-small">
                    <!-- User avatar logic or placeholder -->
                    U
                </div>
                <form class="comment-form main-form" onsubmit="submitComment(event, null)">
                    <textarea placeholder="What are your thoughts?" rows="3"></textarea>
                    <div class="form-actions">
                        <button type="submit" class="btn-submit">Comment</button>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="login-to-comment">
                <p>Please <a href="{% url 'login' %}?next={{ request.path }}">log in</a> to leave a comment.</p>
            </div>
            {% endif %}
            
            <div class="comments-list" id="comments-list">
                {% for comment in comments %}
                    {% include "blog/includes/comment_item.html" with comment=comment %}
                {% empty %}
                    <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
                {% endfor %}
            </div>
        </div>
        {% if related_posts %}
        <div class="related-section">
            <h3>Related Posts</h3>
            <div class="related-posts-list">
                {% for post in related_posts %}
                <div class="related-post-item">
                    <a href="{% url 'blog_detail' post.slug %}" class="related-post-link">
                        <h4>{{ post.title }}</h4>
                        <p>{{ post.excerpt|default:"Read more about this topic..." }}</p>
                        <span class="related-post-author">
                            by @{{ post.author_username }}
                        </span>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Bookmark functionality
    // Save/Bookmark functionality
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            
            {% if not is_authenticated %}
            showLoginModal();
            return;
            {% endif %}
            
            const slug = this.getAttribute('data-slug');
            const isCurrentlySaved = this.classList.contains('active');
            
            // Optimistic update
            // Listener will confirm this, but we toggle immediately for responsiveness
            /* 
               Actually, since we have a listener, we can just rely on the backend response + listener?
               But for strict responsiveness, let's toggle.
               However, if we toggle here AND the listener updates, it might flicker if there's lag.
               The user said "does not bookmark", implies nothing happened.
               Let's trigger the backend call. The listener (lines 286+) will handle the UI state.
               We can add a temporary loading state if we want, or just fire and forget.
               To be safe and "premium", let's toggle optimistically.
            */
            
            // Toggle local state
            this.classList.toggle('active');
            const icon = this.querySelector('.material-icons');
            const text = this.querySelector('.action-text');
            
            if (this.classList.contains('active')) {
                if(icon) icon.textContent = 'bookmark';
                if(text) text.textContent = 'Saved';
            } else {
                if(icon) icon.textContent = 'bookmark_border';
                if(text) text.textContent = 'Save';
            }
            
            // Logic for URL
            const url = isCurrentlySaved ? `/blog/${slug}/unsave/` : `/blog/${slug}/save/`;
            
            // CSRF
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    // Revert if failed
                    this.classList.toggle('active');
                    if (this.classList.contains('active')) {
                        if(icon) icon.textContent = 'bookmark';
                        if(text) text.textContent = 'Saved';
                    } else {
                        if(icon) icon.textContent = 'bookmark_border';
                        if(text) text.textContent = 'Save';
                    }
                    console.error('Save failed:', data.error);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                // Revert
                this.classList.toggle('active');
                // ... revert logic
            });
        });
    });

    // Share functionality
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (navigator.share) {
                navigator.share({
                    title: document.title,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                const originalText = this.querySelector('.action-text');
                if (originalText) {
                    const original = originalText.textContent;
                    originalText.textContent = 'Copied!';
                    setTimeout(() => {
                        originalText.textContent = original;
                    }, 2000);
                }
            }
        });
    });

    // Real-time Voting Listener
    const blogId = '{{ blog.id }}';
    const currentUid = '{{ request.session.uid|default:"" }}';
    const upvoteBtn = document.querySelector('.upvote-btn');
    const upvoteCount = upvoteBtn ? upvoteBtn.querySelector('.action-count') : null;

    if (blogId && upvoteBtn) {
        db.collection('blogs').doc(blogId).onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                const upvoters = data.upvoters || [];
                const count = upvoters.length;
                
                // Update count
                if (upvoteCount) {
                    upvoteCount.textContent = count;
                }
                
                // Update active state if logged in
                if (currentUid) {
                    if (upvoters.includes(currentUid)) {
                        upvoteBtn.classList.add('active');
                    } else {
                        upvoteBtn.classList.remove('active');
                    }
                    
                    // Update dataset locally to minimize flicker on potential conflict (optional)
                    if (upvoters.includes(currentUid)) {
                         upvoteBtn.dataset.userVoted = 'true';
                         if (upvoteCount) upvoteCount.style.color = ''; // Reset to default/active color
                    } else {
                         upvoteBtn.dataset.userVoted = 'false';
                         if (upvoteCount) upvoteCount.style.color = '#ccc';
                    }
                } else {
                    // Not logged in -> always gray
                    if (upvoteCount) upvoteCount.style.color = '#ccc';
                }
            }
        });
    }

    // Real-time Saved Status Listener
    if (currentUid && blogId) {
        db.collection('users').doc(currentUid).collection('saved_posts').doc(blogId)
            .onSnapshot((doc) => {
                const saveBtn = document.querySelector('.save-btn');
                if (saveBtn) {
                    const icon = saveBtn.querySelector('.material-icons');
                    const text = saveBtn.querySelector('.action-text');
                    
                    if (doc.exists) {
                        saveBtn.classList.add('active');
                        if (icon) icon.textContent = 'bookmark';
                        if (text) text.textContent = 'Saved';
                    } else {
                        saveBtn.classList.remove('active');
                        if (icon) icon.textContent = 'bookmark_border';
                        if (text) text.textContent = 'Save';
                    }
                }
            });
    }

    // Voting functionality
    if (upvoteBtn) {
        upvoteBtn.addEventListener('click', function() {
            {% if is_authenticated %}
            // Optimistic UI update is handled by listener mostly, but we can do immediate feedback if needed.
            // But with listener it feels instant enough usually.
            
            const voteType = this.dataset.voteType;
            const slug = '{{ blog.slug }}';
            
            // Send AJAX request just to toggle backend
            // Pure toggle logic now
            
            fetch(`/blog/${slug}/vote/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `vote_type=upvote`
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Error: ' + data.error);
                }
                // Success means backend toggled it. Listener will catch the result.
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while voting');
            });
            {% else %}
            alert('Please log in to vote');
            {% endif %}
        });
    }
});


// Comment System Functions
function toggleReply(commentId) {
    const form = document.getElementById(`reply-form-${commentId}`);
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}

function submitComment(event, parentId) {
    event.preventDefault();
    const form = event.target;
    const textarea = form.querySelector('textarea');
    const content = textarea.value.trim();
    
    if (!content) return;
    
    // Disable button
    const submitBtn = form.querySelector('.btn-submit');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Posting...';
    
    const formData = new FormData();
    formData.append('content', content);
    if (parentId) {
        formData.append('parent_id', parentId);
    }
    
    fetch(`/blog/{{ blog.slug }}/comment/add/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page to show new comment (simpler than appending to DOM for now)
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to post comment');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
}

function voteComment(commentId, voteType) {
    fetch(`/blog/{{ blog.slug }}/comment/${commentId}/vote/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `vote_type=${voteType}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ideally update the count locally, for now reload or just alert
            // Simple optimistic update:
            const countSpan = document.getElementById(`vote-count-${commentId}`);
            let current = parseInt(countSpan.textContent);
            if (data.action === 'voted') {
                // Determine direction based on voteType if we tracked old state
                // This is tricky without knowing old state.
                // For this MVP, let's just reload or accept minor inaccuracy until reload
                window.location.reload(); 
            } else {
                window.location.reload();
            }
        }
    });
}

function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment?')) return;
    
    fetch(`/blog/{{ blog.slug }}/comment/${commentId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error deleting comment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete comment');
    });
}
</script>
{% endblock %}