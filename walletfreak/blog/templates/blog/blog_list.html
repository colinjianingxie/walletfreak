{% extends 'base.html' %}
{% load static %}
{% csrf_token %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/blog_community.css' %}">
{% endblock %}

{% block main_style %}background: #F8F9FA; min-height: 100vh; padding: 0;{% endblock %}

{% block full_width_content %}
<div class="blog-container">
    <!-- Header with Search -->
    <div class="blog-header">
        <div class="container">
            <div class="header-content">
                <div class="search-wrapper">
                    <span class="search-icon material-icons">search</span>
                    <form action="." method="GET" style="width: 100%;">
                        {% if current_category and current_category != 'All' %}
                        <input type="hidden" name="category" value="{{ current_category }}">
                        {% endif %}
                        <input type="text" name="q" placeholder="Search the community..." value="{{ search_query|default:'' }}" class="search-input">
                    </form>
                </div>
                
                <!-- Category Tabs -->
                <div class="category-tabs">
                    <a href="?category=All" class="category-tab {% if not current_category or current_category == 'All' %}active{% endif %}">All</a>
                    <a href="?category=Reviews" class="category-tab {% if current_category == 'Reviews' %}active{% endif %}">Reviews</a>
                    <a href="?category=Guides" class="category-tab {% if current_category == 'Guides' %}active{% endif %}">Guides</a>
                    <a href="?category=Tips" class="category-tab {% if current_category == 'Tips' %}active{% endif %}">Tips</a>
                    <a href="?category=News" class="category-tab {% if current_category == 'News' %}active{% endif %}">News</a>
                    <a href="?category=Saved" class="category-tab {% if current_category == 'Saved' %}active{% endif %}">Saved</a>
                </div>
            </div>
            
            <!-- Mobile Category Tabs (shown only on mobile, right below search) -->
            <div class="mobile-category-tabs">
                <a href="?category=All" class="mobile-tab {% if not current_category or current_category == 'All' %}active{% endif %}">All</a>
                <a href="?category=Reviews" class="mobile-tab {% if current_category == 'Reviews' %}active{% endif %}">Reviews</a>
                <a href="?category=Guides" class="mobile-tab {% if current_category == 'Guides' %}active{% endif %}">Guides</a>
                <a href="?category=Tips" class="mobile-tab {% if current_category == 'Tips' %}active{% endif %}">Tips</a>
                <a href="?category=News" class="mobile-tab {% if current_category == 'News' %}active{% endif %}">News</a>
                <a href="?category=Saved" class="mobile-tab {% if current_category == 'Saved' %}active{% endif %}">Saved</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="blog-layout">
            <!-- Posts Feed -->
            <div class="posts-feed">
                {% for post in blogs %}
                <article class="post-card" data-href="{% url 'blog_detail' post.slug %}" data-slug="{{ post.slug }}">
                    <!-- Post Vote Section -->
                    <div class="post-vote" onclick="event.stopPropagation();">
                        {% if is_authenticated %}
                        <button class="vote-btn upvote {% if post.user_vote == 'upvote' %}active{% endif %}"
                                data-slug="{{ post.slug }}" data-vote-type="upvote">
                            <span class="material-icons">trending_up</span>
                        </button>
                        <span class="vote-count">{{ post.total_score|default:0 }}</span>
                        <button class="vote-btn downvote {% if post.user_vote == 'downvote' %}active{% endif %}"
                                data-slug="{{ post.slug }}" data-vote-type="downvote">
                            <span class="material-icons">trending_down</span>
                        </button>
                        {% else %}
                        <button class="vote-btn upvote" onclick="alert('Please log in to vote')">
                            <span class="material-icons">trending_up</span>
                        </button>
                        <span class="vote-count">{{ post.total_score|default:0 }}</span>
                        <button class="vote-btn downvote" onclick="alert('Please log in to vote')">
                            <span class="material-icons">trending_down</span>
                        </button>
                        {% endif %}
                    </div>

                    <!-- Post Main Content -->
                    <div class="post-main">
                        <!-- Post Header -->
                        <div class="post-header">
                            <div class="post-author">
                                <div class="author-avatar">
                                    <span class="material-icons">person</span>
                                </div>
                                <div class="author-info">
                                    <span class="author-name">@{{ post.author_name|lower|cut:" " }}</span>
                                    <span class="post-time">{{ post.published_at|timesince }} ago</span>
                                </div>
                            </div>
                            <div class="post-category">
                                {% if 'review' in post.tags|lower %}REVIEWS
                                {% elif 'guide' in post.tags|lower %}GUIDES
                                {% elif 'tips' in post.tags|lower %}TIPS
                                {% elif 'news' in post.tags|lower %}NEWS
                                {% else %}REVIEWS{% endif %}
                            </div>
                        </div>

                        <!-- Post Content -->
                        <div class="post-content">
                            <div class="post-text">
                                <h2 class="post-title">
                                    {{ post.title }}
                                </h2>
                                
                                <!-- TL;DR Section -->
                                {% if post.excerpt %}
                                <div class="post-tldr">
                                    <span class="tldr-label">TL;DR</span>
                                    <span class="tldr-text">{{ post.excerpt|truncatewords:25 }}</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if post.featured_image %}
                            <div class="post-image">
                                <img src="{{ post.featured_image }}" alt="{{ post.title }}">
                            </div>
                            {% endif %}
                        </div>

                        <!-- Post Actions -->
                        <div class="post-actions" onclick="event.stopPropagation();">
                            <div class="action-group">
                                <button class="action-btn comment-btn">
                                    <span class="material-icons">chat_bubble_outline</span>
                                    <span class="action-count">{{ post.id|add:50|add:39 }} Comments</span>
                                </button>
                                <button class="action-btn share-btn">
                                    <span class="material-icons">share</span>
                                    <span class="action-text">Share</span>
                                </button>
                            </div>
                            <button class="action-btn save-btn {% if post.id in user_saved_posts %}active{% endif %}" data-slug="{{ post.slug }}">
                                <span class="material-icons">{% if post.id in user_saved_posts %}bookmark{% else %}bookmark_border{% endif %}</span>
                                <span class="action-text">{% if post.id in user_saved_posts %}Saved{% else %}Save{% endif %}</span>
                            </button>
                        </div>
                    </div>
                </article>
                {% empty %}
                <div class="empty-state">
                    <span class="material-icons">article</span>
                    <h3>No posts found</h3>
                    <p>Try adjusting your search or category filter.</p>
                </div>
                {% endfor %}
            </div>

            <!-- Sidebar -->
            <div class="blog-sidebar">
                <!-- Community Info -->
                <div class="sidebar-card community-card">
                    <div class="community-header">
                        <div class="community-icon">
                            <span class="material-icons">bolt</span>
                        </div>
                        <div class="community-info">
                            <h3>The Ledger</h3>
                            <span class="community-status">
                                <span class="status-dot"></span>
                                120 Online
                            </span>
                        </div>
                    </div>
                    <p class="community-description">
                        The unofficial official headquarters for credit card optimizers, point hoarders, and spreadsheet enthusiasts.
                    </p>
                    <div class="community-stats">
                        <div class="stat">
                            <span class="stat-number">14.2k</span>
                            <span class="stat-label">MEMBERS</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number">Top 1%</span>
                            <span class="stat-label">RANK</span>
                        </div>
                    </div>
                    <button class="join-btn">Join Community</button>
                </div>

                <!-- Trending Topics -->
                <div class="sidebar-card trending-card">
                    <div class="card-header">
                        <span class="material-icons">local_fire_department</span>
                        <h4>TRENDING TOPICS</h4>
                    </div>
                    <div class="trending-list">
                        <div class="trending-item">
                            <span class="trending-rank">1</span>
                            <div class="trending-content">
                                <span class="trending-title">Retention Offer Data Points 2024</span>
                                <span class="trending-score">324 score</span>
                            </div>
                        </div>
                        <div class="trending-item">
                            <span class="trending-rank">2</span>
                            <div class="trending-content">
                                <span class="trending-title">Hyatt Category Changes incoming?</span>
                                <span class="trending-score">156 score</span>
                            </div>
                        </div>
                        <div class="trending-item">
                            <span class="trending-rank">3</span>
                            <div class="trending-content">
                                <span class="trending-title">Which card for tax payments?</span>
                                <span class="trending-score">89 score</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Contributors -->
                <div class="sidebar-card contributors-card">
                    <div class="card-header">
                        <span class="material-icons">emoji_events</span>
                        <h4>TOP CONTRIBUTORS</h4>
                    </div>
                    <div class="contributors-list">
                        <div class="contributor-item">
                            <div class="contributor-avatar">
                                <span class="material-icons">person</span>
                            </div>
                            <span class="contributor-name">@TheFreak</span>
                            <span class="contributor-points">120k pts</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% if is_editor %}
<!-- Floating Action Button for Editors -->
<a href="{% url 'blog_create' %}" class="fab">
    <span class="material-icons">add</span>
</a>
{% endif %}

<script>
// Add interactivity for post actions
document.addEventListener('DOMContentLoaded', function() {
    // Make post cards clickable
    document.querySelectorAll('.post-card').forEach(card => {
        card.addEventListener('click', function() {
            const href = this.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        });
    });

    // Vote buttons
    document.querySelectorAll('.vote-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent card click
            
            {% if is_authenticated %}
            const slug = this.getAttribute('data-slug');
            const voteType = this.getAttribute('data-vote-type');
            
            if (!slug || !voteType) {
                console.error('Missing slug or vote type');
                return;
            }
            
            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            
            // Make AJAX request
            fetch(`/blog/${slug}/vote/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: `vote_type=${voteType}`,
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const postCard = this.closest('.post-card');
                    const voteCount = postCard.querySelector('.vote-count');
                    const upvoteBtn = postCard.querySelector('.vote-btn.upvote');
                    const downvoteBtn = postCard.querySelector('.vote-btn.downvote');
                    
                    // Update vote count (total score)
                    const totalScore = data.upvote_count - data.downvote_count;
                    voteCount.textContent = totalScore;
                    
                    // Update active states
                    upvoteBtn.classList.remove('active');
                    downvoteBtn.classList.remove('active');
                    
                    if (data.user_vote === 'upvote') {
                        upvoteBtn.classList.add('active');
                    } else if (data.user_vote === 'downvote') {
                        downvoteBtn.classList.add('active');
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while voting');
            });
            {% endif %}
        });
    });

    // Save buttons
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent card click
            
            const slug = this.getAttribute('data-slug');
            const isCurrentlySaved = this.classList.contains('active');
            const icon = this.querySelector('.material-icons');
            const text = this.querySelector('.action-text');
            
            // Optimistically update UI
            if (isCurrentlySaved) {
                this.classList.remove('active');
                icon.textContent = 'bookmark_border';
                text.textContent = 'Save';
            } else {
                this.classList.add('active');
                icon.textContent = 'bookmark';
                text.textContent = 'Saved';
            }
            
            // Make API call
            const url = isCurrentlySaved ? `/blog/${slug}/unsave/` : `/blog/${slug}/save/`;
            
            // Get CSRF token from cookie or meta tag
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    // Revert UI changes if API call failed
                    if (isCurrentlySaved) {
                        this.classList.add('active');
                        icon.textContent = 'bookmark';
                        text.textContent = 'Saved';
                    } else {
                        this.classList.remove('active');
                        icon.textContent = 'bookmark_border';
                        text.textContent = 'Save';
                    }
                    console.error('Failed to save/unsave post:', data.error);
                }
            })
            .catch(error => {
                // Revert UI changes if request failed
                if (isCurrentlySaved) {
                    this.classList.add('active');
                    icon.textContent = 'bookmark';
                    text.textContent = 'Saved';
                } else {
                    this.classList.remove('active');
                    icon.textContent = 'bookmark_border';
                    text.textContent = 'Save';
                }
                console.error('Error saving/unsaving post:', error);
            });
        });
    });

    // Share buttons
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent card click
            // Simple share functionality
            const postCard = this.closest('.post-card');
            const postTitle = postCard.querySelector('.post-title').textContent;
            const postUrl = window.location.origin + postCard.getAttribute('data-href');
            
            if (navigator.share) {
                navigator.share({
                    title: postTitle,
                    url: postUrl
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(postUrl);
                // Show feedback
                const originalText = this.querySelector('.action-text');
                if (originalText) {
                    const original = originalText.textContent;
                    originalText.textContent = 'Copied!';
                    setTimeout(() => {
                        originalText.textContent = original;
                    }, 2000);
                }
            }
        });
    });

    // Comment buttons
    document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent card click
            // Navigate to post detail page and scroll to comments
            const postCard = this.closest('.post-card');
            const href = postCard.getAttribute('data-href');
            if (href) {
                window.location.href = href + '#comments';
            }
        });
    });
});
</script>
{% endblock %}