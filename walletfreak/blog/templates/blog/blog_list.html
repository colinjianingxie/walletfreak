{% extends 'base.html' %}
{% load static %}
{% load blog_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/blog_redesign.css' %}">
{% endblock %}

{% block content %}
<div class="blog-layout">
    
    <!-- Header -->
    <header class="blog-header" style="padding-bottom: 0; margin-bottom: 0.5rem;">
        <h1 class="blog-page-title">The Ledger</h1>
        <p class="blog-page-subtitle">Proprietary strategies and card intelligence.</p>
    </header>

     <!-- Mobile Controls (Search & Chips) -->
    <div class="mobile-controls">
        <div class="mobile-search-row">
            <div class="search-wrapper mobile-search-wrapper">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon" aria-hidden="true"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg>
                 <input type="text" 
                        name="q" 
                        class="search-input" 
                        placeholder="Search ledger..." 
                        value="{{ search_query|default:'' }}"
                        hx-get="{% url 'blog_list' %}" 
                        hx-trigger="keyup changed delay:500ms" 
                        hx-target="#blog-grid-container" 
                        hx-indicator="#blog-grid-container"
                        hx-push-url="true">
            </div>
            <button class="mobile-filter-btn" onclick="toggleMobileModal()">
                <span class="material-icons">tune</span>
            </button>
        </div>
        
        {% include "blog/partials/mobile_quick_chips.html" %}

        <!-- Mobile Active Filters (OOB Swapped) -->
        <div id="mobile-active-filters">
            {% include "blog/partials/active_filters.html" %}
        </div>
    </div>
     
     <div class="blog-layout-grid">
         
         <!-- Sidebar -->
         <aside class="blog-sidebar-col">
             <div id="blog-sidebar">
                 {% include "blog/partials/sidebar.html" %}
             </div>
 
             <!-- Admin Actions (Editors Only) -->
             {% if is_editor %}
             <div class="inner-circle-promo" style="background: white; border: 1px solid #e2e8f0; margin-top: 2rem;">
                 <div class="promo-content">
                     <span class="material-icons crown-icon" style="color: #6366F1; background: rgba(99, 102, 241, 0.1);">edit_note</span>
                     <h4 class="promo-title">Editor Console</h4>
                     <p class="promo-text">Manage the ledger and drafts.</p>
                     <div style="display: flex; gap: 0.5rem; margin-top: 1rem; width: 100%;">
                         <a href="{% url 'blog_create' %}" class="promo-btn" style="text-align: center; flex: 1; justify-content: center;">Create</a>
                         <a href="{% url 'blog_drafts' %}" class="promo-btn" style="text-align: center; flex: 1; justify-content: center; background: white; color: #0F172A; border: 1px solid #e2e8f0;">Drafts</a>
                         <a href="{% url 'media_library' %}" class="promo-btn" style="text-align: center; flex: 1; justify-content: center; background: white; color: #0F172A; border: 1px solid #e2e8f0;">Media</a>
                     </div>
                 </div>
             </div>
             {% endif %}
 
             <!-- Inner Circle Promo (Non-Premium Only) -->
             {% if not user_is_premium and not is_editor %}
             <div class="inner-circle-promo" style="background: white; border: 1px solid #e2e8f0; margin-top: 2rem;">
                 <div class="promo-content">
                     <span class="material-icons crown-icon">emoji_events</span>
                     <h4 class="promo-title">The Inner Circle</h4>
                     <p class="promo-text">Access restricted churning paths and data-points.</p>
                     <button class="promo-btn">Go Premium</button>
                 </div>
             </div>
             {% endif %}
         </aside>
         
         <!-- Main Content -->
         <!-- Main Content -->
         <div class="blog-main-col">
              <!-- Desktop Search Implementation -->
              <div class="desktop-search" style="margin-bottom: 1rem;">
                  <div class="search-wrapper">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon" aria-hidden="true"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg>
                      <input type="text" 
                             name="q" 
                             class="search-input" 
                             placeholder="Search the ledger..." 
                             value="{{ search_query|default:'' }}"
                             hx-get="{% url 'blog_list' %}" 
                             hx-trigger="keyup changed delay:500ms" 
                             hx-target="#blog-grid-container" 
                             hx-indicator="#blog-grid-container" 
                            hx-push-url="true"> 
                 </div>
            </div>
            
            <!-- Active Filters -->
            <div id="active-filters-bar">
                {% include "blog/partials/active_filters.html" %}
            </div>
            <!-- Blog Grid (HTMX Target) -->
            <div id="blog-grid-container" class="relative min-h-[500px]">
                
                {% include "blog/partials/blog_list_results.html" %}
            </div>
        </div>
        
    </div>
</div>
<div id="mobile-filter-modal-container">
    {% include "blog/partials/mobile_filter_modal.html" %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Mobile Filter Modal Logic
    function toggleMobileModal() {
        const modal = document.getElementById('mobile-filter-modal');
        if (!modal) {
            console.error('Mobile filter modal not found');
            return;
        }
        modal.classList.toggle('hidden');
        if (!modal.classList.contains('hidden')) {
            document.body.style.overflow = 'hidden'; 
        } else {
            document.body.style.overflow = '';
        }
    }

    function resetMobileFilters() {
        const form = document.getElementById('mobile-filter-form');
        if (!form) return;
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        // Close modal immediately so user sees loading state
        toggleMobileModal();

        // Auto-apply the reset (triggers HTMX request)
        htmx.trigger(form, 'submit');
    }

    // Workaround for CSRF token in JS
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function toggleBlogBookmark(e, slug, btn) {
        e.preventDefault();
        e.stopPropagation();

        const icon = btn.querySelector('.material-icons');
        const isSaved = icon.textContent.trim() === 'bookmark';
        const action = isSaved ? 'unsave' : 'save';
        const url = `/blog/${slug}/${action}/`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Toggle Icon
                    icon.textContent = isSaved ? 'bookmark_border' : 'bookmark';
                    // Toggle Color
                    btn.style.color = isSaved ? '#94A3B8' : 'var(--primary)'; // Reset to gray or set to primary
                } else {
                    console.error('Action failed:', data.error);
                    if (data.error === 'Not authenticated') {
                         window.location.href = '/login/?next=' + window.location.pathname;
                    }
                }
            } else {
                console.error('Server error');
            }
        } catch (error) {
            console.error('Network error:', error);
        }
    }

    async function toggleBlogVote(e, slug, btn) {
        e.preventDefault();
        e.stopPropagation();
        
        const url = `/blog/${slug}/vote/`;
        const countSpan = btn.parentElement.querySelector('.vote-count');
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Update count
                    if (countSpan) {
                         countSpan.textContent = data.new_count;
                    }
                    
                    // Toggle active class
                    if (data.action === 'added') {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                    
                } else {
                    console.error('Vote failed:', data.error);
                    if (data.error === 'Not authenticated') {
                         // Redirect to login or show modal
                         window.location.href = '/login/?next=' + window.location.pathname;
                    }
                }
            } else {
                console.error('Server error');
            }
        } catch (error) {
            console.error('Network error:', error);
        }
    }
</script>
{% endblock %}