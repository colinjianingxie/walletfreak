{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Personalities Header with Quiz -->
<section style="background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); padding: 4rem 0; text-align: center; color: white; position: relative; overflow: hidden;">
    <!-- Background decoration -->
    <div style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: rgba(124, 58, 237, 0.1); border-radius: 50%; filter: blur(80px);"></div>
    <div style="position: absolute; bottom: -100px; left: -100px; width: 300px; height: 300px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; filter: blur(80px);"></div>
    
    <div class="container" style="position: relative; z-index: 1;">
        <!-- Badge -->
        <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 999px; margin-bottom: 1.5rem; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);">
            <span style="font-size: 1.1rem;"><span class="material-icons" style="font-size: 16px; vertical-align: middle;">auto_awesome</span></span>
            <span style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.1em;">Discover Your Financial DNA</span>
        </div>
        
        <!-- Title -->
        <h1 style="font-size: clamp(2.5rem, 5vw, 3.5rem); font-weight: 700; margin-bottom: 1rem; line-height: 1.2; color: white;">
            What's your <span style="background: linear-gradient(135deg, #A78BFA 0%, #C084FC 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Wallet Vibe?</span>
        </h1>
        
        <!-- Subtitle -->
        <p style="font-size: 1.125rem; color: #94A3B8; max-width: 600px; margin: 0 auto 3rem;">
            Click the statement that sounds most like you.
        </p>

        <!-- Quiz Container -->
        <div id="quiz-container" style="max-width: 800px; margin: 0 auto;">
            <!-- Question Text -->
            <h2 id="question-text" style="font-size: 1.5rem; font-weight: 600; margin-bottom: 3rem; color: white; line-height: 1.4;"></h2>

            <!-- Slider Container -->
            <div id="slider-container" style="margin-bottom: 4rem; padding: 0 2rem;">
                <input type="range" min="1" max="5" value="3" class="slider" id="rating-slider">
                <div style="display: flex; justify-content: space-between; margin-top: 1rem; color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                    <span>Not at all (1)</span>
                    <span>Somewhat (3)</span>
                    <span>Absolutely (5)</span>
                </div>
                <div id="current-rating" style="margin-top: 1.5rem; font-size: 2rem; font-weight: 700; color: #a78bfa;">3</div>
            </div>

            <!-- Next Button -->
            <button id="next-btn" class="btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1rem 3rem; font-size: 1.1rem; font-weight: 600; box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4); border: none; border-radius: 99px; cursor: pointer; transition: transform 0.2s;" onclick="nextQuestion()">
                Next ‚Üí
            </button>
        </div>
    </div>
</section>

<style>
    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 12px;
        border-radius: 6px;
        background: rgba(255,255,255,0.1);
        outline: none;
        transition: opacity .2s;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #8b5cf6;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        border: 4px solid #1e293b;
    }

    .slider::-moz-range-thumb {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #8b5cf6;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        border: 4px solid #1e293b;
    }
    
    #next-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(139, 92, 246, 0.5) !important;
    }
    
    #next-btn:active {
        transform: translateY(0);
    }
    
    .quiz-card:hover {
        background: rgba(255,255,255,0.1) !important;
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .quiz-card-highlight:hover {
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%) !important;
        box-shadow: 0 12px 24px rgba(124, 58, 237, 0.4) !important;
    }
</style>

<!-- User's Assigned Personality (if exists) -->
{% if assigned_personality %}
<section class="container" style="padding: 2rem 0 1rem;">
    <div style="background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%); border-radius: 20px; padding: 2rem; border: 1px solid #E9D5FF; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15);">
        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 2rem; align-items: center;">
            <!-- Left: Icon -->
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #A855F7 0%, #9333EA 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: 0 8px 16px rgba(168, 85, 247, 0.3);">
                {{ assigned_personality.icon|default:"üéØ" }}
            </div>

            <!-- Middle: Info -->
            <div>
                <div style="font-size: 0.75rem; color: #7C3AED; font-weight: 700; letter-spacing: 0.1em; margin-bottom: 0.5rem; text-transform: uppercase;">
                    YOUR PERSONALITY
                </div>
                
                <h3 style="font-size: 1.75rem; font-weight: 800; margin: 0 0 0.5rem 0; color: #1F2937;">
                    {{ assigned_personality.name }}
                </h3>

                <p style="color: #64748B; line-height: 1.6; margin: 0; font-size: 0.9375rem; max-width: 600px;">
                    {{ assigned_personality.tagline }}
                </p>
            </div>

            <!-- Right: Action -->
            <a href="{% url 'personality_results' %}" style="padding: 1rem 1.5rem; background: white; color: #7C3AED; border: 2px solid #A855F7; border-radius: 12px; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; white-space: nowrap;">
                View Details
                <span class="material-icons" style="font-size: 18px;">arrow_forward</span>
            </a>
        </div>
    </div>
</section>
{% endif %}

<!-- Personalities Grid -->
<section class="container" style="padding: 4rem 0;">
    <div style="display: flex; flex-direction: column; gap: 2rem;" id="personalities-grid">
        {% for personality in personalities %}
        <a href="{% url 'personality_detail' personality.id %}" class="personality-card-link"
            style="text-decoration: none; color:inherit;" data-name="{{ personality.name|lower }}"
            data-desc="{{ personality.description|lower }}" data-tag="{{ personality.tagline|default:''|lower }}">
            <div style="background: white; border-radius: 20px; padding: 2.5rem; border: 1px solid #E5E7EB; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: all 0.3s; display: grid; grid-template-columns: auto 1fr auto; gap: 2rem; align-items: center;" class="personality-card">
                <!-- Left: Avatar -->
                <div style="width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex-shrink: 0; backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                    <img src="{% static 'img/personalities/'|add:personality.id|add:'.svg' %}" alt="{{ personality.name }}" style="width: 100%; height: 100%; object-fit: contain; padding: 15px;">
                </div>

                <!-- Middle: Info -->
                <div style="min-width: 0;">
                    <!-- Label -->
                    <div style="font-size: 0.75rem; color: #9CA3AF; font-weight: 600; letter-spacing: 0.1em; margin-bottom: 0.5rem; text-transform: uppercase;">
                        RECOMMENDED STACK
                    </div>
                    
                    <!-- Name -->
                    <h3 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 0.75rem 0; color: #1F2937;">
                        {{ personality.name }}
                    </h3>

                    <!-- Description -->
                    <p style="color: #64748B; line-height: 1.6; margin: 0 0 1rem 0; font-size: 0.9375rem;">
                        {{ personality.description|truncatewords:25 }}
                    </p>

                    <!-- Tags -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                        {% if personality.tagline %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em;">
                            #{{ personality.tagline|upper|truncatewords:2 }}
                        </span>
                        {% endif %}
                        <!-- Additional context tags based on personality type -->
                        {% if 'jetsetter' in personality.id|lower %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#TRAVEL</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#FLY</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#PLANE</span>
                        {% elif 'freak' in personality.id|lower or 'wallet freak' in personality.name|lower %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#CHURNING</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#MAXIMUM</span>
                        {% elif 'hunter' in personality.id|lower %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#CASHBACK</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#NOFEE</span>
                        {% endif %}
                    </div>

                    <!-- View Full Strategy Link (Moved Inside) -->
                    <a href="{% url 'personality_detail' personality.id %}" style="display: inline-flex; align-items: center; gap: 0.5rem; color: #6366F1; font-weight: 600; font-size: 0.9rem; text-decoration: none;">
                        View Full Strategy <span class="material-icons" style="font-size: 16px;">arrow_forward</span>
                    </a>
                </div>

                <!-- Right: Card Stack -->
                <div style="position: relative; width: 280px; height: 200px; flex-shrink: 0; cursor: pointer;" onclick="event.preventDefault(); openCardModal('{{ personality.recommended_cards.0 }}');">
                    <!-- Card 1 (Back) - Amex/Gray -->
                    <div style="position: absolute; top: 0; left: 0; width: 240px; height: 150px; background: linear-gradient(135deg, #8B9BA7 0%, #6B7B88 100%); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); transform: rotate(-8deg); z-index: 1; transition: transform 0.3s;">
                        <div style="padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; color: white;">
                            <div style="font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;">AMEX</div>
                            <div style="font-size: 0.9rem; letter-spacing: 0.1em;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1323</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-size: 0.7rem;">YOUR NAME</div>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: #EB001B; border-radius: 50%;"></div>
                                    <div style="width: 14px; height: 14px; background: #F79E1B; border-radius: 50%; margin-left: -6px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2 (Middle) - Chase Blue -->
                    <div style="position: absolute; top: 20px; left: 30px; width: 240px; height: 150px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); transform: rotate(-4deg); z-index: 2; transition: transform 0.3s;">
                        <div style="padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; color: white;">
                            <div style="font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;">CHASE</div>
                            <div style="font-size: 0.9rem; letter-spacing: 0.1em;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-size: 0.7rem;">YOUR NAME</div>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: #EB001B; border-radius: 50%;"></div>
                                    <div style="width: 14px; height: 14px; background: #F79E1B; border-radius: 50%; margin-left: -6px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 3 (Front) - Capital One Dark -->
                    <div style="position: absolute; top: 40px; left: 60px; width: 240px; height: 150px; background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); border-radius: 12px; box-shadow: 0 12px 24px rgba(0,0,0,0.2); transform: rotate(2deg); z-index: 3; transition: transform 0.3s;">
                        <div style="padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; color: white;">
                            <div style="font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;">CAPITAL ONE</div>
                            <div style="font-size: 0.9rem; letter-spacing: 0.1em;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-size: 0.7rem;">VENTURE X</div>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: #EB001B; border-radius: 50%;"></div>
                                    <div style="width: 14px; height: 14px; background: #F79E1B; border-radius: 50%; margin-left: -6px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </a>
        {% empty %}
        <!-- Empty State -->
        <div style="text-align: center; padding: 4rem 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.3;"><span class="material-icons" style="font-size: 64px;">credit_card</span></div>
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.75rem;">No personalities yet</h2>
            <p style="color: var(--text-muted);">Check back soon!</p>
        </div>
        {% endfor %}
    </div>

    <!-- No Results State (Hidden by default) -->
    <div id="no-results" style="display: none; text-align: center; padding: 4rem 0;">
        <div style="font-size: 3rem; margin-bottom: 1rem;"><span class="material-icons" style="font-size: 48px;">search</span></div>
        <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">No personalities found</h3>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Try adjusting your search terms or take the quiz to
            find your match.</p>
    </div>
</section>

{% include 'cards/includes/card_modal.html' %}

<script>
    // Personalities data for quiz
    const personalities = {{ personalities_json|safe }};

    const questions = [
        {
            category: "travel",
            text: "How important are travel perks like flights, hotels, and lounge access?",
            icon: "‚úàÔ∏è"
        },
        {
            category: "dining",
            text: "How much do you value rewards on dining, takeout, and food delivery?",
            icon: "üçΩÔ∏è"
        },
        {
            category: "shopping",
            text: "How often do you shop for clothes, electronics, or everyday items?",
            icon: "üõçÔ∏è"
        },
        {
            category: "cashback",
            text: "Do you prefer simple cash back over complicated points systems?",
            icon: "üíµ"
        },
        {
            category: "luxury",
            text: "Are you willing to pay high annual fees for premium status and luxury benefits?",
            icon: "üíé"
        }
    ];

    let currentQuestion = 0;
    const userPreferences = {};

    const slider = document.getElementById('rating-slider');
    const ratingDisplay = document.getElementById('current-rating');

    slider.oninput = function() {
        ratingDisplay.textContent = this.value;
    }

    function loadQuestion() {
        const q = questions[currentQuestion];
        document.getElementById('question-text').innerHTML = `<span style="display:block; font-size: 3rem; margin-bottom: 1rem;">${q.icon}</span>${q.text}`;
        
        // Reset slider to middle
        slider.value = 3;
        ratingDisplay.textContent = 3;
    }

    function nextQuestion() {
        // Save answer
        const q = questions[currentQuestion];
        userPreferences[q.category] = parseInt(slider.value);

        currentQuestion++;

        if (currentQuestion < questions.length) {
            loadQuestion();
        } else {
            calculateResult();
        }
    }

    function calculateResult() {
        let bestMatch = null;
        let minDistance = Infinity;

        personalities.forEach(p => {
            let distance = 0;
            // Calculate Euclidean distance
            for (const [category, value] of Object.entries(userPreferences)) {
                const pValue = p.preferences[category] || 3; // Default to 3 if missing
                distance += Math.pow(value - pValue, 2);
            }
            distance = Math.sqrt(distance);

            if (distance < minDistance) {
                minDistance = distance;
                bestMatch = p;
            }
        });

        if (bestMatch) {
            // Redirect to personality detail page
            window.location.href = `/personalities/${bestMatch.id}/`;
        } else {
            // Fallback
            alert('No matching personality found. Please try again.');
            location.reload();
        }
    }

    // Load first question
    loadQuestion();
</script>

<style>
    .personality-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1) !important;
    }

    @media (max-width: 1024px) {
        #options-container {
            grid-template-columns: repeat(3, 1fr) !important;
        }
    }

    @media (max-width: 768px) {
        #options-container {
            grid-template-columns: 1fr !important;
        }

        .option-card {
            min-height: 140px !important;
            padding: 1.5rem 1rem !important;
        }
    }
</style>
{% endblock %}