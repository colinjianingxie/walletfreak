{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Personalities Header with Quiz -->
<section style="background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); padding: 4rem 0; text-align: center; color: white; position: relative; overflow: hidden;">
    <!-- Background decoration -->
    <div style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: rgba(124, 58, 237, 0.1); border-radius: 50%; filter: blur(80px);"></div>
    <div style="position: absolute; bottom: -100px; left: -100px; width: 300px; height: 300px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; filter: blur(80px);"></div>
    
    <div style="position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 0 1rem;">
        <!-- Badge -->
        <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 999px; margin-bottom: 1.5rem; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);">
            <span style="font-size: 1.1rem;"><span class="material-icons" style="font-size: 16px; vertical-align: middle;">auto_awesome</span></span>
            <span style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.1em;">Discover Your Financial DNA</span>
        </div>
        
        <!-- Title -->
        <h1 style="font-size: clamp(2.5rem, 5vw, 3.5rem); font-weight: 700; margin-bottom: 1rem; line-height: 1.2; color: white;">
            What's your <span style="background: linear-gradient(135deg, #A78BFA 0%, #C084FC 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Wallet Vibe?</span>
        </h1>
        
        <!-- Subtitle (hidden during quiz, shown on initial load) -->
        <p id="quiz-subtitle-text" style="font-size: 1.125rem; color: #94A3B8; max-width: 600px; margin: 0 auto 3rem;">
            Answer a few quick questions to discover your perfect credit card personality.
        </p>

        <!-- Quiz Container -->
        <div id="quiz-container" style="max-width: 750px; margin: 0 auto; background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(20px); border-radius: 20px; padding: 2.5rem 3rem; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <!-- Progress Header -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span id="question-counter" style="font-size: 0.75rem; font-weight: 700; letter-spacing: 0.1em; color: #94A3B8;">QUESTION 1 OF 4</span>
                    <span id="progress-percent" style="font-size: 0.75rem; font-weight: 700; letter-spacing: 0.1em; color: #94A3B8;">0% COMPLETE</span>
                </div>
                <!-- Progress Bar -->
                <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 999px; overflow: hidden;">
                    <div id="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3B82F6 0%, #8B5CF6 100%); border-radius: 999px; transition: width 0.5s ease;"></div>
                </div>
            </div>

            <!-- Question Text -->
            <h2 id="question-text" style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.75rem; color: white; line-height: 1.3;"></h2>
            <p id="question-subtitle" style="font-size: 0.9rem; color: #94A3B8; margin-bottom: 1.75rem;"></p>

            <!-- Options Container -->
            <div id="options-container" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.875rem; margin-bottom: 1.75rem;">
                <!-- Options will be dynamically inserted here -->
            </div>

            <!-- Navigation Buttons -->
            <div style="display: flex; gap: 1rem; justify-content: center; align-items: center;">
                <button id="back-btn" style="display: none; padding: 0.875rem 1.5rem; background: rgba(100, 116, 139, 0.3); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 1rem;" onclick="previousQuestion()">
                    ‚Üê Back
                </button>
                <button id="continue-btn" style="display: none; padding: 0.875rem 2rem; background: white; color: #1E293B; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 1rem;" onclick="nextQuestion()">
                    Continue ‚Üí
                </button>
            </div>
        </div>

        <!-- Loading Container (hidden initially) -->
        <div id="loading-container" style="display: none; max-width: 750px; margin: 0 auto; background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(20px); border-radius: 20px; padding: 4rem 3rem; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.3); text-align: center;">
            <!-- Spinner -->
            <div style="margin: 0 auto 2rem; width: 80px; height: 80px; border: 4px solid rgba(139, 92, 246, 0.2); border-top: 4px solid #8B5CF6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            
            <h2 id="loading-title" style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1rem; color: white;">Analyzing your preferences...</h2>
            <p id="loading-subtitle" style="font-size: 1rem; color: #94A3B8;">Crunching the multipliers</p>
        </div>

        <!-- Results Container (hidden initially) -->
        <div id="results-container" style="display: none; max-width: 750px; margin: 0 auto; background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(20px); border-radius: 20px; padding: 3.5rem 3rem; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.3); text-align: center;">
            <p style="font-size: 0.75rem; font-weight: 700; letter-spacing: 0.1em; color: #94A3B8; margin-bottom: 2rem;">YOUR VIBE IS</p>
            
            <!-- Personality Avatar -->
            <div style="margin: 0 auto 2rem; width: 160px; height: 160px; background: linear-gradient(135deg, #A855F7 0%, #C084FC 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 0 12px rgba(168, 85, 247, 0.2), 0 0 60px rgba(168, 85, 247, 0.4); position: relative;">
                <div id="result-icon" style="font-size: 5rem;"></div>
                <!-- Glow effect -->
                <div style="position: absolute; inset: -20px; background: radial-gradient(circle, rgba(168, 85, 247, 0.4) 0%, transparent 70%); filter: blur(20px); z-index: -1;"></div>
            </div>

            <h2 id="result-name" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1.5rem; color: white;"></h2>
            <p id="result-description" style="font-size: 1.125rem; color: #CBD5E1; max-width: 600px; margin: 0 auto 3rem; line-height: 1.6;"></p>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <a id="view-stack-btn" href="#" style="padding: 1rem 2rem; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); color: white; border: none; border-radius: 12px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);">
                    View Your Stack
                </a>
                <button onclick="resetQuiz()" style="padding: 1rem 2rem; background: rgba(100, 116, 139, 0.3); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s;">
                    <span class="material-icons" style="font-size: 18px;">refresh</span>
                    Start Over
                </button>
            </div>
        </div>
    </div>
</section>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .quiz-option {
        background: rgba(30, 41, 59, 0.4);
        border: 2px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 1.125rem 1.25rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.875rem;
        position: relative;
        overflow: hidden;
    }

    .quiz-option:hover {
        background: rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.4);
        transform: translateY(-2px);
    }

    .quiz-option.selected {
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .quiz-option .icon {
        font-size: 1.75rem;
        flex-shrink: 0;
    }

    .quiz-option .text {
        flex: 1;
        text-align: left;
        font-size: 0.9375rem;
        font-weight: 500;
        color: white;
    }

    .quiz-option .checkmark {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .quiz-option.selected .checkmark {
        display: flex;
    }

    #continue-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    #back-btn:hover {
        background: rgba(100, 116, 139, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    @media (max-width: 768px) {
        #options-container {
            grid-template-columns: 1fr !important;
        }
        
        .quiz-option {
            padding: 1.25rem;
        }
        
        .quiz-option .text {
            font-size: 0.9rem;
        }
    }
</style>

<!-- User's Assigned Personality (if exists) -->
{% if assigned_personality %}
<section class="container" style="padding: 2rem 0 1rem;">
    <div style="background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%); border-radius: 20px; padding: 2rem; border: 1px solid #E9D5FF; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15);">
        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 2rem; align-items: center;">
            <!-- Left: Icon -->
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #A855F7 0%, #9333EA 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: 0 8px 16px rgba(168, 85, 247, 0.3);">
                {{ assigned_personality.icon|default:"üéØ" }}
            </div>

            <!-- Middle: Info -->
            <div>
                <div style="font-size: 0.75rem; color: #7C3AED; font-weight: 700; letter-spacing: 0.1em; margin-bottom: 0.5rem; text-transform: uppercase;">
                    YOUR PERSONALITY
                </div>
                
                <h3 style="font-size: 1.75rem; font-weight: 800; margin: 0 0 0.5rem 0; color: #1F2937;">
                    {{ assigned_personality.name }}
                </h3>

                <p style="color: #64748B; line-height: 1.6; margin: 0; font-size: 0.9375rem; max-width: 600px;">
                    {{ assigned_personality.tagline }}
                </p>
            </div>

            <!-- Right: Action -->
            <a href="{% url 'personality_results' %}" style="padding: 1rem 1.5rem; background: white; color: #7C3AED; border: 2px solid #A855F7; border-radius: 12px; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; white-space: nowrap;">
                View Details
                <span class="material-icons" style="font-size: 18px;">arrow_forward</span>
            </a>
        </div>
    </div>
</section>
{% endif %}

<!-- Personalities Grid -->
<section class="container" style="padding: 4rem 0;">
    <div style="display: flex; flex-direction: column; gap: 2rem;" id="personalities-grid">
        {% for personality in personalities %}
        <a href="{% url 'personality_detail' personality.id %}" class="personality-card-link"
            style="text-decoration: none; color:inherit;" data-name="{{ personality.name|lower }}"
            data-desc="{{ personality.description|lower }}" data-tag="{{ personality.tagline|default:''|lower }}">
            <div style="background: white; border-radius: 20px; padding: 2.5rem; border: 1px solid #E5E7EB; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: all 0.3s; display: grid; grid-template-columns: auto 1fr auto; gap: 2rem; align-items: center;" class="personality-card">
                <!-- Left: Avatar -->
                <div style="width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex-shrink: 0; backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                    <img src="{% static 'img/personalities/'|add:personality.id|add:'.svg' %}" alt="{{ personality.name }}" style="width: 100%; height: 100%; object-fit: contain; padding: 15px;">
                </div>

                <!-- Middle: Info -->
                <div style="min-width: 0;">
                    <!-- Label -->
                    <div style="font-size: 0.75rem; color: #9CA3AF; font-weight: 600; letter-spacing: 0.1em; margin-bottom: 0.5rem; text-transform: uppercase;">
                        RECOMMENDED STACK
                    </div>
                    
                    <!-- Name -->
                    <h3 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 0.75rem 0; color: #1F2937;">
                        {{ personality.name }}
                    </h3>

                    <!-- Description -->
                    <p style="color: #64748B; line-height: 1.6; margin: 0 0 1rem 0; font-size: 0.9375rem;">
                        {{ personality.description|truncatewords:25 }}
                    </p>

                    <!-- Tags -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                        {% if personality.tagline %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em;">
                            #{{ personality.tagline|upper|truncatewords:2 }}
                        </span>
                        {% endif %}
                        <!-- Additional context tags based on personality type -->
                        {% if 'jetsetter' in personality.id|lower %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#TRAVEL</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#FLY</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#PLANE</span>
                        {% elif 'freak' in personality.id|lower or 'wallet freak' in personality.name|lower %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#CHURNING</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#MAXIMUM</span>
                        {% elif 'hunter' in personality.id|lower %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#CASHBACK</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#NOFEE</span>
                        {% endif %}
                    </div>

                    <!-- View Full Strategy Link (Moved Inside) -->
                    <a href="{% url 'personality_detail' personality.id %}" style="display: inline-flex; align-items: center; gap: 0.5rem; color: #6366F1; font-weight: 600; font-size: 0.9rem; text-decoration: none;">
                        View Full Strategy <span class="material-icons" style="font-size: 16px;">arrow_forward</span>
                    </a>
                </div>

                <!-- Right: Card Stack -->
                <div style="position: relative; width: 280px; height: 200px; flex-shrink: 0; cursor: pointer;" onclick="event.preventDefault(); openCardModal('{{ personality.recommended_cards.0 }}');">
                    <!-- Card 1 (Back) - Amex/Gray -->
                    <div style="position: absolute; top: 0; left: 0; width: 240px; height: 150px; background: linear-gradient(135deg, #8B9BA7 0%, #6B7B88 100%); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); transform: rotate(-8deg); z-index: 1; transition: transform 0.3s;">
                        <div style="padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; color: white;">
                            <div style="font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;">AMEX</div>
                            <div style="font-size: 0.9rem; letter-spacing: 0.1em;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1323</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-size: 0.7rem;">YOUR NAME</div>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: #EB001B; border-radius: 50%;"></div>
                                    <div style="width: 14px; height: 14px; background: #F79E1B; border-radius: 50%; margin-left: -6px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2 (Middle) - Chase Blue -->
                    <div style="position: absolute; top: 20px; left: 30px; width: 240px; height: 150px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); transform: rotate(-4deg); z-index: 2; transition: transform 0.3s;">
                        <div style="padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; color: white;">
                            <div style="font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;">CHASE</div>
                            <div style="font-size: 0.9rem; letter-spacing: 0.1em;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-size: 0.7rem;">YOUR NAME</div>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: #EB001B; border-radius: 50%;"></div>
                                    <div style="width: 14px; height: 14px; background: #F79E1B; border-radius: 50%; margin-left: -6px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 3 (Front) - Capital One Dark -->
                    <div style="position: absolute; top: 40px; left: 60px; width: 240px; height: 150px; background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); border-radius: 12px; box-shadow: 0 12px 24px rgba(0,0,0,0.2); transform: rotate(2deg); z-index: 3; transition: transform 0.3s;">
                        <div style="padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; color: white;">
                            <div style="font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;">CAPITAL ONE</div>
                            <div style="font-size: 0.9rem; letter-spacing: 0.1em;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-size: 0.7rem;">VENTURE X</div>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: #EB001B; border-radius: 50%;"></div>
                                    <div style="width: 14px; height: 14px; background: #F79E1B; border-radius: 50%; margin-left: -6px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </a>
        {% empty %}
        <!-- Empty State -->
        <div style="text-align: center; padding: 4rem 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.3;"><span class="material-icons" style="font-size: 64px;">credit_card</span></div>
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.75rem;">No personalities yet</h2>
            <p style="color: var(--text-muted);">Check back soon!</p>
        </div>
        {% endfor %}
    </div>

    <!-- No Results State (Hidden by default) -->
    <div id="no-results" style="display: none; text-align: center; padding: 4rem 0;">
        <div style="font-size: 3rem; margin-bottom: 1rem;"><span class="material-icons" style="font-size: 48px;">search</span></div>
        <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">No personalities found</h3>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Try adjusting your search terms or take the quiz to
            find your match.</p>
    </div>
</section>

{% include 'cards/includes/card_modal.html' %}

<script>
    // Personalities data for quiz
    const personalities = {{ personalities_json|safe }};

    const questions = [
        {
            id: 1,
            text: "What is your rewards endgame?",
            subtitle: "Select up to 3 priorities.",
            multiSelect: true,
            maxSelect: 3,
            category: "rewards",
            options: [
                { icon: "‚úàÔ∏è", text: "Free International Flights", value: "flights", weight: { travel: 2 } },
                { icon: "üíµ", text: "Cold Hard Cash Back", value: "cashback", weight: { cashback: 2 } },
                { icon: "‚òï", text: "Airport Lounge Access", value: "lounge", weight: { travel: 1, luxury: 1 } },
                { icon: "üè®", text: "Hotel/Airline Status", value: "status", weight: { travel: 2, luxury: 1 } },
                { icon: "üíº", text: "Business Expenses", value: "business", weight: { shopping: 1, cashback: 1 } },
                { icon: "üéÅ", text: "Sign-Up Bonuses", value: "bonuses", weight: { shopping: 1 } }
            ]
        },
        {
            id: 2,
            text: "Where does most of your money go?",
            subtitle: "Select all that apply.",
            multiSelect: true,
            maxSelect: 6,
            category: "spending",
            options: [
                { icon: "üçî", text: "Restaurants & Bars", value: "dining", weight: { dining: 2 } },
                { icon: "ü•¨", text: "Groceries", value: "groceries", weight: { cashback: 1 } },
                { icon: "‚úàÔ∏è", text: "Flights & Hotels", value: "travel", weight: { travel: 2 } },
                { icon: "üíª", text: "Online Ads / Software", value: "software", weight: { shopping: 1 } },
                { icon: "‚õΩ", text: "Gas / Commute", value: "gas", weight: { cashback: 1 } },
                { icon: "üõçÔ∏è", text: "Online Shopping", value: "shopping", weight: { shopping: 2 } }
            ]
        },
        {
            id: 3,
            text: "How do you feel about Annual Fees?",
            subtitle: "Pick the one that fits best.",
            multiSelect: false,
            category: "fees",
            options: [
                { icon: "üö´", text: "I refuse to pay them. ($0)", value: "no_fee", weight: { cashback: 2 } },
                { icon: "ü§∑", text: "I'm okay with moderate fees ($95ish).", value: "moderate", weight: { travel: 1, shopping: 1 } },
                { icon: "üß†", text: "I'll pay $695+ if the math works.", value: "premium", weight: { luxury: 2, travel: 1 } }
            ]
        },
        {
            id: 4,
            text: "Which of these sound like you?",
            subtitle: "Select all true statements.",
            multiSelect: true,
            maxSelect: 5,
            category: "personality",
            options: [
                { icon: "üìä", text: "I have a spreadsheet for my points.", value: "spreadsheet", weight: { luxury: 2 } },
                { icon: "üéØ", text: "I just want one card for everything.", value: "simple", weight: { cashback: 2 } },
                { icon: "üéÅ", text: "I open cards just for the bonus.", value: "churner", weight: { shopping: 2 } },
                { icon: "üíº", text: "I run a small business or side hustle.", value: "business", weight: { shopping: 1, cashback: 1 } },
                { icon: "üë∂", text: "I'm brand new to credit cards.", value: "beginner", weight: { cashback: 1 } }
            ]
        }
    ];

    let currentQuestion = 0;
    const userAnswers = {};
    const categoryScores = { travel: 0, dining: 0, shopping: 0, cashback: 0, luxury: 0 };

    function loadQuestion() {
        const q = questions[currentQuestion];
        const progress = (currentQuestion / questions.length) * 100;
        
        document.getElementById('question-counter').textContent = `QUESTION ${q.id} OF ${questions.length}`;
        document.getElementById('progress-percent').textContent = `${Math.round(progress)}% COMPLETE`;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('question-text').textContent = q.text;
        document.getElementById('question-subtitle').textContent = q.subtitle;
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        
        // Set grid columns based on number of options
        const cols = q.options.length === 3 ? '3' : '2';
        container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        
        q.options.forEach((option, idx) => {
            const div = document.createElement('div');
            div.className = 'quiz-option';
            div.dataset.value = option.value;
            div.innerHTML = `
                <span class="icon">${option.icon}</span>
                <span class="text">${option.text}</span>
                <div class="checkmark">
                    <span class="material-icons" style="font-size: 16px; color: #2563EB;">check</span>
                </div>
            `;
            
            div.onclick = () => selectOption(div, q.multiSelect, q.maxSelect || 1);
            container.appendChild(div);
        });
        
        // Hide Continue button initially
        document.getElementById('continue-btn').style.display = 'none';
        
        // Update button text for last question
        const btn = document.getElementById('continue-btn');
        btn.textContent = currentQuestion === questions.length - 1 ? 'Reveal Match ‚Üí' : 'Continue ‚Üí';
        
        // Show/hide back button
        const backBtn = document.getElementById('back-btn');
        if (currentQuestion > 0) {
            backBtn.style.display = 'block';
        } else {
            backBtn.style.display = 'none';
        }
    }

    function selectOption(element, multiSelect, maxSelect) {
        const container = document.getElementById('options-container');
        const selected = container.querySelectorAll('.quiz-option.selected');
        
        if (multiSelect) {
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
            } else {
                if (selected.length >= maxSelect) {
                    selected[0].classList.remove('selected');
                }
                element.classList.add('selected');
            }
        } else {
            selected.forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }
        
        // Show/hide continue button based on selection
        const hasSelection = container.querySelectorAll('.quiz-option.selected').length > 0;
        const continueBtn = document.getElementById('continue-btn');
        if (hasSelection) {
            continueBtn.style.display = 'block';
        } else {
            continueBtn.style.display = 'none';
        }
    }

    function nextQuestion() {
        const q = questions[currentQuestion];
        const container = document.getElementById('options-container');
        const selected = container.querySelectorAll('.quiz-option.selected');
        
        // Save answers and calculate scores
        const answers = Array.from(selected).map(el => el.dataset.value);
        userAnswers[q.category] = answers;
        
        // Update category scores
        selected.forEach(el => {
            const option = q.options.find(opt => opt.value === el.dataset.value);
            if (option && option.weight) {
                for (const [category, weight] of Object.entries(option.weight)) {
                    categoryScores[category] += weight;
                }
            }
        });
        
        currentQuestion++;
        
        if (currentQuestion < questions.length) {
            loadQuestion();
        } else {
            showLoading();
        }
    }

    function previousQuestion() {
        if (currentQuestion > 0) {
            // Revert category scores from current question
            const q = questions[currentQuestion - 1];
            if (userAnswers[q.category]) {
                userAnswers[q.category].forEach(answerValue => {
                    const option = q.options.find(opt => opt.value === answerValue);
                    if (option && option.weight) {
                        for (const [category, weight] of Object.entries(option.weight)) {
                            categoryScores[category] -= weight;
                        }
                    }
                });
            }
            
            currentQuestion--;
            loadQuestion();
            
            // Restore previous selections
            if (userAnswers[q.category]) {
                userAnswers[q.category].forEach(answerValue => {
                    const optionEl = document.querySelector(`[data-value="${answerValue}"]`);
                    if (optionEl) {
                        optionEl.classList.add('selected');
                    }
                });
                // Show continue button since we have selections
                document.getElementById('continue-btn').style.display = 'block';
            }
        }
    }

    function showLoading() {
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('loading-container').style.display = 'block';
        
        // Simulate loading with fun messages
        const messages = [
            { title: "Analyzing your preferences...", subtitle: "Crunching the multipliers" },
            { title: "Calculating your vibe...", subtitle: "Consulting the credit card oracle" },
            { title: "Finding your match...", subtitle: "Almost there!" }
        ];
        
        let msgIndex = 0;
        const interval = setInterval(() => {
            msgIndex++;
            if (msgIndex < messages.length) {
                document.getElementById('loading-title').textContent = messages[msgIndex].title;
                document.getElementById('loading-subtitle').textContent = messages[msgIndex].subtitle;
            }
        }, 1000);
        
        // Show results after 3 seconds
        setTimeout(() => {
            clearInterval(interval);
            calculateAndShowResults();
        }, 3000);
    }

    function calculateAndShowResults() {
        // Find best matching personality based on category scores
        let bestMatch = null;
        let minDistance = Infinity;
        
        personalities.forEach(p => {
            let distance = 0;
            for (const [category, score] of Object.entries(categoryScores)) {
                const pValue = p.preferences[category] || 3;
                distance += Math.pow(score - pValue, 2);
            }
            distance = Math.sqrt(distance);
            
            if (distance < minDistance) {
                minDistance = distance;
                bestMatch = p;
            }
        });
        
        // If no good match, use highest category score
        if (!bestMatch || minDistance > 10) {
            const maxCategory = Object.keys(categoryScores).reduce((a, b) => 
                categoryScores[a] > categoryScores[b] ? a : b
            );
            
            // Map categories to personality types
            const categoryMap = {
                travel: personalities.find(p => p.id.includes('jetsetter')) || personalities[0],
                luxury: personalities.find(p => p.id.includes('freak')) || personalities[0],
                cashback: personalities.find(p => p.id.includes('hunter')) || personalities[0],
                shopping: personalities.find(p => p.id.includes('optimizer')) || personalities[0],
                dining: personalities.find(p => p.id.includes('foodie')) || personalities[0]
            };
            
            bestMatch = categoryMap[maxCategory] || personalities[0];
        }
        
        showResults(bestMatch);
    }

    function showResults(personality) {
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';
        
        // Update progress to 100%
        document.getElementById('progress-bar').style.width = '100%';
        
        // Display personality info
        const iconImg = personality.icon || 'üéØ';
        document.getElementById('result-icon').textContent = iconImg;
        document.getElementById('result-name').textContent = personality.name;
        document.getElementById('result-description').textContent = personality.description;
        document.getElementById('view-stack-btn').href = `/personalities/${personality.id}/`;
    }

    function resetQuiz() {
        currentQuestion = 0;
        Object.keys(categoryScores).forEach(key => categoryScores[key] = 0);
        Object.keys(userAnswers).forEach(key => delete userAnswers[key]);
        
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'block';
        
        loadQuestion();
    }

    // Load first question on page load
    loadQuestion();
</script>

<style>
    .personality-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1) !important;
    }

    @media (max-width: 1024px) {
        #options-container {
            grid-template-columns: repeat(3, 1fr) !important;
        }
    }

    @media (max-width: 768px) {
        #options-container {
            grid-template-columns: 1fr !important;
        }

        .option-card {
            min-height: 140px !important;
            padding: 1.5rem 1rem !important;
        }
    }
</style>
{% endblock %}