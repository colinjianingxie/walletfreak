{% extends 'base.html' %}

{% block content %}
<!-- Personalities Header with Quiz -->
<section style="background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); padding: 4rem 0; text-align: center; color: white; position: relative; overflow: hidden;">
    <!-- Background decoration -->
    <div style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: rgba(124, 58, 237, 0.1); border-radius: 50%; filter: blur(80px);"></div>
    <div style="position: absolute; bottom: -100px; left: -100px; width: 300px; height: 300px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; filter: blur(80px);"></div>
    
    <div class="container" style="position: relative; z-index: 1;">
        <!-- Badge -->
        <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 999px; margin-bottom: 1.5rem; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);">
            <span style="font-size: 1.1rem;">‚ú®</span>
            <span style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.1em;">Discover Your Financial DNA</span>
        </div>
        
        <!-- Title -->
        <h1 style="font-size: clamp(2.5rem, 5vw, 3.5rem); font-weight: 700; margin-bottom: 1rem; line-height: 1.2;">
            What's your <span style="background: linear-gradient(135deg, #A78BFA 0%, #C084FC 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Wallet Vibe?</span>
        </h1>
        
        <!-- Subtitle -->
        <p style="font-size: 1.125rem; color: #94A3B8; max-width: 600px; margin: 0 auto 3rem;">
            Click the statement that sounds most like you.
        </p>

        <!-- Quiz Container -->
        <div id="quiz-container" style="max-width: 1200px; margin: 0 auto;">
            <!-- Question Text -->
            <h2 id="question-text" style="font-size: 1.25rem; font-weight: 500; margin-bottom: 2.5rem; color: rgba(255,255,255,0.9); line-height: 1.4;"></h2>

            <!-- Options Container - 5 Cards in a Row -->
            <div id="options-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 3rem;">
                <!-- Options will be injected here -->
            </div>

            <!-- Next Button -->
            <button id="next-btn" class="btn" style="display: none; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1rem 3rem; font-size: 1.1rem; font-weight: 600; box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4); border: none;" onclick="nextQuestion()">
                Continue ‚Üí
            </button>
        </div>
    </div>
</section>

<style>
    .quiz-card:hover {
        background: rgba(255,255,255,0.1) !important;
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .quiz-card-highlight:hover {
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%) !important;
        box-shadow: 0 12px 24px rgba(124, 58, 237, 0.4) !important;
    }
</style>

<!-- Personalities Grid -->
<section class="container" style="padding: 4rem 0;">
    <div style="display: flex; flex-direction: column; gap: 2rem;" id="personalities-grid">
        {% for personality in personalities %}
        <a href="{% url 'personality_detail' personality.id %}" class="personality-card-link"
            style="text-decoration: none; color:inherit;" data-name="{{ personality.name|lower }}"
            data-desc="{{ personality.description|lower }}" data-tag="{{ personality.tagline|default:''|lower }}">
            <div style="background: white; border-radius: 20px; padding: 2.5rem; border: 1px solid #E5E7EB; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: all 0.3s; display: grid; grid-template-columns: auto 1fr auto; gap: 2rem; align-items: center;" class="personality-card">
                <!-- Left: Avatar -->
                <div style="width: 100px; height: 100px; background: linear-gradient(135deg, {% if 'jetsetter' in personality.id|lower %}#06B6D4{% elif 'freak' in personality.id|lower or 'wallet freak' in personality.name|lower %}#A855F7{% elif 'minimalist' in personality.id|lower or 'hunter' in personality.id|lower %}#10B981{% else %}#F59E0B{% endif %} 0%, {% if 'jetsetter' in personality.id|lower %}#0EA5E9{% elif 'freak' in personality.id|lower or 'wallet freak' in personality.name|lower %}#9333EA{% elif 'minimalist' in personality.id|lower or 'hunter' in personality.id|lower %}#059669{% else %}#D97706{% endif %} 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex-shrink: 0;">
                    {% if 'jetsetter' in personality.id|lower %}‚úàÔ∏è
                    {% elif 'freak' in personality.id|lower or 'wallet freak' in personality.name|lower %}ü§ì
                    {% elif 'minimalist' in personality.id|lower %}üíµ
                    {% elif 'foodie' in personality.id|lower %}üçΩÔ∏è
                    {% elif 'hunter' in personality.id|lower %}üéØ
                    {% elif 'strategist' in personality.id|lower or 'optimizer' in personality.id|lower %}üìä
                    {% else %}üí≥{% endif %}
                </div>

                <!-- Middle: Info -->
                <div style="min-width: 0;">
                    <!-- Label -->
                    <div style="font-size: 0.75rem; color: #9CA3AF; font-weight: 600; letter-spacing: 0.1em; margin-bottom: 0.5rem; text-transform: uppercase;">
                        RECOMMENDED STACK
                    </div>
                    
                    <!-- Name -->
                    <h3 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 0.75rem 0; color: #1F2937;">
                        {{ personality.name }}
                    </h3>

                    <!-- Description -->
                    <p style="color: #64748B; line-height: 1.6; margin: 0 0 1rem 0; font-size: 0.9375rem;">
                        {{ personality.description|truncatewords:25 }}
                    </p>

                    <!-- Tags -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        {% if personality.tagline %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em;">
                            #{{ personality.tagline|upper|truncatewords:2 }}
                        </span>
                        {% endif %}
                        <!-- Additional context tags based on personality type -->
                        {% if 'jetsetter' in personality.id|lower %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#TRAVEL</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#FLY</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#PLANE</span>
                        {% elif 'freak' in personality.id|lower or 'wallet freak' in personality.name|lower %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#CHURNING</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#MAXIMUM</span>
                        {% elif 'hunter' in personality.id|lower %}
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#CASHBACK</span>
                        <span style="background: #F3F4F6; color: #6366F1; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 6px;">#NOFEE</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Right: Card Stack -->
                <div style="position: relative; width: 280px; height: 200px; flex-shrink: 0;">
                    <!-- Card 1 (Back) - Amex/Gray -->
                    <div style="position: absolute; top: 0; left: 0; width: 240px; height: 150px; background: linear-gradient(135deg, #8B9BA7 0%, #6B7B88 100%); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); transform: rotate(-8deg); z-index: 1;">
                        <div style="padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; color: white;">
                            <div style="font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;">AMEX</div>
                            <div style="font-size: 0.9rem; letter-spacing: 0.1em;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1323</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-size: 0.7rem;">YOUR NAME</div>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: #EB001B; border-radius: 50%;"></div>
                                    <div style="width: 14px; height: 14px; background: #F79E1B; border-radius: 50%; margin-left: -6px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 2 (Middle) - Chase Blue -->
                    <div style="position: absolute; top: 20px; left: 30px; width: 240px; height: 150px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); transform: rotate(-4deg); z-index: 2;">
                        <div style="padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; color: white;">
                            <div style="font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;">CHASE</div>
                            <div style="font-size: 0.9rem; letter-spacing: 0.1em;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-size: 0.7rem;">YOUR NAME</div>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: #EB001B; border-radius: 50%;"></div>
                                    <div style="width: 14px; height: 14px; background: #F79E1B; border-radius: 50%; margin-left: -6px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 3 (Front) - Capital One Dark -->
                    <div style="position: absolute; top: 40px; left: 60px; width: 240px; height: 150px; background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); border-radius: 12px; box-shadow: 0 12px 24px rgba(0,0,0,0.2); transform: rotate(2deg); z-index: 3;">
                        <div style="padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; color: white;">
                            <div style="font-size: 0.7rem; font-weight: 600; letter-spacing: 0.1em;">CAPITAL ONE</div>
                            <div style="font-size: 0.9rem; letter-spacing: 0.1em;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-size: 0.7rem;">VENTURE X</div>
                                <div style="display: flex; gap: 2px;">
                                    <div style="width: 14px; height: 14px; background: #EB001B; border-radius: 50%;"></div>
                                    <div style="width: 14px; height: 14px; background: #F79E1B; border-radius: 50%; margin-left: -6px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- View Full Strategy Link -->
            <div style="text-align: right; margin-top: 1rem;">
                <span style="color: #6366F1; font-weight: 600; font-size: 0.9rem;">View Full Strategy ‚Üí</span>
            </div>
        </a>
        {% empty %}
        <!-- Empty State -->
        <div style="text-align: center; padding: 4rem 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.3;">üí≥</div>
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.75rem;">No personalities yet</h2>
            <p style="color: var(--text-muted);">Check back soon!</p>
        </div>
        {% endfor %}
    </div>

    <!-- No Results State (Hidden by default) -->
    <div id="no-results" style="display: none; text-align: center; padding: 4rem 0;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
        <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">No personalities found</h3>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Try adjusting your search terms or take the quiz to
            find your match.</p>
        <a href="{% url 'quiz' %}" class="btn btn-primary">Take the Quiz</a>
    </div>
</section>

<script>
    // Get personalities data from Django template
    const personalities = {{ personalities_json|safe }};
    
    // Create a mapping from quiz types to actual personality IDs
    const personalityMapping = {};
    personalities.forEach(p => {
        const name = p.name.toLowerCase();
        const desc = (p.description || '').toLowerCase();
        const tagline = (p.tagline || '').toLowerCase();
        
        // Map based on keywords in personality data
        if (name.includes('jetsetter') || name.includes('travel') || desc.includes('travel') || desc.includes('flight')) {
            personalityMapping['jetsetter'] = p.id;
        }
        if (name.includes('minimalist') || name.includes('cash') || desc.includes('cash back') || tagline.includes('simple')) {
            personalityMapping['minimalist'] = p.id;
        }
        if (name.includes('foodie') || name.includes('dining') || desc.includes('dining') || desc.includes('restaurant')) {
            personalityMapping['foodie'] = p.id;
        }
        if (name.includes('strategist') || name.includes('optimizer') || name.includes('maximize') || desc.includes('optimize')) {
            personalityMapping['strategist'] = p.id;
            personalityMapping['optimizer'] = p.id;
        }
        // Fallback: use first personality as default
        if (!personalityMapping['default']) {
            personalityMapping['default'] = p.id;
        }
    });
    
    // Quiz functionality
    const questions = [
        {
            question: "What describes you best when it comes to credit cards? (Select all that apply)",
            options: [
                { text: "I live for free flights & lounges", icon: "‚úàÔ∏è", type: "jetsetter" },
                { text: "Cash is king. Fees are evil.", icon: "üíµ", type: "minimalist" },
                { text: "Dining out & VIP events", icon: "üçΩÔ∏è", type: "foodie" },
                { text: "Maximize ROI. Optimize everything", icon: "üìä", type: "strategist" },
                { text: "I have a spreadsheet for everything", icon: "‚ö°", type: "optimizer" }
            ]
        },
        {
            question: "How do you feel about annual fees? (Select all that apply)",
            options: [
                { text: "Worth it for premium travel perks", icon: "‚úàÔ∏è", type: "jetsetter" },
                { text: "I avoid them at all costs", icon: "üö´", type: "minimalist" },
                { text: "Fine if dining credits offset the cost", icon: "üçΩÔ∏è", type: "foodie" },
                { text: "I calculate the exact ROI", icon: "üìä", type: "strategist" },
                { text: "I track every dollar of value", icon: "‚ö°", type: "optimizer" }
            ]
        },
        {
            question: "What's your biggest spending category? (Select all that apply)",
            options: [
                { text: "Travel: flights, hotels, experiences", icon: "‚úàÔ∏è", type: "jetsetter" },
                { text: "Essentials: groceries and gas", icon: "üõí", type: "minimalist" },
                { text: "Restaurants and food delivery", icon: "üçΩÔ∏è", type: "foodie" },
                { text: "Everything - I optimize by category", icon: "üìä", type: "strategist" },
                { text: "I diversify across multiple cards", icon: "‚ö°", type: "optimizer" }
            ]
        }
    ];

    let currentQuestion = 0;
    const scores = {};
    const selectedOptions = new Set();

    function loadQuestion() {
        const q = questions[currentQuestion];
        document.getElementById('question-text').innerText = q.question;
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        document.getElementById('next-btn').style.display = 'none';
        selectedOptions.clear();

        q.options.forEach((opt, index) => {
            const optionCard = document.createElement('div');
            optionCard.className = 'option-card';
            optionCard.dataset.value = opt.type;
            optionCard.style.cssText = `
                background: rgba(255,255,255,0.05);
                border: 2px solid rgba(255,255,255,0.1);
                border-radius: 16px;
                padding: 2rem 1rem;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                min-height: 180px;
            `;

            const iconSpan = document.createElement('div');
            iconSpan.style.cssText = `
                font-size: 3rem;
                margin-bottom: 1rem;
            `;
            iconSpan.textContent = opt.icon;

            const textSpan = document.createElement('div');
            textSpan.style.cssText = `
                color: white;
                font-size: 0.95rem;
                font-weight: 500;
                line-height: 1.4;
            `;
            textSpan.textContent = opt.text;

            optionCard.appendChild(iconSpan);
            optionCard.appendChild(textSpan);

            // Click handler for multiple selection
            optionCard.onclick = () => {
                const isSelected = optionCard.classList.contains('selected');
                
                if (isSelected) {
                    // Deselect
                    optionCard.classList.remove('selected');
                    optionCard.style.background = 'rgba(255,255,255,0.05)';
                    optionCard.style.borderColor = 'rgba(255,255,255,0.1)';
                    optionCard.style.transform = 'scale(1)';
                    optionCard.style.boxShadow = 'none';
                    selectedOptions.delete(opt.type);
                } else {
                    // Select
                    optionCard.classList.add('selected');
                    optionCard.style.background = 'linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.3))';
                    optionCard.style.borderColor = '#8b5cf6';
                    optionCard.style.transform = 'scale(1.05)';
                    optionCard.style.boxShadow = '0 8px 24px rgba(139, 92, 246, 0.4)';
                    selectedOptions.add(opt.type);
                }

                // Show next button if at least one option is selected
                if (selectedOptions.size > 0) {
                    document.getElementById('next-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('next-btn').style.display = 'none';
                }
            };

            optionsContainer.appendChild(optionCard);
        });
    }

    function nextQuestion() {
        // Collect all selected answers
        selectedOptions.forEach(type => {
            scores[type] = (scores[type] || 0) + 1;
        });

        currentQuestion++;

        if (currentQuestion < questions.length) {
            loadQuestion();
        } else {
            // Calculate personality
            let maxScore = 0;
            let personality = 'jetsetter'; // default

            for (const [type, score] of Object.entries(scores)) {
                if (score > maxScore) {
                    maxScore = score;
                    personality = type;
                }
            }

            // Map quiz result to actual personality ID
            const actualPersonalityId = personalityMapping[personality] || personalityMapping['default'] || personalities[0]?.id;
            
            if (actualPersonalityId) {
                // Redirect to personality detail page with correct URL
                window.location.href = `/personalities/${actualPersonalityId}/`;
            } else {
                // No personalities available, stay on page
                alert('No personalities available yet. Please check back later!');
                location.reload();
            }
        }
    }

    // Load first question on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadQuestion();
    });

    // Search functionality (if search input exists)
    const searchInput = document.getElementById('personality-search');
    if (searchInput) {
        searchInput.addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.personality-card-link');
            let hasVisible = false;

            cards.forEach(card => {
                const name = card.dataset.name;
                const desc = card.dataset.desc;
                const tag = card.dataset.tag;

                if (name.includes(searchTerm) || desc.includes(searchTerm) || tag.includes(searchTerm)) {
                    card.style.display = 'block';
                    hasVisible = true;
                } else {
                    card.style.display = 'none';
                }
            });

            const noResults = document.getElementById('no-results');
            const grid = document.getElementById('personalities-grid');

            if (!hasVisible && cards.length > 0) {
                noResults.style.display = 'block';
                grid.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                grid.style.display = 'grid';
            }
        });
    }
</script>

<style>
    .personality-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1) !important;
    }

    @media (max-width: 1024px) {
        #options-container {
            grid-template-columns: repeat(3, 1fr) !important;
        }
    }

    @media (max-width: 768px) {
        #options-container {
            grid-template-columns: 1fr !important;
        }

        .option-card {
            min-height: 140px !important;
            padding: 1.5rem 1rem !important;
        }
    }
</style>
{% endblock %}