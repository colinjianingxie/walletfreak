{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/personality_detail.css' %}">
<link rel="stylesheet" href="{% static 'css/card_modal.css' %}">
{% endblock %}

{% block main_style %}padding: 0; background: #F8FAFC;{% endblock %}

{% block full_width_content %}
<!-- Hero Section -->
<section class="personality-hero">
    <div class="container">
        <a href="{% url 'personality_list' %}" class="personality-back-link">
            <span class="material-icons personality-back-icon">arrow_back</span>
            Back to Archetypes
        </a>

        <div class="personality-content-grid">
            <div class="personality-avatar-large">
                <img src="{% static 'images/personalities/'|add:personality.slug|add:'.png' %}" alt="{{ personality.name }}" class="personality-avatar-img">
            </div>

            <div>
                <div class="personality-tagline-pill">
                    {{ personality.tagline|default:"FINANCIAL STRATEGY" }}
                </div>
                <h1 class="personality-title">{{ personality.name }}</h1>
                <p class="personality-description">{{ personality.description }}</p>
            </div>
        </div>
    </div>
</section>

<!-- Stats Cards -->
<div class="container stats-cards-container">
    <div class="grid stats-grid">
        <!-- Annual Fees -->
        <div class="stats-card">
            <div class="stats-card-label">
                <span class="material-icons stats-icon-base stats-icon-warning">warning</span>
                ANNUAL FEES
            </div>
            <div id="metric-annual-fees" class="stats-card-value stats-value-base">
                -$0
            </div>
        </div>

        <!-- Credit Value -->
        <div class="stats-card">
            <div class="stats-card-label">
                <span class="material-icons stats-icon-base stats-icon-verified">verified_user</span>
                CREDIT VALUE
            </div>
            <div id="metric-credit-value" class="stats-card-value stats-value-base">
                +$0
            </div>
        </div>

        <!-- Points Value -->
        <div class="stats-card">
            <div class="stats-card-label">
                POINTS/MILES
            </div>
            <div id="metric-points-value" class="stats-card-value stats-value-base">
                +$0
            </div>
        </div>

        <!-- Net Value -->
        <div class="stats-card dark">
            <div class="stats-card-label">
                <span class="material-icons stats-icon-base stats-icon-success">emoji_events</span>
                NET VALUE
            </div>
            <div id="metric-net-value" class="stats-card-value stats-value-success">
                +$0
            </div>
        </div>
    </div>
</div>

<!-- Build Your Loadout -->
<div class="container loadout-section">
    <div class="loadout-header">
        <span class="material-icons loadout-icon">bolt</span>
        <h2 class="loadout-title">Build Your Loadout</h2>
    </div>

    {% if personality.slots %}
    <div class="loadout-grid">
        {% for slot in personality.slots %}
        <div class="personality-slot-container slot-container">
            <!-- Slot Info -->
            <div class="slot-info-wrapper">
                {% if slot.hydrated_cards|length > 1 %}
                <!-- Navigation Buttons (Corners) -->
                <div class="carousel-btn prev slot-nav-btn slot-nav-prev" onclick="changeCard({{ forloop.counter }}, -1)">
                    <span class="material-icons">chevron_left</span>
                </div>
                <div class="carousel-btn next slot-nav-btn slot-nav-next" onclick="changeCard({{ forloop.counter }}, 1)">
                    <span class="material-icons">chevron_right</span>
                </div>
                {% endif %}

                <div class="slot-text-content">
                    <div class="slot-badge">
                        SLOT {{ forloop.counter }}
                    </div>
                    <h3 class="slot-title-text">{{ slot.name }}</h3>
                    <p class="slot-description-text">{{ slot.description }}</p>
                </div>
            </div>

            <!-- Cards in Slot (Carousel) -->
            <div class="slot-carousel" id="carousel-slot-{{ forloop.counter }}">
                <div class="carousel-track {% if slot.hydrated_cards|length > 3 %}align-start{% endif %}">
                    {% for card in slot.hydrated_cards %}
                    <div class="card-option slot-card-{{ forloop.parentloop.counter }} {% if not forloop.first %}slot-card-hidden{% endif %}" 
                        data-id="{{ card.id }}"
                        data-fee="{{ card.annual_fee|default:0 }}"
                        data-bonus-value="{{ card.sign_up_bonus.value|default:0 }}"
                        data-bonus-currency="{{ card.sign_up_bonus.currency|default:'points' }}"
                        data-slot="{{ forloop.parentloop.counter }}"
                        data-index="{{ forloop.counter0 }}"
                        onclick="toggleCardSelection(this, {{ forloop.parentloop.counter }})"
                        style="cursor: pointer; transition: transform 0.2s;">
                        
                        <!-- Info Icon -->
                        <div class="card-info-btn" onclick="event.stopPropagation(); openCardModal('{{ card.id }}')">
                            <span class="material-icons">info_outline</span>
                        </div>


                        <!-- Card Visual -->
                        {% if card.local_image %}
                        <div class="credit-card card-visual-wrapper">
                            <img src="{% static card.local_image %}" alt="{{ card.name }}" class="card-img-cover" onerror="this.onerror=null; this.src='{{ card.image_url }}';">
                            
                            <!-- Selection Indicator (Overlay) -->
                            <div class="selection-indicator selection-indicator-overlay">
                                <span class="material-icons status-icon status-icon-active">add</span>
                            </div>
                        </div>
                        {% elif card.image_url %}
                        <div class="credit-card card-visual-wrapper">
                            <img src="{{ card.image_url }}" alt="{{ card.name }}" class="card-img-cover">
                            
                            <!-- Selection Indicator (Overlay) -->
                            <div class="selection-indicator selection-indicator-overlay">
                                <span class="material-icons status-icon status-icon-active">add</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="credit-card {% if 'american express' in card.name|lower or 'amex' in card.name|lower %}{% if 'platinum' in card.name|lower %}card-amex-platinum{% elif 'gold' in card.name|lower %}card-gold{% else %}card-chase{% endif %}{% elif 'chase' in card.name|lower %}card-chase{% elif 'capital one' in card.name|lower %}card-capital-one{% elif 'citi' in card.name|lower %}card-citi{% else %}card-chase{% endif %}" style="position: relative;">
                            
                            <!-- Selection Indicator (Moved Inside) -->
                            <div class="selection-indicator selection-indicator-internal">
                                <span class="material-icons status-icon status-icon-light">add</span>
                            </div>

                            <div class="card-visual-header">
                                <!-- Icons are absolutely positioned -->
                            </div>
                            
                            <div class="credit-card-chip"></div>
                            
                            <div class="credit-card-number">
                                â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242
                            </div>
                            
                                <div class="card-visual-footer">
                                    <div>
                                        <!-- Strategy label removed -->
                                    </div>
                                    <div class="logo-circle-placeholder"></div>
                                </div>
                        </div>
                        {% endif %}

                        <!-- Card Metadata (Below) -->
                        <div class="card-meta-container">
                            <div class="card-name-meta">{{ card.name }}</div>
                            <div class="card-details-meta">
                                <span class="text-slate-400">${{ card.annual_fee|default:0 }}</span>
                                <span class="meta-separator">â€¢</span>
                                <span class="text-blue-500">{{ card.categories.0|default:'CREDIT' }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination Dots -->
                {% if slot.hydrated_cards|length > 1 %}
                <div class="pagination-dots" id="dots-slot-{{ forloop.counter }}">
                    {% for card in slot.hydrated_cards %}
                    <div class="pagination-dot {% if forloop.first %}active{% endif %}"></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-loadout-state">
        <div class="empty-loadout-icon">ðŸ’³</div>
        <h3 class="empty-loadout-title">No loadout defined</h3>
        <p class="empty-loadout-text">We're still building out card recommendations for this personality.</p>
    </div>
    {% endif %}
</div>

<!-- Rules of Engagement Section -->
{% if personality.rules %}
<section class="container rules-section">
    <div class="rules-container">
        <h2 class="rules-title">
            Rules of Engagement
        </h2>

        <div class="rules-grid">
            {% for rule in personality.rules %}
            <div class="rule-item">
                <div class="rule-number">
                    {{ forloop.counter }}
                </div>
                <div class="rule-content">
                    <h3>{{ rule.title }}</h3>
                    <p>{{ rule.description }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- CTA Section -->
<section class="cta-section">
    <!-- Background decoration -->
    <div class="cta-blob-1"></div>
    <div class="cta-blob-2"></div>
    
    <div class="container cta-content">
        <h2 class="cta-title">
            Ready to build this setup?
        </h2>
        <p class="cta-text">
            Track these cards, manage your fees, and calculate your net worth with WalletFreak.
        </p>
        <a href="{% url 'dashboard' %}" class="cta-btn">
            Start My Wallet
        </a>
    </div>
</section>

<script>
    // Initialize allCardsData for shared modal
    const allCardsData = {{ cards_json|safe }};
    const walletCardIds = new Set({{ wallet_card_ids|safe|default:'[]' }});
    const userMatchScores = {{ user_match_scores|safe|default:'{}' }};
</script>
<script src="{% static 'js/personality_detail.js' %}"></script>

{% include 'cards/includes/card_modal.html' %}
{% endblock %}