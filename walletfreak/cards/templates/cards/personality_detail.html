{% extends 'base.html' %}
{% load static %}

{% block extra_css %}

<link rel="stylesheet" href="{% static 'css/personality_detail.css' %}">
{% endblock %}

{% block main_style %}padding: 0; background: #F8FAFC;{% endblock %}

{% block full_width_content %}
<!-- Hero Section -->
<section class="personality-hero">
    <div class="container">
        <a href="{% url 'personality_list' %}" class="personality-back-link">
            <span class="material-icons" style="font-size: 16px;">arrow_back</span>
            Back to Archetypes
        </a>

        <div class="personality-content-grid">
            <div class="personality-avatar-large">
                <img src="{% static 'images/personalities/'|add:personality.slug|add:'.png' %}" alt="{{ personality.name }}" style="width: 60%; height: 60%; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2));">
            </div>

            <div>
                <div class="personality-tagline-pill">
                    CHASE ECOSYSTEM â€¢ HYATT TRANSFERS
                </div>
                <h1 class="personality-title">{{ personality.name }}</h1>
                <p class="personality-description">{{ personality.description }}</p>
            </div>
        </div>
    </div>
</section>

<!-- Stats Cards -->
<div class="container stats-cards-container">
    <div class="grid stats-grid">
        <!-- Annual Fees -->
        <div class="stats-card">
            <div class="stats-card-label">
                <span class="material-icons" style="font-size: 16px; color: #ef4444;">warning</span>
                ANNUAL FEES
            </div>
            <div id="metric-annual-fees" class="stats-card-value" style="color: #1e293b;">
                -$550
            </div>
        </div>

        <!-- Credit Value -->
        <div class="stats-card">
            <div class="stats-card-label">
                <span class="material-icons" style="font-size: 16px; color: #3b82f6;">verified_user</span>
                CREDIT VALUE
            </div>
            <div id="metric-credit-value" class="stats-card-value" style="color: #1e293b;">
                +$300
            </div>
        </div>

        <!-- Points Value -->
        <div class="stats-card">
            <div class="stats-card-label">
                <span class="material-icons" style="font-size: 16px; color: #8b5cf6;">trending_up</span>
                POINTS VALUE
            </div>
            <div id="metric-points-value" class="stats-card-value" style="color: #1e293b;">
                +$1200
            </div>
        </div>

        <!-- Net Value -->
        <div class="stats-card dark">
            <div class="stats-card-label">
                <span class="material-icons" style="font-size: 16px; color: #10b981;">emoji_events</span>
                NET VALUE
            </div>
            <div id="metric-net-value" class="stats-card-value" style="color: #10b981;">
                +$950
            </div>
        </div>
    </div>
</div>

<!-- Build Your Loadout -->
<div class="container" style="padding-bottom: 6rem;">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem;">
        <span class="material-icons" style="color: #2563eb; font-size: 28px;">bolt</span>
        <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0; color: #0f172a;">Build Your Loadout</h2>
    </div>

    {% if personality.slots %}
    <div style="display: grid; gap: 2rem;">
        {% for slot in personality.slots %}
        <div class="personality-slot-container" style="background: white; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
            <!-- Slot Info -->
            <div style="margin-bottom: 2rem;">
                <div style="display: inline-block; background: #f1f5f9; color: #64748b; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                    SLOT {{ forloop.counter }}
                </div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: #0f172a;">{{ slot.name }}</h3>
                <p style="color: #64748b; line-height: 1.6;">{{ slot.description }}</p>
            </div>

            <!-- Cards in Slot (Carousel) -->
            <div class="slot-carousel" id="carousel-slot-{{ forloop.counter }}">
                <!-- Navigation Buttons (only for JS) -->
                {% if slot.hydrated_cards|length > 1 %}
                <div class="carousel-btn prev" onclick="changeCard({{ forloop.counter }}, -1)">
                    <span class="material-icons">chevron_left</span>
                </div>
                <div class="carousel-btn next" onclick="changeCard({{ forloop.counter }}, 1)">
                    <span class="material-icons">chevron_right</span>
                </div>
                {% endif %}

                <div class="carousel-track" style="display: flex; overflow: hidden; justify-content: center; width: 100%;">
                    {% for card in slot.hydrated_cards %}
                    <div class="card-option" 
                        data-id="{{ card.id }}"
                        data-fee="{{ card.annual_fee|default:0 }}"
                        data-bonus-value="{{ card.sign_up_bonus.value|default:0 }}"
                        data-bonus-currency="{{ card.sign_up_bonus.currency|default:'points' }}"
                        data-slot="{{ forloop.parentloop.counter }}"
                        data-index="{{ forloop.counter0 }}"
                        onclick="toggleCardSelection(this, {{ forloop.parentloop.counter }})"
                        style="position: relative; width: 340px; flex-shrink: 0; cursor: pointer; transition: transform 0.2s; {% if not forloop.first %}display: none;{% endif %}"
                        class="slot-card-{{ forloop.parentloop.counter }}">
                        
                        <!-- Info Icon -->
                        <div style="position: absolute; top: 1rem; left: 1rem; z-index: 10; opacity: 0.8; transition: opacity 0.2s;" onclick="event.stopPropagation(); openCardModal('{{ card.id }}')">
                            <span class="material-icons" style="font-size: 24px; color: white;">info_outline</span>
                        </div>

                        <!-- Card Visual -->
                        <div class="credit-card {% if 'american express' in card.name|lower or 'amex' in card.name|lower %}{% if 'platinum' in card.name|lower %}card-amex-platinum{% elif 'gold' in card.name|lower %}card-gold{% else %}card-chase{% endif %}{% elif 'chase' in card.name|lower %}card-chase{% elif 'capital one' in card.name|lower %}card-capital-one{% elif 'citi' in card.name|lower %}card-citi{% else %}card-chase{% endif %}" style="position: relative;">
                            
                            <!-- Selection Indicator (Moved Inside) -->
                            <div class="selection-indicator" style="position: absolute; top: 1rem; right: 1rem; width: 28px; height: 28px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; border: 1px solid rgba(255,255,255,0.4); transition: all 0.2s;">
                                <span class="material-icons status-icon" style="font-size: 18px; color: white;">add</span>
                            </div>

                            <div style="display: flex; justify-content: flex-end; align-items: flex-start; margin-bottom: 1rem; height: 24px;">
                                <!-- Icons are absolutely positioned -->
                            </div>
                            
                            <div class="credit-card-chip"></div>
                            
                            <div class="credit-card-number">
                                â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div>
                                    <div style="font-size: 0.65rem; font-weight: 700; opacity: 0.8; margin-bottom: 0.25rem; letter-spacing: 0.1em;">STRATEGY</div>
                                </div>
                                <div style="width: 32px; height: 32px; background: rgba(255,255,255,0.3); border-radius: 50%;"></div>
                            </div>
                        </div>

                        <!-- Card Metadata (Below) -->
                        <div style="text-align: center; margin-top: 1rem; padding: 0 0.5rem;">
                            <div style="font-weight: 700; font-size: 1rem; color: #1e293b; margin-bottom: 0.25rem;">{{ card.name }}</div>
                            <div style="font-size: 0.75rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                                <span style="color: #94a3b8;">${{ card.annual_fee|default:0 }}</span>
                                <span style="margin: 0 0.5rem; color: #cbd5e1;">â€¢</span>
                                <span style="color: #3b82f6;">{{ card.categories.0|default:'CREDIT' }} STRATEGY</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination Dots -->
                {% if slot.hydrated_cards|length > 1 %}
                <div class="pagination-dots" id="dots-slot-{{ forloop.counter }}">
                    {% for card in slot.hydrated_cards %}
                    <div class="pagination-dot {% if forloop.first %}active{% endif %}"></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: 16px; border: 2px dashed #e5e7eb;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">ðŸ’³</div>
        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">No loadout defined</h3>
        <p style="color: #6b7280;">We're still building out card recommendations for this personality.</p>
    </div>
    {% endif %}
</div>

<!-- Rules of Engagement Section -->
{% if personality.rules %}
<section class="container" style="padding: 0 0 4rem 0;">
    <div style="background: white; padding: 3rem; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
        <h2 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 2rem; color: #111827;">
            Rules of Engagement
        </h2>

        <div style="display: grid; gap: 1.5rem;">
            {% for rule in personality.rules %}
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 1.5rem; align-items: start;">
                <div style="width: 32px; height: 32px; background: #111827; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; margin-top: 0.25rem;">
                    {{ forloop.counter }}
                </div>
                <div>
                    <h3 style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; color: #111827;">{{ rule.title }}</h3>
                    <p style="color: #6b7280; line-height: 1.6; margin: 0;">{{ rule.description }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- CTA Section -->
<section style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); padding: 4rem 0; color: white; position: relative; overflow: hidden;">
    <!-- Background decoration -->
    <div style="position: absolute; top: -50%; left: -10%; width: 500px; height: 500px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); border-radius: 50%;"></div>
    <div style="position: absolute; bottom: -30%; right: -5%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%); border-radius: 50%;"></div>
    
    <div class="container" style="position: relative; z-index: 1; text-align: center;">
        <h2 style="font-size: clamp(1.75rem, 4vw, 2.5rem); font-weight: 700; margin-bottom: 1rem;">
            Ready to build this setup?
        </h2>
        <p style="font-size: 1.1rem; margin-bottom: 2rem; opacity: 0.95; max-width: 600px; margin-left: auto; margin-right: auto;">
            Track these cards, manage your fees, and calculate your net worth with WalletFreak.
        </p>
        <a href="{% url 'dashboard' %}" class="btn" style="background: white; color: #8b5cf6; padding: 1rem 2.5rem; font-weight: 700; font-size: 1.05rem; border-radius: 12px; text-decoration: none; display: inline-block; box-shadow: 0 4px 16px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.2)';">
            Start My Wallet
        </a>
    </div>
</section>

<script>
    // Initialize allCardsData for shared modal
    const allCardsData = {{ cards_json|safe }};
    const walletCardIds = new Set({{ wallet_card_ids|safe|default:'[]' }});
    const userMatchScores = {{ user_match_scores|safe|default:'{}' }};

    // Track current index for each slot
    const currentSlotIndices = {};

    function changeCard(slotIndex, direction) {
        const slotClass = `slot-card-${slotIndex}`;
        const cards = document.querySelectorAll(`.${slotClass}`);
        if (cards.length <= 1) return;

        // Get current index
        let currentIndex = currentSlotIndices[slotIndex] || 0;

        // Hide current
        cards[currentIndex].style.display = 'none';

        // Calculate new index
        currentIndex += direction;
        if (currentIndex < 0) currentIndex = cards.length - 1;
        if (currentIndex >= cards.length) currentIndex = 0;

        // Show new and update tracker
        cards[currentIndex].style.display = 'block';
        currentSlotIndices[slotIndex] = currentIndex;

        // Update Dots
        const dotsContainer = document.getElementById(`dots-slot-${slotIndex}`);
        if (dotsContainer) {
            const dots = dotsContainer.querySelectorAll('.pagination-dot');
            dots.forEach((dot, index) => {
                if (index === currentIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }
    }
</script>
<script src="{% static 'js/personality_detail.js' %}"></script>

{% include 'cards/includes/card_modal.html' %}
{% endblock %}