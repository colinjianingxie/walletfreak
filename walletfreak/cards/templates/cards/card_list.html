{% extends 'base.html' %}
{% load card_extras %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/card_list.css' %}">
<link rel="stylesheet" href="{% static 'css/card_modal.css' %}">
{% endblock %}

{% block main_style %}padding: 3rem 0; background: #F9FAFB; min-height: calc(100vh - 70px);{% endblock %}

{% block content %}
<div class="main-content-wrapper">
    <!-- Header Section -->
    {% include 'cards/includes/card_list/header.html' %}

    <!-- Search Bar -->
    {% include 'cards/includes/card_list/search_bar.html' %}

    <!-- Category Pills -->
    {% include 'cards/includes/card_list/categories.html' %}

    <!-- Mobile Filter & Sort Bar -->
    {% include 'cards/includes/card_list/mobile_controls.html' %}

    <!-- Main Content: Sidebar + Cards Grid -->
    <div class="main-grid main-grid-layout">
        <!-- Left Sidebar: Filters -->
        {% include 'cards/includes/card_list/filters_sidebar.html' %}

        <!-- Right Content: Cards Grid -->
        <div class="cards-content-column">
            <!-- Sort & View Toggle Header (Desktop) -->
            {% include 'cards/includes/card_list/toolbar.html' %}

            <!-- Scroll Wrapper for List View -->
            <div id="cards-scroll-container" class="list-view-container">
                <!-- List Header (Hidden by default, shown in ListView via CSS) -->
                <div id="list-header" class="list-view-header">
                    <div class="col-compare">COMPARE</div>
                    <div class="col-card">CARD</div>
                    <div class="col-fee">FEE</div>
                    <div class="col-rewards">REWARDS SUMMARY</div>
                    <div class="col-action">ACTION</div>
                </div>

                <!-- Grid -->
                <div
                    id="cards-grid"
                    class="view-grid cards-grid-layout"
                >
                    {% for card in cards %}
                    {% include 'cards/includes/card_list/card_item.html' %}
                    {% empty %}
                    <div class="empty-state-container">
                        <span class="material-icons empty-icon">credit_card</span>
                        <h2 class="empty-title">No cards found</h2>
                        <p class="empty-text">Try adjusting your filters or search query.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Show More Button -->
            <div id="load-more-container" class="load-more-btn-container">
                <button id="load-more-btn" onclick="loadMoreCards()" class="load-more-btn">
                    <span style="font-size: 1rem; font-weight: 600; color: #1F2937;">Show More Results</span>
                    <span id="remaining-count" class="remaining-count-badge">5 more</span>
                    <span class="material-icons" style="font-size: 20px; color: #94A3B8; margin-left: 0.25rem;">expand_more</span>
                </button>
            </div>

            <!-- No Results Message -->
            {% include 'cards/includes/card_list/empty_states.html' %}
        </div>
    </div>
</div>

<!-- Floating Compare Bar -->
{% include 'cards/includes/card_list/compare_bar.html' %}

<!-- Mobile Filter Overlay -->
<div id="filter-overlay" onclick="closeFilters()" class="filter-overlay-bg"></div>

{% include 'cards/includes/card_modal.html' %}
{% include 'cards/includes/match_explanation_modal.html' %}
{% include 'cards/includes/compare_modal.html' %}

<script>
// Define allCardsData for modal usage
const allCardsData = {{ cards_json|safe }};

// Track which cards are already in wallet
const walletCardIds = new Set({{ wallet_card_ids|safe|default:'[]' }});

// Template filter for dictionary access
const userMatchScores = {{ user_match_scores|safe|default:'{}' }};
const userPersonality = {{ user_personality_json|safe|default:'null' }};
const currentUserUid = "{{ request.session.uid }}";

</script>
<script src="{% static 'js/card_list.js' %}"></script>


{% endblock %}