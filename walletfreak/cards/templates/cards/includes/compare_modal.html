<div id="compare-modal-overlay" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); z-index: 1000; justify-content: center; align-items: center; padding: 2rem;">
    <div class="compare-modal" style="background: white; width: 100%; max-width: 700px; max-height: 90vh; border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        
        <!-- Header -->
        <div style="padding: 1.5rem 2rem; border-bottom: 1px solid #F1F5F9; display: flex; justify-content: space-between; align-items: center; background: white;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <h2 style="font-size: 1.5rem; font-weight: 800; color: #0F172A; margin: 0;">Compare Cards</h2>
                <span id="compare-modal-count" style="background: #DBEAFE; color: #1E40AF; font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 20px;">3 Selected</span>
            </div>
            <button onclick="closeCompareModal()" style="background: none; border: none; cursor: pointer; color: #94A3B8; padding: 0.5rem;">
                <span class="material-icons">close</span>
            </button>
        </div>

        <!-- Scrollable Content -->
        <div id="compare-content" style="flex: 1; overflow-y: auto; padding: 2rem;">
            <!-- Content will be injected here by JS -->
        </div>
    </div>
</div>

<style>
    /* Modal Styles */
    .modal-overlay.active {
        display: flex !important;
    }

    /* Section Card */
    .compare-section-card {
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .compare-section-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.25rem;
    }
    
    .compare-section-icon {
        font-size: 18px;
    }
    
    .compare-section-title {
        font-size: 0.75rem;
        font-weight: 800;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Card row in section */
    .card-data-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid #F8FAFC;
    }
    
    .card-data-row:last-child {
        border-bottom: none;
    }

    /* Multiplier Pills */
    .multiplier-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }
    
    .multiplier-pill {
        background: #EFF6FF;
        color: #1D4ED8;
        font-weight: 700;
        font-size: 0.8125rem;
        padding: 0.5rem 0.875rem;
        border-radius: 8px;
        white-space: nowrap;
    }

    /* Card Visual Rectangle */
    .card-preview-small {
        width: 90px;
        height: 56px;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow: hidden;
        border: 1px solid #E2E8F0;
    }

    /* Mobile Layout */
    @media (max-width: 768px) {
        .compare-modal {
            height: 100vh !important;
            max-height: 100vh !important;
            border-radius: 0 !important;
            max-width: 100% !important;
        }
    }
</style>

<script>
function closeCompareModal() {
    document.getElementById('compare-modal-overlay').classList.remove('active');
    document.body.style.overflow = '';
}

function openCompareModal() {
    const modal = document.getElementById('compare-modal-overlay');
    const content = document.getElementById('compare-content');
    const countBadge = document.getElementById('compare-modal-count');
    
    // Update count
    countBadge.textContent = `${selectedCards.size} Selected`;
    
    // Clear content
    content.innerHTML = '';
    
    // Get card data for all selected cards
    const cards = Array.from(selectedCards.entries()).map(([cardId, cardMeta]) => {
        const card = allCardsData[cardId];
        return card ? { ...card, cardMeta, id: cardId } : null;
    }).filter(c => c);
    
    if (cards.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #94A3B8;">No cards selected</p>';
        modal.classList.add('active');
        return;
    }
    
    // Render card visuals at top
    const cardsHeader = document.createElement('div');
    cardsHeader.style.cssText = 'display: flex; justify-content: center; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap; padding-bottom: 1.5rem; border-bottom: 1px solid #F1F5F9;';
    
    cards.forEach(card => {
        const cardVisual = document.createElement('div');
        cardVisual.style.cssText = 'text-align: center; display: flex; flex-direction: column; align-items: center;';
        
        let imageUrl = card.image_url;
        if (card.local_image) {
            imageUrl = `/static/${card.local_image}`; // Assuming static prefix
        }

        if (imageUrl) {
             cardVisual.innerHTML = `
                <div class="card-preview-small" style="margin: 0 auto 0.75rem;">
                     <img src="${imageUrl}" 
                          style="width: 100%; height: 100%; object-fit: cover;"
                          onerror="this.onerror=null; this.src='${card.image_url || ''}';">
                </div>
                <div style="font-size: 0.875rem; font-weight: 700; color: #0F172A; max-width: 120px; line-height: 1.2;">${card.name}</div>
            `;
        } else {
            cardVisual.innerHTML = `
                <div class="card-preview-small" style="background: ${card.cardMeta.color}; margin: 0 auto 0.75rem;">
                    <span class="material-icons" style="color: white; font-size: 24px; opacity: 0.9;">contactless</span>
                </div>
                <div style="font-size: 0.875rem; font-weight: 700; color: #0F172A; max-width: 120px; line-height: 1.2;">${card.name}</div>
            `;
        }
        cardsHeader.appendChild(cardVisual);
    });
    
    content.appendChild(cardsHeader);
    
    // Annual Fee Section
    content.appendChild(createAggregatedSection(
        'attach_money',
        'ANNUAL FEE',
        cards.map(card => ({
            name: card.name,
            value: `$${card.annual_fee || 0}`
        })),
        '#64748B'
    ));
    
    // Welcome Bonus Section
    const welcomeSection = document.createElement('div');
    welcomeSection.className = 'compare-section-card';
    welcomeSection.innerHTML = `
        <div class="compare-section-header">
            <span class="material-icons compare-section-icon" style="color: #F59E0B;">flash_on</span>
            <span class="compare-section-title">WELCOME BONUS</span>
        </div>
    `;
    
    cards.forEach(card => {
        // Match card modal's logic for bonus extraction, but be safer about falsy values
        // Check for various possible bonus fields
        let bonusValue = null;
        let bonusTerms = null;
        let bonusCurrency = null; // Store the type from DB if available
        
        if (card.sign_up_bonus && card.sign_up_bonus.value) {
            // Prioritize the structured object from seed_db which now has the correct type in 'currency' field
            bonusValue = card.sign_up_bonus.value;
            bonusTerms = card.sign_up_bonus.terms;
            bonusCurrency = card.sign_up_bonus.currency; 
        } else if (card.welcomeOffer && card.welcomeOffer.value) {
            bonusValue = card.welcomeOffer.value;
            bonusTerms = card.welcomeOffer.terms;
        } else if (card.bonus_value) {
            bonusValue = card.bonus_value.toLocaleString();
            bonusTerms = card.bonus_text;
        }
        
        // Sanitize 'undefined' strings if they somehow got in
        if (String(bonusValue).toLowerCase().includes('undefined')) bonusValue = null;
        if (String(bonusTerms).toLowerCase().includes('undefined')) bonusTerms = null;

        const row = document.createElement('div');
        row.className = 'card-data-row';

        if (bonusValue && bonusValue !== '0' && bonusValue !== 0) {
            // We have a bonus
            let displayValue = bonusValue;
            let displayType = 'Points';

            // Determine type
            // 1. Explicit type from DB (SignUpBonusType mapped to 'currency' in python)
            if (bonusCurrency) {
                 if (String(bonusCurrency).toLowerCase() === 'cash') {
                     displayType = ''; 
                     displayValue = `$${bonusValue}`;
                 } else {
                     displayType = bonusCurrency; // 'Miles', 'Points'
                 }
            } else {
                // 2. Infer from terms
                displayType = String(bonusTerms || '').toLowerCase().includes('miles') ? 'Miles' : 'Points';
            }
            
            // Refine display
            if (String(displayType).toLowerCase() === 'cash' || String(displayType).toLowerCase() === 'cash back') {
                 if (!String(displayValue).startsWith('$')) {
                     displayValue = `$${displayValue}`;
                 }
                 displayType = '';
            }
            
            row.innerHTML = `
                <div style="font-weight: 600; font-size: 0.9375rem; color: #475569;">${card.name}</div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; font-size: 1.125rem; color: #6366F1;">${displayValue} ${displayType === 'Cash Back' || displayType === 'Cash' ? '' : displayType}</div>
                    <div style="font-size: 0.75rem; color: #94A3B8; margin-top: 0.25rem;">${bonusTerms || 'Terms apply.'}</div>
                </div>
            `;
        } else {
            // No valid bonus found
            row.innerHTML = `
                <div style="font-weight: 600; font-size: 0.9375rem; color: #475569;">${card.name}</div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; font-size: 1.125rem; color: #6366F1;">0 Points</div>
                    <div style="font-size: 0.75rem; color: #94A3B8; margin-top: 0.25rem;">No public sign up bonus or welcome offer</div>
                </div>
            `;
        }
        
        welcomeSection.appendChild(row);
    });
    
    content.appendChild(welcomeSection);
    
    // Top Multipliers Section
    const multipliersSection = document.createElement('div');
    multipliersSection.className = 'compare-section-card';
    multipliersSection.innerHTML = `
        <div class="compare-section-header">
            <span class="material-icons compare-section-icon" style="color: #6366F1;">trending_up</span>
            <span class="compare-section-title">TOP MULTIPLIERS</span>
        </div>
    `;
    
    cards.forEach(card => {
        let rates = card.earning_rates || [];
        if (!rates.length) {
             rates = extractEarningRates(card.benefits) || [];
        }
        const topRates = rates.sort((a, b) => (b.value || 0) - (a.value || 0)).slice(0, 3);
        
        const cardRow = document.createElement('div');
        cardRow.style.cssText = 'margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #F8FAFC;';
        
        const pills = topRates.map(rate => {
            const value = rate.value || 1;
            const category = rate.category || 'Purchases';
            return `<span class="multiplier-pill">${value}x ${category}</span>`;
        }).join('');
        
        cardRow.innerHTML = `
            <div style="font-weight: 700; font-size: 0.9375rem; color: #0F172A; margin-bottom: 0.75rem;">${card.name}</div>
            <div class="multiplier-pills">${pills || '<span style="color: #94A3B8; font-size: 0.875rem;">No multipliers</span>'}</div>
        `;
        
        multipliersSection.appendChild(cardRow);
    });
    
    content.appendChild(multipliersSection);
    
    // Key Benefits Section
    const benefitsSection = document.createElement('div');
    benefitsSection.className = 'compare-section-card';
    benefitsSection.innerHTML = `
        <div class="compare-section-header">
            <span class="material-icons compare-section-icon" style="color: #10B981;">verified_user</span>
            <span class="compare-section-title">KEY BENEFITS</span>
        </div>
    `;
    
    cards.forEach(card => {
        const benefits = extractKeyBenefits(card.benefits) || [];
        
        const cardRow = document.createElement('div');
        cardRow.style.cssText = 'margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #F8FAFC;';
        
        cardRow.innerHTML = `<div style="font-weight: 700; font-size: 0.9375rem; color: #0F172A; margin-bottom: 0.75rem;">${card.name}</div>`;
        
        if (benefits.length > 0) {
            benefits.forEach(benefit => {
                const value = benefit.value || '';
                let displayValue = value;
                
                // Only add $ if the value is purely numerical
                // Remove commas for the check to handle "1,000"
                const cleanValue = String(value).replace(/,/g, '').trim();
                const isNumerical = /^-?\d+(\.\d+)?$/.test(cleanValue);
                
                if (typeof value === 'number' || (isNumerical && cleanValue !== '')) {
                    displayValue = `$${value}`;
                }
                
                const benefitItem = document.createElement('div');
                benefitItem.style.cssText = 'margin-bottom: 0.875rem;';
                benefitItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                        <span style="font-weight: 600; font-size: 0.875rem; color: #475569;">${benefit.title}</span>
                        <span style="font-weight: 700; font-size: 0.9375rem; color: #10B981;">${displayValue}</span>
                    </div>
                    ${benefit.description ? `<div style="font-size: 0.75rem; color: #94A3B8; line-height: 1.4;">${benefit.description}</div>` : ''}
                `;
                cardRow.appendChild(benefitItem);
            });
        } else {
            cardRow.innerHTML += '<div style="color: #94A3B8; font-size: 0.875rem;">No benefits listed</div>';
        }
        
        benefitsSection.appendChild(cardRow);
    });
    
    content.appendChild(benefitsSection);
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function createAggregatedSection(icon, title, items, iconColor = '#6366F1') {
    const section = document.createElement('div');
    section.className = 'compare-section-card';
    
    const header = `
        <div class="compare-section-header">
            <span class="material-icons compare-section-icon" style="color: ${iconColor};">${icon}</span>
            <span class="compare-section-title">${title}</span>
        </div>
    `;
    
    const rows = items.map(item => `
        <div class="card-data-row">
            <div style="font-weight: 600; font-size: 0.9375rem; color: #475569;">${item.name}</div>
            <div style="font-weight: 800; font-size: 1.125rem; color: #0F172A;">${item.value}</div>
        </div>
    `).join('');
    
    section.innerHTML = header + rows;
    return section;
}

function extractEarningRates(benefits) {
    // Extract benefits with benefit_type "Multiplier" or "Cashback" as earning rates
    if (!benefits || !Array.isArray(benefits)) return [];
    
    return benefits
        .filter(b => b.benefit_type === 'Multiplier' || b.benefit_type === 'Cashback')
        .map(b => ({
            category: b.short_description || b.name || b.title || b.description || 'Purchases',
            value: parseFloat(b.numeric_value || b.value || b.multiplier) || 1,
            currency: b.benefit_type === 'Cashback' ? 'cash' : (b.currency || 'points')
        }));
}

function extractKeyBenefits(benefits) {
    // Extract benefits that are NOT "Multiplier" or "Cashback" - match card modal logic
    if (!benefits || !Array.isArray(benefits)) return [];
    
    return benefits
        .filter(b => b.benefit_type !== 'Multiplier' && b.benefit_type !== 'Cashback' && b.benefit_type !== 'Financing' && b.benefit_type !== 'Deferred Interest' && b.benefit_type !== 'Insurance')
        .map(b => ({
            title: b.short_description || b.name || b.title || 'Benefit',
            value: b.numeric_value || b.value || b.amount || 'Included',
            description: b.description || b.additional_details || ''
        }));
}

function selectCardForWallet(cardId) {
    closeCompareModal();
    openCardModal(cardId);
}
</script>
