<!-- Card Details Modal (Shared) -->
<div id="card-details-modal" class="modal" style="display: none;">
    <div class="modal-content card-details-content">
        <!-- Mobile Header -->
        <div class="mobile-modal-header-text">Card Details</div>
        <button class="modal-close-mobile" onclick="closeCardDetailsModal()">
            <span class="material-icons" style="font-size: 18px;">arrow_back_ios</span> Back
        </button>
        <!-- Left Column: Card Visual & Actions -->
        <div class="card-details-left">
            <!-- Card Visual -->
            <div class="card-visual-container">
                <div id="modal-card-visual" class="credit-card">
                    <div class="card-generated-content" style="display: flex; flex-direction: column; justify-content: space-between; height: 100%; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div id="modal-card-issuer-logo" style="font-size: 0.75rem; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; opacity: 0.9;">ISSUER</div>
                            <span class="material-icons" style="font-size: 28px; opacity: 0.8;">contactless</span>
                        </div>
                        <div class="credit-card-chip"></div>
                        <div class="credit-card-number">•••• •••• •••• 4242</div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div class="credit-card-name">YOUR NAME</div>
                            <div style="display: flex; gap: 2px;">
                                <div style="width: 20px; height: 20px; background: #EB001B; border-radius: 50%; opacity: 0.9;"></div>
                                <div style="width: 20px; height: 20px; background: #F79E1B; border-radius: 50%; margin-left: -8px; opacity: 0.9;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-identity-section">
                <h2 id="modal-card-name" class="modal-card-title">Card Name</h2>
                
                <div class="modal-badges-row">
                    <!-- Match Badge (Re-added per design) -->
                    <!-- Match Badge (Re-added per design) -->
                    {% if request.user.is_authenticated %}
                    <div class="modal-badge match-badge-pill">
                        <span class="material-icons" style="font-size: 14px; color: #F59E0B;">star</span>
                        <span id="modal-match-score">98% Match</span>
                    </div>
                    {% endif %}

                    <!-- Fee Badge -->
                    <div class="modal-badge fee-badge-pill">
                        <span class="badge-label">FEE</span>
                        <span id="modal-annual-fee" class="badge-value">$550</span>
                    </div>
                </div>

                <!-- Report Issue Link (Mobile Only - beneath badges) -->
                {% if request.user.is_authenticated %}
                <div class="mobile-report-container">
                    <button onclick="reportIssue()">
                        Report Outdated Benefits
                    </button>
                </div>
                {% endif %}
            </div>

            <div class="card-actions-desktop">
                <button id="modal-add-btn" class="btn-add-wallet" onclick="addToWalletFromModal()">
                    Add to Wallet <span class="material-icons" style="font-size: 18px;">check</span>
                </button>
                <button class="btn-apply" id="modal-apply-btn" onclick="window.open('#', '_blank')">
                    Apply Now <span class="material-icons" style="font-size: 16px;">open_in_new</span>
                </button>
                
                <!-- Report Issue Link (Desktop) -->
                {% if request.user.is_authenticated %}
                <div style="text-align: center; margin-top: 0.75rem;">
                    <button onclick="reportIssue()" style="background: none; border: none; color: #94A3B8; font-size: 0.75rem; text-decoration: underline; cursor: pointer;">
                        Report Outdated Benefits
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Details & Tabs -->
        <div class="card-details-right" style="position: relative;">
            <button class="modal-close-desktop" onclick="closeCardDetailsModal()" style="position: absolute; top: 1.5rem; right: 1.5rem; z-index: 10;">×</button>

            <!-- Tabs -->
            <div class="card-tabs">
                <button class="card-tab active" onclick="switchCardTab('overview')">
                    <span class="material-icons">grid_view</span> Overview
                </button>
                <button class="card-tab" onclick="switchCardTab('earning')">
                    <span class="material-icons">trending_up</span> Earning
                </button>
                <button class="card-tab" onclick="switchCardTab('benefits')">
                    <span class="material-icons">verified</span> Benefits
                </button>
            </div>

            <!-- Tab Content -->
            <div class="card-tab-content">
                <!-- Overview Tab -->
                <div id="tab-overview" class="tab-pane active">
                    <!-- Freak Verdict -->
                    <div class="freak-verdict">
                        <div class="verdict-icon">
                            <span class="material-icons">bolt</span>
                        </div>
                        <div>
                            <div class="verdict-title">THE FREAK VERDICT</div>
                            <div id="modal-verdict-text" class="verdict-text">
                                No verdict available.
                            </div>
                        </div>
                    </div>

                    <!-- Welcome Offer -->
                    <div style="margin-bottom: 2rem;" id="modal-welcome-container">
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 14px;">card_giftcard</span>
                            WELCOME OFFER
                        </div>
                        <div class="welcome-offer-box" style="display: flex; align-items: center; gap: 1.5rem;">
                            <div style="font-size: 2rem; font-weight: 800; color: #1F2937; line-height: 1; white-space: nowrap;" id="modal-bonus-value">60,000 Points</div>
                            <div style="width: 1px; height: 40px; background: #E2E8F0;"></div>
                            <div style="font-size: 0.95rem; color: #64748B; font-weight: 500; line-height: 1.3;" id="modal-bonus-terms">after $4k spend in 3 months</div>
                        </div>
                    </div>

                    <!-- Key Stats Grid -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                        <div class="stat-box" style="text-align: center;">
                            <div class="stat-label">CREDITS VALUE</div>
                            <div class="stat-value" style="color: #10B981; font-size: 2rem;" id="modal-credits-value">$0</div>
                        </div>
                    </div>
                </div>

                <!-- Earning Tab -->
                <div id="tab-earning" class="tab-pane">
                    <!-- Pro Tip Removed -->
                    <div id="modal-earning-rows">
                        <!-- Populated by JS with expandable rows -->
                    </div>
                </div>

                <!-- Benefits Tab -->
                <div id="tab-benefits" class="tab-pane">
                    <div id="modal-benefits-rows">
                        <!-- Populated by JS with expandable rows -->
                    </div>
                </div>
                </div>
            </div>
            <!-- Mobile Sticky Footer -->
            <div class="card-actions-mobile">
                <button id="modal-add-btn-mobile" class="btn-add-wallet" onclick="addToWalletFromModal()">
                    Add to Wallet
                </button>
                <button class="btn-apply" id="modal-apply-btn-mobile" onclick="window.open('#', '_blank')">
                    Apply Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Anniversary Date Modal (Shared from Dashboard) -->
{% include "dashboard/modals/_anniversary.html" %}

<script>
// Shared Modal Logic
let scrollPosition = 0;

function setAnniversaryDefaultState() {
    const dateInput = document.getElementById('anniversary-date-input');
    const defaultDisplay = document.getElementById('anniversary-default-display');
    const unknownBtn = document.getElementById('btn-unknown-add-anniversary');
    const dateText = document.getElementById('anniversary-default-date-display-text');

    if (dateInput) {
        dateInput.value = ''; // Clear value
        dateInput.style.display = 'none';
        dateInput.required = false;
    }
    if (defaultDisplay) defaultDisplay.style.display = 'flex';
    if (unknownBtn) unknownBtn.style.display = 'none';

    // Set dynamic date text
    if (dateText) {
        const prevYear = new Date().getFullYear() - 1;
        dateText.innerText = `1/1/${prevYear}`;
    }
}

function clearAnniversaryDefaultState() {
    const dateInput = document.getElementById('anniversary-date-input');
    const defaultDisplay = document.getElementById('anniversary-default-display');
    const unknownBtn = document.getElementById('btn-unknown-add-anniversary');

    if (dateInput) {
        dateInput.style.display = 'block';
        if (!dateInput.value) {
            // Default to today
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    }
    if (defaultDisplay) defaultDisplay.style.display = 'none';
    if (unknownBtn) unknownBtn.style.display = 'flex';
}

function openCardModal(cardId) {
    // Check if allCardsData exists
    if (typeof allCardsData === 'undefined') {
        console.error('allCardsData is not defined');
        return;
    }

    // Handle both string IDs (from personality page) and numeric IDs (from sample data)
    let card = allCardsData[cardId];
    // Fallback for array-based sampleCards if used
    if (!card && Array.isArray(allCardsData)) {
        card = allCardsData.find(c => c.id == cardId);
    }

    if (!card) {
        console.error('Card not found:', cardId);
        return;
    }

    currentModalCardId = cardId;
    const modal = document.getElementById('card-details-modal');
    
    // Populate Data
    document.getElementById('modal-card-name').textContent = card.name;
    document.getElementById('modal-card-issuer-logo').textContent = (card.issuer || 'ISSUER').toUpperCase();
    
    // Visual
    const visual = document.getElementById('modal-card-visual');
    const generatedContent = visual.querySelector('.card-generated-content');
    
    // Reset styles and classes
    visual.className = 'credit-card';
    visual.style.backgroundImage = '';
    if (generatedContent) generatedContent.style.display = 'flex';
    visual.style.backgroundSize = '';
    visual.style.backgroundPosition = '';
    
    // Helper to set background image
    const setBgImage = (url) => {
        // Use 'important' to override the CSS background: linear-gradient(...) !important
        visual.style.setProperty('background', `url('${url}') center / cover no-repeat`, 'important');
        if (generatedContent) generatedContent.style.display = 'none';
        
        // Remove specific classes that might add conflicting backgrounds
        visual.className = 'credit-card';
    };

    // Helper to set default visual based on issuer
    const setDefaultVisual = () => {
        let imageClass = 'card-default';
        const nameLower = card.name.toLowerCase();
        const issuerLower = (card.issuer || '').toLowerCase();
        
        if (issuerLower.includes('american express') || issuerLower.includes('amex')) {
            if (nameLower.includes('platinum')) imageClass = 'card-amex-platinum';
            else if (nameLower.includes('gold')) imageClass = 'card-gold';
            else imageClass = 'card-amex-platinum'; // Fallback
        } else if (issuerLower.includes('chase')) {
            imageClass = 'card-chase';
        } else if (issuerLower.includes('capital one')) {
            imageClass = 'card-capital-one';
        } else if (issuerLower.includes('citi')) {
            imageClass = 'card-citi';
        }
        
        // If card object has imageClass property (from sampleCards), use it
        if (card.imageClass) imageClass = card.imageClass;
        
        visual.classList.add(imageClass);
    };

    // Logic: Try remote URL (image_url/ImageURL) -> local_image -> heuristic local (slug+ext) -> default
    
    // Helper to try loading an image
    const tryLoadImage = (url, onSuccess, onError) => {
        const img = new Image();
        img.onload = () => onSuccess(url);
        img.onerror = onError;
        // Add cache buster to prevent caching issues
        img.src = url;
    };

    // Chain step 3: Heuristic search for local image
    const tryHeuristic = (index = 0) => {
        const extensions = ['png', 'PNG', 'jpg', 'JPG', 'jpeg', 'webp', 'WEBP', 'avif', 'AVIF'];
        if (index >= extensions.length) {
            setDefaultVisual();
            return;
        }
        
        // Use slug if available, else id (if it looks like a slug)
        // If id is numeric (mock data) and no slug, skip heuristic
        if ((typeof card.id === 'number' || !isNaN(card.id)) && !card.slug) {
             setDefaultVisual();
             return;
        }
        
        const slug = card.slug || card.id;
        const path = `/static/images/credit_cards/${slug}.${extensions[index]}`;
        
        tryLoadImage(path, setBgImage, () => tryHeuristic(index + 1));
    };

    // Chain step 2: Check defined local_image
    const tryLocalImage = () => {
        if (card.local_image) {
            // Handle path with or without /static/ prefix
            let localPath = card.local_image;
            if (!localPath.startsWith('/static/') && !localPath.startsWith('http')) {
                 localPath = `/static/${localPath}`;
            }
            
            tryLoadImage(localPath, setBgImage, () => tryHeuristic(0));
        } else {
            tryHeuristic(0);
        }
    };

    // Chain step 1: Check remote URL (Prioritized)
    // Check both snake_case and CamelCase to be safe
    let remoteUrl = card.image_url || card.ImageURL;
    
    // Fix: Strip absolute domain if present to avoid 404s on localhost
    if (remoteUrl) {
        remoteUrl = remoteUrl.replace('https://www.walletfreak.com', '').replace('https://walletfreak.com', '');
        tryLoadImage(remoteUrl, setBgImage, tryLocalImage);
    } else {
        tryLocalImage();
    }
    
    // Stats
    // Fix: Backend sends snake_case match_score, frontend mock might use matchScore
    // Check global userMatchScores first (calculated on Explore page)
    let dynamicScore = null;
    if (typeof userMatchScores !== 'undefined' && userMatchScores[cardId] !== undefined) {
        dynamicScore = userMatchScores[cardId];
    }

    const rawScore = (dynamicScore !== null) ? dynamicScore : (card.match_score !== undefined ? card.match_score : (card.matchScore || '90'));
    
    // Format to 1 decimal place
    let cleanScore = String(rawScore).replace('%', '').replace(' Match', '').trim();
    let floatScore = parseFloat(cleanScore);
    let displayScore = !isNaN(floatScore) ? floatScore.toFixed(1) : cleanScore;
    
    const matchScoreText = `${displayScore}% Match`;
    
    const matchEl = document.getElementById('modal-match-score');
    if (matchEl) matchEl.textContent = matchScoreText;

    document.getElementById('modal-annual-fee').textContent = '$' + (card.annualFee || card.annual_fee || 0);
    document.getElementById('modal-verdict-text').textContent = card.freak_verdict || card.verdict || card.description || 'No verdict available.';
    
    // Welcome Offer
    // Welcome Offer
    // Prioritize structure from seed_db
    let bonusValue = null;
    let bonusTerms = null;
    let bonusCurrency = null;

    if (card.sign_up_bonus && card.sign_up_bonus.value) {
        bonusValue = card.sign_up_bonus.value;
        bonusTerms = card.sign_up_bonus.terms;
        bonusCurrency = card.sign_up_bonus.currency;
    } else if (card.welcomeOffer && card.welcomeOffer.value) {
        bonusValue = card.welcomeOffer.value;
        bonusTerms = card.welcomeOffer.terms;
    } else if (card.bonus_value) {
        bonusValue = card.bonus_value; // Assuming string or number
        bonusTerms = card.bonus_text || card.sign_up_bonus_terms;
    } else {
        // Fallback or "0"
        bonusValue = 0;
    }
    
    if (bonusValue && bonusValue !== 0 && bonusValue !== "0") {
        let displayValue = bonusValue.toLocaleString ? bonusValue.toLocaleString() : bonusValue;
        
        // Determine type/currency
        let displayType = 'Points'; // Default
        
        if (bonusCurrency) {
            if (String(bonusCurrency).toLowerCase() === 'cash') {
                if (!String(displayValue).startsWith('$')) {
                    displayValue = `$${displayValue}`;
                }
                displayType = ''; 
            } else {
                displayType = bonusCurrency; // Miles, Points
            }
        } else {
            // Infer
             const termsLower = String(bonusTerms || '').toLowerCase();
             if (termsLower.includes('miles')) displayType = 'Miles';
             else if (termsLower.includes('cash')) {
                 if (!String(displayValue).startsWith('$')) displayValue = `$${displayValue}`;
                 displayType = '';
             }
        }
        
        // Final string assembly
        let finalBonusString = `${displayValue}`;
        if (displayType) {
            finalBonusString += ` ${displayType}`;
        }
        
        document.getElementById('modal-bonus-value').textContent = finalBonusString;
        document.getElementById('modal-bonus-terms').textContent = bonusTerms || "";
        document.getElementById('modal-welcome-container').style.display = 'block';
    } else {
        document.getElementById('modal-welcome-container').style.display = 'none';
    }

    // Credits
    // Credits
    document.getElementById('modal-credits-value').textContent = '$' + (card.creditsValue || 0);
    
    // APR removed
    
    // Set annual fee
    const annualFee = '$' + (card.annualFee || card.annual_fee || 0);
    document.getElementById('modal-annual-fee').textContent = annualFee;
    
    // Check if card is already in wallet and update Add to Wallet button
    const addBtn = document.getElementById('modal-add-btn');
    const addBtnMobile = document.getElementById('modal-add-btn-mobile'); // Mobile btn
    
    // Robust check for ID in wallet (handle both string and int types)
    // ALSO check by Name as a fallback for ID mismatches (e.g. slug vs int ID)
    const walletCardNames = new Set({{ wallet_card_names|safe|default:'[]' }});
    const cardName = card.name || document.getElementById('modal-card-name').textContent.trim();
    
    const isOwned = (typeof walletCardIds !== 'undefined' && 
                    (walletCardIds.has(cardId) || walletCardIds.has(String(cardId)) || walletCardIds.has(Number(cardId)))) ||
                    (walletCardNames.has(cardName));
    
    // Visual update for owned cards
    if (isOwned) {
        visual.classList.add('card-in-wallet');
    } else {
        visual.classList.remove('card-in-wallet');
    }

    // Helper to update button state
    const updateAddBtn = (btn) => {
        if (!btn) return;
        
        // Reset button state first
        btn.disabled = false;
        btn.style.background = '#0F172A';
        btn.style.cursor = 'pointer';
        btn.onclick = addToWalletFromModal;

        const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
        
        if (!isAuthenticated) {
            btn.disabled = true;
            btn.innerHTML = 'Login to Add to Wallet <span class="material-icons" style="font-size: 18px;">lock</span>';
            btn.style.background = '#94A3B8';
            btn.style.setProperty('cursor', 'default', 'important');
            btn.onclick = null;
            return;
        }

        if (isOwned) {
            btn.disabled = true;
            btn.innerHTML = 'Already in Wallet <span class="material-icons" style="font-size: 18px;">check_circle</span>';
            btn.style.background = '#94A3B8';
            btn.style.setProperty('cursor', 'default', 'important');
            btn.onclick = null;
        } else {
            btn.disabled = false;
            btn.innerHTML = 'Add to Wallet <span class="material-icons" style="font-size: 18px;">add</span>';
            btn.style.background = '#0F172A';
            btn.style.setProperty('cursor', 'pointer', 'important');
            btn.onclick = addToWalletFromModal;
        }
    };
    
    updateAddBtn(addBtn);
    updateAddBtn(addBtnMobile);
    
    // Apply Link
    const applyBtn = document.getElementById('modal-apply-btn');
    const applyBtnMobile = document.getElementById('modal-apply-btn-mobile'); // Mobile btn
    
    const openApply = () => {
        let url = card.application_link || '#';
        
        // Check for referral links
        if (card.referral_links && Array.isArray(card.referral_links) && card.referral_links.length > 0) {
            // Determine structure (string or object)
            // Assuming object based on views.py: {link: 'url', weight: 1}
            // But handling both just in case
            const links = card.referral_links;
            let selectedLink = null;
            
            // Randomly choose one
            const index = Math.floor(Math.random() * links.length);
            const item = links[index];
            
            if (typeof item === 'string') {
                selectedLink = item;
            } else if (item && item.link) {
                selectedLink = item.link;
            }
            
            if (selectedLink) {
                url = selectedLink;
            }
        }
        
        window.open(url, '_blank');
    };
    if (applyBtn) applyBtn.onclick = openApply;
    if (applyBtnMobile) applyBtnMobile.onclick = openApply;

    // Earning Tab Population with Expandable Rows
    const earningContainer = document.getElementById('modal-earning-rows');
    earningContainer.innerHTML = '';
    
    // Support multiple field names for earning rates
    // Also check benefits for Multiplier and Cashback type items
    let earning = card.earning_rates || card.earning || card.rewards_structure || [];
    
    // If no earning rates found, extract from benefits with benefit_type "Multiplier" or "Cashback"
    if (!earning || earning.length === 0) {
        const benefits = card.benefits || [];
        earning = benefits.filter(b => b.benefit_type === 'Multiplier' || b.benefit_type === 'Cashback').map(b => ({
            category: b.short_description || b.name || b.title || b.description,
            rate: b.numeric_value || b.value || b.multiplier,
            currency: b.benefit_type === 'Cashback' ? 'cash' : (b.currency || 'points')
        }));
    }
    
    if (Array.isArray(earning) && earning.length > 0) {
        // Find the highest earning rate for Pro Tip
        let highestRate = 0;
        let highestCategory = '';
        
        earning.forEach((item, index) => {
            // Support different field names
            let cat = item.category || item.cat || item.description || 'Category';
            
            // Handle array categories (new format)
            if (Array.isArray(cat)) {
                cat = cat.join(', ');
            }
            const rate = item.rate || item.mult || item.multiplier || item.value || 0;
            const currency = item.currency || 'points';
            
            // Track highest rate (excluding "All Purchases" or generic categories)
            if (rate > highestRate && !cat.toLowerCase().includes('all purchases') && !cat.toLowerCase().includes('everything')) {
                highestRate = rate;
                highestCategory = cat;
            }
            
            // Format multiplier display (e.g., "10x", "5x", "2%")
            let mult;
            if (currency.toLowerCase().includes('cash') || currency.toLowerCase().includes('%')) {
                mult = `${rate}%`;
            } else {
                mult = `${rate}x`;
            }
            
            // Build details text
            let details = item.details || item.description_long || item.additional_details || '';
            
            // Handle array details if present
            if (Array.isArray(details)) {
                details = details.join(', ');
            }
            
            if (!details) {
                // Generate default details text
                if (currency.toLowerCase().includes('cash')) {
                    details = `Earn ${rate}% cash back on ${cat.toLowerCase()}.`;
                } else {
                    details = `Earn ${rate}x ${currency} on ${cat.toLowerCase()}.`;
                }
            }
            
            // Title Case Helper
            const toTitleCase = (str) => {
                if (typeof str !== 'string') return String(str);
                return str.toLowerCase().split(' ').map(word => {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }).join(' ');
            };
            
            const displayTitle = toTitleCase(details);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'expandable-row-wrapper';
            wrapper.innerHTML = `
                <div class="expandable-row" style="cursor: default;">
                    <div class="earning-cat">${displayTitle}</div>
                    <div class="earning-actions" style="display: flex; align-items: center; gap: 0.5rem;">
                        <div class="earning-mult">${mult}</div>
                    </div>
                </div>
            `;
            earningContainer.appendChild(wrapper);
        });
        
        // Pro Tip removed
    } else {
        earningContainer.innerHTML = '<div style="color: #64748B; text-align: center; padding: 2rem;">No earning information available.</div>';
    }

    // Benefits Tab Population with Expandable Rows
    const benefitsContainer = document.getElementById('modal-benefits-rows');
    benefitsContainer.innerHTML = '';
    
    const benefits = card.benefits || [];
    // Filter out benefits with benefit_type "Multiplier" or "Cashback"
    const filteredBenefits = benefits.filter(b => b.benefit_type !== 'Multiplier' && b.benefit_type !== 'Cashback');
    
    if (Array.isArray(filteredBenefits) && filteredBenefits.length > 0) {
        filteredBenefits.forEach((benefit, index) => {
            // Use the correct field names from database
            const name = benefit.short_description || benefit.name || benefit.title || 'Unnamed Benefit';
            const value = benefit.numeric_value || benefit.value || benefit.amount || 'Included';
            
            // Combine details and additional_details for dropdown content
            let detailsText = '';
            if (benefit.description) {
                detailsText = benefit.description;
            }
            if (benefit.additional_details) {
                detailsText += (detailsText ? ' ' : '') + benefit.additional_details;
            }
            if (!detailsText) {
                detailsText = 'No additional details available.';
            }
            
            // Format value with proper styling
            // Rules:
            // - Cash: $Value
            // - Percent: Value%
            // - Points/Miles/Upgrade/Other: Value (raw)
            
            let valueDisplay = String(value);
            let valueClass = 'benefit-value';
            const numericType = benefit.numeric_type ? benefit.numeric_type.toLowerCase() : '';

            // Special case for "Included" text which shouldn't look like a number
            if (valueDisplay.toLowerCase() === 'included') {
                 valueClass = 'benefit-value benefit-value-included';
            } else {
                if (numericType === 'cash') {
                    if (!valueDisplay.includes('$')) {
                        valueDisplay = '$' + valueDisplay;
                    }
                    valueClass += ' benefit-value-money';
                } else if (numericType === 'percent') {
                    if (!valueDisplay.includes('%')) {
                        valueDisplay += '%';
                    }
                    valueClass += ' benefit-value-money';
                } else {
                    // Points, Miles, Upgrade, or any other type -> Just the number
                    // Also fallback for missing type -> Just the number
                    valueClass += ' benefit-value-money'; 
                }
            }
            
            const wrapper = document.createElement('div');
            wrapper.className = 'expandable-row-wrapper';
            wrapper.innerHTML = `
                <div class="expandable-row" onclick="toggleExpandable(this)">
                    <div class="earning-cat">${name}</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div class="${valueClass}">${valueDisplay}</div>
                        <span class="material-icons expand-arrow" style="font-size: 20px; color: #94A3B8;">expand_more</span>
                    </div>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">${detailsText}</div>
                </div>
            `;
            benefitsContainer.appendChild(wrapper);
        });
    } else {
        benefitsContainer.innerHTML = '<div style="color: #64748B; text-align: center; padding: 2rem;">No benefits information available.</div>';
    }


    // Reset Tabs
    switchCardTab('overview');
    
    modal.style.display = 'flex';
    
    // Better scroll lock for iOS
    scrollPosition = window.pageYOffset;
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
}

function closeCardDetailsModal() {
    document.getElementById('card-details-modal').style.display = 'none';
    currentModalCardId = null;
    
    // Unlock scroll and restore position
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('position');
    document.body.style.removeProperty('top');
    document.body.style.removeProperty('width');
    if (scrollPosition) {
        window.scrollTo(0, scrollPosition);
    }
}

function switchCardTab(tabName) {
    // Update Tab Buttons
    document.querySelectorAll('.card-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('onclick').includes(tabName)) {
            btn.classList.add('active');
        }
    });
    
    // Update Tab Content
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    document.getElementById(`tab-${tabName}`).classList.add('active');
}

function toggleExpandable(element) {
    const wrapper = element.parentElement;
    const content = wrapper.querySelector('.expandable-content');
    const arrow = element.querySelector('.expand-arrow');
    
    const isExpanded = wrapper.classList.contains('expanded');
    
    if (isExpanded) {
        // Collapse
        wrapper.classList.remove('expanded');
        arrow.style.transform = 'rotate(0deg)';
    } else {
        // Expand
        wrapper.classList.add('expanded');
        arrow.style.transform = 'rotate(180deg)';
    }
}

// Anniversary Modal Logic
let currentAnniversaryCardId = null;
let pendingCardForAdd = null;

function openAnniversaryModal(cardId, cardName) {
    currentAnniversaryCardId = cardId;
    document.getElementById('anniversary-card-name').textContent = cardName;
    // Default to current date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('anniversary-date-input').value = today;
    document.getElementById('anniversary-modal').style.display = 'flex';
}

function closeAnniversaryModal() {
    document.getElementById('anniversary-modal').style.display = 'none';
    currentAnniversaryCardId = null;
    pendingCardForAdd = null;
}

function saveAnniversaryDate() {
    let date = document.getElementById('anniversary-date-input').value;
    
    // Handle "I don't know" default state
    const defaultDisplay = document.getElementById('anniversary-default-display');
    if (defaultDisplay && defaultDisplay.style.display !== 'none') {
        date = 'default';
        console.log("Using default anniversary date");
    }

    if (!date) {
        alert('Please select a date');
        return;
    }
    
    // Validate that date is not in the future
    if (date !== 'default') {
        const selectedDate = new Date(date);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to compare dates only
        
        if (selectedDate > today) {
            alert('Anniversary date cannot be in the future');
            return;
        }
    }
    
    // Check if we should proceed with adding the card BEFORE closing the modal
    // because closing the modal clears the pendingCardForAdd flag
    if (pendingCardForAdd) {
        proceedWithAddCard(date);
    }
    
    // Close anniversary modal
    closeAnniversaryModal();
}

function proceedWithAddCard(anniversaryDate) {
    if (!currentModalCardId) return;
    
    const btn = document.getElementById('modal-add-btn');
    // Also target mobile button
    const btnMobile = document.getElementById('modal-add-btn-mobile');
    
    // Helper to update both buttons
    const updateButtons = (html, disabled, bg) => {
        if (btn) {
            btn.innerHTML = html;
            if (disabled !== null) btn.disabled = disabled;
            if (bg) btn.style.background = bg;
        }
        if (btnMobile) {
             btnMobile.innerHTML = html;
             if (disabled !== null) btnMobile.disabled = disabled;
             if (bg) btnMobile.style.background = bg;
        }
    };

    const originalText = btn ? btn.innerHTML : 'Add to Wallet';
    
    // Show Loader
    updateButtons('Adding... <span class="material-icons" style="animation: spin 1s linear infinite; font-size: 18px;">hourglass_empty</span>', true, '#6366F1');
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/wallet/add-card/${currentModalCardId}/`;
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCookie('csrftoken');
    form.appendChild(csrfInput);
    
    const ajaxInput = document.createElement('input');
    ajaxInput.type = 'hidden';
    ajaxInput.name = 'ajax';
    ajaxInput.value = '1';
    form.appendChild(ajaxInput);

    // Add anniversary date
    if (anniversaryDate) {
        const anniversaryInput = document.createElement('input');
        anniversaryInput.type = 'hidden';
        anniversaryInput.name = 'anniversary_date';
        anniversaryInput.value = anniversaryDate;
        form.appendChild(anniversaryInput);
    }
    
    document.body.appendChild(form);
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(res => res.json())
    .then(data => {
        document.body.removeChild(form);
        
        if (data.success) {
            // Show success state
            updateButtons('Added! <span class="material-icons" style="font-size: 18px;">check_circle</span>', true, '#10B981');

            // Add card to walletCardIds set to update button state immediately
            if (typeof walletCardIds !== 'undefined') {
                walletCardIds.add(currentModalCardId);
                // Also update the global set if using numeric ID vs string ID mismatch
                walletCardIds.add(String(currentModalCardId));
                walletCardIds.add(Number(currentModalCardId)); 
            }
            
            // Also notify any listeners (like the main page card list)
            if (typeof updateWalletState === 'function') {
                 // Creating a dummy set for now or triggering a refresh of the UI logic
                 // Since updateWalletState usually takes a set of IDs, we can pass the updated global set
                 if (typeof walletCardIds !== 'undefined') {
                      updateWalletState(walletCardIds);
                 }
            }

            // Close after delay
            setTimeout(() => {
                closeCardDetailsModal();
            }, 1500);
        } else {
             // Revert on error
            updateButtons('Add to Wallet', false, '#0F172A');
            alert(data.error || 'Failed to add card');
        }
    })
    .catch(err => {
        if (document.body.contains(form)) document.body.removeChild(form);
        updateButtons('Add to Wallet', false, '#0F172A');
        alert('Error adding card: ' + err.message);
    });
}

function addToWalletFromModal() {
    if (!currentModalCardId) return;

    // Check if we are using mock data (numeric IDs)
    if (typeof currentModalCardId === 'number') {
        alert(`Added card to wallet! (Mock Action)`);
        return;
    }
    
    // Get current card data for the modal
    const card = allCardsData[currentModalCardId]; // Assuming allCardsData is available globally
    const cardName = card ? card.name : 'Card';
    
    // Store the current card for after anniversary is set
    pendingCardForAdd = true;
    
    // Open anniversary modal
    openAnniversaryModal(currentModalCardId, cardName);
}

function reportIssue() {
    if (!currentModalCardId) return;
    
    const card = allCardsData[currentModalCardId];
    const cardName = card ? card.name : 'Card';
    
    // One-click reporting, no prompt
    const issueDetails = "Benefits appear out of date (Reported via Quick Action)";
    
    // Send report
    const formData = new FormData();
    formData.append('card_id', currentModalCardId);
    formData.append('card_name', cardName);
    formData.append('issue_details', issueDetails);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    // Optional: Visual feedback on button?
    // user likely will see the toast
    
    fetch('/report-issue/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showReportSuccessModal();
        } else {
            alert("Failed to send report: " + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert("Error sending report: " + err.message);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add spin animation
const style = document.createElement('style');
style.innerHTML = `
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 30px; opacity: 1;}
}
@keyframes fadeout {
  from {bottom: 30px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
}

/* Mobile Report Link Styles */
.mobile-report-container {
    display: none;
}
@media (max-width: 768px) {
    .mobile-report-container {
        display: block;
        text-align: center;
        margin-top: 0.75rem;
    }
    .mobile-report-container button {
        background: none;
        border: none;
        color: #94A3B8;
        font-size: 0.75rem;
        text-decoration: underline;
        cursor: pointer;
    }
}

@media (max-width: 768px) {
    /* Compact Modal Title */
    #modal-card-name {
        font-size: 1.25rem !important;
        margin-bottom: 0 !important;
    }
    #modal-card-issuer {
        font-size: 0.875rem !important;
        margin-bottom: 0.5rem !important;
    }
    
    /* Compact Modal Header Padding */
    .card-details-header {
        padding: 1.5rem 1.5rem 0.5rem 1.5rem !important; /* Reduced top/bottom */
    }
    
    /* Compact Tabs */
    .card-tabs {
        margin-bottom: 1rem !important;
    }
    .card-tab {
        padding: 0.5rem !important;
        font-size: 0.8rem !important;
    }
    
    /* Compact Overview Content */
    .freak-verdict {
        padding: 0.75rem !important; /* Reduced padding */
        margin-bottom: 0.75rem !important; /* Reduced margin */
    }
    .verdict-title {
        font-size: 0.65rem !important;
        margin-bottom: 0.25rem !important;
    }
    .verdict-text {
        font-size: 0.85rem !important;
    }
    
    /* Compact Welcome Offer */
    #modal-welcome-container {
        margin-bottom: 0.75rem !important;
    }
    /* Assuming welcome-offer-box style is handled elsewhere or inline, overrides here if class exists in css files */
    
    #modal-bonus-value {
        font-size: 1.5rem !important;
    }
    
    /* Compact Stats Box */
    .stat-box {
        padding: 0.75rem !important;
    }
    .stat-value {
        font-size: 1.5rem !important;
    }
    
    /* Overall Content Padding */
    .card-details-right {
        padding: 0 !important;
    }
    .card-tab-content {
        padding: 0 1.5rem 10rem 1.5rem !important;
    }
}
`;
document.head.appendChild(style);

// Close modal when clicking outside
window.onclick = function(event) {
    const detailsModal = document.getElementById('card-details-modal');
    if (event.target == detailsModal) {
        closeCardDetailsModal();
    }
}
</script>

<!-- Report Success Modal -->
<!-- Note: We use inline styles with !important to override the global .modal mobile styles in card_modal.css which force full screen -->
<div id="report-success-modal" class="modal" style="display: none; align-items: center !important; justify-content: center !important; background: rgba(0,0,0,0.5) !important; z-index: 10001; padding: 1rem !important;">
    <div style="background: white !important; padding: 2rem; border-radius: 16px !important; text-align: center; max-width: 90% !important; width: 320px !important; box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important; margin: auto !important; height: auto !important; position: relative !important;">
        <div style="width: 50px; height: 50px; background: #DEF7EC; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem auto;">
            <span class="material-icons" style="font-size: 30px; color: #10B981;">check</span>
        </div>
        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700; color: #1F2937;">Report Sent</h3>
        <p style="color: #6B7280; font-size: 0.875rem; margin: 0 0 1.5rem 0; line-height: 1.5;">
            Thank you for helping us keep our data accurate. We've received your report.
        </p>
        <button onclick="closeReportSuccessModal()" style="background: #1F2937; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; width: 100%; cursor: pointer;">
            Got it
        </button>
    </div>
</div>

<script>
function showReportSuccessModal() {
    document.getElementById('report-success-modal').style.display = 'flex';
}
function closeReportSuccessModal() {
    document.getElementById('report-success-modal').style.display = 'none';
}
</script>
