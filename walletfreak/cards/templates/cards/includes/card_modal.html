<!-- Card Detail Modal -->
<div id="card-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
    <div class="modal-content" style="background: white; width: 90%; max-width: 1000px; border-radius: 32px; overflow: hidden; display: flex; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.95); transition: transform 0.3s; height: 85vh;">
        
        <!-- Left Side: Card Visual -->
        <div style="width: 35%; background: #F8FAFC; padding: 3rem 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-right: 1px solid #F1F5F9;">
            <div id="modal-card-visual" style="width: 260px; height: 164px; background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); border-radius: 16px; box-shadow: 0 20px 40px -5px rgba(0,0,0,0.3); position: relative; overflow: hidden; padding: 1.25rem; display: flex; flex-direction: column; justify-content: space-between; color: white; margin-bottom: 2rem;">
                <!-- Card content will be injected via JS -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="font-size: 0.65rem; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; opacity: 0.9;" id="modal-card-issuer-visual">AMERICAN EXPRESS</div>
                    <span class="material-icons" style="font-size: 20px; opacity: 0.8;">contactless</span>
                </div>
                
                <div>
                    <div style="width: 36px; height: 26px; background: rgba(255,255,255,0.3); border-radius: 4px; margin-bottom: 1rem; backdrop-filter: blur(4px);"></div>
                    <div style="font-family: monospace; font-size: 0.9rem; letter-spacing: 0.15em; margin-bottom: 0.5rem; opacity: 0.9; text-shadow: 0 1px 2px rgba(0,0,0,0.1);" id="modal-card-number">•••• •••• •••• 4242</div>
                    <div style="font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.8;" id="modal-card-holder">YOUR NAME</div>
                </div>

                <div style="position: absolute; bottom: 1.25rem; right: 1.25rem; display: flex;">
                    <div style="width: 20px; height: 20px; background: rgba(255,255,255,0.4); border-radius: 50%;"></div>
                    <div style="width: 20px; height: 20px; background: rgba(255,255,255,0.4); border-radius: 50%; margin-left: -8px;"></div>
                </div>
            </div>
            
            <div style="text-align: center; width: 100%;">
                <div style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 0.75rem 1.5rem; display: inline-flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 2rem;">
                    <span style="color: #F59E0B; font-size: 20px;" class="material-icons">star</span>
                    <span id="modal-match-score" style="font-weight: 800; color: #0F172A; font-size: 1rem;">98% Match</span>
                </div>
                
                <div>
                    <div style="font-size: 0.7rem; color: #94A3B8; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.25rem;">ANNUAL FEE</div>
                    <div id="modal-annual-fee" style="font-size: 1.75rem; font-weight: 800; color: #0F172A;">$550</div>
                </div>
            </div>
        </div>

        <!-- Right Side: Details -->
        <div style="width: 65%; padding: 3rem; position: relative; overflow-y: auto; display: flex; flex-direction: column;">
            <button onclick="closeCardModal()" style="position: absolute; top: 2rem; right: 2rem; background: none; border: none; cursor: pointer; color: #94A3B8; transition: color 0.2s; padding: 0.5rem; border-radius: 50%;">
                <span class="material-icons" style="font-size: 24px;">close</span>
            </button>

            <!-- Header -->
            <div style="margin-bottom: 1.5rem;">
                <h2 id="modal-card-name" style="font-size: 2.25rem; font-weight: 800; color: #0F172A; margin: 0 0 0.25rem 0; line-height: 1.1; letter-spacing: -0.02em;">Sapphire Reserve</h2>
                <div id="modal-issuer" style="font-size: 1rem; color: #64748B; font-weight: 500;">Chase</div>
            </div>

            <!-- Action Buttons (Top) -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                <button id="add-wallet-btn" onclick="addToWalletFromModal()" style="background: #0F172A; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; font-size: 0.9375rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; min-width: 160px; justify-content: center;">
                    <span id="add-wallet-text">Add to Wallet</span>
                    <span class="material-icons" id="add-wallet-icon" style="font-size: 18px;">check</span>
                    <span class="material-icons" id="add-wallet-loader" style="display: none; animation: spin 1s linear infinite; font-size: 18px;">hourglass_empty</span>
                </button>
                <a id="modal-apply-link" href="#" target="_blank" style="padding: 0.75rem 1.5rem; background: white; color: #0F172A; border: 1px solid #E2E8F0; border-radius: 8px; font-weight: 600; font-size: 0.9375rem; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;">
                    Apply <span class="material-icons" style="font-size: 18px;">open_in_new</span>
                </a>
            </div>

            <!-- Freak Verdict -->
            <div style="background: #F5F3FF; border: 1px solid #E9D5FF; border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #7C3AED; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <span class="material-icons" style="font-size: 20px;">bolt</span>
                </div>
                <div>
                    <div style="font-size: 0.75rem; font-weight: 800; color: #5B21B6; letter-spacing: 0.05em; margin-bottom: 0.5rem; text-transform: uppercase;">THE FREAK VERDICT</div>
                    <p id="modal-verdict" style="margin: 0; color: #4B5563; line-height: 1.6; font-size: 0.9375rem;">
                        The easiest travel card to use. The $300 credit applies automatically to any travel, making the effective fee $250.
                    </p>
                </div>
            </div>

            <!-- Welcome Offer -->
            <div id="modal-welcome-offer-container" style="margin-bottom: 2.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; color: #94A3B8; font-weight: 700; font-size: 0.75rem; letter-spacing: 0.05em; text-transform: uppercase;">
                    <span class="material-icons" style="font-size: 16px;">card_giftcard</span> WELCOME OFFER
                </div>
                <div style="background: #F8FAFC; border: 1px solid #F1F5F9; border-radius: 16px; padding: 1.5rem; display: flex; align-items: center; gap: 2rem;">
                    <div id="modal-welcome-value" style="font-size: 2rem; font-weight: 800; color: #0F172A; line-height: 1;">
                        60,000 Points
                    </div>
                    <div style="width: 1px; height: 40px; background: #E2E8F0;"></div>
                    <div id="modal-welcome-terms" style="color: #64748B; font-size: 0.9375rem; font-weight: 500;">
                        after $4k spend in 3 months
                    </div>
                </div>
            </div>

            <!-- Benefits Columns -->
            <div id="modal-all-benefits" style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem;">
                <!-- Injected via JS -->
            </div>
            
            <div style="margin-top: auto; padding-top: 2rem; text-align: center; font-size: 0.75rem; color: #94A3B8;">
                Variable APR: 22.49% - 29.49% Var. Terms apply. Rates as of Oct 2024.
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="success-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); z-index: 2000; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
    <div style="background: white; width: 90%; max-width: 400px; border-radius: 24px; padding: 3rem 2rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.95); transition: transform 0.3s;">
        <div style="width: 64px; height: 64px; background: #10B981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
            <span class="material-icons" style="font-size: 36px; color: white;">check_circle</span>
        </div>
        <h3 style="font-size: 1.5rem; font-weight: 800; color: #0F172A; margin: 0 0 0.5rem 0;">Card Added!</h3>
        <p style="color: #64748B; margin: 0 0 2rem 0; font-size: 0.95rem;">Successfully added to your wallet</p>
        <button onclick="closeSuccessModal()" style="width: 100%; background: #0F172A; color: white; border: none; padding: 1rem; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer;">
            Got it!
        </button>
    </div>
</div>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Accordion styles for card modal */
.modal-benefit-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #F1F5F9;
}

.modal-benefit-row:last-child {
    border-bottom: none;
}
</style>

<script>
let currentModalCardId = null;
const allCardsData = {{ cards_json|safe }};

function openCardModal(cardId) {
    currentModalCardId = cardId;
    const card = allCardsData[cardId];
    
    if (!card) {
        console.error('Card not found:', cardId);
        return;
    }
    
    // Update card name and issuer
    document.getElementById('modal-card-name').textContent = card.name || 'Credit Card';
    document.getElementById('modal-issuer').textContent = card.issuer || 'Issuer';
    document.getElementById('modal-card-issuer-visual').textContent = (card.issuer || 'CREDIT CARD').toUpperCase();
    
    // Update annual fee
    const annualFee = card.annual_fee || 0;
    document.getElementById('modal-annual-fee').textContent = '$' + annualFee;
    
    // Update Match Score
    const matchScore = userMatchScores[cardId] || 0;
    document.getElementById('modal-match-score').textContent = `${matchScore}% Match`;
    
    // Update card visual background color based on issuer
    const cardVisual = document.getElementById('modal-card-visual');
    if (card.issuer && card.issuer.toLowerCase().includes('american express')) {
        if (card.name.toLowerCase().includes('platinum')) {
            cardVisual.style.background = 'linear-gradient(135deg, #E2E8F0 0%, #94A3B8 100%)';
            cardVisual.style.color = '#1F2937';
        } else if (card.name.toLowerCase().includes('gold')) {
            cardVisual.style.background = 'linear-gradient(135deg, #FCD34D 0%, #F59E0B 100%)';
            cardVisual.style.color = '#78350F';
        } else {
            cardVisual.style.background = 'linear-gradient(135deg, #94A3B8 0%, #64748B 100%)';
            cardVisual.style.color = 'white';
        }
    } else if (card.issuer && card.issuer.toLowerCase().includes('chase')) {
        cardVisual.style.background = 'linear-gradient(135deg, #1040C1 0%, #002685 100%)';
        cardVisual.style.color = 'white';
    } else if (card.issuer && card.issuer.toLowerCase().includes('capital one')) {
        cardVisual.style.background = 'linear-gradient(135deg, #002D5C 0%, #001529 100%)';
        cardVisual.style.color = 'white';
    } else {
        cardVisual.style.background = 'linear-gradient(135deg, #6366F1 0%, #4F46E5 100%)';
        cardVisual.style.color = 'white';
    }
    
    // Update verdict
    const verdict = card.verdict || card.description || 'This card offers great value for your spending needs.';
    document.getElementById('modal-verdict').textContent = verdict;
    
    // Welcome Offer
    const welcomeOffer = card.sign_up_bonus;
    const welcomeContainer = document.getElementById('modal-welcome-offer-container');
    
    if (welcomeOffer && welcomeOffer.value > 0) {
        welcomeContainer.style.display = 'block';
        
        let valueText = '';
        
        if (welcomeOffer.currency && welcomeOffer.currency.toLowerCase() === 'cash') {
            valueText = `$${welcomeOffer.value} Cash Back`;
        } else {
            valueText = `${welcomeOffer.value.toLocaleString()} ${welcomeOffer.currency || 'Points'}`;
        }
        
        document.getElementById('modal-welcome-value').textContent = valueText;
        document.getElementById('modal-welcome-terms').textContent = welcomeOffer.terms || '';
    } else {
        welcomeContainer.style.display = 'none';
    }
    
    // Parse benefits
    const benefits = card.benefits || [];
    const allBenefitsContainer = document.getElementById('modal-all-benefits');
    
    if (benefits.length > 0) {
        const multipliers = [];
        const credits = [];
        
        benefits.forEach((benefit) => {
            const desc = benefit.description || '';
            const shortDesc = benefit.short_description || desc;
            const benefitType = benefit.benefit_type || '';
            const numericValue = benefit.numeric_value;
            
            let formattedValue = '';
            if (benefitType === 'Multiplier' && numericValue) {
                formattedValue = `${numericValue}x`;
            } else if (benefitType === 'Cashback' && numericValue) {
                formattedValue = `${numericValue}%`;
            } else if (benefitType === 'Credit' && numericValue) {
                formattedValue = `$${numericValue}`;
            } else if (numericValue) {
                 formattedValue = numericValue.toLocaleString();
            }

            const benefitData = {
                shortDescription: shortDesc,
                formattedValue: formattedValue,
                benefitType: benefitType
            };
            
            if (benefitType === 'Credit') {
                credits.push(benefitData);
            } else {
                multipliers.push(benefitData);
            }
        });
        
        let html = `
            <!-- Multipliers Column -->
            <div>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #94A3B8; font-weight: 700; font-size: 0.75rem; letter-spacing: 0.05em; text-transform: uppercase;">
                    <span class="material-icons" style="font-size: 16px;">trending_up</span> MULTIPLIERS
                </div>
                <div style="display: flex; flex-direction: column;">
        `;
        
        if (multipliers.length > 0) {
            multipliers.forEach(benefit => {
                html += `
                    <div class="modal-benefit-row">
                        <span style="color: #334155; font-size: 0.9375rem; font-weight: 500;">${benefit.shortDescription}</span>
                        ${benefit.formattedValue ? `<div style="font-size: 0.875rem; font-weight: 700; color: #2563EB; background: #EFF6FF; padding: 0.25rem 0.625rem; border-radius: 6px;">${benefit.formattedValue}</div>` : ''}
                    </div>
                `;
            });
        } else {
            html += `<div style="color: #94A3B8; font-size: 0.875rem; font-style: italic;">No multipliers</div>`;
        }
        
        html += `
                </div>
            </div>
            
            <!-- Credits Column -->
            <div>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #94A3B8; font-weight: 700; font-size: 0.75rem; letter-spacing: 0.05em; text-transform: uppercase;">
                    <span class="material-icons" style="font-size: 16px;">verified_user</span> CREDITS
                </div>
                <div style="display: flex; flex-direction: column;">
        `;
        
        if (credits.length > 0) {
            credits.forEach(benefit => {
                html += `
                    <div class="modal-benefit-row">
                        <span style="color: #334155; font-size: 0.9375rem; font-weight: 500;">${benefit.shortDescription}</span>
                        <div style="font-size: 0.875rem; font-weight: 700; color: #16A34A; background: #DCFCE7; padding: 0.25rem 0.625rem; border-radius: 6px;">${benefit.formattedValue}</div>
                    </div>
                `;
            });
        } else {
            html += `<div style="color: #94A3B8; font-size: 0.875rem; font-style: italic;">No credits</div>`;
        }
        
        html += `
                </div>
            </div>
        `;
        
        allBenefitsContainer.innerHTML = html;
    } else {
        allBenefitsContainer.innerHTML = '<div style="grid-column: 1 / -1; color: #9CA3AF; font-size: 0.875rem; text-align: center; padding: 1rem;">No benefits available</div>';
    }
    
    // Update apply link
    const applyLink = document.getElementById('modal-apply-link');
    applyLink.href = card.application_url || '#';
    
    // Show modal
    const modal = document.getElementById('card-modal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.style.opacity = '1';
        modal.querySelector('.modal-content').style.transform = 'scale(1)';
    }, 10);
}

function closeCardModal() {
    const modal = document.getElementById('card-modal');
    modal.style.opacity = '0';
    modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
    currentModalCardId = null;
}

function addToWalletFromModal() {
    if (!currentModalCardId) return;
    
    // Show loader
    const btn = document.getElementById('add-wallet-btn');
    const text = document.getElementById('add-wallet-text');
    const icon = document.getElementById('add-wallet-icon');
    const loader = document.getElementById('add-wallet-loader');
    
    btn.disabled = true;
    btn.style.opacity = '0.8';
    btn.style.cursor = 'not-allowed';
    text.textContent = 'Adding...';
    icon.style.display = 'none';
    loader.style.display = 'inline-block';
    
    // Submit form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/dashboard/add-card/${currentModalCardId}/`;
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCookie('csrftoken');
    form.appendChild(csrfInput);
    
    const ajaxInput = document.createElement('input');
    ajaxInput.type = 'hidden';
    ajaxInput.name = 'ajax';
    ajaxInput.value = '1';
    form.appendChild(ajaxInput);
    
    document.body.appendChild(form);
    
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(res => res.json())
    .then(data => {
        document.body.removeChild(form);
        
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        text.textContent = 'Add to Wallet';
        icon.style.display = 'inline-block';
        loader.style.display = 'none';
        
        if (data.success) {
            closeCardModal();
            showSuccessModal();
        } else {
            alert(data.error || 'Failed to add card');
        }
    })
    .catch(err => {
        if (document.body.contains(form)) {
            document.body.removeChild(form);
        }
        
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        text.textContent = 'Add to Wallet';
        icon.style.display = 'inline-block';
        loader.style.display = 'none';
        
        console.error('Error adding card:', err);
        alert('Failed to add card to wallet');
    });
}

function showSuccessModal() {
    const modal = document.getElementById('success-modal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.style.opacity = '1';
        modal.querySelector('div > div').style.transform = 'scale(1)';
    }, 10);
}

function closeSuccessModal() {
    const modal = document.getElementById('success-modal');
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.style.display = 'none';
        window.location.reload();
    }, 300);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('card-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeCardModal();
            }
        });
    }
});
</script>
