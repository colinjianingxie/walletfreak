<!-- Card Details Modal (Shared) -->
<div id="card-details-modal" class="modal" style="display: none;">
    <div class="modal-content card-details-content">
        <!-- Left Column: Card Visual & Actions -->
        <div class="card-details-left">
            <!-- Card Visual -->
            <div class="card-visual-container">
                <div id="modal-card-visual" class="credit-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div id="modal-card-issuer-logo" style="font-size: 0.75rem; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; opacity: 0.9;">ISSUER</div>
                        <span class="material-icons" style="font-size: 28px; opacity: 0.8;">contactless</span>
                    </div>
                    <div class="credit-card-chip"></div>
                    <div class="credit-card-number">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242</div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div class="credit-card-name">YOUR NAME</div>
                        <div style="display: flex; gap: 2px;">
                            <div style="width: 20px; height: 20px; background: #EB001B; border-radius: 50%; opacity: 0.9;"></div>
                            <div style="width: 20px; height: 20px; background: #F79E1B; border-radius: 50%; margin-left: -8px; opacity: 0.9;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desktop: Match Badge -->
            <div class="match-badge">
                <span class="material-icons" style="font-size: 16px;">star</span>
                <span id="modal-match-score">90% Match</span>
            </div>

            <!-- Desktop: Annual Fee -->
            <div class="desktop-annual-fee" style="text-align: center; margin: 1.5rem 0;">
                <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.5rem;">ANNUAL FEE</div>
                <div id="modal-annual-fee" style="font-size: 2rem; font-weight: 800; color: #1F2937;">$0</div>
            </div>

            <!-- Desktop: Action Buttons -->
            <div class="card-actions">
                <button id="modal-add-btn" class="btn-add-wallet" onclick="addToWalletFromModal()">
                    Add to Wallet <span class="material-icons" style="font-size: 18px;">check</span>
                </button>
                <button class="btn-apply" id="modal-apply-btn" onclick="window.open('#', '_blank')">
                    Apply Now <span class="material-icons" style="font-size: 16px;">open_in_new</span>
                </button>
            </div>
        </div>

        <!-- Right Column: Details & Tabs -->
        <div class="card-details-right">
            <!-- Header -->
            <div class="card-details-header">
                <div>
                    <h2 id="modal-card-name" style="font-size: 1.75rem; font-weight: 800; color: #1F2937; margin: 0 0 0.25rem 0; line-height: 1.2;">Card Name</h2>
                    <div id="modal-card-issuer" style="color: #64748B; font-size: 1rem; font-weight: 500;">Issuer</div>
                </div>
                <button class="modal-close-desktop" onclick="closeCardDetailsModal()">Ã—</button>
            </div>

            <!-- Tabs -->
            <div class="card-tabs">
                <button class="card-tab active" onclick="switchCardTab('overview')">
                    <span class="material-icons">grid_view</span> Overview
                </button>
                <button class="card-tab" onclick="switchCardTab('earning')">
                    <span class="material-icons">trending_up</span> Earning
                </button>
                <button class="card-tab" onclick="switchCardTab('benefits')">
                    <span class="material-icons">verified</span> Benefits
                </button>
            </div>

            <!-- Tab Content -->
            <div class="card-tab-content">
                <!-- Overview Tab -->
                <div id="tab-overview" class="tab-pane active">
                    <!-- Freak Verdict -->
                    <div class="freak-verdict">
                        <div class="verdict-icon">
                            <span class="material-icons">bolt</span>
                        </div>
                        <div>
                            <div class="verdict-title">THE FREAK VERDICT</div>
                            <div id="modal-verdict-text" class="verdict-text">
                                No verdict available.
                            </div>
                        </div>
                    </div>

                    <!-- Welcome Offer -->
                    <div style="margin-bottom: 2rem;" id="modal-welcome-container">
                        <div style="font-size: 0.75rem; font-weight: 700; color: #94A3B8; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 14px;">card_giftcard</span>
                            WELCOME OFFER
                        </div>
                        <div class="welcome-offer-box">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="font-size: 2rem; font-weight: 800; color: #1F2937; line-height: 1;" id="modal-bonus-value">60,000 Points</div>
                                <div style="font-size: 0.875rem; color: #64748B; font-weight: 500;" id="modal-bonus-terms">after $4k spend in 6 months</div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Stats Grid -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                        <div class="stat-box">
                            <div class="stat-label">CREDITS VALUE</div>
                            <div class="stat-value" style="color: #10B981;" id="modal-credits-value">$0</div>
                        </div>
                    </div>
                </div>

                <!-- Earning Tab -->
                <div id="tab-earning" class="tab-pane">
                    <div class="pro-tip">
                        <span class="material-icons" style="color: #6366F1; font-size: 16px;">lightbulb</span>
                        <span id="modal-pro-tip-text">Pro Tip: Use this card for <strong>Travel</strong> to maximize your return on spend.</span>
                    </div>
                    <div id="modal-earning-rows">
                        <!-- Populated by JS with expandable rows -->
                    </div>
                </div>

                <!-- Benefits Tab -->
                <div id="tab-benefits" class="tab-pane">
                    <div id="modal-benefits-rows">
                        <!-- Populated by JS with expandable rows -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Anniversary Date Modal (for adding cards from explore) -->
<div id="anniversary-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
                <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0;">Set Card Anniversary</h3>
                <p style="color: #64748B; margin: 0; font-size: 0.875rem;">When did you get this card?</p>
            </div>
            <button class="modal-close-desktop" onclick="closeAnniversaryModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94A3B8;">Ã—</button>
        </div>

        <!-- Card Info -->
        <div style="background: #F9FAFB; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
            <div style="font-size: 0.75rem; font-weight: 700; color: #64748B; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.5rem;">CARD</div>
            <div id="anniversary-card-name" style="font-weight: 700; font-size: 1.125rem; color: #1F2937;">Loading...</div>
        </div>

        <!-- Date Input -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1F2937;">Anniversary Date</label>
            <input type="date" id="anniversary-date-input" 
                   style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 1rem; font-weight: 600;">
            <p style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">This helps track which months/quarters are available for benefit tracking.</p>
        </div>

        <!-- Example -->
        <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <div style="font-weight: 600; color: #92400E; margin-bottom: 0.25rem; font-size: 0.875rem;">ðŸ’¡ Example</div>
            <div style="color: #78350F; font-size: 0.875rem;">If you got your card in October 2025, months before October will be grayed out.</div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 0.75rem;">
            <button onclick="closeAnniversaryModal()" style="flex: 1; background: #F3F4F6; color: #64748B; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Cancel
            </button>
            <button onclick="saveAnniversaryDate()" style="flex: 1; background: #7C3AED; color: white; border: none; padding: 0.875rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                Save Anniversary
            </button>
        </div>
    </div>
</div>

<script>
// Shared Modal Logic
let currentModalCardId = null;

function openCardModal(cardId) {
    // Check if allCardsData exists
    if (typeof allCardsData === 'undefined') {
        console.error('allCardsData is not defined');
        return;
    }

    // Handle both string IDs (from personality page) and numeric IDs (from sample data)
    let card = allCardsData[cardId];
    // Fallback for array-based sampleCards if used
    if (!card && Array.isArray(allCardsData)) {
        card = allCardsData.find(c => c.id == cardId);
    }

    if (!card) {
        console.error('Card not found:', cardId);
        return;
    }

    currentModalCardId = cardId;
    const modal = document.getElementById('card-details-modal');
    
    // Populate Data
    document.getElementById('modal-card-name').textContent = card.name;
    document.getElementById('modal-card-issuer').textContent = card.issuer;
    document.getElementById('modal-card-issuer-logo').textContent = (card.issuer || 'ISSUER').toUpperCase();
    
    // Visual
    const visual = document.getElementById('modal-card-visual');
    // Reset classes
    visual.className = 'credit-card';
    // Add specific class based on issuer/name logic
    let imageClass = 'card-default';
    const nameLower = card.name.toLowerCase();
    const issuerLower = (card.issuer || '').toLowerCase();
    
    if (issuerLower.includes('american express') || issuerLower.includes('amex')) {
        if (nameLower.includes('platinum')) imageClass = 'card-amex-platinum';
        else if (nameLower.includes('gold')) imageClass = 'card-gold';
        else imageClass = 'card-amex-platinum'; // Fallback
    } else if (issuerLower.includes('chase')) {
        imageClass = 'card-chase';
    } else if (issuerLower.includes('capital one')) {
        imageClass = 'card-capital-one';
    } else if (issuerLower.includes('citi')) {
        imageClass = 'card-citi';
    }
    
    // If card object has imageClass property (from sampleCards), use it
    if (card.imageClass) imageClass = card.imageClass;
    
    visual.classList.add(imageClass);
    
    // Stats
    document.getElementById('modal-match-score').textContent = (card.matchScore || '90') + (String(card.matchScore).includes('%') ? '' : '% Match');
    document.getElementById('modal-annual-fee').textContent = '$' + (card.annualFee || card.annual_fee || 0);
    document.getElementById('modal-verdict-text').textContent = card.verdict || card.description || 'No verdict available.';
    
    // Welcome Offer
    const bonusValue = card.welcomeOffer ? card.welcomeOffer.value : (card.sign_up_bonus ? card.sign_up_bonus.value : 0);
    const bonusTerms = card.welcomeOffer ? card.welcomeOffer.terms : (card.sign_up_bonus ? card.sign_up_bonus.terms : '');
    
    if (bonusValue) {
        document.getElementById('modal-bonus-value').textContent = bonusValue;
        document.getElementById('modal-bonus-terms').textContent = bonusTerms;
        document.getElementById('modal-welcome-container').style.display = 'block';
    } else {
        document.getElementById('modal-welcome-container').style.display = 'none';
    }

    // Credits
    document.getElementById('modal-credits-value').textContent = '$' + (card.creditsValue || 0);
    
    // Set annual fee
    const annualFee = '$' + (card.annualFee || card.annual_fee || 0);
    document.getElementById('modal-annual-fee').textContent = annualFee;
    
    // Check if card is already in wallet and update Add to Wallet button
    const addBtn = document.getElementById('modal-add-btn');
    const isInWallet = typeof walletCardIds !== 'undefined' && walletCardIds.has(cardId);
    
    if (isInWallet) {
        addBtn.disabled = true;
        addBtn.innerHTML = 'Already in Wallet <span class="material-icons" style="font-size: 18px;">check_circle</span>';
        addBtn.style.background = '#94A3B8';
        addBtn.style.cursor = 'not-allowed';
        addBtn.onclick = null;
    } else {
        addBtn.disabled = false;
        addBtn.innerHTML = 'Add to Wallet <span class="material-icons" style="font-size: 18px;">add</span>';
        addBtn.style.background = '#0F172A';
        addBtn.style.cursor = 'pointer';
        addBtn.onclick = addToWalletFromModal;
    }
    
    // Apply Link
    const applyBtn = document.getElementById('modal-apply-btn');
    applyBtn.onclick = () => window.open(card.application_url || '#', '_blank');

    // Earning Tab Population with Expandable Rows
    const earningContainer = document.getElementById('modal-earning-rows');
    earningContainer.innerHTML = '';
    
    // Support multiple field names for earning rates
    // Also check benefits for Multiplier and Cashback type items
    let earning = card.earning_rates || card.earning || card.rewards_structure || [];
    
    // If no earning rates found, extract from benefits with benefit_type "Multiplier" or "Cashback"
    if (!earning || earning.length === 0) {
        const benefits = card.benefits || [];
        earning = benefits.filter(b => b.benefit_type === 'Multiplier' || b.benefit_type === 'Cashback').map(b => ({
            category: b.short_description || b.name || b.title || b.description,
            rate: b.numeric_value || b.value || b.multiplier,
            currency: b.benefit_type === 'Cashback' ? 'cash' : (b.currency || 'points')
        }));
    }
    
    if (Array.isArray(earning) && earning.length > 0) {
        // Find the highest earning rate for Pro Tip
        let highestRate = 0;
        let highestCategory = '';
        
        earning.forEach((item, index) => {
            // Support different field structures
            const cat = item.category || item.cat || item.description || 'Category';
            const rate = item.rate || item.mult || item.multiplier || item.value || 0;
            const currency = item.currency || 'points';
            
            // Track highest rate (excluding "All Purchases" or generic categories)
            if (rate > highestRate && !cat.toLowerCase().includes('all purchases') && !cat.toLowerCase().includes('everything')) {
                highestRate = rate;
                highestCategory = cat;
            }
            
            // Format multiplier display (e.g., "10x", "5x", "2%")
            let mult;
            if (currency.toLowerCase().includes('cash') || currency.toLowerCase().includes('%')) {
                mult = `${rate}%`;
            } else {
                mult = `${rate}x`;
            }
            
            // Build details text
            let details = item.details || item.description_long || item.additional_details || '';
            if (!details) {
                // Generate default details text
                if (currency.toLowerCase().includes('cash')) {
                    details = `Earn ${rate}% cash back on ${cat.toLowerCase()}.`;
                } else {
                    details = `Earn ${rate}x ${currency} on ${cat.toLowerCase()}.`;
                }
            }
            
            const wrapper = document.createElement('div');
            wrapper.className = 'expandable-row-wrapper';
            wrapper.innerHTML = `
                <div class="expandable-row" onclick="toggleExpandable(this)">
                    <div class="earning-cat">${cat}</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div class="earning-mult">${mult}</div>
                        <span class="material-icons expand-arrow" style="font-size: 20px; color: #94A3B8;">expand_more</span>
                    </div>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">${details}</div>
                </div>
            `;
            earningContainer.appendChild(wrapper);
        });
        
        // Update Pro Tip with highest earning category
        if (highestCategory) {
            document.getElementById('modal-pro-tip-text').innerHTML = `Pro Tip: Use this card for <strong>${highestCategory}</strong> to maximize your return on spend.`;
        }
    } else {
        earningContainer.innerHTML = '<div style="color: #64748B; text-align: center; padding: 2rem;">No earning information available.</div>';
    }

    // Benefits Tab Population with Expandable Rows
    const benefitsContainer = document.getElementById('modal-benefits-rows');
    benefitsContainer.innerHTML = '';
    
    const benefits = card.benefits || [];
    // Filter out benefits with benefit_type "Multiplier" or "Cashback"
    const filteredBenefits = benefits.filter(b => b.benefit_type !== 'Multiplier' && b.benefit_type !== 'Cashback');
    
    if (Array.isArray(filteredBenefits) && filteredBenefits.length > 0) {
        filteredBenefits.forEach((benefit, index) => {
            // Use the correct field names from database
            const name = benefit.short_description || benefit.name || benefit.title || 'Unnamed Benefit';
            const value = benefit.numeric_value || benefit.value || benefit.amount || 'Included';
            
            // Combine details and additional_details for dropdown content
            let detailsText = '';
            if (benefit.description) {
                detailsText = benefit.description;
            }
            if (benefit.additional_details) {
                detailsText += (detailsText ? ' ' : '') + benefit.additional_details;
            }
            if (!detailsText) {
                detailsText = 'No additional details available.';
            }
            
            // Format value with proper styling
            let valueDisplay = String(value);
            let valueClass = 'benefit-value';
            if (valueDisplay.includes('$') || !isNaN(parseFloat(value))) {
                // If numeric or contains $, show as money
                if (!valueDisplay.includes('$')) {
                    valueDisplay = '$' + valueDisplay;
                }
                valueClass += ' benefit-value-money';
            } else if (valueDisplay.toLowerCase() === 'included') {
                valueClass += ' benefit-value-included';
            }
            
            const wrapper = document.createElement('div');
            wrapper.className = 'expandable-row-wrapper';
            wrapper.innerHTML = `
                <div class="expandable-row" onclick="toggleExpandable(this)">
                    <div class="earning-cat">${name}</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div class="${valueClass}">${valueDisplay}</div>
                        <span class="material-icons expand-arrow" style="font-size: 20px; color: #94A3B8;">expand_more</span>
                    </div>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">${detailsText}</div>
                </div>
            `;
            benefitsContainer.appendChild(wrapper);
        });
    } else {
        benefitsContainer.innerHTML = '<div style="color: #64748B; text-align: center; padding: 2rem;">No benefits information available.</div>';
    }


    // Reset Tabs
    switchCardTab('overview');
    
    modal.style.display = 'flex';
}

function closeCardDetailsModal() {
    document.getElementById('card-details-modal').style.display = 'none';
    currentModalCardId = null;
}

function switchCardTab(tabName) {
    // Update Tab Buttons
    document.querySelectorAll('.card-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('onclick').includes(tabName)) {
            btn.classList.add('active');
        }
    });
    
    // Update Tab Content
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    document.getElementById(`tab-${tabName}`).classList.add('active');
}

function toggleExpandable(element) {
    const wrapper = element.parentElement;
    const content = wrapper.querySelector('.expandable-content');
    const arrow = element.querySelector('.expand-arrow');
    
    const isExpanded = wrapper.classList.contains('expanded');
    
    if (isExpanded) {
        // Collapse
        wrapper.classList.remove('expanded');
        arrow.style.transform = 'rotate(0deg)';
    } else {
        // Expand
        wrapper.classList.add('expanded');
        arrow.style.transform = 'rotate(180deg)';
    }
}

// Anniversary Modal Logic
let currentAnniversaryCardId = null;
let pendingCardForAdd = null;

function openAnniversaryModal(cardId, cardName) {
    currentAnniversaryCardId = cardId;
    document.getElementById('anniversary-card-name').textContent = cardName;
    // Default to current date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('anniversary-date-input').value = today;
    document.getElementById('anniversary-modal').style.display = 'flex';
}

function closeAnniversaryModal() {
    document.getElementById('anniversary-modal').style.display = 'none';
    currentAnniversaryCardId = null;
    pendingCardForAdd = null;
}

function saveAnniversaryDate() {
    const date = document.getElementById('anniversary-date-input').value;
    if (!date) {
        alert('Please select a date');
        return;
    }
    
    // Close anniversary modal
    closeAnniversaryModal();
    
    // Proceed with adding the card
    if (pendingCardForAdd) {
        proceedWithAddCard(date);
    }
}

function proceedWithAddCard(anniversaryDate) {
    if (!currentModalCardId) return;
    
    const btn = document.getElementById('modal-add-btn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'Adding... <span class="material-icons" style="animation: spin 1s linear infinite;">hourglass_empty</span>';
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/dashboard/add-card/${currentModalCardId}/`;
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCookie('csrftoken');
    form.appendChild(csrfInput);
    
    const ajaxInput = document.createElement('input');
    ajaxInput.type = 'hidden';
    ajaxInput.name = 'ajax';
    ajaxInput.value = '1';
    form.appendChild(ajaxInput);

    // Add anniversary date
    if (anniversaryDate) {
        const anniversaryInput = document.createElement('input');
        anniversaryInput.type = 'hidden';
        anniversaryInput.name = 'anniversary_date';
        anniversaryInput.value = anniversaryDate;
        form.appendChild(anniversaryInput);
    }
    
    document.body.appendChild(form);
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(res => res.json())
    .then(data => {
        document.body.removeChild(form);
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
            // Show success state or reload
            btn.innerHTML = 'Added! <span class="material-icons">check_circle</span>';
            btn.style.background = '#10B981';

            // Add card to walletCardIds set to update button state on reload
            if (typeof walletCardIds !== 'undefined') {
                walletCardIds.add(currentModalCardId);
            }
            
            setTimeout(() => {
                closeCardDetailsModal();
                window.location.reload();
            }, 1000);
        } else {
            alert(data.error || 'Failed to add card');
        }
    })
    .catch(err => {
        if (document.body.contains(form)) document.body.removeChild(form);
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('Error adding card: ' + err.message);
    });
}

function addToWalletFromModal() {
    if (!currentModalCardId) return;

    // Check if we are using mock data (numeric IDs)
    if (typeof currentModalCardId === 'number') {
        alert(`Added card to wallet! (Mock Action)`);
        return;
    }
    
    // Get current card data for the modal
    const card = allCardsData[currentModalCardId]; // Assuming allCardsData is available globally
    const cardName = card ? card.name : 'Card';
    
    // Store the current card for after anniversary is set
    pendingCardForAdd = true;
    
    // Open anniversary modal
    openAnniversaryModal(currentModalCardId, cardName);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add spin animation
const style = document.createElement('style');
style.innerHTML = `
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);

// Close modal when clicking outside
window.onclick = function(event) {
    const detailsModal = document.getElementById('card-details-modal');
    if (event.target == detailsModal) {
        closeCardDetailsModal();
    }
}
</script>
