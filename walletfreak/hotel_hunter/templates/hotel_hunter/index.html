{% extends "base.html" %}
{% load static %}

{% block breadcrumb_section %}Tools{% endblock %}
{% block page_title %}Hotel Hunter{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'hotel_hunter/css/hotel_hunter_styles.css' %}?v=3.5">
{% endblock %}

{# Override main_style to allow full width and zero padding #}
{% block main_style %}padding: 0; margin: 0; max-width: 100%; width: 100%; height: 100%;{% endblock %}

{% block content %}
<div class="hh-layout">
    <!-- Header / Search Bar -->
    <div class="hh-header-outer">
        <div class="hh-header-inner">
            <!-- Nav Tabs -->
            <div class="hh-nav-tabs" style="margin-right: 2rem;">
                <a href="{% url 'hotel_hunter:index' %}" class="hh-nav-link active">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg> 
                    Find Hotels
                </a>
                <a href="{% url 'hotel_hunter:history' %}" class="hh-nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M12 7v5l4 2"></path></svg> 
                    Strategy History
                </a>
            </div>

            <div class="hh-search-row">
                <form id="searchForm" method="GET" action="{% url 'hotel_hunter:index' %}" style="display:contents;" onsubmit="showLoader()">
                    
                    <!-- Location -->
                    <div class="hh-input-wrapper-loc">
                        <div class="hh-icon-overlay">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </div>
                        <input name="location" class="hh-input-loc" placeholder="Where are you going?" value="{{ request.GET.location|default:'' }}" required>
                    </div>

                    <!-- Dates -->
                    <div class="hh-date-group">
                        <div class="hh-input-date-wrapper">
                            <input name="checkInDate" class="hh-input-date" type="date" value="{{ request.GET.checkInDate|default:default_check_in }}">
                        </div>
                        <div class="hh-input-date-wrapper">
                            <input name="checkOutDate" class="hh-input-date" type="date" value="{{ request.GET.checkOutDate|default:default_check_out }}">
                        </div>
                        <input type="hidden" name="guests" value="1">
                    </div>

                    <!-- Search Button -->
                    <button type="submit" class="hh-btn">
                        Search
                    </button>

                </form>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="hh-content-wrapper">
        
        <!-- LOADER (Hidden by default) -->
        <div id="loadingState" class="hh-hidden" style="height: 100%;">
            <div class="hh-loader-container">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hh-loader-icon"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                <h3 class="hh-loader-title">Fetching live rates...</h3>
                <p class="hh-loader-subtitle">Connecting to hotel partners</p>
            </div>
        </div>

        <div id="mainContent" class="hh-flex-container">
            {% if hotels %}
            <!-- Sidebar -->
            <aside class="hh-sidebar">
                <div class="hh-filter-header">
                    <h3 class="hh-filter-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sliders-horizontal"><path d="M10 5H3"></path><path d="M12 19H3"></path><path d="M14 3v4"></path><path d="M16 17v4"></path><path d="M21 12h-9"></path><path d="M21 19h-5"></path><path d="M21 5h-7"></path><path d="M8 10v4"></path><path d="M8 12H3"></path></svg>
                         Filters
                    </h3>
                </div>
                <div class="hh-space-y-6">
                    <!-- Brands -->
                    <div>
                        <label class="hh-filter-label">Brands</label>
                        <div class="hh-space-y-3">
                            <label class="hh-checkbox-label">
                                <input class="hh-hidden hh-checkbox-input" type="checkbox">
                                <div class="hh-checkbox-box"></div>
                                <span class="hh-checkbox-text">Hyatt</span>
                            </label>
                             <label class="hh-checkbox-label">
                                <input class="hh-hidden hh-checkbox-input" type="checkbox">
                                <div class="hh-checkbox-box"></div>
                                <span class="hh-checkbox-text">Hilton</span>
                            </label>
                             <label class="hh-checkbox-label">
                                <input class="hh-hidden hh-checkbox-input" type="checkbox">
                                <div class="hh-checkbox-box"></div>
                                <span class="hh-checkbox-text">Marriott</span>
                            </label>
                             <label class="hh-checkbox-label">
                                <input class="hh-hidden hh-checkbox-input" type="checkbox">
                                <div class="hh-checkbox-box"></div>
                                <span class="hh-checkbox-text">IHG</span>
                            </label>
                             <label class="hh-checkbox-label">
                                <input class="hh-hidden hh-checkbox-input" type="checkbox">
                                <div class="hh-checkbox-box"></div>
                                <span class="hh-checkbox-text">Independent</span>
                            </label>
                        </div>
                    </div>

                    <!-- Ratings -->
                    <div>
                        <label class="hh-filter-label">Rating</label>
                        <div class="hh-space-y-3">
                            <label class="hh-radio-label">
                                <input class="hh-hidden hh-radio-input" type="radio" name="rating_filter" value="4">
                                <div class="hh-radio-circle"></div>
                                <div class="hh-radio-text">
                                    4+ <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star ml-1 fill-yellow-400 text-yellow-400" style="margin-left: 0.25rem; fill: #facc15; color: #facc15;"><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path></svg>
                                </div>
                            </label>
                            <label class="hh-radio-label">
                                <input class="hh-hidden hh-radio-input" type="radio" name="rating_filter" value="3">
                                <div class="hh-radio-circle"></div>
                                <div class="hh-radio-text">
                                    3+ <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star ml-1 fill-yellow-400 text-yellow-400" style="margin-left: 0.25rem; fill: #facc15; color: #facc15;"><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path></svg>
                                </div>
                            </label>
                        </div>
                    </div>

                </div>
            </aside>

            <!-- Results -->
            <div class="hh-results-area">
                <div class="hh-results-inner">
                    <div class="hh-results-header">
                        <h2 class="hh-count-title">{{ hotels|length }} Hotels in {{ request.GET.location }}</h2>
                        <span class="hh-subtext">Select up to 5 to compare</span>
                    </div>

                    <form id="compareForm" method="POST" action="{% url 'hotel_hunter:compare' %}" onsubmit="showAnalysisLoader()">
                        {% csrf_token %}
                        <input type="hidden" name="location" value="{{ request.GET.location }}">
                        <input type="hidden" name="checkInDate" value="{{ request.GET.checkInDate|default:default_check_in }}">
                        <input type="hidden" name="checkOutDate" value="{{ request.GET.checkOutDate|default:default_check_out }}">
                        <input type="hidden" name="guests" value="{{ request.GET.guests|default:'1' }}">
                        
                        {% for hotel in hotels %}
                        <div class="hh-card" onclick="toggleCard(this, '{{ hotel.id_safe }}')">
                            <div class="hh-color-bar {{ hotel.brand_class_bg }}"></div>
                            <div class="hh-card-content">
                                <div class="hh-card-top-row">
                                    <div>
                                        <div class="hh-brand-row">
                                            <span class="hh-brand-text">{{ hotel.brand|default:"Independent" }}</span>
                                            <span class="hh-rating-pill">
                                                <svg class="hh-star-fill" xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" class="lucide lucide-star" ><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path></svg>
                                                {{ hotel.rating|default:"--" }}
                                            </span>
                                        </div>
                                        <h3 class="hh-hotel-title">{{ hotel.name }}</h3>
                                        <div class="hh-loc-row">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                            {{ hotel.location_text }}
                                        </div>
                                    </div>
                                    <div class="hh-price-col">
                                        <span class="hh-price-text">${{ hotel.price|floatformat:0 }}</span>
                                        <span class="hh-night-text">per night</span>
                                    </div>
                                </div>
                            </div>
                            <div class="hh-check-col">
                                <div class="hh-circle-check">
                                    <!-- Check icon via CSS bg-image -->
                                </div>
                                <input type="checkbox" name="selected_hotels" value='{{ hotel.json_data }}' class="hh-hidden" id="check-{{ hotel.id_safe }}">
                            </div>
                        </div>
                        {% endfor %}

                        <div id="compareFooter" class="hh-footer-bar">
                            <div class="hh-footer-inner">
                                <div class="hh-footer-left">
                                    <div id="footerCount" class="hh-footer-badge">0</div>
                                    <div class="hh-footer-text-group">
                                        <span class="hh-footer-title">Hotels Selected</span>
                                        <span class="hh-footer-subtitle">Ready for AI Analysis</span>
                                    </div>
                                </div>
                                <div class="hh-footer-right">
                                    <button type="button" class="hh-btn-clear" onclick="clearSelection()">Clear</button>
                                    <button type="submit" class="hh-btn-analyze">
                                        Analyze Strategies 
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% else %}
            <!-- Empty State -->
             <div style="flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; flex-direction: column;">
                 <div style="width: 6rem; height: 6rem; background: white; border-radius: 50%; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                     <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin" style="color: var(--text-slate-900);"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path><circle cx="12" cy="10" r="3"></circle></svg>
                 </div>
                 <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-slate-900); margin-bottom: 0.5rem;">Ready to Hunt?</h2>
                 <p style="color: var(--text-slate-500); max-width: 28rem;">Enter a destination and dates above to find real-time availability. Select hotels to compare cash vs. points redemption value.</p>
             </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function showLoader() {
        document.getElementById('mainContent').classList.add('hh-hidden');
        document.getElementById('loadingState').classList.remove('hh-hidden');
    }
    
    function showAnalysisLoader() {
        // Update loader text
        document.querySelector('.hh-loader-title').innerText = "Running Strategy Analysis...";
        document.querySelector('.hh-loader-subtitle').innerText = "Comparing millions of possibilities";
        
        document.getElementById('mainContent').classList.add('hh-hidden');
        document.getElementById('loadingState').classList.remove('hh-hidden');
    }

    function toggleCard(card, id) {
        // Only toggle if click didn't come from checkbox (avoids double toggle)
        if (event.target.type !== 'checkbox') {
             const checkbox = document.getElementById('check-' + id);
             checkbox.checked = !checkbox.checked;
        }
        
        // Update styling based on checkbox state
        const checkbox = document.getElementById('check-' + id);
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
        updateFooter();
    }
    
    function updateFooter() {
        const checkboxes = document.querySelectorAll('input[name="selected_hotels"]:checked');
        const count = checkboxes.length;
        const footer = document.getElementById('compareFooter');
        const countBadge = document.getElementById('footerCount');
        
        countBadge.innerText = count;
        
        if (count > 0) {
            footer.classList.add('visible');
        } else {
            footer.classList.remove('visible');
        }
    }

    function clearSelection() {
        const checkboxes = document.querySelectorAll('input[name="selected_hotels"]:checked');
        checkboxes.forEach(cb => {
            cb.checked = false;
            // Remove styling from parent card
            const card = cb.closest('.hh-card');
            if (card) {
                card.classList.remove('selected');
            }
        });
        updateFooter();
    }
</script>
{% endblock %}
