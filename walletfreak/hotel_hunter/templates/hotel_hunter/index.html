{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block page_title %}Hotel Hunter{% endblock %}
{% block breadcrumb_section %}Tools{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/hotel_hunter.css' %}">
<link rel="stylesheet" href="{% static 'css/hotel_hunter_filters.css' %}">
<style>
    /* Small layout override for the grid in new design */
    @media (min-width: 768px) {
        .hh-search-grid {
            grid-template-columns: repeat(12, 1fr) !important;
        }
        .hh-input-wrapper:nth-child(1) { grid-column: span 3 !important; } /* Location */
        .hh-input-wrapper:nth-child(2) { grid-column: span 2 !important; } /* Check-in */
        .hh-input-wrapper:nth-child(3) { grid-column: span 2 !important; } /* Check-out */
        .hh-input-wrapper:nth-child(4) { grid-column: span 2 !important; } /* Guests */
        .hh-search-actions { grid-column: span 3 !important; } /* Actions */
    }
</style>
{% endblock %}

{% block content %}
<div class="hh-main-content">
    <div class="hh-container">
        <div class="hh-content-wrapper hh-animate-fade-in">
            
            <!-- Header Section -->
            <div class="hh-header-section">
                <div>
                    <h1 class="hh-title">Hotel Hunter</h1>
                    <p class="hh-subtitle">Optimize your stay using your specific credit cards and points.</p>
                </div>
                
                <div class="hh-points-group" style="flex-wrap: wrap;">
                    {% for point in loyalty_points %}
                    <div class="hh-points-pill">
                        <div class="hh-dot {{ point.color_class }}"></div>
                        <span class="hh-points-text">{{ point.name }}: {{ point.balance|intcomma }}</span>
                    </div>
                    {% empty %}
                    <div class="hh-points-pill">
                        <span class="hh-points-text text-slate-500">No linked hotel/bank points found</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Search Form -->
            <div class="hh-card" style="padding: 0; overflow: hidden;">
                <form id="hh-search-form" method="GET" style="margin:0;">
                    <div style="padding: 1rem;">
                        <div class="hh-search-grid">
                            <!-- Location Input -->
                            <div class="hh-input-wrapper" style="grid-column: span 12;">
                                <div class="hh-input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin" aria-hidden="true"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                </div>
                                <input name="location" placeholder="Where to?" class="hh-input" type="text" value="{{ request.GET.location }}">
                            </div>

                            <!-- Check-in Input -->
                            <div class="hh-input-wrapper" style="grid-column: span 12;">
                                <div class="hh-input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar" aria-hidden="true"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect width="18" height="18" x="3" y="4" rx="2"></rect><path d="M3 10h18"></path></svg>
                                </div>
                                <input name="checkInDate" placeholder="Check-in" class="hh-input" type="text" onfocus="(this.type='date')" onblur="(this.type='text')" value="{{ request.GET.checkInDate|default:'' }}">
                            </div>

                            <!-- Check-out Input -->
                            <div class="hh-input-wrapper" style="grid-column: span 12;">
                                <div class="hh-input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar" aria-hidden="true"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect width="18" height="18" x="3" y="4" rx="2"></rect><path d="M3 10h18"></path></svg>
                                </div>
                                <input name="checkOutDate" placeholder="Check-out" class="hh-input" type="text" onfocus="(this.type='date')" onblur="(this.type='text')" value="{{ request.GET.checkOutDate|default:'' }}">
                            </div>

                            <!-- Guests Input -->
                            <div class="hh-input-wrapper" style="grid-column: span 12;">
                                <div class="hh-input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users" aria-hidden="true"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><path d="M16 3.128a4 4 0 0 1 0 7.744"></path><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><circle cx="9" cy="7" r="4"></circle></svg>
                                </div>
                                <input name="guests" placeholder="Guests" class="hh-input" type="number" value="{{ request.GET.guests|default:2 }}">
                            </div>

                            <!-- Actions -->
                            <div class="hh-search-actions" style="grid-column: span 12;">
                                <button type="button" id="hh-toggle-filters" class="hh-filter-toggle">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sliders-horizontal" aria-hidden="true"><path d="M10 5H3"></path><path d="M12 19H3"></path><path d="M14 3v4"></path><path d="M16 17v4"></path><path d="M21 12h-9"></path><path d="M21 19h-5"></path><path d="M21 5h-7"></path><path d="M8 10v4"></path><path d="M8 12H3"></path></svg>
                                </button>
                                <button type="submit" class="hh-btn-primary">Search</button>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Section (Collapsible) -->
                    <div id="hh-filters" class="hh-filter-section" style="display: block;"> <!-- Always shown matching UI snippet -->
                        <div class="hh-filter-grid">
                            <!-- Price Filter -->
                            <div>
                                <div class="hh-filter-header">
                                    <label class="hh-label">Max Price (Cash)</label>
                                    <span id="price-val" class="hh-value-display">$2000</span>
                                </div>
                                <input type="range" min="100" max="3000" step="50" value="{{ request.GET.maxPrice|default:2000 }}" class="hh-range-input" id="price-range" name="maxPrice">
                                <div class="hh-range-labels">
                                    <span>$100</span>
                                    <span>$3000+</span>
                                </div>
                            </div>

                            <!-- Brands Filter -->
                            <div>
                                <label class="hh-label" style="display:block; margin-bottom: 0.75rem;">Hotel Brands</label>
                                <div class="hh-filter-group" id="brand-group">
                                    <input type="hidden" name="chainCodes" id="chain-codes-input" value="{{ request.GET.chainCodes }}">
                                    
                                    <button type="button" class="hh-filter-btn" data-code="HY">Hyatt</button>
                                    <button type="button" class="hh-filter-btn" data-code="HI">Hilton</button>
                                    <button type="button" class="hh-filter-btn" data-code="MC">Marriott</button>
                                    <button type="button" class="hh-filter-btn" data-code="IH">IHG</button>
                                    <button type="button" class="hh-filter-btn" data-code="IND">Independent</button>
                                </div>
                            </div>

                            <!-- Rating Filter -->
                            <div>
                                <label class="hh-label" style="display:block; margin-bottom: 0.75rem;">Min Rating</label>
                                <div class="hh-filter-group" id="rating-group">
                                    <input type="hidden" name="ratings" id="rating-input" value="{{ request.GET.ratings }}">
                                    
                                    <button type="button" class="hh-filter-btn-rect" data-rating="3">
                                        3+ <svg xmlns="http://www.w3.org/2000/svg" class="hh-star-mini" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    </button>
                                    <button type="button" class="hh-filter-btn-rect" data-rating="4">
                                        4+ <svg xmlns="http://www.w3.org/2000/svg" class="hh-star-mini" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    </button>
                                    <button type="button" class="hh-filter-btn-rect" data-rating="5">
                                        5+ <svg xmlns="http://www.w3.org/2000/svg" class="hh-star-mini" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="hh-filter-footer">
                            <span class="hh-count-text">Showing {{ hotels|length }} properties</span>
                            <button type="button" class="hh-clear-btn" id="clear-filters">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>


            <!-- Empty State / Results Area -->
            <div class="hh-results-area">
                <!-- Loader (Hidden by default) -->
                <div id="hh-loading-indicator" class="hh-loading-overlay" style="display: none;">
                    <div class="hh-spinner"></div>
                    <p>Scanning Amadeus Global inventory...</p>
                </div>

                <div id="hh-results-content">
                    {% if hotels %}
                        {% include 'hotel_hunter/components/search_results.html' %}
                    {% else %}
                    <div class="hh-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hh-empty-icon" aria-hidden="true"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg>
                        <h3 class="hh-empty-title">Start Hunting</h3>
                        <p class="hh-empty-text">Enter a destination to search across your loyalty programs and credit card benefits simultaneously.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
        </div>
    </div>
</div>

{% endblock %} <!-- Close content from prev structure, but wait, the tool call targets specific lines. -->

<!-- I will Target the JS script block at the end specifically -->
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('hh-search-form');
        const priceRange = document.getElementById('price-range');
        const priceVal = document.getElementById('price-val');
        const chainInput = document.getElementById('chain-codes-input');
        const ratingInput = document.getElementById('rating-input');
        
        // 1. Price Slider
        if(priceRange) {
            priceRange.addEventListener('input', function() {
                priceVal.textContent = '$' + this.value;
            });
        }

        // 2. Brand Buttons (Multi-select)
        const brandBtns = document.querySelectorAll('#brand-group .hh-filter-btn');
        let selectedChains = chainInput.value ? chainInput.value.split(',').filter(Boolean) : [];
        
        // Init active state
        brandBtns.forEach(btn => {
            if(selectedChains.includes(btn.dataset.code)) {
                btn.classList.add('active');
            }
            
            btn.addEventListener('click', function() {
                const code = this.dataset.code;
                if(this.classList.contains('active')) {
                    this.classList.remove('active');
                    selectedChains = selectedChains.filter(c => c !== code);
                } else {
                    this.classList.add('active');
                    selectedChains.push(code);
                }
                chainInput.value = selectedChains.join(',');
            });
        });

        // 3. Rating Buttons (Single Select logic for "Min Rating" usually, but let's see. 
        //    "Min Rating" implies 4+ means 4 or 5. 
        //    Let's make it toggle one active at a time for simplicity of "Min Rating".)
        const ratingBtns = document.querySelectorAll('#rating-group .hh-filter-btn-rect');
        ratingBtns.forEach(btn => {
            if(ratingInput.value === btn.dataset.rating) {
                btn.classList.add('active');
            }
            
            btn.addEventListener('click', function() {
                // If clicking active, clear it? Or just keep it. Let's allowing clearing.
                const val = this.dataset.rating;
                
                ratingBtns.forEach(b => b.classList.remove('active'));
                
                if(ratingInput.value === val) {
                    ratingInput.value = ''; // Deselect
                } else {
                    this.classList.add('active');
                    ratingInput.value = val;
                }
            });
        });

        // 4. Toggle Filters
        const toggleBtn = document.getElementById('hh-toggle-filters');
        const filtersDiv = document.getElementById('hh-filters');
        if(toggleBtn && filtersDiv) {
            toggleBtn.addEventListener('click', function() {
                if(filtersDiv.style.display === 'none') {
                    filtersDiv.style.display = 'block';
                } else {
                    filtersDiv.style.display = 'none';
                }
            });
        }

        // 5. Clear Filters
        const clearBtn = document.getElementById('clear-filters');
        if(clearBtn) {
            clearBtn.addEventListener('click', function() {
                // Reset inputs
                priceRange.value = 2000;
                priceVal.textContent = '$2000';
                
                selectedChains = [];
                chainInput.value = '';
                brandBtns.forEach(b => b.classList.remove('active'));
                
                ratingInput.value = '';
                ratingBtns.forEach(b => b.classList.remove('active'));
            });
        }

        // 6. Form Submit Loader
        form.addEventListener('submit', function() {
            const btn = this.querySelector('button[type="submit"]');
            const loader = document.getElementById('hh-loading-indicator');
            const content = document.getElementById('hh-results-content');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="hh-spinner-sm"></span> Searching...';
            
            if (content) content.style.display = 'none';
            if (loader) loader.style.display = 'flex';
        });
        // 7. Results Accordion Logic (Event Delegation)
        const resultsArea = document.getElementById('hh-results-content');
        if (resultsArea) {
            resultsArea.addEventListener('click', function(e) {
                const trigger = e.target.closest('.hh-accordion-trigger');
                if (trigger) {
                    const targetId = trigger.dataset.target;
                    const content = document.getElementById(targetId);
                    
                    // Close others
                    const openTriggers = document.querySelectorAll('.hh-accordion-trigger.active');
                    openTriggers.forEach(t => {
                        if (t !== trigger) {
                            t.classList.remove('active');
                            const tid = t.dataset.target;
                            const c = document.getElementById(tid);
                            if (c) c.classList.remove('open');
                        }
                    });

                    // Toggle current
                    if (content) {
                        trigger.classList.toggle('active');
                        content.classList.toggle('open');
                    }
                }
            });
        }
    });
</script>
{% endblock %}
